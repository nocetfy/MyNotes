<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta property="og:url" content="https://newzone.top/MyNotes/interview/Java/Java%20IO.html"><meta property="og:site_name" content="nocetfy"><meta property="og:title" content="Java IO"><meta property="og:description" content="Java IO é˜»å¡IO æœ¬åœ°IO å¤§è‡´å¯ä»¥æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š in.read(buf)æ‰§è¡Œæ—¶ï¼Œç¨‹åºå‘å†…æ ¸å‘èµ· read()ç³»ç»Ÿè°ƒç”¨ï¼› æ“ä½œç³»ç»Ÿå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç”±ç”¨æˆ·æ€(User mode)åˆ‡æ¢åˆ°å†…æ ¸æ€(Kernel mode)ï¼ŒæŠŠæ•°æ®è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒº ï¼ˆbufferï¼‰ä¸­ï¼› å†…æ ¸æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒåŒæ—¶ç”±å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼› ç»§ç»­æ‰§è¡Œ out.write(buf)ï¼› å†æ¬¡å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´bufferæ‹·è´åˆ°å†…æ ¸ç©ºé—´bufferä¸­ï¼Œç”±å†…æ ¸æŠŠæ•°æ®å†™å…¥æ–‡ä»¶ã€‚"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Java IO","image":[""],"dateModified":null,"author":[]}</script><title>Java IO | nocetfy</title><meta name="description" content="Java IO é˜»å¡IO æœ¬åœ°IO å¤§è‡´å¯ä»¥æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š in.read(buf)æ‰§è¡Œæ—¶ï¼Œç¨‹åºå‘å†…æ ¸å‘èµ· read()ç³»ç»Ÿè°ƒç”¨ï¼› æ“ä½œç³»ç»Ÿå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç”±ç”¨æˆ·æ€(User mode)åˆ‡æ¢åˆ°å†…æ ¸æ€(Kernel mode)ï¼ŒæŠŠæ•°æ®è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒº ï¼ˆbufferï¼‰ä¸­ï¼› å†…æ ¸æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒåŒæ—¶ç”±å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼› ç»§ç»­æ‰§è¡Œ out.write(buf)ï¼› å†æ¬¡å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´bufferæ‹·è´åˆ°å†…æ ¸ç©ºé—´bufferä¸­ï¼Œç”±å†…æ ¸æŠŠæ•°æ®å†™å…¥æ–‡ä»¶ã€‚">
    <meta name="keywords" content="è‡ªæˆ‘æå‡,æ•ˆç‡æå‡,å¼€æºå·¥å…·,å­¦ä¹ ç¬”è®°" />
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #252232;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/MyNotes/assets/style-fdc52a0b.css" as="style"><link rel="stylesheet" href="/MyNotes/assets/style-fdc52a0b.css">
    <link rel="modulepreload" href="/MyNotes/assets/app-59c87434.js"><link rel="modulepreload" href="/MyNotes/assets/framework-1ee2252c.js"><link rel="modulepreload" href="/MyNotes/assets/Java IO.html-22b50620.js"><link rel="modulepreload" href="/MyNotes/assets/Java IO.html-bce5aef5.js">

    <!-- çœ‹æ¿å¨˜åŒºå— -->
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-y/font-awesome/6.0.0/css/all.min.css" type="text/css" rel="stylesheet" />
    <script src="/live2d-widget/autoload.js"></script>
    <!-- End çœ‹æ¿å¨˜åŒºå— -->

    <!-- Matomo æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://piwik.seoipo.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '7']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->

  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/MyNotes/" class="brand"><img class="logo" src="/MyNotes/logo.svg" alt="nocetfy"><!----><span class="site-name hide-in-pad">nocetfy</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/MyNotes/blog" class="nav-link" aria-label="åšå®¢"><span class="font-icon icon iconfont icon-blog" style=""></span>åšå®¢<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ä»£ç "><span class="title"><span class="font-icon icon iconfont icon-code" style=""></span>ä»£ç </span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/MyNotes/code/Markdown" class="nav-link" aria-label="/code/Markdown"><!---->/code/Markdown<!----></a></li><li class="dropdown-item"><a href="/MyNotes/code/AutoHotkey" class="nav-link" aria-label="/code/AutoHotkey"><!---->/code/AutoHotkey<!----></a></li><li class="dropdown-item"><a href="/MyNotes/code/Electron" class="nav-link" aria-label="/code/Electron"><!---->/code/Electron<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>é¡µé¢å¼€å‘</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/MyNotes/web/VuePress" class="nav-link" aria-label="/web/VuePress"><!---->/web/VuePress<!----></a></li><li class="dropdown-subitem"><a href="/MyNotes/web/docsify" class="nav-link" aria-label="/web/docsify"><!---->/web/docsify<!----></a></li><li class="dropdown-subitem"><a href="/MyNotes/deploy/VPS" class="nav-link" aria-label="/deploy/VPS"><!---->/deploy/VPS<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="åº”ç”¨"><span class="title"><span class="font-icon icon iconfont icon-app" style=""></span>åº”ç”¨</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/MyNotes/apps/Applist" class="nav-link" aria-label="/apps/Applist"><!---->/apps/Applist<!----></a></li><li class="dropdown-item"><a href="/MyNotes/apps/ChatGPT" class="nav-link" aria-label="/apps/ChatGPT"><!---->/apps/ChatGPT<!----></a></li><li class="dropdown-item"><a href="/MyNotes/apps/livestreaming/1_obs_basic" class="nav-link" aria-label="ç›´æ’­æ‰‹å†Œ"><span class="font-icon icon iconfont icon-quote" style=""></span>ç›´æ’­æ‰‹å†Œ<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æœåŠ¡/ç³»ç»Ÿ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/MyNotes/services/NAS" class="nav-link" aria-label="/services/NAS"><!---->/services/NAS<!----></a></li><li class="dropdown-subitem"><a href="/MyNotes/windows/faq" class="nav-link" aria-label="/windows/faq"><!---->/windows/faq<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ç”Ÿæ´»"><span class="title"><span class="font-icon icon iconfont icon-emmet" style=""></span>ç”Ÿæ´»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/MyNotes/family/Diet" class="nav-link" aria-label="/family/Diet"><!---->/family/Diet<!----></a></li><li class="dropdown-item"><a href="/MyNotes/family/Shoppinglist" class="nav-link" aria-label="/family/Shoppinglist"><!---->/family/Shoppinglist<!----></a></li><li class="dropdown-item"><a href="/MyNotes/family/Coupon" class="nav-link" aria-label="/family/Coupon"><!---->/family/Coupon<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://nav.newzone.top/" rel="noopener noreferrer" target="_blank" aria-label="å·¥å…·æ”¶è—" class="nav-link"><span class="font-icon icon iconfont icon-tool" style=""></span>å·¥å…·æ”¶è—<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><div class="nav-item"><a class="repo-link" href="https://github.com/nocetfy" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ğŸ§° ç®—æ³•ç¬”è®°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">ğŸš€ é¢è¯•ç¬”è®°</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">è®¡ç®—æœºåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">Java</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Java IO"><!---->Java IO<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#é˜»å¡io" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="é˜»å¡IO"><!---->é˜»å¡IO<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#éé˜»å¡io" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="éé˜»å¡IO"><!---->éé˜»å¡IO<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#ioå¤šè·¯å¤ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="IOå¤šè·¯å¤ç”¨"><!---->IOå¤šè·¯å¤ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#ioåˆ†ç±»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="IOåˆ†ç±»"><!---->IOåˆ†ç±»<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/Java/Java.html" class="nav-link sidebar-link sidebar-page" aria-label="Java åŸºç¡€"><!---->Java åŸºç¡€<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/Java/Java%20Thread.html" class="nav-link sidebar-link sidebar-page" aria-label="Java å¹¶å‘"><!---->Java å¹¶å‘<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/Java/JVM.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM"><!---->JVM<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/Java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" class="nav-link sidebar-link sidebar-page" aria-label="è®¾è®¡æ¨¡å¼"><!---->è®¾è®¡æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">MySQL</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">Redis</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ¶ˆæ¯é˜Ÿåˆ—</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ¡†æ¶</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ•°æ®ç»“æ„ä¸ç®—æ³•</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">ç½‘ç»œ</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ¶æ„</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">åˆ†å¸ƒå¼</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">è¿ç»´å¼€å‘</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">å¼€æ”¾è®¾è®¡</span><span class="arrow right"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Java IO</h1><div class="page-info"><!----><!----><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 14991 å­—</span><meta property="wordCount" content="14991"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 50 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT50M"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#é˜»å¡io" class="router-link-active router-link-exact-active toc-link level3">é˜»å¡IO</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#éé˜»å¡io" class="router-link-active router-link-exact-active toc-link level3">éé˜»å¡IO</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#ioå¤šè·¯å¤ç”¨" class="router-link-active router-link-exact-active toc-link level3">IOå¤šè·¯å¤ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/Java/Java%20IO.html#ioåˆ†ç±»" class="router-link-active router-link-exact-active toc-link level3">IOåˆ†ç±»</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="java-io" tabindex="-1"><a class="header-anchor" href="#java-io" aria-hidden="true">#</a> Java IO</h1><h3 id="é˜»å¡io" tabindex="-1"><a class="header-anchor" href="#é˜»å¡io" aria-hidden="true">#</a> é˜»å¡IO</h3><h4 id="æœ¬åœ°io" tabindex="-1"><a class="header-anchor" href="#æœ¬åœ°io" aria-hidden="true">#</a> æœ¬åœ°IO</h4><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604224850936.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¤§è‡´å¯ä»¥æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p><ul><li><code>in.read(buf)</code>æ‰§è¡Œæ—¶ï¼Œç¨‹åºå‘å†…æ ¸å‘èµ· <code>read()</code>ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>æ“ä½œç³»ç»Ÿå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç”±ç”¨æˆ·æ€(User mode)åˆ‡æ¢åˆ°å†…æ ¸æ€(Kernel mode)ï¼ŒæŠŠæ•°æ®è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒº ï¼ˆbufferï¼‰ä¸­ï¼›</li><li>å†…æ ¸æŠŠæ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ŒåŒæ—¶ç”±å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼›</li><li>ç»§ç»­æ‰§è¡Œ <code>out.write(buf)</code>ï¼›</li><li>å†æ¬¡å‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´bufferæ‹·è´åˆ°å†…æ ¸ç©ºé—´bufferä¸­ï¼Œç”±å†…æ ¸æŠŠæ•°æ®å†™å…¥æ–‡ä»¶ã€‚</li></ul><h4 id="ç½‘ç»œio" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œio" aria-hidden="true">#</a> ç½‘ç»œIO</h4><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/640.gif" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>å®¢æˆ·ç«¯è°ƒç”¨<code>connect()</code>å‡½æ•°ï¼Œå¼€å§‹3æ¬¡æ¡æ‰‹ï¼Œé¦–å…ˆå‘é€ä¸€ä¸ª<code>SYN X</code>çš„æŠ¥æ–‡ï¼ˆ<code>X</code>æ˜¯ä¸ªæ•°å­—ï¼Œä¸‹åŒï¼‰ï¼›</li><li>æœåŠ¡ç«¯æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„<code>SYN</code>ï¼Œç„¶ååœ¨ç›‘å¬socketå¯¹åº”çš„åŠè¿æ¥é˜Ÿåˆ—ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„socketï¼Œç„¶åå¯¹å®¢æˆ·ç«¯å‘å›å“åº”<code>SYN Y</code>ï¼Œæå¸¦æ‰‹å¯¹å®¢æˆ·ç«¯çš„æŠ¥æ–‡ç»™ä¸ª<code>ACK</code>ï¼›</li><li>ç›´åˆ°å®¢æˆ·ç«¯å®Œæˆç¬¬3æ¬¡æ¡æ‰‹ï¼Œåˆšæ‰æ–°åˆ›å»ºçš„socketå°±ä¼šè¢«è½¬ç§»åˆ°å·²è¿æ¥é˜Ÿåˆ—ï¼›</li><li><strong>å½“è¿›ç¨‹è°ƒç”¨<code>accept()</code>æ—¶ï¼Œä¼šå°†å·²è¿æ¥é˜Ÿåˆ—å¤´éƒ¨çš„socketè¿”å›ï¼›å¦‚æœå·²è¿æ¥é˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆè¿›ç¨‹å°†è¢«ç¡çœ ï¼Œç›´åˆ°å·²è¿æ¥é˜Ÿåˆ—ä¸­æœ‰æ–°çš„socketï¼Œè¿›ç¨‹æ‰ä¼šè¢«å”¤é†’ï¼Œå°†è¿™ä¸ªsocketè¿”å›</strong>ã€‚</li></ol><p>æ‹¿Serverç«¯çš„BIOæ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œé˜»å¡åœ¨äº†<code>serverSocket.accept()</code>ä»¥åŠ<code>bufferedReader.readLine()</code>è¿™ä¸¤ä¸ªåœ°æ–¹ã€‚æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥è¯æ˜é˜»å¡å—ï¼Ÿ</p><p>â€‹ ç®€å•çš„å¾ˆï¼ä½ åœ¨<code>serverSocket.accept();</code> çš„ä¸‹ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œç„¶ådebugæ¨¡å¼è¿è¡Œ<code>BIOServerSocket</code>ï¼Œåœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–­ç‚¹ç»ä¸ä¼šè§¦å‘ï¼åŒæ ·ï¼Œåœ¨<code>bufferedReader.readLine();</code>ä¸‹ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œåœ¨å·²è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ•°æ®ä¹‹å‰ï¼Œè¿™ä¸ªæ–­ç‚¹ç»ä¸ä¼šè§¦å‘ï¼</p><p><code> readLine()</code>çš„é˜»å¡è¿˜å¸¦æ¥ä¸€ä¸ªéå¸¸ä¸¥é‡çš„é—®é¢˜ï¼Œå¦‚æœå·²ç»è¿æ¥çš„å®¢æˆ·ç«¯ä¸€ç›´ä¸å‘é€æ¶ˆæ¯ï¼Œ<code>readLine()</code>è¿›ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ï¼ˆå¤„äºç¡çœ çŠ¶æ€ï¼‰ï¼Œç»“æœå°±æ˜¯ä»£ç ä¸ä¼šå†æ¬¡è¿è¡Œåˆ°<code>accept()</code>ï¼Œè¿™ä¸ª<code>ServerSocket</code>æ²¡åŠæ³•æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230603234401468.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ BIOä¹‹æ‰€ä»¥æ˜¯BIOï¼Œæ˜¯å› ä¸ºç³»ç»Ÿåº•å±‚è°ƒç”¨æ˜¯é˜»å¡çš„ï¼Œä¸Šå›¾ä¸­çš„è¿›ç¨‹è°ƒç”¨<code>recv</code>ï¼Œå…¶ç³»ç»Ÿè°ƒç”¨ç›´åˆ°æ•°æ®åŒ…å‡†å¤‡å¥½å¹¶ä¸”è¢«å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºæˆ–è€…å‘ç”Ÿé”™è¯¯ä¸ºæ­¢æ‰ä¼šè¿”å›ï¼Œåœ¨æ­¤æ•´ä¸ªæœŸé—´ï¼Œè¿›ç¨‹æ˜¯è¢«é˜»å¡çš„ï¼Œå•¥ä¹Ÿå¹²ä¸äº†ã€‚(æ¯ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥éƒ½å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨çº¿ç¨‹)ã€‚</p><hr><h3 id="éé˜»å¡io" tabindex="-1"><a class="header-anchor" href="#éé˜»å¡io" aria-hidden="true">#</a> éé˜»å¡IO</h3><p>æœåŠ¡å™¨åªæä¾›ä¸€ä¸ªçº¿ç¨‹å¤„ç†æ‰€æœ‰è¯·æ±‚ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹åº”å¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230603234959997.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ç³»ç»Ÿè°ƒç”¨å‘å†…æ ¸è¦æ•°æ®æ—¶ï¼Œå†…æ ¸çš„åŠ¨ä½œåˆ†æˆä¸¤æ­¥ï¼š</p><ol><li>ç­‰å¾…æ•°æ®ï¼ˆä»ç½‘å¡ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼‰</li><li>æ‹·è´æ•°æ®ï¼ˆæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼‰</li></ol><p>åªæœ‰åœ¨ç¬¬1æ­¥æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯éé˜»å¡çš„ï¼Œç¬¬2æ­¥è¿›ç¨‹ä¾ç„¶éœ€è¦ç­‰å¾…è¿™ä¸ªæ‹·è´è¿‡ç¨‹ï¼Œç„¶åæ‰èƒ½è¿”å›ï¼Œè¿™ä¸€æ­¥æ˜¯é˜»å¡çš„ã€‚</p><p>â€‹ éé˜»å¡IOæ¨¡å‹ä»…ç”¨ä¸€ä¸ªçº¿ç¨‹å°±èƒ½å¤„ç†æ‰€æœ‰æ“ä½œï¼Œå¯¹æ¯”BIOçš„ä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦ä¸€ä¸ªçº¿ç¨‹è€Œè¨€è¿›æ­¥è¿˜æ˜¯å·¨å¤§çš„ã€‚ä½†æ˜¯ä»–çš„è‡´å‘½é—®é¢˜åœ¨äºä¼šä¸åœåœ°è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¸åœçš„è¿›è¡Œ<code>accept()</code>ï¼Œä¸åœåœ°å¯¹è¿æ¥socketè¿›è¡Œ<code>read()</code>æ“ä½œï¼Œå³ä½¿å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯ç™½å¿™æ´»ã€‚è¦çŸ¥é“ï¼Œç³»ç»Ÿè°ƒç”¨æ¶‰åŠåˆ°ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„å¤šæ¬¡è½¬æ¢ï¼Œä¼šä¸¥é‡å½±å“æ•´ä½“æ€§èƒ½ã€‚</p><hr><h3 id="ioå¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#ioå¤šè·¯å¤ç”¨" aria-hidden="true">#</a> IOå¤šè·¯å¤ç”¨</h3><p>â€‹ éé˜»å¡IOä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å¤„ç†æ‰€æœ‰socketï¼Œä½†æ˜¯ä»˜å‡ºçš„ä»£ä»·æ˜¯å¿…é¡»é¢‘ç¹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ¥è½®è¯¢æ¯ä¸€ä¸ªsocketçš„æ•°æ®ï¼Œè¿™ç§è½®è¯¢å¤ªè€—è´¹æ€§èƒ½ï¼Œè€Œä¸”å¤§éƒ¨åˆ†è½®è¯¢éƒ½æ˜¯ç©ºè½®è¯¢ã€‚æˆ‘ä»¬å¸Œæœ›æœ‰ä¸ªç»„ä»¶èƒ½åŒæ—¶ç›‘æ§å¤šä¸ªsocketï¼Œå¹¶åœ¨socketæŠŠæ•°æ®å‡†å¤‡å¥½çš„æ—¶å€™å‘Šè¯‰è¿›ç¨‹å“ªäº›socketå·²<strong>å°±ç»ª</strong>ï¼Œç„¶åè¿›ç¨‹åªå¯¹å°±ç»ªçš„socketè¿›è¡Œæ•°æ®è¯»å†™ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604203812252.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NIOServer</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">Selector</span> selector<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è·å¾—selectorå¤šè·¯å¤ç”¨å™¨</span>
            selector <span class="token operator">=</span> <span class="token class-name">Selector</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token class-name">ServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç›‘å¬socketçš„acceptå°†ä¸ä¼šé˜»å¡</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span><span class="token number">8099</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// éœ€è¦æŠŠç›‘å¬socketæ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰selectorï¼Œéœ€è¦å…³æ³¨ç›‘å¬socketçš„OP_ACCEPTäº‹ä»¶</span>
            serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_ACCEPT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¯¥æ–¹æ³•ä¼šé˜»å¡</span>
                selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// å¾—åˆ°æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶ï¼Œäº‹ä»¶è¢«å°è£…æˆäº†SelectionKey</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> selectionKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> selectionKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">SelectionKey</span> key <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isAcceptable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">handleAccept</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">handleRead</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//å‘é€æ•°æ®</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
    <span class="token comment">// å¤„ç†ã€Œè¯»ã€äº‹ä»¶çš„ä¸šåŠ¡é€»è¾‘</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleRead</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteBuffer</span> allocate <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>allocate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;From Client:&quot;</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>allocate<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  	<span class="token comment">// å¤„ç†ã€Œè¿æ¥ã€äº‹ä»¶çš„ä¸šåŠ¡é€»è¾‘</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">handleAccept</span><span class="token punctuation">(</span><span class="token class-name">SelectionKey</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerSocketChannel</span> serverSocketChannel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServerSocketChannel</span><span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// socketChannelä¸€å®šæ˜¯éç©ºï¼Œå¹¶ä¸”è¿™é‡Œä¸ä¼šé˜»å¡</span>
            <span class="token class-name">SocketChannel</span> socketChannel <span class="token operator">=</span> serverSocketChannel<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å°†è¿æ¥socketçš„è¯»å†™è®¾ç½®ä¸ºéé˜»å¡</span>
            socketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">&quot;Hello Clientï¼Œ I am Serverï¼&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ³¨å†Œè¿æ¥socketçš„ã€Œè¯»äº‹ä»¶ã€</span>
            socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>selector<span class="token punctuation">,</span> <span class="token class-name">SelectionKey</span><span class="token punctuation">.</span><span class="token constant">OP_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ æˆ‘ä»¬é¦–å…ˆä½¿ç”¨<code>Selector.open();</code>å¾—åˆ°äº†<code>selector</code>è¿™ä¸ªå¤šè·¯å¤ç”¨å¯¹è±¡ï¼›ç„¶ååœ¨æœåŠ¡ç«¯åˆ›å»ºäº†ç›‘å¬socketï¼Œå¹¶å°†å…¶è®¾ç½®ä¸º<strong>éé˜»å¡</strong>ï¼Œæœ€åå°†ç›‘å¬socketæ³¨å†Œåˆ°<code>selector</code>å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰<code>selector</code>ï¼Œå¦‚æœç›‘å¬socketæœ‰<code>OP_ACCEPT</code>äº‹ä»¶å‘ç”Ÿçš„è¯å°±è¦å‘Šè¯‰æˆ‘ä»¬ã€‚</p><p>â€‹ æˆ‘ä»¬åœ¨whileå¾ªç¯ä¸­è°ƒç”¨<code>selector.select();</code>æ–¹æ³•ï¼Œè¿›ç¨‹å°†ä¼šé˜»å¡åœ¨è¯¥æ–¹æ³•ä¸Šï¼Œç›´åˆ°æ³¨å†Œåœ¨<code>selector</code>ä¸Šçš„ä»»æ„ä¸€ä¸ªsocketæœ‰äº‹ä»¶å‘ç”Ÿä¸ºæ­¢ï¼Œæ‰ä¼šè¿”å›ã€‚å¦‚æœä¸ä¿¡çš„è¯å¯ä»¥åœ¨<code>selector.select();</code>çš„ä¸‹ä¸€è¡Œæ‰“ä¸ªæ–­ç‚¹ï¼Œdebugæ¨¡å¼è¿è¡Œåï¼Œåœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¿æ¥çš„æƒ…å†µä¸‹æ–­ç‚¹ä¸ä¼šè¢«è§¦å‘ã€‚</p><p>â€‹ å½“<code>select()</code>è¿”å›ï¼Œæ„å‘³ç€æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªsocketå·²ç»å¤„äºå°±ç»ªçŠ¶æ€ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>Set&lt;SelectionKey&gt;</code>æ¥ä¿å­˜æ‰€æœ‰äº‹ä»¶ï¼Œ<code>SelectionKey</code>å°è£…äº†å°±ç»ªçš„äº‹ä»¶ï¼Œæˆ‘ä»¬å¾ªç¯æ¯ä¸ªäº‹ä»¶ï¼Œæ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹è¿›è¡Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚</p><p><code> OP_READ</code>äº‹ä»¶å°±ç»ªçš„è¯ï¼Œæˆ‘ä»¬å°±å‡†å¤‡ä¸€ä¸ªç¼“å†²ç©ºé—´ï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´è¯»åˆ°ç¼“å†²ä¸­ï¼›å¦‚æœæ˜¯<code>OP_ACCEPT</code>å°±ç»ªï¼Œé‚£å°±è°ƒç”¨ç›‘å¬socketçš„<code>accept()</code>æ–¹æ³•å¾—åˆ°è¿æ¥socketï¼Œå¹¶ä¸”<code>accept()</code>ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºåœ¨æœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬å·²ç»å°†ç›‘å¬socketè®¾ç½®ä¸ºéé˜»å¡äº†ã€‚å¾—åˆ°çš„è¿æ¥socketåŒæ ·éœ€è¦è®¾ç½®ä¸ºéé˜»å¡ï¼Œè¿™æ ·è¿æ¥socketçš„è¯»å†™æ“ä½œå°±æ˜¯éé˜»å¡çš„ï¼Œæœ€åå°†è¿æ¥socketæ³¨å†Œåˆ°<code>selector</code>å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œå¹¶å‘Šè¯‰<code>selector</code>ï¼Œå¦‚æœè¿æ¥socketæœ‰<code>OP_READ</code>äº‹ä»¶å‘ç”Ÿçš„è¯å°±è¦å‘Šè¯‰æˆ‘ä»¬ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-02-150949.gif" alt="å¤šè·¯å¤ç”¨" tabindex="0" loading="lazy"><figcaption>å¤šè·¯å¤ç”¨</figcaption></figure><p>â€‹ å¤šè·¯å¤ç”¨æœ¬è´¨ä¸Šå°±æ˜¯åŒæ—¶ç›‘å¬å¤šä¸ªsocketçš„è¯·æ±‚ï¼Œå½“æˆ‘ä»¬è®¢é˜…çš„socketä¸Šæœ‰æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œå¤šè·¯å¤ç”¨å‡½æ•°ä¼šè¿”å›ï¼Œç„¶åæˆ‘ä»¬çš„ç”¨æˆ·ç¨‹åºæ ¹æ®è¿”å›ç»“æœç»§ç»­å¤„ç†è¿™äº›å°±ç»ªçŠ¶æ€çš„socketã€‚</p><p>ä½†æ˜¯ï¼Œä¸åŒçš„å¤šè·¯å¤ç”¨æ¨¡å‹åœ¨å…·ä½“çš„å®ç°ä¸Šæœ‰æ‰€ä¸åŒï¼Œä¸»è¦ä½“ç°åœ¨ä¸‰ä¸ªæ–¹é¢ï¼š</p><ol><li>å¤šè·¯å¤ç”¨æ¨¡å‹æœ€å¤šå¯ä»¥åŒæ—¶ç›‘å¬å¤šå°‘ä¸ªsocketï¼Ÿ</li><li>å¤šè·¯å¤ç”¨æ¨¡å‹ä¼šç›‘å¬socketä¸Šå“ªäº›äº‹ä»¶ï¼Ÿ</li><li>å½“socketå°±ç»ªæ—¶ï¼Œå¤šè·¯å¤ç”¨æ¨¡å‹å¦‚ä½•æ‰¾åˆ°å°±ç»ªçš„socketï¼Ÿ</li></ol><p>å¤šè·¯å¤ç”¨ä¸»è¦æœ‰3ç§ï¼Œåˆ†åˆ«æ˜¯<code>select</code>ã€<code>poll</code>å’Œ<code>epoll</code></p><h4 id="select" tabindex="-1"><a class="header-anchor" href="#select" aria-hidden="true">#</a> select</h4><p>â€‹ æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>select</code>å‘Šè¯‰å†…æ ¸ï¼Œæˆ‘ä»¬å¯¹å“ªäº›æè¿°ç¬¦ï¼ˆè¿™äº›æè¿°ç¬¦å¯ä»¥è¡¨ç¤ºæ ‡å‡†è¾“å…¥ã€ç›‘å¬socketæˆ–è€…è¿æ¥socketç­‰ï¼‰çš„å“ªäº›äº‹ä»¶ï¼ˆå¯è¯»ã€å¯å†™ã€å‘ç”Ÿå¼‚å¸¸ï¼‰æ„Ÿå…´è¶£ï¼Œæˆ–è€…æŸä¸ªè¶…æ—¶æ—¶é—´ä¹‹åç›´æ¥è¿”å›ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// è¿”å›ï¼šè‹¥æœ‰å°±ç»ªæè¿°ç¬¦åˆ™ä¸ºå…¶æ•°ç›®ï¼Œè‹¥è¶…æ—¶åˆ™ä¸º0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1</span>
<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span>
                  fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>nfds</code>å‚æ•°ç”¨æ¥å‘Šè¯‰<code>select</code>éœ€è¦æ£€æŸ¥çš„æè¿°ç¬¦çš„ä¸ªæ•°ï¼Œå–å€¼ä¸ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„æœ€å¤§æè¿°ç¬¦ + 1ã€‚<code>readfds</code>é‡Œä¿å­˜çš„æ˜¯æˆ‘ä»¬å¯¹<strong>è¯»å°±ç»ªäº‹ä»¶</strong>æ„Ÿå…´è¶£çš„æè¿°ç¬¦ï¼Œ<code>writefds</code>ä¿å­˜çš„æ˜¯æˆ‘ä»¬å¯¹<strong>å†™å°±ç»ªäº‹ä»¶</strong>æ„Ÿå…´è¶£çš„æè¿°ç¬¦ï¼Œ<code>exceptfds</code>ä¿å­˜çš„æ˜¯æˆ‘ä»¬å¯¹<strong>å‘ç”Ÿå¼‚å¸¸</strong>è¿™ç§äº‹ä»¶æ„Ÿå…´è¶£çš„æè¿°ç¬¦ã€‚è¿™ä¸‰ä¸ªå‚æ•°ä¼šå‘Šè¯‰å†…æ ¸ï¼Œåˆ†åˆ«éœ€è¦åœ¨å“ªäº›æè¿°ç¬¦ä¸Šæ£€æµ‹æ•°æ®å¯è¯»ã€å¯å†™ä»¥åŠå‘ç”Ÿå¼‚å¸¸ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /usr/include/sys/select.h</span>
<span class="token comment">/* __fd_mask æ˜¯ long int ç±»å‹çš„åˆ«å  */</span>
<span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">int</span> __fd_mask<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__NFDBITS</span>	<span class="token expression"><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>__fd_mask<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>  <span class="token punctuation">{</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   __fd_mask fds_bits<span class="token punctuation">[</span>__FD_SETSIZE <span class="token operator">/</span> __NFDBITS<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> fd_set<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ å› æ­¤ï¼Œ<code>fd_set</code>çš„å®šä¹‰ï¼Œå…¶å®å°±æ˜¯<code>long int</code>ç±»å‹çš„æ•°ç»„ï¼Œå…ƒç´ ä¸ªæ•°ä¸º<code>__FD_SETSIZE / __NFDBITS</code>ã€‚è¯¥æ•°ç»„ä¸­ä¸€å…±æœ‰16ä¸ªå…ƒç´ ï¼ˆ1024 / 64 = 16ï¼‰ï¼Œæ¯ä¸ªå…ƒç´ ä¸ºlong intç±»å‹ï¼Œå 64ä½ã€‚æ•°ç»„çš„ç¬¬<code>1</code>ä¸ªå…ƒç´ ç”¨äºè¡¨ç¤ºæè¿°ç¬¦<code>0ï½63</code>ï¼Œç¬¬<code>2</code>ä¸ªå…ƒç´ ç”¨äºè¡¨ç¤ºæè¿°ç¬¦<code>64ï½127</code>ï¼Œä»¥æ­¤ç±»æ¨ï¼Œæ¯1ä¸ªbitä½ç”¨<code>0</code>ã€<code>1</code>ä¸¤ç§çŠ¶æ€è¡¨ç¤ºæ˜¯å¦æ£€æµ‹å½“å‰æè¿°ç¬¦çš„äº‹ä»¶ã€‚</p><p>â€‹ å‡è®¾æˆ‘ä»¬å¯¹<code>{1, 4, 7}</code>å·æè¿°ç¬¦çš„è¯»å°±ç»ªäº‹ä»¶æ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆ<code>readfds</code>å‚æ•°çš„æ•°ç»„ç¬¬1ä¸ªå…ƒç´ çš„äºŒè¿›åˆ¶è¡¨ç¤ºå°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç¬¬1ã€4ã€7ä½åˆ†åˆ«è¢«æ ‡è®°ä¸º1ï¼Œå®é™…å­˜å‚¨çš„10è¿›åˆ¶æ•°å­—ä¸º146ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-11-015644.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ—¢ç„¶<code>fd_set</code>åº•å±‚ç”¨çš„æ˜¯æ•°ç»„ï¼Œé‚£å°±ä¸€å®šæœ‰é•¿åº¦é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>selectåŒæ—¶ç›‘å¬çš„socketæ•°é‡æ˜¯æœ‰é™çš„</strong>ï¼Œé•¿åº¦ä¸º<code>1024</code>ã€‚</p><h5 id="é˜»å¡" tabindex="-1"><a class="header-anchor" href="#é˜»å¡" aria-hidden="true">#</a> é˜»å¡</h5><p>â€‹ å½“ç”¨æˆ·çº¿ç¨‹å‘èµ·ä¸€ä¸ªé˜»å¡å¼çš„readç³»ç»Ÿè°ƒç”¨ï¼Œæ•°æ®æœªå°±ç»ªæ—¶ï¼Œçº¿ç¨‹å°±ä¼šé˜»å¡ã€‚é˜»å¡å…¶å®æ˜¯è°ƒç”¨çº¿ç¨‹è¢«æŠ•å…¥ç¡çœ ï¼Œç›´åˆ°å†…æ ¸åœ¨æŸä¸ªæ—¶æœºå”¤é†’çº¿ç¨‹ï¼Œé˜»å¡ä¹Ÿå°±ç»“æŸã€‚å†…æ ¸ä¼šä¸ºæ¯ä¸€ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªåä¸º<code>task_struct</code>çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„æœ¬èº«æ˜¯åˆ†é…åœ¨å†…æ ¸ç©ºé—´çš„ï¼Œå…¶ä¸­ä¿å­˜äº†å½“å‰è¿›ç¨‹çš„è¿›ç¨‹å·ã€socketä¿¡æ¯ã€CPUçš„è¿è¡Œä¸Šä¸‹æ–‡ä»¥åŠå…¶ä»–ä¿¡æ¯ï¼ŒLinuxå†…æ ¸ç»´æŠ¤äº†ä¸€ä¸ª<strong>æ‰§è¡Œé˜Ÿåˆ—</strong>ï¼Œé‡Œè¾¹æ”¾çš„éƒ½æ˜¯å¤„äº<code>TASK_RUNNING</code>çŠ¶æ€çš„è¿›ç¨‹çš„<code>task_struct</code>ï¼Œè¿™äº›è¿›ç¨‹ä»¥åŒå‘é“¾è¡¨çš„æ–¹å¼æ’é˜Ÿç­‰å¾…CPUæçŸ­æ—¶é—´çš„ä¸´å¹¸ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-12-014945.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ é˜»å¡çš„æœ¬è´¨å°±æ˜¯å°†è¿›ç¨‹çš„<code>task_struct</code>ç§»å‡ºæ‰§è¡Œé˜Ÿåˆ—ï¼Œè®©å‡ºCPUçš„è°ƒåº¦ï¼Œå°†è¿›ç¨‹çš„çŠ¶æ€çš„ç½®ä¸º<code>TASK_UNINTERRUPTIBLE</code>æˆ–è€…<code>TASK_INTERRUPTIBLE</code>ï¼Œç„¶åæ·»åŠ åˆ°<strong>ç­‰å¾…é˜Ÿåˆ—</strong>ä¸­ï¼Œç›´åˆ°è¢«å”¤é†’ã€‚é‚£è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—åœ¨å“ªå„¿å‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬å¯¹ä¸€ä¸ªsocketå‘èµ·ä¸€ä¸ªé˜»å¡å¼çš„ <code>read</code> è°ƒç”¨ï¼Œç”¨æˆ·è¿›ç¨‹è‚¯å®šæ˜¯éœ€è¦å’Œè¿™ä¸ªsocketè¿›è¡Œç»‘å®šçš„ï¼Œè¦ä¸ç„¶socketå°±ç»ªä¹‹åéƒ½ä¸çŸ¥é“è¯¥å”¤é†’è°ã€‚è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—å…¶å®å°±æ˜¯ä¿å­˜åœ¨socketæ•°æ®ç»“æ„ä¸­ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">socket</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// è¿™ä¸ªåœ¨epollä¸­ä¼šæåˆ°</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span>	<span class="token operator">*</span>file<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// struct sock - network layer representation of sockets</span>
	<span class="token keyword">struct</span> <span class="token class-name">sock</span>	<span class="token operator">*</span>sk<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// incoming packets</span>
	<span class="token keyword">struct</span> <span class="token class-name">sk_buff_head</span>	sk_receive_queue<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// Packet sending queue</span>
	<span class="token keyword">struct</span> <span class="token class-name">sk_buff_head</span>	sk_write_queue<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// socketçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œwqçš„æ„æ€å°±æ˜¯wait_queue</span>
  <span class="token keyword">struct</span> <span class="token class-name">socket_wq</span> __rcu	<span class="token operator">*</span>sk_wq<span class="token punctuation">;</span>
	
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-28-081300.png" alt="socketæ•°æ®ç»“æ„" tabindex="0" loading="lazy"><figcaption>socketæ•°æ®ç»“æ„</figcaption></figure><p>socketè‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—<code>sk_wq</code>ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¸­æ¯ä¸ªå…ƒç´ ä¿å­˜çš„æ˜¯ï¼š</p><ul><li>é˜»å¡åœ¨å½“å‰socketä¸Šçš„è¿›ç¨‹æè¿°ç¬¦</li><li>è¿›ç¨‹è¢«å”¤é†’ä¹‹ååº”è¯¥è°ƒç”¨çš„å›è°ƒå‡½æ•°</li></ul><p>â€‹ è¿™ä¸ªå›è°ƒå‡½æ•°æ˜¯è¿›ç¨‹åœ¨åŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„æ—¶å€™è®¾ç½®çš„ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ˆè¡Œè¯å«ï¼Œå‘å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼‰ï¼Œå‘Šè¯‰å†…æ ¸ï¼šæˆ‘æ­£ç­‰ç€è¿™ä¸ªsocketä¸Šçš„æ•°æ®å‘¢ï¼Œå…ˆç¡ä¸€ä¼šå„¿ï¼Œç­‰æœ‰æ•°æ®äº†ä½ å°±æ‰§è¡Œè¿™ä¸ªå›è°ƒå‡½æ•°å§ï¼Œé‡Œè¾¹æœ‰æŠŠæˆ‘å”¤é†’çš„é€»è¾‘ã€‚å°±è¿™æ ·ï¼Œç»è¿‡ç½‘å¡æ¥æ”¶æ•°æ®ã€ç¡¬ä¸­æ–­ä»¥åŠè½¯ä¸­æ–­å†åˆ°å†…æ ¸è°ƒç”¨å›è°ƒå‡½æ•°å”¤é†’è¿›ç¨‹ï¼ŒæŠŠè¿›ç¨‹çš„<code>task_struct</code>ä»ç­‰å¾…é˜Ÿåˆ—ç§»åŠ¨åˆ°æ‰§è¡Œé˜Ÿåˆ—ï¼Œè¿›ç¨‹å†æ¬¡å¾—åˆ°CPUçš„ä¸´å¹¸ï¼Œå‡½æ•°è¿”å›ç»“æœï¼Œé˜»å¡ç»“æŸã€‚</p><p>â€‹ ç”¨æˆ·è¿›ç¨‹ä¼šé˜»å¡åœ¨<code>select</code>ä¹‹ä¸Šï¼Œç”±äº<code>select</code>ä¼šåŒæ—¶ç›‘å¬å¤šä¸ªsocketï¼Œå› æ­¤å½“å‰è¿›ç¨‹ä¼šè¢«æ·»åŠ åˆ°æ¯ä¸ªè¢«ç›‘å¬çš„socketçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ¯æ¬¡å”¤é†’è¿˜éœ€è¦ä»æ¯ä¸ªsocketç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-12-044606.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>select</code>çš„å”¤é†’ä¹Ÿæœ‰ä¸ªé—®é¢˜ï¼Œè°ƒç”¨<code>select</code>çš„è¿›ç¨‹è¢«å”¤é†’ä¹‹åæ˜¯ä¸€è„¸æ‡µå•Šï¼Œå†…æ ¸ç›´æ¥æ‰”ç»™ä»–ä¸€ä¸ªæ•´æ•°ï¼Œè¿›ç¨‹ä¸çŸ¥é“å“ªäº›socketæ”¶åˆ°æ•°æ®äº†ï¼Œè¿˜å¿…é¡»éå†ä¸€ä¸‹æ‰èƒ½çŸ¥é“ã€‚</p><h5 id="å¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#å¤šè·¯å¤ç”¨" aria-hidden="true">#</a> å¤šè·¯å¤ç”¨</h5><p><code> select</code>åœ¨è¶…æ—¶æ—¶é—´å†…ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æˆ‘ä»¬æ„Ÿå…´è¶£çš„socketè¯»å°±ç»ªã€å†™å°±ç»ªæˆ–è€…æœ‰å¼‚å¸¸äº‹ä»¶å‘ç”Ÿï¼Œç„¶å<code>select</code>ä¼šè¿”å›å·²å°±ç»ªçš„æè¿°ç¬¦æ•°ã€‚</p><p>ç”¨æˆ·è¿›ç¨‹æ‹¿åˆ°è¿™ä¸ªæ•´æ•°è¯´æ˜äº†ä¸¤ä»¶äº‹æƒ…ï¼š</p><ol><li>æˆ‘ä»¬ä¸Šæ–‡è®²çš„æ‰€æœ‰<code>select</code>æ“ä½œéƒ½æ˜¯åœ¨å†…æ ¸æ€è¿è¡Œçš„ï¼Œ<code>select</code>è¿”å›ä¹‹åï¼Œæƒé™äº¤è¿˜åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼›</li><li>ç”¨æˆ·è¿›ç¨‹æ‹¿åˆ°è¿™ä¸ªæ•´æ•°ï¼Œéœ€è¦å¯¹<code>select</code>ç›‘å¬çš„æè¿°ç¬¦é€ä¸ªè¿›è¡Œæ£€æµ‹ï¼Œåˆ¤æ–­äºŒè¿›åˆ¶ä½æ˜¯å¦è¢«è®¾ç½®ä¸º1ï¼Œè¿›è€Œè¿›è¡Œç›¸å…³çš„é€»è¾‘å¤„ç†ã€‚å¯æ˜¯é—®é¢˜æ˜¯ï¼Œå†…æ ¸æŠŠâ€œå°±ç»ªâ€çš„è¿™ä¸ªçŠ¶æ€ä¿å­˜åœ¨äº†å“ªé‡Œå‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œç”¨æˆ·è¿›ç¨‹è¯¥éå†è°ï¼Ÿ</li></ol><p>â€‹ <code>select</code>çš„<code>readfds</code>ã€<code>writefds</code>ã€<code>exceptfds</code> 3ä¸ªå‚æ•°éƒ½æ˜¯æŒ‡é’ˆç±»å‹ï¼Œç”¨æˆ·è¿›ç¨‹ä¼ é€’è¿™3ä¸ªå‚æ•°å‘Šè¯‰å†…æ ¸å¯¹å“ªäº›socketçš„å“ªäº›äº‹ä»¶æ„Ÿå…´è¶£ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹ååè¿‡æ¥å†…æ ¸ä¼šå°†å°±ç»ªçš„æè¿°ç¬¦çŠ¶æ€ä¹Ÿæ”¾åœ¨è¿™ä¸‰ä¸ªå‚æ•°å˜é‡ä¸­ï¼Œè¿™ç§å‚æ•°ç§°ä¸º<strong>å€¼-ç»“æœ</strong>å‚æ•°ã€‚</p><p>ç”¨æˆ·è¿›ç¨‹é€šè¿‡è°ƒç”¨<code>FD_ISSET(int fd, fd_set *fdset)</code>å¯¹æè¿°ç¬¦é›†è¿›è¡Œåˆ¤æ–­å³å¯ï¼Œçœ‹ä¸ªæ•´ä½“æµç¨‹çš„åŠ¨å›¾ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-11-120008.gif" alt="selectåŠ¨å›¾" tabindex="0" loading="lazy"><figcaption>selectåŠ¨å›¾</figcaption></figure><ul><li>ç”¨æˆ·è¿›ç¨‹è®¾ç½®<code>fd_set</code>å‚æ•°ï¼Œè°ƒç”¨<code>select()</code>å‡½æ•°ï¼Œå¹¶å°†æè¿°ç¬¦é›†åˆæ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼›</li><li>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå†…æ ¸é€šè¿‡<code>nfds</code>å‚æ•°é¿å…æ£€æµ‹é‚£äº›æ€»ä¸º<code>0</code>çš„ä½ï¼Œéå†çš„è¿‡ç¨‹å‘ç”Ÿåœ¨å†…æ ¸ç©ºé—´ï¼Œä¸å­˜åœ¨ç³»ç»Ÿè°ƒç”¨åˆ‡æ¢ä¸Šä¸‹æ–‡çš„å¼€é”€ï¼›</li><li><code>select</code>å‡½æ•°ä¿®æ”¹ç”±æŒ‡é’ˆ<code>readset</code>ã€<code>writeset</code>ä»¥åŠ<code>exceptset</code>æ‰€æŒ‡å‘çš„æè¿°ç¬¦é›†ï¼Œå‡½æ•°è¿”å›æ—¶ï¼Œæè¿°ç¬¦é›†ä¸­åªæœ‰ä¹‹å‰æˆ‘ä»¬æ ‡è®°è¿‡çš„å¹¶ä¸”å¤„äºå°±ç»ªçŠ¶æ€çš„æè¿°ç¬¦å¯¹åº”çš„äºŒè¿›åˆ¶ä½æ‰æ˜¯1ï¼Œå…¶ä½™éƒ½ä¼šè¢«é‡ç½®ä¸º0ï¼ˆå› æ­¤æ¯æ¬¡é‡æ–°è°ƒç”¨<code>select</code>æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠæ‰€æœ‰æè¿°ç¬¦é›†ä¸­æ„Ÿå…´è¶£çš„ä½å†æ¬¡è®¾ç½®ä¸º1ï¼‰ï¼›</li><li>è¿›ç¨‹æ ¹æ®<code>select()</code>è¿”å›çš„ç»“æœåˆ¤æ–­æ“ä½œæ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœä¸º<code>0</code>è¡¨ç¤ºè¶…æ—¶ï¼Œ<code>-1</code>è¡¨ç¤ºå‡ºé”™ï¼Œå¤§äº<code>0</code>è¡¨ç¤ºæœ‰ç›¸åº”æ•°é‡çš„æè¿°ç¬¦å°±ç»ªäº†ï¼Œè¿›è€Œåˆ©ç”¨<code>FD_ISSET</code>éå†æ£€æŸ¥æ‰€æœ‰ç›¸åº”ç±»å‹çš„<code>fd_set</code>ä¸­çš„æ‰€æœ‰æè¿°ç¬¦ï¼Œå¦‚æœä¸º<code>1</code>ï¼Œåˆ™è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†å³å¯ã€‚</li></ul><p>â€‹ <code>select</code>æ˜¯é˜»å¡çš„ï¼Œè¿›ç¨‹ä¼šé˜»å¡åœ¨<code>select</code>ä¹‹ä¸Šï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨çœŸæ­£çš„I/Oç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œæ¨¡å‹ç¤ºæ„å›¾è§ä¸‹å›¾ï¼š</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-02-020526.png" alt="I/Oå¤šè·¯å¤ç”¨æ¨¡å‹" tabindex="0" loading="lazy"><figcaption>I/Oå¤šè·¯å¤ç”¨æ¨¡å‹</figcaption></figure><p>â€‹ æˆ‘ä»¬ä»å¤´åˆ°å°¾éƒ½æ˜¯ä½¿ç”¨ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰socketï¼ŒåŒæ—¶åˆé¿å…äº†éé˜»å¡IOçš„é‚£ç§æ— æ•ˆè½®è¯¢ï¼Œä¸ºæ­¤ä»˜å‡ºçš„ä»£ä»·æ˜¯ä¸€æ¬¡<code>select</code>ç³»ç»Ÿè°ƒç”¨çš„é˜»å¡ï¼Œå¤–åŠ Næ¬¡å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><hr><h4 id="poll" tabindex="-1"><a class="header-anchor" href="#poll" aria-hidden="true">#</a> poll</h4><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// è¿”å›ï¼šè‹¥æœ‰å°±ç»ªæè¿°ç¬¦åˆ™ä¸ºå…¶æ•°ç›®ï¼Œè‹¥è¶…æ—¶åˆ™ä¸º0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1</span>
<span class="token keyword">int</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token operator">*</span>fds<span class="token punctuation">,</span> <span class="token class-name">nfds_t</span> nfds<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡½æ•°æœ‰3ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<code>pollfd</code>ç±»å‹çš„æ•°ç»„ï¼Œå…¶ä¸­<code>pollfd</code>ç»“æ„å¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">pollfd</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>    fd<span class="token punctuation">;</span>       <span class="token comment">/* file descriptor */</span>
    <span class="token keyword">short</span>  events<span class="token punctuation">;</span>   <span class="token comment">/* events to look for */</span>
    <span class="token keyword">short</span>  revents<span class="token punctuation">;</span>  <span class="token comment">/* events returned */</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>pollfd</code>ç”±3éƒ¨åˆ†ç»„æˆï¼Œé¦–å…ˆæ˜¯æè¿°ç¬¦<code>fd</code>ï¼Œå…¶æ¬¡<code>events</code>è¡¨ç¤ºæè¿°ç¬¦<code>fd</code>ä¸Šå¾…æ£€æµ‹çš„äº‹ä»¶ç±»å‹ï¼Œä¸€ä¸ª<code>short</code>ç±»å‹çš„æ•°å­—ç”¨æ¥è¡¨ç¤ºå¤šç§äº‹ä»¶ï¼Œè‡ªç„¶å¯ä»¥æƒ³åˆ°ç”¨çš„æ˜¯äºŒè¿›åˆ¶æ©ç çš„æ–¹å¼æ¥è¿›è¡Œä½æ“ä½œã€‚æºç ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ‰€æœ‰äº‹ä»¶çš„å®šä¹‰ï¼Œé¡ºåºåšäº†ä¸€å®šè°ƒæ•´ï¼Œå¦‚ä¸‹ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /usr/include/bits/poll.h</span>
<span class="token comment">/* ç¬¬ä¸€ç±»ï¼šå¯è¯»äº‹ä»¶  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLIN</span>	<span class="token expression"><span class="token number">0x001</span>	</span><span class="token comment">/* There is data to read.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLPRI</span>	<span class="token expression"><span class="token number">0x002</span>	</span><span class="token comment">/* There is urgent data to read.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLRDNORM</span>	<span class="token expression"><span class="token number">0x040</span>	</span><span class="token comment">/* Normal data may be read.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLRDBAND</span>	<span class="token expression"><span class="token number">0x080</span>	</span><span class="token comment">/* Priority data may be read.  */</span></span>


<span class="token comment">/* ç¬¬äºŒç±»ï¼šå¯å†™äº‹ä»¶  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLOUT</span>	<span class="token expression"><span class="token number">0x004</span>	</span><span class="token comment">/* Writing now will not block.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLWRNORM</span>	<span class="token expression"><span class="token number">0x100</span>	</span><span class="token comment">/* Writing now will not block.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLWRBAND</span>	<span class="token expression"><span class="token number">0x200</span>	</span><span class="token comment">/* Priority data may be written.  */</span></span>


<span class="token comment">/* ç¬¬ä¸‰ç±»ï¼šé”™è¯¯äº‹ä»¶ */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLERR</span>	<span class="token expression"><span class="token number">0x008</span>	</span><span class="token comment">/* Error condition.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLHUP</span>	<span class="token expression"><span class="token number">0x010</span>	</span><span class="token comment">/* Hung up.  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POLLNVAL</span>	<span class="token expression"><span class="token number">0x020</span>	</span><span class="token comment">/* Invalid polling request.  */</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>pollfd</code>ç»“æ„ä¸­è¿˜æœ‰ä¸€ä¸ª<code>revents</code>å­—æ®µï¼Œå…¨ç§°æ˜¯<code>returned events</code>ï¼Œè¿™æ˜¯<code>poll</code>ä¸<code>select</code>çš„ç¬¬1ä¸ªä¸åŒç‚¹ã€‚</p><p>â€‹ <strong>pollä¼šå°†æ¯æ¬¡éå†ä¹‹åçš„ç»“æœä¿å­˜åˆ°reventså­—æ®µä¸­ï¼Œæ²¡æœ‰selecté‚£ç§å€¼-ç»“æœå‚æ•°ï¼Œä¹Ÿå°±ä¸éœ€è¦æ¯æ¬¡è°ƒç”¨pollçš„æ—¶å€™é‡ç½®æˆ‘ä»¬æ„Ÿå…´è¶£çš„æè¿°ç¬¦ä»¥åŠç›¸å…³äº‹ä»¶</strong>ã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œ<strong>é”™è¯¯äº‹ä»¶ä¸èƒ½åœ¨eventsä¸­è¿›è¡Œè®¾ç½®ï¼Œä½†æ˜¯å½“ç›¸åº”äº‹ä»¶å‘ç”Ÿæ—¶ä¼šé€šè¿‡reventså­—æ®µè¿”å›</strong>ã€‚è¿™æ˜¯<code>poll</code>ä¸<code>select</code>çš„ç¬¬2ä¸ªä¸åŒç‚¹ã€‚</p><p>â€‹ å†æ¥çœ‹<code>poll</code>çš„ç¬¬2ä¸ªå‚æ•°<code>nfds</code>ï¼Œè¡¨ç¤ºçš„æ˜¯æ•°ç»„<code>fds</code>çš„å…ƒç´ ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·è¿›ç¨‹æƒ³è®©<code>poll</code>åŒæ—¶ç›‘å¬çš„æè¿°ç¬¦çš„ä¸ªæ•°ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œ<strong>pollå‡½æ•°å°†è®¾ç½®æœ€å¤§ç›‘å¬æ•°é‡çš„æƒé™ç»™äº†ç¨‹åºè®¾è®¡è€…ï¼Œè‡ªç”±æ§åˆ¶pollfdç»“æ„æ•°ç»„çš„å¤§å°ï¼Œçªç ´äº†selectå‡½æ•°1024ä¸ªæœ€å¤§æè¿°ç¬¦çš„é™åˆ¶</strong>ã€‚è¿™æ˜¯<code>poll</code>ä¸<code>select</code>çš„ç¬¬3ä¸ªä¸åŒç‚¹ã€‚</p><p>â€‹ è‡³äº<code>timeout</code>å‚æ•°å°±æ›´å¥½ç†è§£äº†ï¼Œå°±æ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´ç½¢äº†ã€‚<code>poll</code>æœ¬è´¨ä¸Šå’Œ<code>select</code>æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ã€‚<code>poll</code>å‡½æ•°è¿”å›ä¹‹åï¼Œè¢«å”¤é†’çš„ç”¨æˆ·è¿›ç¨‹ä¾ç„¶æ˜¯æ‡µçš„ï¼Œå¾ªç¯å»éå†æ–‡ä»¶æè¿°ç¬¦ã€æ£€æŸ¥ç›¸å…³äº‹ä»¶ã€è¿›è¡Œç›¸åº”é€»è¾‘å¤„ç†ã€‚</p><hr><h4 id="epoll" tabindex="-1"><a class="header-anchor" href="#epoll" aria-hidden="true">#</a> epoll</h4><p>ä¸åŒäº<code>select/poll</code>å•ä¸ªå‡½æ•°èµ°å¤©ä¸‹ï¼Œ<code>epoll</code>ç”¨èµ·æ¥ç¨å¾®éº»çƒ¦äº†ä¸€ç‚¹ç‚¹ï¼Œå®ƒæä¾›äº†å‡½æ•°ä¸‰ä»¶å¥—ï¼Œ<code>epoll_create</code>ã€<code>epoll_ctl</code>ã€<code>epoll_wait</code>ã€‚</p><h5 id="åˆ›å»ºepollå®ä¾‹" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºepollå®ä¾‹" aria-hidden="true">#</a> åˆ›å»ºepollå®ä¾‹</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// sizeå‚æ•°ä»Linux2.6.8ä¹‹åå¤±å»æ„ä¹‰ï¼Œä¸ºä¿æŒå‘å‰å…¼å®¹ï¼Œéœ€è¦ä½¿sizeå‚æ•° &gt; 0</span>
<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿™ä¸ªå‡½æ•°æ˜¯æœ€æ–°æ¬¾ï¼Œå¦‚æœfalgsä¸º0ï¼Œç­‰åŒäºepoll_create()</span>
<span class="token keyword">int</span> <span class="token function">epoll_create1</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>epoll_create()</code> æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª epoll å®ä¾‹ï¼Œå¹¶è¿”å›äº†æŒ‡å‘epollå®ä¾‹çš„æè¿°ç¬¦ï¼Œè¿™ä¸ªæè¿°ç¬¦ç”¨äºä¸‹æ–‡å³å°†ä»‹ç»çš„å¦å¤–ä¸¤ä¸ªå‡½æ•°ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code>epoll_create1()</code>è¿™ä¸ªæ–°å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç›¸æ¯”å‰è€…å¯ä»¥å¤šæ·»åŠ <code>EPOLL_CLOEXEC</code>è¿™ä¸ªå¯é€‰é¡¹ã€‚è¿™ä¸ªepollå®ä¾‹å†…éƒ¨ç»´æŠ¤äº†ä¸¤ä¸ªé‡è¦ç»“æ„ï¼Œåˆ†åˆ«æ˜¯<code>éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ ‘</code>å’Œ<code>å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦</code>ï¼Œå¯¹äºå°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»–ä»¬ä¼šè¢«è¿”å›ç»™ç”¨æˆ·è¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œ<strong>epollé¿å…äº†æ¯æ¬¡select/pollä¹‹åç”¨æˆ·è¿›ç¨‹éœ€è¦æ‰«ææ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦çš„é—®é¢˜</strong>ã€‚</p><h5 id="epollæ³¨å†Œäº‹ä»¶" tabindex="-1"><a class="header-anchor" href="#epollæ³¨å†Œäº‹ä»¶" aria-hidden="true">#</a> epollæ³¨å†Œäº‹ä»¶</h5><p>â€‹ åˆ›å»ºå®Œepollå®ä¾‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>epoll_ctl</code>ï¼ˆ<code>ctl</code>å°±æ˜¯controlçš„ç¼©å†™ï¼‰å‡½æ•°ï¼Œå‘epollå®ä¾‹ä¸­æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤æˆ‘ä»¬æ„Ÿå…´è¶£çš„æŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æŸäº›äº‹ä»¶ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//  è¿”å›å€¼: è‹¥æˆåŠŸè¿”å›0ï¼›è‹¥è¿”å›-1è¡¨ç¤ºå‡ºé”™</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸€ä¸ªå‚æ•°<code>epfd</code>å°±æ˜¯åˆšæ‰è°ƒç”¨<code>epoll_create</code>åˆ›å»ºçš„epollå®ä¾‹çš„æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯epollçš„å¥æŸ„ã€‚</p><p>ç¬¬äºŒä¸ªå‚æ•°<code>op</code>è¡¨ç¤ºè¦è¿›è¡Œä»€ä¹ˆæ§åˆ¶æ“ä½œï¼Œæœ‰3ä¸ªé€‰é¡¹</p><ul><li><code>EPOLL_CTL_ADD</code>ï¼š å‘ epoll å®ä¾‹<strong>æ³¨å†Œ</strong>æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶ï¼›</li><li><code>EPOLL_CTL_DEL</code>ï¼šå‘ epoll å®ä¾‹<strong>åˆ é™¤</strong>æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶ï¼›</li><li><code>EPOLL_CTL_MOD</code>ï¼š <strong>ä¿®æ”¹</strong>æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„äº‹ä»¶ã€‚</li></ul><p>ç¬¬ä¸‰ä¸ªå‚æ•°<code>fd</code>å¾ˆç®€å•ï¼Œå°±æ˜¯è¢«æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>ç¬¬å››ä¸ªå‚æ•°å°±æ˜¯æ³¨å†Œçš„äº‹ä»¶ç±»å‹ï¼Œå…ˆçœ‹ä¸€ä¸‹<code>epoll_event</code>çš„å®šä¹‰ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>
     <span class="token class-name">uint32_t</span>     events<span class="token punctuation">;</span>      <span class="token comment">/* å‘epollè®¢é˜…çš„äº‹ä»¶ */</span>
     <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>        <span class="token comment">/* ç”¨æˆ·æ•°æ® */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{</span>
     <span class="token keyword">void</span>        <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
     <span class="token keyword">int</span>          fd<span class="token punctuation">;</span>
     <span class="token class-name">uint32_t</span>     u32<span class="token punctuation">;</span>
     <span class="token class-name">uint64_t</span>     u64<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>events</code>è¿™ä¸ªå­—æ®µå’Œ<code>poll</code>çš„<code>events</code>å‚æ•°ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡äºŒè¿›åˆ¶æ©ç è®¾ç½®äº‹ä»¶ç±»å‹ï¼Œepollçš„äº‹ä»¶ç±»å‹åœ¨<code>/usr/include/sys/epoll.h</code>ä¸­æœ‰å®šä¹‰ï¼Œæ›´è¯¦ç»†çš„å¯ä»¥ä½¿ç”¨<code>man epoll_ctl</code>çœ‹ä¸€ä¸‹æ–‡æ¡£è¯´æ˜ï¼Œå…¶ä¸­å†…å®¹å¾ˆå¤šï¼ŒçŸ¥é“æœ‰è¿™ä¹ˆå›äº‹å„¿å°±è¡Œäº†ï¼Œä½†æ˜¯æ³¨æ„ä¸€ä¸‹<code>EPOLLET</code>è¿™ä¸ªäº‹ä»¶ï¼Œç‰¹æ„åŠ äº†æ³¨é‡Šã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">enum</span> <span class="token class-name">EPOLL_EVENTS</span> <span class="token punctuation">{</span>
      EPOLLIN <span class="token operator">=</span> <span class="token number">0x001</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLIN</span> <span class="token expression">EPOLLIN</span></span>
      EPOLLPRI <span class="token operator">=</span> <span class="token number">0x002</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLPRI</span> <span class="token expression">EPOLLPRI</span></span>
      EPOLLOUT <span class="token operator">=</span> <span class="token number">0x004</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLOUT</span> <span class="token expression">EPOLLOUT</span></span>
      EPOLLRDNORM <span class="token operator">=</span> <span class="token number">0x040</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLRDNORM</span> <span class="token expression">EPOLLRDNORM</span></span>
      EPOLLRDBAND <span class="token operator">=</span> <span class="token number">0x080</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLRDBAND</span> <span class="token expression">EPOLLRDBAND</span></span>
      EPOLLWRNORM <span class="token operator">=</span> <span class="token number">0x100</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLWRNORM</span> <span class="token expression">EPOLLWRNORM</span></span>
      EPOLLWRBAND <span class="token operator">=</span> <span class="token number">0x200</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLWRBAND</span> <span class="token expression">EPOLLWRBAND</span></span>
      EPOLLMSG <span class="token operator">=</span> <span class="token number">0x400</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLMSG</span> <span class="token expression">EPOLLMSG</span></span>
      EPOLLERR <span class="token operator">=</span> <span class="token number">0x008</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLERR</span> <span class="token expression">EPOLLERR</span></span>
      EPOLLHUP <span class="token operator">=</span> <span class="token number">0x010</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLHUP</span> <span class="token expression">EPOLLHUP</span></span>
      EPOLLRDHUP <span class="token operator">=</span> <span class="token number">0x2000</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLRDHUP</span> <span class="token expression">EPOLLRDHUP</span></span>
      EPOLLWAKEUP <span class="token operator">=</span> <span class="token number">1u</span> <span class="token operator">&lt;&lt;</span> <span class="token number">29</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLWAKEUP</span> <span class="token expression">EPOLLWAKEUP</span></span>
      EPOLLONESHOT <span class="token operator">=</span> <span class="token number">1u</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">,</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLONESHOT</span> <span class="token expression">EPOLLONESHOT</span></span>
  	<span class="token comment">// è®¾ç½®ä¸º edge-triggeredï¼Œé»˜è®¤ä¸º level-triggered</span>
      EPOLLET <span class="token operator">=</span> <span class="token number">1u</span> <span class="token operator">&lt;&lt;</span> <span class="token number">31</span>
  	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPOLLET</span> <span class="token expression">EPOLLET</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>data</code>å­—æ®µæ¯”è¾ƒæœ‰æ„æ€ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>data</code>ä¸­è®¾ç½®æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚</p><h5 id="epoll-wait" tabindex="-1"><a class="header-anchor" href="#epoll-wait" aria-hidden="true">#</a> epoll_wait</h5><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// è¿”å›å€¼: æˆåŠŸè¿”å›çš„æ˜¯ä¸€ä¸ªå¤§äº0çš„æ•°ï¼Œè¡¨ç¤ºäº‹ä»¶çš„ä¸ªæ•°ï¼›0è¡¨ç¤ºè¶…æ—¶ï¼›å‡ºé”™è¿”å›-1.</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>epoll_wait</code>çš„ç”¨æ³•å’Œ<code>select/poll</code>å¾ˆç±»ä¼¼ï¼Œç”¨æˆ·è¿›ç¨‹è¢«é˜»å¡ã€‚ä¸åŒçš„æ˜¯ï¼Œ<code>epoll</code>ä¼šç›´æ¥å‘Šè¯‰ç”¨æˆ·è¿›ç¨‹å“ªäº›æè¿°ç¬¦å·²ç»å°±ç»ªäº†ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>epoll</code>å®ä¾‹çš„æè¿°ç¬¦ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿”å›ç»™ç”¨æˆ·ç©ºé—´çš„éœ€è¦å¤„ç†çš„I/Oäº‹ä»¶ï¼Œæ˜¯ä¸€ä¸ª<code>epoll_event</code>ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦å°±æ˜¯<code>epoll_wait</code>å‡½æ•°çš„è¿”å›å€¼ï¼Œå†çœ‹ä¸€çœ¼è¿™ä¸ªç»“æ„å§ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{</span>
     <span class="token class-name">uint32_t</span>     events<span class="token punctuation">;</span>      <span class="token comment">/* å‘epollè®¢é˜…çš„äº‹ä»¶ */</span>
     <span class="token class-name">epoll_data_t</span> data<span class="token punctuation">;</span>        <span class="token comment">/* ç”¨æˆ·æ•°æ® */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{</span>
     <span class="token keyword">void</span>        <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
     <span class="token keyword">int</span>          fd<span class="token punctuation">;</span>
     <span class="token class-name">uint32_t</span>     u32<span class="token punctuation">;</span>
     <span class="token class-name">uint64_t</span>     u64<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">epoll_data_t</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>events</code> è¡¨ç¤ºå…·ä½“çš„äº‹ä»¶ç±»å‹ï¼Œè‡³äºè¿™ä¸ª<code>data</code>å°±æ˜¯åœ¨<code>epoll_ctl</code>ä¸­è®¾ç½®çš„<code>data</code>ï¼Œè¿™æ ·ç”¨æˆ·è¿›ç¨‹æ”¶åˆ°è¿™ä¸ª<code>epoll_event</code>ï¼Œæ ¹æ®ä¹‹å‰è®¾ç½®çš„<code>data</code>å°±èƒ½è·å–åˆ°ç›¸å…³ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œé€»è¾‘å¤„ç†äº†ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¤§äº <code>0</code> çš„æ•´æ•°ï¼Œè¡¨ç¤º <code>epoll_wait</code> å¯ä»¥è¿”å›çš„æœ€å¤§äº‹ä»¶å€¼ã€‚ç¬¬å››ä¸ªå‚æ•°æ˜¯ <code>epoll_wait</code> é˜»å¡è°ƒç”¨çš„è¶…æ—¶å€¼ï¼Œå¦‚æœè®¾ç½®ä¸º <code>-1</code>ï¼Œè¡¨ç¤ºä¸è¶…æ—¶ï¼›å¦‚æœè®¾ç½®ä¸º <code>0</code> åˆ™ç«‹å³è¿”å›ï¼Œå³ä½¿æ²¡æœ‰ä»»ä½• I/O äº‹ä»¶å‘ç”Ÿã€‚</p><h5 id="edge-triggered-å’Œ-level-triggered" tabindex="-1"><a class="header-anchor" href="#edge-triggered-å’Œ-level-triggered" aria-hidden="true">#</a> edge-triggered å’Œ level-triggered</h5><p>â€‹ <code>epoll</code>è¿˜æä¾›äº†ä¸€ä¸ªåˆ©å™¨ â€”â€” è¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æˆ‘æ²¡è§£é‡Šçš„<code>EPOLLET</code> å‚æ•°ã€‚</p><p>â€‹ å•¥æ„æ€å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ã€‚å¦‚æœæœ‰ä¸ªsocketæœ‰100ä¸ªå­—èŠ‚çš„æ•°æ®å¯è¯»ï¼Œè¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼‰å’Œæ¡ä»¶è§¦å‘ï¼ˆlevel-triggeredï¼‰éƒ½ä¼šäº§ç”Ÿ<strong>è¯»å°±ç»ª</strong>äº‹ä»¶ã€‚ä½†æ˜¯å¦‚æœç”¨æˆ·è¿›ç¨‹åªè¯»å–äº†50ä¸ªå­—èŠ‚ï¼Œè¾¹ç¼˜è§¦å‘å°±ä¼šé™·å…¥ç­‰å¾…ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œä½†æ˜¯ä½ çˆ±è¯»ä¸è¯»ï¼Œåæ­£è€å­å·²ç»é€šçŸ¥è¿‡ä½ äº†ï¼›è€Œæ¡ä»¶è§¦å‘ä¼šå› ä¸ºä½ è¿˜æ²¡æœ‰è¯»å®Œï¼Œå…¢å…¢ä¸šä¸šåœ°ä¸åœäº§ç”Ÿ<strong>è¯»å°±ç»ª</strong>äº‹ä»¶å‚¬ä½ å»è¯»ã€‚è¾¹ç¼˜è§¦å‘åªä¼šäº§ç”Ÿä¸€æ¬¡äº‹ä»¶æé†’ï¼Œæ•ˆç‡å’Œæ€§èƒ½è¦é«˜äºæ¡ä»¶è§¦å‘ï¼Œè¿™æ˜¯epollçš„ä¸€ä¸ªå¤§æ€å™¨ã€‚</p><h5 id="file-operationsä¸poll" tabindex="-1"><a class="header-anchor" href="#file-operationsä¸poll" aria-hidden="true">#</a> file_operationsä¸poll</h5><p>Linuxä¸‹æ‰€æœ‰æ–‡ä»¶éƒ½å¯ä»¥ä½¿ç”¨<code>select/poll/epoll</code>æ¥ç›‘å¬æ–‡ä»¶å˜åŒ–å—ï¼Ÿ</p><p><strong>ç­”æ¡ˆæ˜¯ä¸è¡Œï¼</strong></p><p>åªæœ‰åº•å±‚é©±åŠ¨å®ç°äº† <code>file_operations</code> ä¸­ <code>poll</code> å‡½æ•°çš„æ–‡ä»¶ç±»å‹æ‰å¯ä»¥è¢« <code>epoll</code> ç›‘è§†ï¼</p><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œçš„<code>file_operations</code>ä¸­å®šä¹‰çš„<code>poll</code>å’Œä¸Šæ–‡è®²åˆ°çš„<code>poll()</code>æ˜¯ä¸¤ç äº‹å„¿ï¼Œåªæ˜¯æ°å¥½åå­—ä¸€æ ·ç½¢äº†ã€‚</p></blockquote><p><strong>socket ç±»å‹çš„æ–‡ä»¶é©±åŠ¨å®ç°äº† poll å‡½æ•°ï¼Œå…·ä½“å®ç°æ˜¯sock_poll()ï¼Œå› æ­¤æ‰å¯ä»¥è¢« epoll ç›‘è§†</strong>ã€‚</p><p>ä¸‹é¢æ‘˜å½•äº† <code>file_operations</code> ä¸­æˆ‘ä»¬å¸¸è§çš„å‡½æ•°å®šä¹‰ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: include/linux/fs.h</span>
<span class="token keyword">struct</span> <span class="token class-name">file_operations</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">ssize_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">,</span> <span class="token class-name">loff_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>open<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>flush<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">fl_owner_t</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>release<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ Linuxå¯¹æ–‡ä»¶çš„æ“ä½œåšäº†é«˜åº¦çš„æŠ½è±¡ï¼Œæ¯ä¸ªå¼€å‘è€…éƒ½å¯ä»¥å¼€å‘è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒLinuxå¹¶ä¸çŸ¥é“å…¶ä¸­çš„å…·ä½“æ–‡ä»¶åº”è¯¥æ€æ ·<code>open</code>ã€<code>read/write</code>æˆ–è€…<code>release</code>ï¼Œæ‰€ä»¥Linuxå®šä¹‰äº†<code>file_operations</code>è¿™ä¸ªâ€œæ¥å£â€ï¼Œè®¾å¤‡ç±»å‹éœ€è¦è‡ªå·±å®ç°<code>struct file_operations</code>ç»“æ„ä¸­å®šä¹‰çš„å‡½æ•°çš„ç»†èŠ‚ã€‚æœ‰ç‚¹ç±»ä¼¼äºJavaä¸­çš„æ¥å£å’Œå…·ä½“å®ç°ç±»çš„å…³ç³»ã€‚</p><h5 id="epollå†…æ ¸å¯¹è±¡çš„åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#epollå†…æ ¸å¯¹è±¡çš„åˆ›å»º" aria-hidden="true">#</a> epollå†…æ ¸å¯¹è±¡çš„åˆ›å»º</h5><p><code>epoll_create()</code>çš„ä¸»è¦ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ª<code>struct eventpoll</code>å†…æ ¸å¯¹è±¡ï¼Œåç»­epollçš„æ“ä½œå¤§éƒ¨åˆ†éƒ½æ˜¯å¯¹è¿™ä¸ªæ•°æ®ç»“æ„çš„æ“ä½œã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604222511882.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><code>wq</code>ï¼šç­‰å¾…é˜Ÿåˆ—ã€‚åŒå‘é“¾è¡¨ï¼Œè½¯ä¸­æ–­å°±ç»ªçš„æ—¶å€™ä¼šé€šè¿‡<code>wq</code>æ‰¾åˆ°é˜»å¡åœ¨epollå¯¹è±¡ä¸Šçš„è¿›ç¨‹ï¼›</li><li><code>rdllist</code>ï¼šå°±ç»ªçš„æè¿°ç¬¦é“¾è¡¨ã€‚åŒå‘é“¾è¡¨ï¼Œå½“æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šå°†å°±ç»ªçš„æè¿°ç¬¦æ”¾åˆ°<code>rdllist</code>ï¼Œè¿™æ ·ç”¨æˆ·è¿›ç¨‹å°±å¯ä»¥é€šè¿‡è¯¥é“¾è¡¨ç›´æ¥æ‰¾åˆ°å°±ç»ªçš„æè¿°ç¬¦ï¼›</li><li><code>rbr</code>ï¼š<strong>R</strong>ed <strong>B</strong>lack <strong>R</strong>ootã€‚æŒ‡å‘çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹ï¼Œé‡Œè¾¹çš„æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºçš„å°±æ˜¯epollç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li></ul><p>ç„¶åï¼Œå†…æ ¸å°†<code>eventpoll</code>åŠ å…¥åˆ°å½“å‰è¿›ç¨‹å·²æ‰“å¼€çš„æ–‡ä»¶åˆ—è¡¨ä¸­ã€‚(<code>eventpool</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶)</p><p><code>epoll_create1</code>çš„æºç ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">//file: /fs/eventpoll.c</span>
<span class="token function">SYSCALL_DEFINE1</span><span class="token punctuation">(</span>epoll_create1<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> error<span class="token punctuation">,</span> fd<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
  <span class="token comment">// 1. ä¸ºstruct eventpollåˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–</span>
  <span class="token comment">// 	åˆå§‹åŒ–æ“ä½œä¸»è¦åŒ…æ‹¬åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—wqã€rdllistã€rbrç­‰</span>
	error <span class="token operator">=</span> <span class="token function">ep_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
  <span class="token comment">// 2. è·å–ä¸€ä¸ªå¯ç”¨çš„æè¿°ç¬¦å·fdï¼Œæ­¤æ—¶fdè¿˜æœªä¸å…·ä½“çš„fileç»‘å®š</span>
	fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span>O_RDWR <span class="token operator">|</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
  <span class="token comment">// 3. åˆ›å»ºä¸€ä¸ªåä¸º&quot;[eventpoll]&quot;çš„åŒ¿åæ–‡ä»¶file</span>
  <span class="token comment">//	å¹¶å°†eventpollå¯¹è±¡èµ‹å€¼åˆ°åŒ¿åæ–‡ä»¶fileçš„private_dataå­—æ®µè¿›è¡Œå…³è”</span>
	file <span class="token operator">=</span> <span class="token function">anon_inode_getfile</span><span class="token punctuation">(</span><span class="token string">&quot;[eventpoll]&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>eventpoll_fops<span class="token punctuation">,</span> ep<span class="token punctuation">,</span>
	 O_RDWR <span class="token operator">|</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token comment">// 4. å°†eventpollå¯¹è±¡çš„fileæŒ‡é’ˆæŒ‡å‘åˆšåˆ›å»ºçš„åŒ¿åæ–‡ä»¶file</span>
	ep<span class="token operator">-&gt;</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
  
  <span class="token comment">// 5. å°†fdå’ŒåŒ¿åæ–‡ä»¶fileè¿›è¡Œç»‘å®š</span>
	<span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> fd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604222616245.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ è°ƒç”¨<code>epoll_create1</code>åå¾—åˆ°çš„æ–‡ä»¶æè¿°ç¬¦æœ¬è´¨ä¸Šæ˜¯åŒ¿åæ–‡ä»¶<code>[eventpoll]</code>çš„æè¿°ç¬¦ï¼Œè¯¥åŒ¿åæ–‡ä»¶ä¸­çš„<code>private_data</code>å­—æ®µæ‰æŒ‡å‘äº†çœŸæ­£çš„<code>eventpoll</code>å¯¹è±¡ã€‚Linuxä¸­çš„ä¸€åˆ‡çš†æ–‡ä»¶å¹¶éè™šè¨€ã€‚è¿™æ ·ä¸€æ¥ï¼Œ<code>eventpollæ–‡ä»¶</code>ä¹Ÿå¯ä»¥è¢«epollæœ¬èº«ç›‘æµ‹ï¼Œä¹Ÿå°±æ˜¯è¯´epollå®ä¾‹å¯ä»¥ç›‘å¬å…¶ä»–çš„epollå®ä¾‹ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚è‡³æ­¤ï¼Œ<code>epoll_create1</code>è°ƒç”¨ç»“æŸã€‚</p><h5 id="æ·»åŠ socketåˆ°epoll" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ socketåˆ°epoll" aria-hidden="true">#</a> æ·»åŠ socketåˆ°epoll</h5><p>â€‹ ç°åœ¨è€ƒè™‘ä½¿ç”¨<code>EPOLL_CTL_ADD</code>å‘epollå®ä¾‹ä¸­æ·»åŠ fdçš„æƒ…å†µã€‚è¿™æ—¶å€™å°±è¦ç”¨åˆ°ä¸Šæ–‡çš„<code>rbr</code>çº¢é»‘æ ‘äº†ï¼Œ <code>epoll_ctl</code>å¯¹fdçš„å¢åˆ æ”¹æ“æŸ¥ä½œå®é™…ä¸Šå°±æ˜¯å¯¹è¿™æ£µçº¢é»‘æ ‘è¿›è¡Œæ“ä½œï¼Œæ ‘çš„èŠ‚ç‚¹ç»“æ„<code>epitem</code>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token punctuation">{</span>
	<span class="token comment">/* çº¢é»‘æ ‘çš„èŠ‚ç‚¹ */</span>
	<span class="token keyword">struct</span> <span class="token class-name">rb_node</span> rbn<span class="token punctuation">;</span>

	<span class="token comment">/* ç”¨äºå°†å½“å‰epitemè¿æ¥åˆ°eventpollä¸­rdllistä¸­çš„å·¥å…· */</span>
	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> rdllink<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* è¯¥ç»“æ„ä¿å­˜äº†æˆ‘ä»¬æƒ³è®©epollç›‘å¬çš„fdä»¥åŠè¯¥fdå¯¹åº”çš„file */</span>
	<span class="token keyword">struct</span> <span class="token class-name">epoll_filefd</span> ffd<span class="token punctuation">;</span>


	<span class="token comment">/* å½“å‰epitemå±äºå“ªä¸ªeventpoll */</span>
	<span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604222929136.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ¥ç€æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>epoll_ctl</code>çš„æºç :</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token function">SYSCALL_DEFINE4</span><span class="token punctuation">(</span>epoll_ctl<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span>
	<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token operator">*</span>tfile<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* æ ¹æ®epfdæ‰¾åˆ°eventpollå¯¹åº”çš„åŒ¿åæ–‡ä»¶ */</span>
	file <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>epfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* fdæ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„socketæè¿°ç¬¦ï¼Œæ ¹æ®å®ƒæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ */</span>
	tfile <span class="token operator">=</span> <span class="token function">fget</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token comment">/* æ ¹æ®fileçš„private_dataå­—æ®µæ‰¾åˆ°eventpollå®ä¾‹ */</span>
	ep <span class="token operator">=</span> file<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* åœ¨çº¢é»‘æ ‘ä¸­æŸ¥æ‰¾ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯å·²ç»å­˜åœ¨äº†
	å¦‚æœå­˜åœ¨äº†ï¼Œé‚£å°±æŠ¥é”™ï¼›å¦åˆ™ï¼Œæ‰§è¡Œep_insert */</span>
  epi <span class="token operator">=</span> <span class="token function">ep_find</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
	<span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> EPOLL_CTL_ADD<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>epi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	epds<span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLERR <span class="token operator">|</span> POLLHUP<span class="token punctuation">;</span>
	error <span class="token operator">=</span> <span class="token function">ep_insert</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epds<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
	error <span class="token operator">=</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">;</span>
	<span class="token function">clear_tfile_check_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
  
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>epoll_ctl</code>ä¸­ï¼Œé¦–å…ˆæ ¹æ®ä¼ å…¥çš„<code>epfd</code>ä»¥åŠ<code>fd</code>æ‰¾åˆ°ç›¸å…³çš„å†…æ ¸å¯¹è±¡ï¼Œç„¶ååœ¨çº¢é»‘æ ‘ä¸­åˆ¤æ–­è¿™ä¸ª<code>epitem</code>æ˜¯ä¸æ˜¯å·²ç»å­˜åœ¨ï¼Œå­˜åœ¨çš„è¯å°±æŠ¥é”™ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œ<code>ep_insert</code>å‡½æ•°ã€‚<code>ep_insert</code>æ•…åæ€ä¹‰å°±æ˜¯å°†<code>epitem</code>ç»“æ„æ’å…¥åˆ°çº¢é»‘æ ‘å½“ä¸­ï¼Œä½†æ˜¯å¹¶éå•çº¯æ’å…¥é‚£ä¹ˆç®€å•ï¼Œå…¶ä¸­æ¶‰åŠåˆ°ä¸€äº›ç»†èŠ‚ã€‚</p><h6 id="ep-insert" tabindex="-1"><a class="header-anchor" href="#ep-insert" aria-hidden="true">#</a> ep_insert</h6><p>å¾ˆå¤šå…³é”®æ“ä½œéƒ½æ˜¯åœ¨<code>ep_insert</code>å‡½æ•°ä¸­å®Œæˆçš„ï¼Œçœ‹ä¸€ä¸‹æºç ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_insert</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">,</span>
	     <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>tfile<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">int</span> error<span class="token punctuation">,</span> revents<span class="token punctuation">,</span> pwake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	<span class="token keyword">long</span> user_watches<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">ep_pqueue</span> epq<span class="token punctuation">;</span>

	<span class="token comment">// 1. åˆ†é…epitemå†…å­˜ç©ºé—´</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>epi <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>epi_cache<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
	<span class="token comment">// 2. å°†epitemè¿›è¡Œåˆå§‹åŒ–</span>
	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>rdllink<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>fllink<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>pwqlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
	epi<span class="token operator">-&gt;</span>ep <span class="token operator">=</span> ep<span class="token punctuation">;</span>
	<span class="token function">ep_set_ffd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>ffd<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
	epi<span class="token operator">-&gt;</span>event <span class="token operator">=</span> <span class="token operator">*</span>event<span class="token punctuation">;</span>
	epi<span class="token operator">-&gt;</span>nwait <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	epi<span class="token operator">-&gt;</span>next <span class="token operator">=</span> EP_UNACTIVE_PTR<span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* 3. åˆå§‹åŒ– poll tableï¼Œè®¾ç½®å›è°ƒå‡½æ•°ä¸ºep_ptable_queue_proc */</span>
	epq<span class="token punctuation">.</span>epi <span class="token operator">=</span> epi<span class="token punctuation">;</span>
	<span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">,</span> ep_ptable_queue_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * 4. è°ƒç”¨ep_ptable_queue_procå‡½æ•°ï¼Œ
	 * 	è®¾ç½®socketç­‰å¾…é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°ä¸ºep_poll_callback
	 */</span>
	revents <span class="token operator">=</span> <span class="token function">ep_item_poll</span><span class="token punctuation">(</span>epi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	
	<span class="token comment">/* 5. epitemæ’å…¥eventpollçš„çº¢é»‘æ ‘ */</span>
	<span class="token function">ep_rbtree_insert</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>åˆ†é…ä¸åˆå§‹åŒ–epitem</li></ul><p>è™½ç„¶æºç è¡Œæ•°ä¸å°‘ï¼Œä½†æ˜¯è¿™ä¸€æ­¥éå¸¸ç®€å•ï¼Œå°±æ˜¯å°†<code>epitem</code>ä¸­çš„æ•°æ®å‡†å¤‡å¥½ï¼Œåˆ°æ’å…¥çš„æ—¶å€™ç›´æ¥æ‹¿æ¥ç”¨å°±è¡Œäº†ã€‚ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜è¿™ä¸€æ­¥çš„é‡ç‚¹é—®é¢˜ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604223150567.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ <code>epitem</code>å·²ç»å‡†å¤‡å¥½äº†ï¼Œä¹Ÿå°±æ˜¯ç›‘å¬çš„socketå¯¹è±¡å·²ç»æœ‰äº†ï¼Œå°±å·®æ’å…¥åˆ°çº¢é»‘æ ‘äº†ï¼Œä½†æ˜¯åœ¨æ’å…¥ä¹‹å‰éœ€è¦è§£å†³ä¸ªé—®é¢˜ï¼Œå½“ç›‘å¬çš„å¯¹è±¡å°±ç»ªäº†ä¹‹åå†…æ ¸è¯¥æ€ä¹ˆåŠï¼Ÿ</p><p>â€‹ é‚£å°±æ˜¯è®¾ç½®å›è°ƒå‡½æ•°ï¼</p><p>â€‹ è¿™ä¸ªå›è°ƒå‡½æ•°æ˜¯é€šè¿‡å‡½æ•° <code>ep_ptable_queue_proc</code> æ¥è¿›è¡Œè®¾ç½®çš„ã€‚å›è°ƒå‡½æ•°æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿå°±æ˜¯å½“å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œæ¯”å¦‚socketç¼“å†²åŒºæœ‰æ•°æ®äº†ï¼Œå†…æ ¸å°±ä¼šå›è°ƒè¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å°±æ˜¯ <code>ep_poll_callback</code>ã€‚</p><ul><li>è®¾ç½®å›è°ƒå‡½æ•°</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /include/linux/poll.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span>poll_table <span class="token operator">*</span>pt<span class="token punctuation">,</span> poll_queue_proc qproc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	pt<span class="token operator">-&gt;</span>_qproc <span class="token operator">=</span> qproc<span class="token punctuation">;</span>
	pt<span class="token operator">-&gt;</span>_key   <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0UL</span><span class="token punctuation">;</span> <span class="token comment">/* all events enabled */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>init_poll_funcptr</code>å‡½æ•°å°†<code>poll_table</code>ç»“æ„çš„<code>_qproc</code>å‡½æ•°æŒ‡é’ˆè®¾ç½®ä¸º<code>qproc</code>å‚æ•°ï¼Œä¹Ÿå°±æ˜¯åœ¨<code>ep_insert</code>ä¸­çœ‹åˆ°çš„<code>ep_ptable_queue_proc</code>å‡½æ•°ã€‚æ¥ä¸‹æ¥è½®åˆ°<code>ep_item_poll</code>äº†ï¼Œæ‰’å¼€å®ƒçœ‹çœ‹ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">ep_item_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  pt<span class="token operator">-&gt;</span>_key <span class="token operator">=</span> epi<span class="token operator">-&gt;</span>event<span class="token punctuation">.</span>events<span class="token punctuation">;</span>
	
  <span class="token comment">// è¿™è¡Œæ˜¯é‡ç‚¹</span>
	<span class="token keyword">return</span> epi<span class="token operator">-&gt;</span>ffd<span class="token punctuation">.</span>file<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span>epi<span class="token operator">-&gt;</span>ffd<span class="token punctuation">.</span>file<span class="token punctuation">,</span> pt<span class="token punctuation">)</span> <span class="token operator">&amp;</span> epi<span class="token operator">-&gt;</span>event<span class="token punctuation">.</span>events<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ é‡ç‚¹æ¥äº†ï¼Œé€šè¿‡ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“äº†ï¼Œ<code>ffd.file</code>æŒ‡çš„æ˜¯socketä»£è¡¨çš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†socketæ–‡ä»¶è‡ªå·±å®ç°çš„<code>poll</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°è¿‡çš„<code>sock_poll()</code>ã€‚ç„¶åç»è¿‡ä¸‹é¢å±‚å±‚å‡½æ•°è°ƒç”¨ï¼Œæœ€ç»ˆæ¥åˆ°äº†<code>poll_wait</code>å‡½æ•°ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-30-064134.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /include/linux/poll.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">poll_wait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span> wait_address<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&amp;&amp;</span> p<span class="token operator">-&gt;</span>_qproc <span class="token operator">&amp;&amp;</span> wait_address<span class="token punctuation">)</span>
	p<span class="token operator">-&gt;</span><span class="token function">_qproc</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> wait_address<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>poll_wait</code>åˆè°ƒç”¨äº†<code>poll_table</code>çš„<code>_qproc</code>å‡½æ•°ï¼Œæˆ‘ä»¬åˆšåˆšåœ¨<code>init_poll_funcptr</code>ä¸­å°†å…¶è®¾ç½®ä¸ºäº†<code>ep_ptable_queue_proc</code>ï¼Œäºæ˜¯ï¼Œä»£ç æ¥åˆ°äº†<code>ep_ptable_queue_proc</code>ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ep_ptable_queue_proc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token class-name">wait_queue_head_t</span> <span class="token operator">*</span>whead<span class="token punctuation">,</span>
	 poll_table <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
	<span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token operator">-&gt;</span>nwait <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pwq <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>pwq_cache<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
    <span class="token comment">// è®¾ç½®æœ€ç»ˆçš„å›è°ƒæ–¹æ³•ep_poll_callback</span>
    <span class="token function">init_waitqueue_func_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>wait<span class="token punctuation">,</span> ep_poll_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token comment">// å°†åŒ…å«ep_poll_callbackåœ¨å†…çš„ä¿¡æ¯æ”¾å…¥socketçš„ç­‰å¾…é˜Ÿåˆ—</span>
	<span class="token function">add_wait_queue</span><span class="token punctuation">(</span>whead<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>ep_ptable_queue_proc</code>è¢«æˆ‘ç®€åŒ–åœ°åªå‰©2ä¸ªå‡½æ•°è°ƒç”¨äº†ï¼Œsocketè‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—<code>sk_wq</code>ï¼Œå¹¶ä¸”è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ¯ä¸€é¡¹ä¿å­˜äº†é˜»å¡åœ¨å½“å‰socketä¸Šçš„è¿›ç¨‹æè¿°ç¬¦ï¼ˆæ˜ç¡®çŸ¥é“è¯¥å”¤é†’è°ï¼‰ä»¥åŠå›è°ƒå‡½æ•°ï¼ˆå†…æ ¸æ˜ç¡®çŸ¥é“æ•°æ®æ¥äº†è¯¥æ€ä¹ˆåšï¼‰ã€‚è¿™ä¸€ç³»åˆ—çš„æ“ä½œå°±æ˜¯è®¾ç½®å›è°ƒå‡½æ•°ä¸º<code>ep_poll_callback</code>ï¼Œå¹¶å°è£…é˜Ÿåˆ—é¡¹æ•°æ®ç»“æ„ï¼Œç„¶åæŠŠè¿™ä¸ªç»“æ„æ”¾åˆ°socketçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</p><p>â€‹ è¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œ<strong>ä¸ä¿å­˜å½“å‰ç”¨æˆ·è¿›ç¨‹ä¿¡æ¯</strong>ï¼Œè¿™ä¹Ÿæ˜¯epollæ›´åŠ é«˜æ•ˆçš„ä¸€ä¸ªåŸå› ï¼Œç°åœ¨socketå·²ç»å®Œå…¨æ‰˜ç®¡ç»™epolläº†ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½åœ¨ä¸€ä¸ªsocketå‡†å¤‡å°±ç»ªçš„æ—¶å€™å°±ç«‹åˆ»å»å”¤é†’è¿›ç¨‹ï¼Œå”¤é†’çš„æ—¶æœºå¾—äº¤ç»™epollï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ<code>eventpoll</code>å¯¹è±¡è¿˜æœ‰ä¸€ä¸ªé˜Ÿåˆ—çš„åŸå› ï¼Œé‡Œè¾¹å­˜æ”¾çš„å°±æ˜¯é˜»å¡åœ¨epollä¸Šçš„è¿›ç¨‹ã€‚</p><ul><li>æ’å…¥çº¢é»‘æ ‘</li></ul><p>â€‹ æœ€åä¸€æ­¥å°±æ˜¯é€šè¿‡<code>ep_rbtree_insert(ep, epi)</code>æŠŠ<code>epitem</code>æ’å…¥åˆ°çº¢é»‘æ ‘ä¸­ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604223735495.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ è‡³æ­¤ï¼Œ<code>epoll_ctl</code>çš„æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å…¨éƒ¨ç»“æŸã€‚ä¸ºä»€ä¹ˆå†…æ ¸å¼€å‘è€…é€‰æ‹©äº†çº¢é»‘æ ‘è¿™ä¸ªç»“æ„ï¼Œè‡ªç„¶å°±æ˜¯ä¸ºäº†é«˜æ•ˆåœ°ç®¡ç†<code>epitem</code>ï¼Œä½¿å¾—åœ¨æ’å…¥ã€æŸ¥æ‰¾ã€åˆ é™¤ç­‰å„ä¸ªæ–¹é¢ä¸ä¼šå› ä¸º<code>epitem</code>æ•°é‡çš„å¢åŠ è€Œäº§ç”Ÿæ€§èƒ½çš„å‰§çƒˆæ³¢åŠ¨ã€‚æ€»ç»“å¦‚ä¸‹ï¼š</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604223907916.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="epoll-wait-1" tabindex="-1"><a class="header-anchor" href="#epoll-wait-1" aria-hidden="true">#</a> epoll_wait</h5><p>â€‹ epollæœ¬èº«æ˜¯é˜»å¡çš„ï¼Œé˜»å¡ä¹Ÿæ­£æ˜¯åœ¨è¿™ä¸€æ­¥ä¸­ä½“ç°çš„ã€‚å¤§éƒ¨åˆ†äººå¬åˆ°é˜»å¡è¿™ä¸ªè¯å°±è§‰å¾—å¾ˆä½æ•ˆï¼Œè¿™ç§æƒ³æ³•å¹¶ä¸å¯¹ã€‚</p><p>â€‹ <code>epoll_wait</code>åšçš„äº‹æƒ…å°±æ˜¯æ£€æŸ¥<code>eventpoll</code>å¯¹è±¡ä¸­çš„å°±ç»ªfdåˆ—è¡¨<code>rdllist</code>ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œå°±è¯´æ˜æœ‰socketå·²ç»å‡†å¤‡å¥½äº†ï¼Œé‚£å°±ç›´æ¥è¿”å›ï¼Œç”¨æˆ·è¿›ç¨‹å¯¹è¯¥åˆ—è¡¨ä¸­çš„fdè¿›è¡Œå¤„ç†ã€‚å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œé‚£å°±å°†å½“å‰è¿›ç¨‹åŠ å…¥åˆ°<code>eventpoll</code>çš„è¿›ç¨‹ç­‰å¾…é˜Ÿåˆ—<code>wq</code>ä¸­ï¼Œè®©å‡ºCPUï¼Œä¸»åŠ¨è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æœ‰æ´»å„¿ï¼ˆfdå°±ç»ªï¼‰ï¼Œepollä¼šç©å„¿å‘½ä¸€ç›´å¹²ï¼Œç»å¯¹ä¸é˜»å¡ã€‚ä½†æ˜¯ä¸€æ—¦æ²¡æ´»å„¿äº†ï¼Œé˜»å¡å°±æ˜¯ä¸€ç§æ­£ç¡®çš„é€‰æ‹©ï¼Œè¦ä¸ç„¶ä¸€ç›´å ç”¨CPUä¹Ÿæ˜¯ä¸€ç§æå¤§çš„æµªè´¹ã€‚å› æ­¤ï¼Œepollé¿å…äº†å¾ˆå¤šä¸å¿…è¦çš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><p>â€‹ å¥½äº†ï¼Œç°åœ¨æ¥çœ‹<code>epoll_wait</code>çš„å®ç°å§ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token function">SYSCALL_DEFINE4</span><span class="token punctuation">(</span>epoll_wait<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> events<span class="token punctuation">,</span>
	<span class="token keyword">int</span><span class="token punctuation">,</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	error <span class="token operator">=</span> <span class="token function">ep_poll</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> events<span class="token punctuation">,</span> maxevents<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span>events<span class="token punctuation">,</span>
	   <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

fetch_events<span class="token operator">:</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	
  <span class="token comment">// å¦‚æœå°±ç»ªé˜Ÿåˆ—ä¸Šæ²¡æœ‰æ—¶é—´å‘ç”Ÿï¼Œè¿›å…¥ä¸‹é¢çš„é€»è¾‘</span>
  <span class="token comment">// å¦åˆ™ï¼Œå°±è¿”å›</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ep_events_available</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">/*
	 * We don&#39;t have any available event to return to the caller.
	 * We need to sleep here, and we will be wake up by
	 * ep_poll_callback() when events will become available.
	 */</span>
    <span class="token comment">// å®šä¹‰ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œå¹¶å°†å½“å‰çº¿ç¨‹å’Œå…¶è¿›è¡Œç»‘å®šï¼Œå¹¶è®¾ç½®å›è°ƒå‡½æ•°</span>
	<span class="token function">init_waitqueue_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wait<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å°†ç­‰å¾…é˜Ÿåˆ—é¡¹åŠ å…¥åˆ°wqç­‰å¾…é˜Ÿåˆ—ä¸­</span>
	<span class="token function">__add_wait_queue_exclusive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">/*
	 * We don&#39;t want to sleep if the ep_poll_callback() sends us
	 * a wakeup in between. That&#39;s why we set the task state
	 * to TASK_INTERRUPTIBLE before doing the checks.
	 */</span>
      <span class="token comment">// è®©å‡ºCPUï¼Œè¿›å…¥ç¡çœ çŠ¶æ€</span>
	<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">schedule_hrtimeout_range</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> slack<span class="token punctuation">,</span> HRTIMER_MODE_ABS<span class="token punctuation">)</span><span class="token punctuation">)</span>
	timed_out <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ep_poll</code>åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ol><li>åˆ¤æ–­<code>eventpoll</code>çš„<code>rdllist</code>é˜Ÿåˆ—ä¸Šæœ‰æ²¡æœ‰å°±ç»ªfdï¼Œå¦‚æœæœ‰ï¼Œé‚£å°±ç›´æ¥è¿”å›ï¼›å¦åˆ™æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ï¼›</li><li>å®šä¹‰<code>eventpoll</code>çš„<code>wq</code>ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œå°†å½“å‰è¿›ç¨‹ç»‘å®šè‡³é˜Ÿåˆ—é¡¹ï¼Œå¹¶ä¸”è®¾ç½®å›è°ƒå‡½æ•°ï¼›</li><li>å°†ç­‰å¾…é˜Ÿåˆ—é¡¹åŠ å…¥åˆ°<code>wq</code>é˜Ÿåˆ—ï¼›</li><li>å½“å‰è¿›ç¨‹è®©å‡ºCPUï¼Œè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè¿›ç¨‹é˜»å¡ã€‚</li></ol><p>æ¯ä¸€æ­¥éƒ½æ¯”è¾ƒå¥½ç†è§£ï¼Œæˆ‘ä»¬é‡ç‚¹æ¥çœ‹ä¸€ä¸‹ç¬¬2æ­¥ï¼Œä¹Ÿå°±æ˜¯<code>init_waitqueue_entry</code>å‡½æ•°ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /include/linux/wait.h</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">init_waitqueue_entry</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_t</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	q<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	q<span class="token operator">-&gt;</span>private <span class="token operator">=</span> p<span class="token punctuation">;</span>
	q<span class="token operator">-&gt;</span>func <span class="token operator">=</span> default_wake_function<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>wait_queue_t</code>å°±æ˜¯<code>wq</code>ç­‰å¾…é˜Ÿåˆ—é¡¹çš„ç»“æ„ä½“ç±»å‹ï¼Œå°†å…¶ä¸­çš„<code>private</code>å­—æ®µè®¾ç½®æˆäº†å½“å‰è¿›ç¨‹çš„<code>task_struct</code>ç»“æ„ä½“æŒ‡é’ˆã€‚ç„¶åå°†<code>default_wake_function</code>ä½œä¸ºå›è°ƒå‡½æ•°ï¼Œèµ‹å€¼ç»™äº†<code>func</code>å­—æ®µã€‚è‡³æ­¤ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604224235462.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="epolloå¤„ç†æ•°æ®æµç¨‹" tabindex="-1"><a class="header-anchor" href="#epolloå¤„ç†æ•°æ®æµç¨‹" aria-hidden="true">#</a> epolloå¤„ç†æ•°æ®æµç¨‹</h5><p>â€‹ æ”¶åˆ°æ•°æ®ä¹‹åï¼Œé¦–å…ˆå¹²è‹¦åŠ›æ´»çš„æ˜¯ç½‘å¡ï¼Œç½‘å¡ä¼šå°†æ•°æ®æ”¾åˆ°æŸå—å…³è”çš„å†…å­˜å½“ä¸­ï¼Œè¿™ä¸ªæ“ä½œä¸éœ€è¦CPUçš„å‚ä¸ã€‚ç­‰åˆ°æ•°æ®ä¿å­˜å®Œäº†ä¹‹åï¼Œç½‘å¡ä¼šå‘CPUå‘èµ·ä¸€ä¸ª<strong>ç¡¬ä¸­æ–­</strong>ï¼Œé€šçŸ¥CPUæ•°æ®æ¥äº†ã€‚è¿™ä¸ªæ—¶å€™CPUå°±è¦å¼€å§‹å¯¹ä¸­æ–­è¿›è¡Œå¤„ç†äº†ï¼Œä½†æ˜¯CPUå¤ªå¿™äº†ï¼Œå®ƒå¿…é¡»æ—¶æ—¶åˆ»åˆ»å‡†å¤‡å¥½æ¥æ”¶å„ç§è®¾å¤‡çš„ä¸­æ–­ï¼Œæ¯”å¦‚é¼ æ ‡ã€é”®ç›˜ç­‰ï¼Œè€Œä¸”è¿˜ä¸èƒ½å¡åœ¨ä¸€ä¸ªä¸­æ–­ä¸Šå¤ªé•¿æ—¶é—´ï¼Œè¦ä¸ç„¶å¯ä»¥æƒ³åƒæˆ‘ä»¬çš„è®¡ç®—æœºå¾—â€œå¡â€æˆä»€ä¹ˆæ ·å­ã€‚</p><p>â€‹ æ‰€ä»¥å®é™…è®¾è®¡ä¸­ç¡¬ä¸­æ–­åªè´Ÿè´£åšä¸€äº›ç®€å•çš„äº‹æƒ…ï¼Œç„¶åæ¥ç€è§¦å‘<strong>è½¯ä¸­æ–­</strong>ï¼Œæ¯”è¾ƒè€—æ—¶ä¸”å¤æ‚çš„å·¥ä½œå°±äº¤ç»™è½¯ä¸­æ–­å¤„ç†ç¨‹åºå»åšäº†ã€‚</p><p>â€‹ è½¯ä¸­æ–­ä»¥å†…æ ¸çº¿ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œæ¯ä¸ªCPUéƒ½ä¼šå¯¹åº”ä¸€ä¸ªè½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹ï¼Œåå­—å«åš<code>ksoftirqd/CPUç¼–å·</code>ï¼Œæ¯”å¦‚ <code>0</code> å· CPU å¯¹åº”çš„è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„åå­—æ˜¯ <code>ksoftirqd/0</code>ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥å«åšksoftirqdå¥½äº†ã€‚ä»è¿™ä¸ªè§’åº¦ä¸Šæ¥è¯´ï¼Œæ“ä½œç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œåœ¨å¾ªç¯ä¸­ä¸æ–­æ¥æ”¶å„ç§ä¸­æ–­ï¼Œå¤„ç†ä¸åŒé€»è¾‘ã€‚å†…æ ¸çº¿ç¨‹ç»è¿‡å„ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°å°±ç»ªçš„socketç­‰å¾…é˜Ÿåˆ—é¡¹ä¸­çš„å›è°ƒå‡½æ•°<code>ep_poll_callback</code>ï¼Œæ˜¯æ—¶å€™çœ‹çœ‹è¿™ä¸ªå‡½æ•°äº†ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// file: /fs/eventpoll.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_poll_callback</span><span class="token punctuation">(</span><span class="token class-name">wait_queue_t</span> <span class="token operator">*</span>wait<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> mode<span class="token punctuation">,</span> <span class="token keyword">int</span> sync<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token comment">// è·å–ç­‰å¾…é˜Ÿåˆ—é¡¹å¯¹åº”çš„epitem</span>
	<span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi <span class="token operator">=</span> <span class="token function">ep_item_from_wait</span><span class="token punctuation">(</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// è·å–epitemå¯¹åº”çš„eventpollå®ä¾‹</span>
	<span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep <span class="token operator">=</span> epi<span class="token operator">-&gt;</span>ep<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token comment">/* å¦‚æœå½“å‰epitemæŒ‡å‘çš„socketå·²ç»åœ¨å°±ç»ªé˜Ÿåˆ—é‡Œäº†ï¼Œé‚£å°±ç›´æ¥é€€å‡º
	å¦åˆ™ï¼Œå°†epitemæ·»åŠ åˆ°eventpollçš„å°±ç»ªé˜Ÿåˆ—rdllistä¸­
	If this file is already in the ready list we exit soon 
	*/</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ep_is_linked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>rdllink<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>rdllink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>rdllist<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// æŸ¥çœ‹eventpollç­‰å¾…é˜Ÿåˆ—ä¸Šæ˜¯å¦æœ‰ç­‰å¾…çš„è¿›ç¨‹</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">waitqueue_active</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>wq<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">wake_up_locked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>ep_poll_callback</code>çš„é€»è¾‘éå¸¸ç®€æ´æ¸…æ™°ã€‚å…ˆæ‰¾åˆ°å°±ç»ªsocketå¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—é¡¹ä¸­çš„<code>epitem</code>ï¼Œç»§è€Œæ‰¾åˆ°å¯¹åº”çš„<code>eventpoll</code>å®ä¾‹ï¼Œå†æ¥å£ç€åˆ¤æ–­å½“å‰çš„<code>epitem</code>æ˜¯ä¸æ˜¯å·²ç»åœ¨<code>rdllist</code>å°±ç»ªé˜Ÿåˆ—é‡Œäº†ï¼Œå¦‚æœåœ¨ï¼Œé‚£å°±æ²¡å•¥å¥½åšçš„äº†ï¼Œå‡½æ•°é€€å‡ºå°±è¡Œäº†ï¼›å¦‚æœä¸åœ¨ï¼Œé‚£å°±æŠŠ<code>epitem</code>åŠ å…¥åˆ°<code>rdllist</code>ä¸­ã€‚æœ€åçœ‹çœ‹<code>eventpoll</code>çš„ç­‰å¾…é˜Ÿåˆ—ä¸Šæ˜¯ä¸æ˜¯æœ‰é˜»å¡çš„è¿›ç¨‹ï¼Œæœ‰çš„è¯å°±è°ƒç”¨è®¾ç½®çš„<code>default_wake_function</code>å›è°ƒå‡½æ•°æ¥å”¤é†’è¿™ä¸ªè¿›ç¨‹ã€‚</p><p>â€‹ epollä¸­é‡ç‚¹ä»‹ç»çš„ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œ<code>ep_poll_callback</code>å’Œ<code>default_wake_function</code>å°±ä¸²èµ·æ¥äº†ã€‚å‰è€…è°ƒç”¨äº†åè€…ï¼Œåè€…å”¤é†’äº†è¿›ç¨‹ã€‚<code>epoll_wait</code>çš„æœ€ç»ˆä½¿å‘½å°±æ˜¯å°†<code>rdllist</code>ä¸­çš„å°±ç»ªfdè¿”å›ç»™ç”¨æˆ·è¿›ç¨‹ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604224520524.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h5 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h5><p>æ¢³ç†ä¸€ä¸‹epollçš„æ•´ä¸ªè¿‡ç¨‹ã€‚</p><ol><li><code>epoll_create</code>åˆ›å»ºäº†<code>eventpoll</code>å®ä¾‹ï¼Œå¹¶å¯¹å…¶ä¸­çš„å°±ç»ªé˜Ÿåˆ—<code>rdllist</code>ã€ç­‰å¾…é˜Ÿåˆ—<code>wq</code>ä»¥åŠçº¢é»‘æ ‘<code>rbr</code>è¿›è¡Œäº†åˆå§‹åŒ–ï¼›</li><li><code>epoll_ctl</code>å°†æˆ‘ä»¬æ„Ÿå…´è¶£çš„socketå°è£…æˆ<code>epitem</code>å¯¹è±¡åŠ å…¥çº¢é»‘æ ‘ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å°è£…äº†socketçš„<code>sk_wq</code>ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œé‡Œè¾¹ä¿å­˜äº†socketå°±ç»ªä¹‹åçš„å‡½æ•°å›è°ƒï¼Œä¹Ÿå°±æ˜¯<code>ep_poll_callback</code>ï¼›</li><li><code>epoll_wait</code>æ£€æŸ¥<code>eventpoll</code>çš„å°±ç»ªé˜Ÿåˆ—æ˜¯ä¸æ˜¯æœ‰å°±ç»ªçš„socketï¼Œæœ‰çš„è¯ç›´æ¥è¿”å›ï¼›å¦åˆ™å°±å°è£…ä¸€ä¸ª<code>eventpoll</code>çš„ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œé‡Œè¾¹ä¿å­˜äº†å½“å‰çš„ç”¨æˆ·è¿›ç¨‹ä¿¡æ¯ä»¥åŠå¦ä¸€ä¸ªå›è°ƒå‡½æ•°<code>default_wake_function</code>ï¼Œç„¶åæŠŠå½“å‰è¿›ç¨‹æŠ•å…¥ç¡çœ ï¼›</li><li>ç›´åˆ°æ•°æ®åˆ°è¾¾ï¼Œå†…æ ¸çº¿ç¨‹æ‰¾åˆ°å°±ç»ªçš„socketï¼Œå…ˆè°ƒç”¨<code>ep_poll_callback</code>ï¼Œç„¶å<code>ep_poll_callback</code>åˆè°ƒç”¨<code>default_wake_function</code>ï¼Œæœ€ç»ˆå”¤é†’<code>eventpoll</code>ç­‰å¾…é˜Ÿåˆ—ä¸­ä¿å­˜çš„è¿›ç¨‹ï¼Œå¤„ç†<code>rdllist</code>ä¸­çš„å°±ç»ªfdï¼›</li><li>epollç»“æŸï¼</li></ol><h5 id="eventpollå¤„ç†" tabindex="-1"><a class="header-anchor" href="#eventpollå¤„ç†" aria-hidden="true">#</a> eventpollå¤„ç†</h5><p>â€‹ <code>eventpollæ–‡ä»¶</code>ä¹Ÿå¯ä»¥è¢«epollæœ¬èº«ç›‘æµ‹ï¼Œä¹Ÿå°±æ˜¯è¯´epollå®ä¾‹å¯ä»¥ç›‘å¬å…¶ä»–çš„epollå®ä¾‹ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚æ€ä¹ˆä¸ªé‡è¦æ³•ï¼Œè¿™å°±æ¶‰åŠåˆ°<code>eventpoll</code>å®ä¾‹ä¸­çš„å¦ä¸€ä¸ªé˜Ÿåˆ—äº†ï¼Œå«åš<code>poll_wait</code>ã€‚</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token punctuation">{</span>
	
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token class-name">wait_queue_head_t</span> wq<span class="token punctuation">;</span>

	<span class="token comment">/* å°±æ˜¯å®ƒï¼ï¼ï¼ï¼ï¼ï¼ï¼ */</span>
	<span class="token class-name">wait_queue_head_t</span> poll_wait<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">list_head</span> rdllist<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">rb_root</span> rbr<span class="token punctuation">;</span>

	<span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-01-31-031620.png" alt="é€’å½’ç›‘å¬çš„æƒ…å†µ" tabindex="0" loading="lazy"><figcaption>é€’å½’ç›‘å¬çš„æƒ…å†µ</figcaption></figure><p>å¦‚ä¸Šå›¾æ‰€ç¤º</p><ul><li><code>epollfd1</code>ç›‘å¬äº†2ä¸ªæ™®é€šæè¿°ç¬¦<code>fd1</code>å’Œ<code>fd2</code></li><li><code>epollfd2</code>ç›‘å¬äº†<code>epollfd1</code>å’Œ2ä¸ªæ™®é€šæè¿°ç¬¦<code>fd3</code>ã€<code>fd4</code></li></ul><p>â€‹ å¦‚æœ<code>fd1</code>æˆ–<code>fd2</code>æœ‰<strong>å¯è¯»äº‹ä»¶</strong>è§¦å‘ï¼Œé‚£ä¹ˆå°±ç»ªçš„fdçš„å›è°ƒå‡½æ•°<code>ep_poll_callback</code>å¯¹å°†è¯¥fdæ”¾åˆ°<code>epollfd1</code>çš„<code>rdllist</code>å°±ç»ªé˜Ÿåˆ—ä¸­ã€‚ç”±äº<code>epollfd1</code>æœ¬èº«ä¹Ÿæ˜¯ä¸ªæ–‡ä»¶ï¼Œå®ƒçš„å¯è¯»äº‹ä»¶æ­¤æ—¶ä¹Ÿè¢«è§¦å‘ï¼Œä½†æ˜¯<code>ep_poll_callback</code>æ€ä¹ˆçŸ¥é“è¯¥æŠŠ<code>epollfd1</code>æ”¾åˆ°è°çš„<code>rdllist</code>ä¸­å‘¢ï¼Ÿ</p><p><code>poll_wait</code>æ¥å–½ï½ï½</p><p>â€‹ å½“epollç›‘å¬epollç±»å‹çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šæŠŠç›‘å¬è€…æ”¾å…¥è¢«ç›‘å¬è€…çš„<code>poll_wait</code>é˜Ÿåˆ—ä¸­ï¼Œä¸Šé¢çš„ä¾‹å­å°±æ˜¯<code>epollfd1</code>çš„<code>poll_wait</code>é˜Ÿåˆ—ä¿å­˜äº†<code>epollfd2</code>ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ<code>å½“epollfd1</code>æœ‰å¯è¯»äº‹ä»¶è§¦å‘ï¼Œå°±å¯ä»¥åœ¨<code>poll_wait</code>ä¸­æ‰¾åˆ°<code>epollfd2</code>ï¼Œè°ƒç”¨<code>epollfd1</code>çš„<code>ep_poll_callback</code>å°†<code>epollfd1</code>æ”¾å…¥<code>epollfd2</code>çš„<code>rdllist</code>ä¸­ã€‚æ‰€ä»¥<code>poll_wait</code>é˜Ÿåˆ—å°±æ˜¯ç”¨æ¥å¤„ç†è¿™ç§é€’å½’ç›‘å¬çš„æƒ…å†µçš„ã€‚</p><hr><h3 id="ioåˆ†ç±»" tabindex="-1"><a class="header-anchor" href="#ioåˆ†ç±»" aria-hidden="true">#</a> IOåˆ†ç±»</h3><p>å…ˆçœ‹ä¸€ä¸ªéå¸¸ç®€å•çš„IOæµç¨‹ï¼Œä¸æ¶‰åŠä»»ä½•é˜»å¡éé˜»å¡ã€åŒæ­¥å¼‚æ­¥æ¦‚å¿µçš„å›¾ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/2023-02-04-001950.png" alt="IOæµç¨‹" tabindex="0" loading="lazy"><figcaption>IOæµç¨‹</figcaption></figure><p>å®¢æˆ·ç«¯å‘èµ·ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œå†…æ ¸çš„æ“ä½œå¯ä»¥è¢«åˆ†æˆä¸¤æ­¥ï¼š</p><ul><li><p>ç­‰å¾…æ•°æ®</p><p>æ­¤é˜¶æ®µç½‘ç»œæ•°æ®è¿›å…¥ç½‘å¡ï¼Œç„¶åç½‘å¡å°†æ•°æ®æ”¾åˆ°æŒ‡å®šçš„å†…å­˜ä½ç½®ï¼Œæ­¤è¿‡ç¨‹CPUæ— æ„ŸçŸ¥ã€‚ç„¶åç»è¿‡ç½‘å¡å‘èµ·ç¡¬ä¸­æ–­ï¼Œå†ç»è¿‡è½¯ä¸­æ–­ï¼Œå†…æ ¸çº¿ç¨‹å°†æ•°æ®å‘é€åˆ°socketçš„<strong>å†…æ ¸ç¼“å†²åŒº</strong>ä¸­ã€‚</p></li><li><p>æ•°æ®æ‹·è´</p><p>æ•°æ®ä»socketçš„<strong>å†…æ ¸ç¼“å†²åŒº</strong>æ‹·è´åˆ°<strong>ç”¨æˆ·ç©ºé—´</strong>ã€‚</p></li></ul><h4 id="é˜»å¡ä¸éé˜»å¡" tabindex="-1"><a class="header-anchor" href="#é˜»å¡ä¸éé˜»å¡" aria-hidden="true">#</a> é˜»å¡ä¸éé˜»å¡</h4><p>å‡è®¾socketä¸ºé˜»å¡æ¨¡å¼ï¼Œåˆ™IOè°ƒç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604225532038.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ å½“å¤„äºè¿è¡ŒçŠ¶æ€çš„ç”¨æˆ·çº¿ç¨‹å‘èµ·recvç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¦‚æœsocketå†…æ ¸ç¼“å†²åŒºå†…æ²¡æœ‰æ•°æ®ï¼Œåˆ™å†…æ ¸ä¼šå°†å½“å‰çº¿ç¨‹æŠ•å…¥ç¡çœ ï¼Œè®©å‡ºCPUçš„å ç”¨ã€‚ç›´åˆ°ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡ï¼Œç½‘å¡DMAæ•°æ®åˆ°å†…å­˜ï¼Œå†ç»è¿‡ç¡¬ä¸­æ–­ã€è½¯ä¸­æ–­ï¼Œç”±å†…æ ¸çº¿ç¨‹å”¤é†’ç”¨æˆ·çº¿ç¨‹ã€‚æ­¤æ—¶socketçš„æ•°æ®å·²ç»å‡†å¤‡å°±ç»ªï¼Œç”¨æˆ·çº¿ç¨‹ç”±ç”¨æˆ·æ€è¿›å…¥åˆ°å†…æ ¸æ€ï¼Œæ‰§è¡Œæ•°æ®æ‹·è´ï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç³»ç»Ÿè°ƒç”¨ç»“æŸã€‚æ­¤é˜¶æ®µï¼Œå¼€å‘è€…é€šå¸¸è®¤ä¸ºç”¨æˆ·çº¿ç¨‹å¤„äºç­‰å¾…ï¼ˆç§°ä¸ºé˜»å¡ä¹Ÿè¡Œï¼‰çŠ¶æ€ï¼Œå› ä¸ºåœ¨ç”¨æˆ·æ€çš„è§’åº¦ä¸Šï¼Œçº¿ç¨‹ç¡®å®å•¥ä¹Ÿæ²¡å¹²ï¼ˆè™½ç„¶åœ¨å†…æ ¸æ€å¹²å¾—ç´¯æ­»ç´¯æ´»ï¼‰ã€‚</p><p>â€‹ å¦‚æœå°†socketè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œè°ƒç”¨ä¾¿æ¢äº†ä¸€å‰¯å…‰æ™¯ã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604225658522.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ ç”¨æˆ·çº¿ç¨‹å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœsocketå†…æ ¸ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®ï¼Œåˆ™ç³»ç»Ÿè°ƒç”¨ç«‹å³è¿”å›ï¼Œä¸ä¼šæŒ‚èµ·çº¿ç¨‹ã€‚è€Œçº¿ç¨‹ä¼šç»§ç»­è½®è¯¢ï¼Œç›´åˆ°socketå†…æ ¸ç¼“å†²åŒºå†…æœ‰æ•°æ®ä¸ºæ­¢ã€‚å¦‚æœsocketå†…æ ¸ç¼“å†²åŒºå†…æœ‰æ•°æ®ï¼Œåˆ™ç”¨æˆ·çº¿ç¨‹è¿›å…¥å†…æ ¸æ€ï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™ä¸€æ­¥é˜»å¡æ²¡æœ‰åŒºåˆ«</p><h4 id="åŒæ­¥ä¸å¼‚æ­¥" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥ä¸å¼‚æ­¥" aria-hidden="true">#</a> åŒæ­¥ä¸å¼‚æ­¥</h4><p>â€‹ <strong>åŒæ­¥</strong>å’Œ<strong>å¼‚æ­¥</strong>ä¸»è¦çœ‹è¯·æ±‚å‘èµ·æ–¹å¯¹æ¶ˆæ¯ç»“æœçš„è·å–æ–¹å¼ï¼Œæ˜¯<strong>ä¸»åŠ¨è·å–</strong>è¿˜æ˜¯<strong>è¢«åŠ¨é€šçŸ¥</strong>ã€‚åŒºåˆ«ä¸»è¦ä½“ç°åœ¨æ•°æ®æ‹·è´é˜¶æ®µã€‚</p><p>â€‹ åŒæ­¥æŒ‡çš„æ˜¯æ•°æ®åˆ°è¾¾socketå†…æ ¸ç¼“å†²åŒºä¹‹åï¼Œç”±ç”¨æˆ·çº¿ç¨‹å‚ä¸åˆ°æ•°æ®æ‹·è´è¿‡ç¨‹ä¸­ï¼Œç›´åˆ°æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚å› æ­¤ï¼Œ<strong>IOå¤šè·¯å¤ç”¨ï¼Œå¯¹äºåº”ç”¨ç¨‹åºè€Œè¨€ï¼Œä»ç„¶åªèƒ½ç®—æ˜¯ä¸€ç§åŒæ­¥</strong>ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºä»ç„¶èŠ±è´¹æ—¶é—´ç­‰å¾…IOç»“æœï¼Œç­‰å¾…æœŸé—´CPUè¦ä¹ˆç”¨äºéå†æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ï¼Œè¦ä¹ˆç”¨äºä¼‘çœ ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚</p><p>â€‹ ä»¥<code>select</code>ä¸ºä¾‹ï¼Œç”¨æˆ·çº¿ç¨‹å‘èµ·<code>select</code>è°ƒç”¨ï¼Œä¼šåˆ‡æ¢åˆ°å†…æ ¸ç©ºé—´ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å‡†å¤‡å°±ç»ªï¼Œåˆ™ç”¨æˆ·çº¿ç¨‹é˜»å¡åˆ°æœ‰æ•°æ®æ¥ä¸ºæ­¢ï¼Œ<code>select</code>è°ƒç”¨ç»“æŸã€‚ç»“æŸä¹‹åç”¨æˆ·çº¿ç¨‹è·å–åˆ°çš„åªæ˜¯ã€Œå†…æ ¸ä¸­æœ‰Nä¸ªsocketå·²ç»å°±ç»ªã€çš„è¿™ä¹ˆä¸€ä¸ªä¿¡æ¯ï¼Œè¿˜éœ€è¦ç”¨æˆ·çº¿ç¨‹å¯¹ç€1024é•¿åº¦çš„æè¿°ç¬¦æ•°ç»„è¿›è¡Œéå†ï¼Œæ‰èƒ½è·å–åˆ°socketä¸­çš„æ•°æ®ï¼Œè¿™å°±æ˜¯åŒæ­¥ã€‚</p><p>â€‹ ç†æƒ³ä¸­çš„å®Œç¾å¼‚æ­¥åº”è¯¥æ˜¯ç”¨æˆ·è¿›ç¨‹å‘èµ·éé˜»å¡è°ƒç”¨ï¼Œå†…æ ¸ç›´æ¥è¿”å›ç»“æœä¹‹åï¼Œç”¨æˆ·çº¿ç¨‹å¯ä»¥ç«‹å³å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œåªéœ€è¦IOå®Œæˆä¹‹åé€šè¿‡ä¿¡å·æˆ–å›è°ƒå‡½æ•°çš„æ–¹å¼å°†æ•°æ®ä¼ é€’ç»™ç”¨æˆ·çº¿ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230604230059665.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>â€‹ <strong>åœ¨ç†æƒ³çš„å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œæ•°æ®å‡†å¤‡é˜¶æ®µå’Œæ•°æ®æ‹·è´é˜¶æ®µéƒ½æ˜¯ç”±å†…æ ¸å®Œæˆçš„</strong>ï¼Œä¸ä¼šå¯¹ç”¨æˆ·çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œè¿™ç§å†…æ ¸çº§åˆ«çš„æ”¹è¿›è‡ªç„¶éœ€è¦æ“ä½œç³»ç»Ÿåº•å±‚çš„åŠŸèƒ½æ”¯æŒã€‚Windowsä¸Šçš„<code>IOCP</code>ï¼Œå®ƒåœ¨æŸç§ç¨‹åº¦ä¸Šæä¾›äº†ç†æƒ³çš„å¼‚æ­¥ï¼Œå…¶å†…éƒ¨ä¾ç„¶é‡‡ç”¨çš„æ˜¯å¤šçº¿ç¨‹çš„åŸç†ï¼Œä¸è¿‡æ˜¯å†…æ ¸çº§åˆ«çš„å¤šçº¿ç¨‹ã€‚linuxé«˜ç‰ˆæœ¬çš„<code>io_uring</code>ä¹Ÿæä¾›äº†å¼‚æ­¥IOçš„æ”¯æŒã€‚</p><h4 id="è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#è¯¦è§£" aria-hidden="true">#</a> è¯¦è§£</h4><h5 id="å†…æ ¸æ€å’Œç”¨æˆ·æ€" tabindex="-1"><a class="header-anchor" href="#å†…æ ¸æ€å’Œç”¨æˆ·æ€" aria-hidden="true">#</a> å†…æ ¸æ€å’Œç”¨æˆ·æ€</h5><p>æˆ‘ä»¬çš„ç”µè„‘å¯èƒ½åŒæ—¶è¿è¡Œç€éå¸¸å¤šçš„ç¨‹åºï¼Œè¿™äº›ç¨‹åºåˆ†åˆ«æ¥è‡ªä¸åŒå…¬å¸ã€‚</p><p>è°ä¹Ÿä¸çŸ¥é“åœ¨ç”µè„‘ä¸Šè·‘ç€çš„æŸä¸ªç¨‹åºä¼šä¸ä¼šå‘ç–¯ä¼¼å¾—åšä¸€äº›å¥‡æ€ªçš„æ“ä½œï¼Œæ¯”å¦‚å®šæ—¶æŠŠå†…å­˜æ¸…ç©ºäº†ã€‚</p><p>å› æ­¤ CPU åˆ’åˆ†äº†éç‰¹æƒæŒ‡ä»¤å’Œç‰¹æƒæŒ‡ä»¤ï¼Œåšäº†æƒé™æ§åˆ¶ï¼Œä¸€äº›å±é™©çš„æŒ‡ä»¤ä¸ä¼šå¼€æ”¾ç»™æ™®é€šç¨‹åºï¼Œåªä¼šå¼€æ”¾ç»™æ“ä½œç³»ç»Ÿç­‰ç‰¹æƒç¨‹åºã€‚</p><p>ä½ å¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬çš„ä»£ç è°ƒç”¨ä¸äº†é‚£äº›å¯èƒ½ä¼šäº§ç”Ÿâ€œå±é™©â€æ“ä½œï¼Œè€Œæ“ä½œç³»ç»Ÿçš„å†…æ ¸ä»£ç å¯ä»¥è°ƒç”¨ã€‚</p><p>è¿™äº›â€œå±é™©â€çš„æ“ä½œæŒ‡ï¼šå†…å­˜çš„åˆ†é…å›æ”¶ï¼Œç£ç›˜æ–‡ä»¶è¯»å†™ï¼Œç½‘ç»œæ•°æ®è¯»å†™ç­‰ç­‰ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æ‰§è¡Œè¿™äº›æ“ä½œï¼Œåªèƒ½è°ƒç”¨æ“ä½œç³»ç»Ÿå¼€æ”¾å‡ºæ¥çš„ API ï¼Œä¹Ÿç§°ä¸ºç³»ç»Ÿè°ƒç”¨ã€‚</p><p>è¿™å°±å¥½æ¯”æˆ‘ä»¬å»è¡Œæ”¿å¤§å…åŠäº‹ï¼Œé‚£äº›æ•æ„Ÿçš„æ“ä½œéƒ½ç”±å®˜æ–¹äººå‘˜å¸®æˆ‘ä»¬å¤„ç†ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œæ‰€ä»¥é“ç†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç›®çš„éƒ½æ˜¯ä¸ºäº†é˜²æ­¢æˆ‘ä»¬(æ™®é€šç¨‹åº)ä¹±æ¥ã€‚</p><p>è¿™é‡Œåˆæœ‰ä¸¤ä¸ªåè¯ï¼š</p><ul><li>ç”¨æˆ·ç©ºé—´</li><li>å†…æ ¸ç©ºé—´ã€‚</li></ul><p>æˆ‘ä»¬æ™®é€šç¨‹åºçš„ä»£ç æ˜¯è·‘åœ¨ç”¨æˆ·ç©ºé—´ä¸Šçš„ï¼Œè€Œæ“ä½œç³»ç»Ÿçš„ä»£ç è·‘åœ¨å†…æ ¸ç©ºé—´ä¸Šï¼Œ<strong>ç”¨æˆ·ç©ºé—´æ— æ³•ç›´æ¥è®¿é—®å†…æ ¸ç©ºé—´çš„</strong>ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´æ—¶å°±å¤„äºç”¨æˆ·æ€ï¼Œè¿è¡Œåœ¨å†…æ ¸ç©ºé—´æ—¶å°±å¤„äºå†…æ ¸æ€ã€‚</p><p>å½“å¤„äºç”¨æˆ·ç©ºé—´çš„ç¨‹åºè¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ API æ—¶ï¼Œå°±ä¼šè¿›è¡Œä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼Œåˆ‡æ¢åˆ°å†…æ ¸æ€ä¸­ï¼Œä¹Ÿæ—¶å¸¸ç§°ä¹‹ä¸ºé™·å…¥å†…æ ¸æ€ã€‚</p><p>é‚£ä¸ºä»€ä¹ˆå¼€å¤´è¦å…ˆä»‹ç»è¿™ä¸ªçŸ¥è¯†ç‚¹å‘¢ï¼Ÿ</p><p>å› ä¸ºå½“ç¨‹åºè¯·æ±‚è·å–ç½‘ç»œæ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦ç»å†ä¸¤æ¬¡æ‹·è´ï¼š</p><ul><li>ç¨‹åºéœ€è¦ç­‰å¾…æ•°æ®ä»ç½‘å¡æ‹·è´åˆ°å†…æ ¸ç©ºé—´ã€‚</li><li>å› ä¸ºç”¨æˆ·ç¨‹åºæ— æ³•è®¿é—®å†…æ ¸ç©ºé—´ï¼Œæ‰€ä»¥å†…æ ¸åˆå¾—æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·å¤„äºç”¨æˆ·ç©ºé—´çš„ç¨‹åºæ‰èƒ½è®¿é—®è¿™ä¸ªæ•°æ®ã€‚</li></ul><p>ä»‹ç»è¿™ä¹ˆå¤šå°±æ˜¯è®©ä½ ç†è§£ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤æ¬¡æ‹·è´ï¼Œä¸”ç³»ç»Ÿè°ƒç”¨æ˜¯æœ‰å¼€é”€çš„ï¼Œå› æ­¤æœ€å¥½ä¸è¦é¢‘ç¹è°ƒç”¨ã€‚</p><p>ç„¶åæˆ‘ä»¬ä»Šå¤©è¯´çš„ I/O æ¨¡å‹ä¹‹é—´çš„å·®è·å°±æ˜¯è¿™æ‹·è´çš„å®ç°æœ‰æ‰€ä¸åŒï¼</p><p>ä»Šå¤©æˆ‘ä»¬å°±ä»¥ read è°ƒç”¨ï¼Œå³è¯»å–ç½‘ç»œæ•°æ®ä¸ºä¾‹å­æ¥å±•å¼€ I/O æ¨¡å‹ã€‚</p><h5 id="åŒæ­¥é˜»å¡-i-o" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥é˜»å¡-i-o" aria-hidden="true">#</a> åŒæ­¥é˜»å¡ I/O</h5><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-10-1024x586.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å½“ç”¨æˆ·ç¨‹åºçš„çº¿ç¨‹è°ƒç”¨ read è·å–ç½‘ç»œæ•°æ®çš„æ—¶å€™ï¼Œé¦–å…ˆè¿™ä¸ªæ•°æ®å¾—æœ‰ï¼Œä¹Ÿå°±æ˜¯ç½‘å¡å¾—å…ˆæ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œç„¶åè¿™ä¸ªæ•°æ®æœ‰äº†ä¹‹åéœ€è¦æ‹·è´åˆ°å†…æ ¸ä¸­ï¼Œç„¶åå†è¢«æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´å†…ï¼Œè¿™æ•´ä¸€ä¸ªè¿‡ç¨‹ç”¨æˆ·çº¿ç¨‹éƒ½æ˜¯è¢«é˜»å¡çš„ã€‚</p><p>å‡è®¾æ²¡æœ‰å®¢æˆ·ç«¯å‘æ•°æ®è¿‡æ¥ï¼Œé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·çº¿ç¨‹å°±ä¼šä¸€ç›´é˜»å¡ç­‰ç€ï¼Œç›´åˆ°æœ‰æ•°æ®ã€‚å³ä½¿æœ‰æ•°æ®ï¼Œé‚£ä¹ˆä¸¤æ¬¡æ‹·è´çš„è¿‡ç¨‹ä¹Ÿå¾—é˜»å¡ç­‰ç€ã€‚</p><p>æ‰€ä»¥è¿™ç§°ä¸ºåŒæ­¥é˜»å¡ I/O æ¨¡å‹ã€‚</p><p>å®ƒçš„ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œç®€å•ã€‚è°ƒç”¨ read ä¹‹åå°±ä¸ç®¡äº†ï¼Œç›´åˆ°æ•°æ®æ¥äº†ä¸”å‡†å¤‡å¥½äº†è¿›è¡Œå¤„ç†å³å¯ã€‚</p><p>ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œ<strong>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªè¿æ¥</strong>ï¼Œä¸€ç›´è¢«éœ¸å ç€ï¼Œå³ä½¿ç½‘å¡æ²¡æœ‰æ•°æ®åˆ°æ¥ï¼Œä¹ŸåŒæ­¥é˜»å¡ç­‰ç€ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“çº¿ç¨‹æ˜¯å±äºæ¯”è¾ƒé‡èµ„æºï¼Œè¿™å°±æœ‰ç‚¹æµªè´¹äº†ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬ä¸æƒ³è®©å®ƒè¿™æ ·å‚»ç­‰ç€ã€‚</p><p>äºæ˜¯å°±æœ‰äº†åŒæ­¥éé˜»å¡ I/Oã€‚</p><h5 id="åŒæ­¥éé˜»å¡-i-o" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥éé˜»å¡-i-o" aria-hidden="true">#</a> åŒæ­¥éé˜»å¡ I/O</h5><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-11-1024x525.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼ŒåŒæ­¥éé˜»å¡I/O åŸºäºåŒæ­¥é˜»å¡I/O è¿›è¡Œäº†ä¼˜åŒ–ï¼š</p><p>åœ¨æ²¡æ•°æ®çš„æ—¶å€™å¯ä»¥ä¸å†å‚»å‚»åœ°é˜»å¡ç­‰ç€ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›é”™è¯¯ï¼Œå‘ŠçŸ¥æš‚æ— å‡†å¤‡å°±ç»ªçš„æ•°æ®ï¼</p><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<strong>ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´è¿™ä¸€æ­¥ï¼Œç”¨æˆ·çº¿ç¨‹è¿˜æ˜¯ä¼šè¢«é˜»å¡çš„</strong>ã€‚</p><p>è¿™ä¸ªæ¨¡å‹ç›¸æ¯”äºåŒæ­¥é˜»å¡ I/O è€Œè¨€æ¯”è¾ƒçµæ´»ï¼Œæ¯”å¦‚è°ƒç”¨ read å¦‚æœæš‚æ— æ•°æ®ï¼Œåˆ™çº¿ç¨‹å¯ä»¥å…ˆå»å¹²å¹²åˆ«çš„äº‹æƒ…ï¼Œç„¶åå†æ¥ç»§ç»­è°ƒç”¨ read çœ‹çœ‹æœ‰æ²¡æœ‰æ•°æ®ã€‚</p><p>ä½†æ˜¯å¦‚æœä½ çš„çº¿ç¨‹å°±æ˜¯å–æ•°æ®ç„¶åå¤„ç†æ•°æ®ï¼Œä¸å¹²åˆ«çš„é€»è¾‘ï¼Œé‚£è¿™ä¸ªæ¨¡å‹åˆæœ‰ç‚¹é—®é¢˜äº†ã€‚</p><p>ç­‰äºä½ ä¸æ–­åœ°è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æœä½ çš„æœåŠ¡å™¨éœ€è¦å¤„ç†æµ·é‡çš„è¿æ¥ï¼Œé‚£ä¹ˆå°±éœ€è¦æœ‰æµ·é‡çš„çº¿ç¨‹ä¸æ–­è°ƒç”¨ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹ï¼ŒCPU ä¹Ÿä¼šå¿™æ­»ï¼Œåšæ— ç”¨åŠŸè€Œå¿™æ­»ã€‚</p><p>é‚£æ€ä¹ˆåŠï¼Ÿ</p><p>äºæ˜¯å°±æœ‰äº†I/O å¤šè·¯å¤ç”¨ã€‚</p><h5 id="i-o-å¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#i-o-å¤šè·¯å¤ç”¨" aria-hidden="true">#</a> I/O å¤šè·¯å¤ç”¨</h5><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-12-1024x514.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä»å›¾ä¸Šæ¥çœ‹ï¼Œå¥½åƒå’Œä¸Šé¢çš„åŒæ­¥éé˜»å¡ I/O å·®ä¸å¤šå•Šï¼Œå…¶å®ä¸å¤ªä¸€æ ·ï¼Œ<strong>çº¿ç¨‹æ¨¡å‹ä¸ä¸€æ ·</strong>ã€‚</p><p>æ—¢ç„¶åŒæ­¥éé˜»å¡ I/O åœ¨å¤ªå¤šçš„è¿æ¥ä¸‹é¢‘ç¹è°ƒç”¨å¤ªæµªè´¹äº†ï¼Œ é‚£å°±æ‹›ä¸ªä¸“å‘˜å§ã€‚</p><p>è¿™ä¸ªä¸“å‘˜å·¥ä½œå°±æ˜¯ç®¡ç†å¤šä¸ªè¿æ¥ï¼Œå¸®å¿™æŸ¥çœ‹è¿æ¥ä¸Šæ˜¯å¦æœ‰æ•°æ®å·²å‡†å¤‡å°±ç»ªã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>å¯ä»¥åªç”¨ä¸€ä¸ªçº¿ç¨‹æŸ¥çœ‹å¤šä¸ªè¿æ¥æ˜¯å¦æœ‰æ•°æ®å·²å‡†å¤‡å°±ç»ª</strong>ã€‚</p><p>å…·ä½“åˆ°ä»£ç ä¸Šï¼Œè¿™ä¸ªä¸“å‘˜å°±æ˜¯ select ï¼Œæˆ‘ä»¬å¯ä»¥å¾€ select æ³¨å†Œéœ€è¦è¢«ç›‘å¬çš„è¿æ¥ï¼Œç”± select æ¥ç›‘æ§å®ƒæ‰€ç®¡ç†çš„è¿æ¥æ˜¯å¦æœ‰æ•°æ®å·²å°±ç»ªï¼Œå¦‚æœæœ‰åˆ™<strong>å¯ä»¥</strong>é€šçŸ¥åˆ«çš„çº¿ç¨‹æ¥ read è¯»å–æ•°æ®ï¼Œ<strong>è¿™ä¸ª read å’Œä¹‹å‰çš„ä¸€æ ·ï¼Œè¿˜æ˜¯ä¼šé˜»å¡ç”¨æˆ·çº¿ç¨‹</strong>ã€‚</p><p>è¿™æ ·ä¸€æ¥å°±å¯ä»¥<strong>ç”¨å°‘é‡çš„çº¿ç¨‹å»ç›‘æ§å¤šæ¡è¿æ¥</strong>ï¼Œå‡å°‘äº†çº¿ç¨‹çš„æ•°é‡ï¼Œé™ä½äº†å†…å­˜çš„æ¶ˆè€—ä¸”å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ï¼Œå¾ˆèˆ’æœã€‚</p><p>æƒ³å¿…åˆ°æ­¤ä½ å·²ç»ç†è§£äº†ä»€ä¹ˆå« I/O å¤šè·¯å¤ç”¨ã€‚</p><p>æ‰€è°“çš„å¤šè·¯æŒ‡çš„æ˜¯å¤šæ¡è¿æ¥ï¼Œå¤ç”¨æŒ‡çš„æ˜¯ç”¨ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥ç›‘æ§è¿™ä¹ˆå¤šæ¡è¿æ¥ã€‚</p><p>çœ‹åˆ°è¿™ï¼Œå†æƒ³æƒ³ï¼Œè¿˜æœ‰ä»€ä¹ˆåœ°æ–¹å¯ä»¥ä¼˜åŒ–çš„ï¼Ÿ</p><h5 id="ä¿¡å·é©±åŠ¨å¼i-o" tabindex="-1"><a class="header-anchor" href="#ä¿¡å·é©±åŠ¨å¼i-o" aria-hidden="true">#</a> ä¿¡å·é©±åŠ¨å¼I/O</h5><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-13-1024x530.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¸Šé¢çš„ select è™½ç„¶ä¸é˜»å¡äº†ï¼Œä½†æ˜¯ä»–å¾—æ—¶åˆ»å»æŸ¥è¯¢çœ‹çœ‹æ˜¯å¦æœ‰æ•°æ®å·²ç»å‡†å¤‡å°±ç»ªï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥è®©å†…æ ¸å‘Šè¯‰æˆ‘ä»¬æ•°æ®åˆ°äº†è€Œä¸æ˜¯æˆ‘ä»¬å»è½®è¯¢å‘¢ï¼Ÿ</p><p>ä¿¡å·é©±åŠ¨ I/O å°±èƒ½å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œç”±å†…æ ¸å‘ŠçŸ¥æ•°æ®å·²å‡†å¤‡å°±ç»ªï¼Œç„¶åç”¨æˆ·çº¿ç¨‹å†å» readï¼ˆè¿˜æ˜¯ä¼šé˜»å¡ï¼‰ã€‚</p><p>å¬èµ·æ¥æ˜¯ä¸æ˜¯æ¯” I/O å¤šè·¯å¤ç”¨å¥½å‘€ï¼Ÿé‚£ä¸ºä»€ä¹ˆå¥½åƒå¾ˆå°‘å¬åˆ°ä¿¡å·é©±åŠ¨ I/Oï¼Ÿ</p><blockquote><p>ä¸ºä»€ä¹ˆå¸‚é¢ä¸Šç”¨çš„éƒ½æ˜¯ I/O å¤šè·¯å¤ç”¨è€Œä¸æ˜¯ä¿¡å·é©±åŠ¨?</p></blockquote><p>å› ä¸ºæˆ‘ä»¬çš„åº”ç”¨é€šå¸¸ç”¨çš„éƒ½æ˜¯ TCP åè®®ï¼Œè€Œ <strong>TCP åè®®çš„ socket å¯ä»¥äº§ç”Ÿä¿¡å·äº‹ä»¶æœ‰ä¸ƒç§</strong>ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ä¸ä»…ä»…åªæœ‰æ•°æ®å‡†å¤‡å°±ç»ªæ‰ä¼šå‘ä¿¡å·ï¼Œå…¶ä»–äº‹ä»¶ä¹Ÿä¼šå‘ä¿¡å·ï¼Œè€Œè¿™ä¸ªä¿¡å·åˆæ˜¯åŒä¸€ä¸ªä¿¡å·ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ— ä»åŒºåˆ†åˆ°åº•æ˜¯ä»€ä¹ˆäº‹ä»¶äº§ç”Ÿçš„è¿™ä¸ªä¿¡å·ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„åº”ç”¨åŸºæœ¬ä¸Šç”¨ä¸äº†ä¿¡å·é©±åŠ¨ I/Oï¼Œä½†å¦‚æœä½ çš„åº”ç”¨ç¨‹åºç”¨çš„æ˜¯ UDP åè®®ï¼Œé‚£æ˜¯å¯ä»¥çš„ï¼Œå› ä¸º UDP æ²¡è¿™ä¹ˆå¤šäº‹ä»¶ã€‚</p><p>å› æ­¤ï¼Œè¿™ä¹ˆä¸€çœ‹å¯¹æˆ‘ä»¬è€Œè¨€ä¿¡å·é©±åŠ¨ I/O ä¹Ÿä¸å¤ªè¡Œã€‚</p><h5 id="å¼‚æ­¥-i-o" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥-i-o" aria-hidden="true">#</a> å¼‚æ­¥ I/O</h5><p>ä¿¡å·é©±åŠ¨ I/O è™½ç„¶å¯¹ TCP ä¸å¤ªå‹å¥½ï¼Œä½†æ˜¯è¿™ä¸ªæ€è·¯å¯¹çš„ï¼š<strong>å¾€å¼‚æ­¥å‘å±•</strong>ï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰å®Œå…¨å¼‚æ­¥ï¼Œå› ä¸ºå…¶åé¢é‚£æ®µ read è¿˜æ˜¯ä¼šé˜»å¡ç”¨æˆ·çº¿ç¨‹ï¼Œæ‰€ä»¥å®ƒç®—æ˜¯åŠå¼‚æ­¥ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬å¾—æƒ³ä¸‹å¦‚ä½•å¼„æˆå…¨å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯æŠŠ read é‚£æ­¥é˜»å¡ä¹Ÿçœäº†ã€‚</p><p>å…¶å®æ€è·¯å¾ˆæ¸…æ™°ï¼šè®©å†…æ ¸ç›´æ¥æŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ä¹‹åå†å‘ŠçŸ¥ç”¨æˆ·çº¿ç¨‹ï¼Œæ¥å®ç°çœŸæ­£çš„éé˜»å¡I/Oï¼</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-14-1024x451.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>æ‰€ä»¥å¼‚æ­¥ I/O å…¶å®å°±æ˜¯ç”¨æˆ·çº¿ç¨‹è°ƒç”¨ <code>aio_read</code> ï¼Œç„¶ååŒ…æ‹¬å°†æ•°æ®ä»å†…æ ¸æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´é‚£æ­¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½ç”±å†…æ ¸å®Œæˆï¼Œå½“å†…æ ¸æ“ä½œå®Œæ¯•ä¹‹åï¼Œå†è°ƒç”¨ä¹‹å‰è®¾ç½®çš„å›è°ƒï¼Œæ­¤æ—¶ç”¨æˆ·çº¿ç¨‹å°±æ‹¿ç€å·²ç»æ‹·è´åˆ°ç”¨æˆ·æ§ä»¶çš„æ•°æ®å¯ä»¥ç»§ç»­æ‰§è¡Œåç»­æ“ä½œã€‚</p><p>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·çº¿ç¨‹æ²¡æœ‰ä»»ä½•é˜»å¡ç‚¹ï¼Œ<strong>è¿™æ‰æ˜¯çœŸæ­£çš„éé˜»å¡I/O</strong>ã€‚</p><p>é‚£ä¹ˆé—®é¢˜åˆæ¥äº†:</p><blockquote><p>ä¸ºä»€ä¹ˆå¸¸ç”¨çš„è¿˜æ˜¯I/Oå¤šè·¯å¤ç”¨ï¼Œè€Œä¸æ˜¯å¼‚æ­¥I/Oï¼Ÿ</p></blockquote><p>å› ä¸º Linux å¯¹å¼‚æ­¥ I/O çš„æ”¯æŒä¸è¶³ï¼Œä½ å¯ä»¥è®¤ä¸ºè¿˜æœªå®Œå…¨å®ç°ï¼Œæ‰€ä»¥ç”¨ä¸äº†å¼‚æ­¥ I/Oã€‚</p><p>è¿™é‡Œå¯èƒ½æœ‰äººä¼šè¯´ä¸å¯¹å‘€ï¼Œåƒ Tomcat éƒ½å®ç°äº† AIOçš„å®ç°ç±»ï¼Œå…¶å®åƒè¿™äº›ç»„ä»¶æˆ–è€…ä½ ä½¿ç”¨çš„ä¸€äº›ç±»åº“çœ‹èµ·æ¥æ”¯æŒäº† AIO(å¼‚æ­¥I/O)ï¼Œ<strong>å®é™…ä¸Šåº•å±‚å®ç°æ˜¯ç”¨ epoll æ¨¡æ‹Ÿå®ç°çš„</strong>ã€‚</p><p>è€Œ Windows æ˜¯å®ç°äº†çœŸæ­£çš„ AIOï¼Œä¸è¿‡æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸€èˆ¬éƒ½æ˜¯éƒ¨ç½²åœ¨ Linux ä¸Šçš„ï¼Œæ‰€ä»¥ä¸»æµè¿˜æ˜¯ I/O å¤šè·¯å¤ç”¨ã€‚</p><h5 id="åŒæ­¥-å¼‚æ­¥" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥-å¼‚æ­¥" aria-hidden="true">#</a> åŒæ­¥&amp;å¼‚æ­¥</h5><p>åŒæ­¥å’Œå¼‚æ­¥æŒ‡çš„æ˜¯ï¼šå½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦ç­‰å¾…æ–¹æ³•è°ƒç”¨æ‰§è¡Œå®Œæ¯•ã€‚</p><p>æ¯”å¦‚ä½ è°ƒç”¨ä¸€ä¸ªæ¬è¿ä¸€ç™¾å—çŸ³å¤´çš„æ–¹æ³•ï¼š</p><ul><li>åŒæ­¥æŒ‡çš„æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½ çš„çº¿ç¨‹éœ€è¦ç­‰å¾…è¿™ä¸€ç™¾å—çŸ³å¤´æ¬å®Œï¼Œç„¶åå¾—åˆ°æ¬å®Œäº†çš„ç»“æœï¼Œæ¥ç€å†ç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„ä»£ç é€»è¾‘ã€‚</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// åŒæ­¥æ–¹å¼ </span>
result <span class="token operator">=</span> <span class="token function">æ¬ä¸€ç™¾å—çŸ³å¤´</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// éœ€ç­‰å¾…æ¬å®Œçš„ç»“æœï¼Œæ‰èƒ½æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ </span>
<span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">çŸ³å¤´æ¬å®Œäº†å‘å·¥èµ„</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token function">è®¡ç®—ä¸‹ä¸€æ¬¡æ¬çŸ³å¤´çš„ä»»åŠ¡</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼›
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¼‚æ­¥æŒ‡çš„æ˜¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç«‹é©¬å°±ç›´æ¥è¿”å›ï¼Œä¸å¿…ç­‰å€™è¿™ä¸€ç™¾å—çŸ³å¤´è¿˜æœªæ¬å®Œï¼Œå¯ä»¥ç«‹é©¬æ‰§è¡Œåé¢çš„ä»£ç é€»è¾‘ï¼Œç„¶ååˆ©ç”¨å›è°ƒæˆ–è€…äº‹ä»¶é€šçŸ¥çš„æ–¹å¼å¾—åˆ°çŸ³å¤´å·²ç»æ¬å®Œçš„ç»“æœã€‚</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// å¼‚æ­¥æ–¹å¼ </span>
<span class="token function">æ¬ä¸€ç™¾å—çŸ³å¤´</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    
  <span class="token comment">// å›è°ƒ </span>
  <span class="token function">çŸ³å¤´æ¬å®Œäº†å‘å·¥èµ„</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// ä¸å¿…ç­‰å¾…çŸ³å¤´æ¬å®Œï¼Œç«‹é©¬æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ </span>
<span class="token function">è®¡ç®—ä¸‹ä¸€æ¬¡æ¬çŸ³å¤´çš„ä»»åŠ¡</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼›
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥å¾ˆç›´è§‚çš„çœ‹å‡ºï¼ŒåŒæ­¥å’Œå¼‚æ­¥å°±æ˜¯è°ƒç”¨æ–¹å¼çš„ä¸åŒï¼Œè¿™ä½¿å¾—æˆ‘ä»¬çš„ç¼–ç æ–¹å¼ä¹Ÿæœ‰æ‰€ä¸åŒã€‚</p><p>åœ¨å¼‚æ­¥è°ƒç”¨ä¸‹çš„ä»£ç é€»è¾‘ç›¸å¯¹è€Œè¨€ä¸å¤ªç›´è§‚ï¼Œéœ€è¦å€ŸåŠ©å›è°ƒæˆ–äº‹ä»¶é€šçŸ¥ï¼Œè¿™åœ¨å¤æ‚é€»è¾‘ä¸‹å¯¹ç¼–ç èƒ½åŠ›çš„è¦æ±‚è¾ƒé«˜ã€‚è€ŒåŒæ­¥è°ƒç”¨å°±æ˜¯ç›´æ¥ç›´å»ï¼Œç­‰å¾…æ‰§è¡Œå®Œæ¯•ç„¶åæ‹¿åˆ°ç»“æœç´§æ¥ç€æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œå¯¹ç¼–ç èƒ½åŠ›çš„è¦æ±‚è¾ƒä½ï¼Œä¹Ÿæ›´ä¸å®¹æ˜“å‡ºé”™ã€‚</p><p>æ‰€ä»¥ä½ ä¼šå‘ç°æœ‰å¾ˆå¤šæ–¹æ³•å®ƒæ˜¯å¼‚æ­¥è°ƒç”¨çš„æ–¹å¼ï¼Œä½†æ˜¯æœ€ç»ˆçš„ä½¿ç”¨è¿˜æ˜¯å¼‚æ­¥è½¬åŒæ­¥ã€‚</p><p>æ¯”å¦‚ä½ å‘çº¿ç¨‹æ± æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå¾—åˆ°ä¸€ä¸ª futureï¼Œæ­¤æ—¶æ˜¯å¼‚æ­¥çš„ï¼Œç„¶åä½ åœ¨ç´§æ¥ç€åœ¨ä»£ç é‡Œè°ƒç”¨ <code>future.get()</code>ï¼Œé‚£å°±å˜æˆç­‰å¾…è¿™ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å¼‚æ­¥è½¬åŒæ­¥ï¼Œåƒ Dubbo RPC è°ƒç”¨åŒæ­¥å¾—åˆ°è¿”å›ç»“æœå°±æ˜¯è¿™æ ·å®ç°çš„ã€‚</p><h5 id="é˜»å¡-éé˜»å¡" tabindex="-1"><a class="header-anchor" href="#é˜»å¡-éé˜»å¡" aria-hidden="true">#</a> é˜»å¡&amp;éé˜»å¡</h5><p>é˜»å¡å’Œéé˜»å¡æŒ‡çš„æ˜¯ï¼šå½“å‰æ¥å£æ•°æ®è¿˜æœªå‡†å¤‡å°±ç»ªæ—¶ï¼Œçº¿ç¨‹æ˜¯å¦è¢«é˜»å¡æŒ‚èµ·ã€‚</p><p>ä½•ä¸ºé˜»å¡æŒ‚èµ·ï¼Ÿå°±æ˜¯å½“å‰çº¿ç¨‹è¿˜å¤„äº CPU æ—¶é—´ç‰‡å½“ä¸­ï¼Œè°ƒç”¨äº†é˜»å¡çš„æ–¹æ³•ï¼Œç”±äºæ•°æ®æœªå‡†å¤‡å°±ç»ªï¼Œåˆ™æ—¶é—´ç‰‡è¿˜æœªåˆ°å°±è®©å‡º CPUã€‚</p><p>æ‰€ä»¥é˜»å¡å’ŒåŒæ­¥çœ‹èµ·æ¥éƒ½æ˜¯ç­‰ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šå®ƒä»¬ä¸ä¸€æ ·ï¼ŒåŒæ­¥çš„æ—¶å€™å¯æ²¡æœ‰è®©å‡º CPUã€‚</p><p>è€Œéé˜»å¡å°±æ˜¯å½“å‰æ¥å£æ•°æ®è¿˜æœªå‡†å¤‡å°±ç»ªæ—¶ï¼Œçº¿ç¨‹ä¸ä¼šè¢«é˜»å¡æŒ‚èµ·ï¼Œå¯ä»¥ä¸æ–­è½®è¯¢è¯·æ±‚æ¥å£ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦å·²ç»å‡†å¤‡å°±ç»ªã€‚</p><p>è‡³æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼š</p><ul><li>åŒæ­¥&amp;å¼‚æ­¥æŒ‡ï¼šå½“æ•°æ®è¿˜æœªå¤„ç†å®Œæˆæ—¶ï¼Œä»£ç çš„é€»è¾‘å¤„ç†æ–¹å¼ä¸åŒã€‚</li><li>é˜»å¡&amp;éé˜»å¡æŒ‡ï¼šå½“æ•°æ®è¿˜æœªå¤„ç†å®Œæˆæ—¶(æœªå°±ç»ª)ï¼Œçº¿ç¨‹çš„çŠ¶æ€ã€‚</li></ul><p>æ‰€ä»¥åŒæ­¥&amp;å¼‚æ­¥å…¶å®æ˜¯å¤„äºæ¡†æ¶è¿™ç§é«˜å±‚æ¬¡ç»´åº¦æ¥çœ‹å¾…çš„ï¼Œè€Œé˜»å¡&amp;éé˜»å¡å¾€å¾€é’ˆå¯¹åº•å±‚çš„ç³»ç»Ÿè°ƒç”¨æ–¹é¢æ¥æŠ‰æ‹©ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸¤è€…æ˜¯ä»ä¸åŒç»´åº¦æ¥è€ƒè™‘çš„ã€‚</p><h5 id="å†ç»“åˆ-i-o-æ¥çœ‹" tabindex="-1"><a class="header-anchor" href="#å†ç»“åˆ-i-o-æ¥çœ‹" aria-hidden="true">#</a> å†ç»“åˆ I/O æ¥çœ‹</h5><blockquote><p>å‰æï¼šç¨‹åºå’Œç¡¬ä»¶ä¹‹é—´éš”äº†ä¸ªæ“ä½œç³»ç»Ÿï¼Œè€Œä¸ºäº†å®‰å…¨è€ƒè™‘ï¼ŒLinux ç³»ç»Ÿåˆ†äº†ï¼šç”¨æˆ·æ€å’Œå†…æ ¸æ€</p></blockquote><p>åœ¨è¿™ä¸ªå‰æä¸‹ï¼Œæˆ‘ä»¬å†æ˜ç¡® I/O æ“ä½œæœ‰ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol><li>å‘èµ· I/O è¯·æ±‚</li><li>å®é™… I/O è¯»å†™ï¼Œå³æ•°æ®ä»å†…æ ¸ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li></ol><p>é˜»å¡ I/O å’Œéé˜»å¡ I/Oã€‚æŒ‰ç…§ä¸Šæ–‡ï¼Œå…¶å®æŒ‡çš„å°±æ˜¯ç”¨æˆ·çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡ï¼Œè¿™é‡ŒæŒ‡ä»£çš„æ­¥éª¤1ï¼ˆå‘èµ·I/Oè¯·æ±‚ï¼‰ã€‚</p><ul><li>é˜»å¡ I/Oï¼ŒæŒ‡ç”¨æˆ·çº¿ç¨‹å‘èµ· I/O è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®è¿˜æœªå‡†å¤‡å°±ç»ªï¼ˆä¾‹å¦‚æš‚æ— ç½‘ç»œæ•°æ®æ¥æ”¶ï¼‰ï¼Œå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè®©å‡º CPUã€‚</li><li>éé˜»å¡ I/Oï¼ŒæŒ‡ç”¨æˆ·çº¿ç¨‹å‘èµ· I/O è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®è¿˜æœªå‡†å¤‡å°±ç»ªï¼ˆä¾‹å¦‚æš‚æ— ç½‘ç»œæ•°æ®æ¥æ”¶ï¼‰ï¼Œä¹Ÿä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œåç»­çš„ä»»åŠ¡ã€‚</li></ul><p>å¯ä»¥å‘ç°ï¼Œè¿™é‡Œçš„é˜»å¡å’Œéé˜»å¡å…¶å®æ˜¯æŒ‡ç”¨æˆ·çº¿ç¨‹æ˜¯å¦ä¼šè¢«é˜»å¡ã€‚</p><p>åŒæ­¥ I/O å’Œå¼‚æ­¥ I/Oã€‚æŒ‰ç…§ä¸Šæ–‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—çŸ¥è¿™å°±æ˜¯æ ¹æ® I/O å“åº”æ–¹å¼ä¸åŒè€Œåˆ’åˆ†çš„ã€‚</p><ul><li>åŒæ­¥ I/Oï¼ŒæŒ‡ç”¨æˆ·çº¿ç¨‹å‘èµ· I/O è¯·æ±‚çš„æ—¶å€™ï¼Œæ•°æ®æ˜¯æœ‰çš„ï¼Œé‚£ä¹ˆå°†è¿›è¡Œæ­¥éª¤2ï¼ˆå®é™… I/O è¯»å†™ï¼Œå³æ•°æ®ä»å†…æ ¸ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”¨æˆ·çº¿ç¨‹æ˜¯è¦ç­‰å¾…ç€æ‹·è´å®Œæˆã€‚</li><li>å¼‚æ­¥ I/Oï¼ŒæŒ‡ç”¨æˆ·çº¿ç¨‹å‘èµ· I/O è¯·æ±‚çš„æ—¶å€™ï¼Œæ•°æ®æ˜¯æœ‰çš„ï¼Œé‚£ä¹ˆå°†è¿›è¡Œæ­¥éª¤2ï¼ˆå®é™… I/O è¯»å†™ï¼Œå³æ•°æ®ä»å†…æ ¸ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼‰ï¼Œæ‹·è´çš„è¿‡ç¨‹ä¸­ä¸éœ€è¦ç”¨æˆ·çº¿ç¨‹ç­‰å¾…ï¼Œç”¨æˆ·çº¿ç¨‹å¯ä»¥å»æ‰§è¡Œå…¶å®ƒé€»è¾‘ï¼Œç­‰å†…æ ¸å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´åï¼Œç”¨æˆ·çº¿ç¨‹ä¼šå¾—åˆ°ä¸€ä¸ªâ€œé€šçŸ¥â€ã€‚</li></ul><p>å†ä»”ç»†æ€è€ƒä¸‹ï¼Œåœ¨ I/O åœºæ™¯ä¸‹åŒæ­¥å’Œå¼‚æ­¥è¯´çš„å…¶å®æ˜¯å†…æ ¸çš„å®ç°ï¼Œå› ä¸ºæ‹·è´çš„æ‰§è¡Œè€…æ˜¯å†…æ ¸ï¼Œä¸€ç§æ˜¯åŒæ­¥å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·çº¿ç¨‹æ˜¯éœ€è¦ç­‰ç€çš„ã€‚ä¸€ä¸ªæ˜¯é€šè¿‡å¼‚æ­¥çš„æ–¹å¼ï¼Œç”¨æˆ·çº¿ç¨‹ä¸ç”¨ç­‰ï¼Œåœ¨æ‹·è´å®Œä¹‹åï¼Œå†…æ ¸ä¼šè°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°ã€‚</p><p><strong>å¦‚æœä¸ç†è§£ä¸Šé¢ï¼Œå°±åªéœ€è®°ä½ï¼š</strong></p><ul><li>åŒæ­¥I/Oï¼šæŒ‡çš„æ˜¯ç”¨æˆ·çº¿ç¨‹ä¼šéœ€è¦ç­‰å¾…æ­¥éª¤ 2 æ‰§è¡Œå®Œæ¯•ã€‚</li><li>å¼‚æ­¥I/Oï¼šæŒ‡çš„æ˜¯ç”¨æˆ·çº¿ç¨‹ä¸éœ€è¦ç­‰å¾…æ­¥éª¤ 2 æ‰§è¡Œã€‚</li></ul><p>å¥½äº†ï¼Œå¦‚æœä»¥ä¸Šçš„æ¦‚å¿µä½ éƒ½å·²ç»ç†è§£äº†çš„è¯ï¼Œé‚£ä¹ˆå¹³æ—¥é‡Œæˆ‘ä»¬æ‰€è¯´çš„åŒæ­¥é˜»å¡I/Oï¼ŒåŒæ­¥éé˜»å¡I/Oç­‰å…¶å®å°±æ˜¯æŠŠä¸Šé¢çš„ä¸¤ä¸ªæ­¥éª¤åˆèµ·æ¥çœ‹ï¼Œåº”è¯¥ä¸éš¾ç†è§£ã€‚</p><p>æˆ‘å†ç®€å•çš„æ€»ç»“ä¸€ä¸‹ï¼Œå…³äº I/O çš„é˜»å¡ã€éé˜»å¡ã€åŒæ­¥ã€å¼‚æ­¥ï¼š</p><ul><li><p>é˜»å¡å’Œéé˜»å¡æŒ‡çš„æ˜¯å‘èµ· I/O è¯·æ±‚åï¼Œç”¨æˆ·çº¿ç¨‹çŠ¶æ€çš„ä¸åŒï¼Œé˜»å¡I/Oåœ¨æ•°æ®æœªå‡†å¤‡å°±ç»ªçš„æ—¶å€™ä¼šé˜»å¡å½“å‰ç”¨æˆ·çº¿ç¨‹ï¼Œè€Œéé˜»å¡ I/O ä¼šç«‹é©¬è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä¸ä¼šé˜»å¡å½“å‰ç”¨æˆ·çº¿ç¨‹ã€‚</p></li><li><p>åŒæ­¥å’Œå¼‚æ­¥æ˜¯æŒ‡ï¼Œå†…æ ¸çš„ I/O æ‹·è´å®ç°ï¼Œå½“æ•°æ®å‡†å¤‡å°±ç»ªåï¼Œéœ€è¦å°†å†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´è‡³ç”¨æˆ·ç©ºé—´ï¼Œå¦‚æœæ˜¯åŒæ­¥ I/O é‚£ä¹ˆç”¨æˆ·çº¿ç¨‹ä¼šç­‰å¾…æ‹·è´çš„å®Œæˆï¼Œè€Œå¼‚æ­¥ I/Oåˆ™è¿™ä¸ªæ‹·è´è¿‡ç¨‹ç”¨æˆ·çº¿ç¨‹è¯¥å¹²å˜›å¯ä»¥å»å¹²å—ï¼Œå½“å†…æ ¸æ‹·è´å®Œæ¯•ä¹‹åä¼šâ€œé€šçŸ¥â€ç”¨æˆ·çº¿ç¨‹ã€‚</p></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/nocetfy/edit/main/docs/interview/Java/Java IO.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><nav class="page-nav"><!----><a href="/MyNotes/interview/Java/Java.html" class="nav-link next" aria-label="Java åŸºç¡€"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">Java åŸºç¡€<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/MyNotes/assets/app-59c87434.js" defer></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-y/instant.page/5.1.0/instantpage.min.js" type="application/javascript"></script>
  </body>
</html>
