<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta property="og:url" content="https://newzone.top/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html"><meta property="og:site_name" content="nocetfy"><meta property="og:title" content="Spring IOC"><meta property="og:description" content="Spring IOC [toc] IOC BeanDefinition Springä¸­å…³äºBeançš„å®šä¹‰æ¥å£ï¼Œå®é™…ä½¿ç”¨çš„Beanåœ¨Springæ¡†æ¶å†…éƒ¨å°±æ˜¯BeanDefinitionã€‚BeanDefinitionå°±æ˜¯Beanä¸­å…ƒæ•°æ®çš„ä½“ç°ã€‚ bean -&gt; beanDefinition class -&gt; klass people -&gt; dna"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Spring IOC","image":[""],"dateModified":null,"author":[]}</script><title>Spring IOC | nocetfy</title><meta name="description" content="Spring IOC [toc] IOC BeanDefinition Springä¸­å…³äºBeançš„å®šä¹‰æ¥å£ï¼Œå®é™…ä½¿ç”¨çš„Beanåœ¨Springæ¡†æ¶å†…éƒ¨å°±æ˜¯BeanDefinitionã€‚BeanDefinitionå°±æ˜¯Beanä¸­å…ƒæ•°æ®çš„ä½“ç°ã€‚ bean -&gt; beanDefinition class -&gt; klass people -&gt; dna">
    <meta name="keywords" content="è‡ªæˆ‘æå‡,æ•ˆç‡æå‡,å¼€æºå·¥å…·,å­¦ä¹ ç¬”è®°" />
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #252232;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/MyNotes/assets/style-fdc52a0b.css" as="style"><link rel="stylesheet" href="/MyNotes/assets/style-fdc52a0b.css">
    <link rel="modulepreload" href="/MyNotes/assets/app-59c87434.js"><link rel="modulepreload" href="/MyNotes/assets/framework-1ee2252c.js"><link rel="modulepreload" href="/MyNotes/assets/Spring IOC.html-ac2d5ab0.js"><link rel="modulepreload" href="/MyNotes/assets/Spring IOC.html-f92d3258.js">

    <!-- çœ‹æ¿å¨˜åŒºå— -->
    <link href="https://lf9-cdn-tos.bytecdntp.com/cdn/expire-1-y/font-awesome/6.0.0/css/all.min.css" type="text/css" rel="stylesheet" />
    <script src="/live2d-widget/autoload.js"></script>
    <!-- End çœ‹æ¿å¨˜åŒºå— -->

    <!-- Matomo æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://piwik.seoipo.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '7']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->

  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/MyNotes/" class="brand"><img class="logo" src="/MyNotes/logo.svg" alt="nocetfy"><!----><span class="site-name hide-in-pad">nocetfy</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/MyNotes/blog" class="nav-link" aria-label="åšå®¢"><span class="font-icon icon iconfont icon-blog" style=""></span>åšå®¢<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ä»£ç "><span class="title"><span class="font-icon icon iconfont icon-code" style=""></span>ä»£ç </span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/MyNotes/code/Markdown" class="nav-link" aria-label="/code/Markdown"><!---->/code/Markdown<!----></a></li><li class="dropdown-item"><a href="/MyNotes/code/AutoHotkey" class="nav-link" aria-label="/code/AutoHotkey"><!---->/code/AutoHotkey<!----></a></li><li class="dropdown-item"><a href="/MyNotes/code/Electron" class="nav-link" aria-label="/code/Electron"><!---->/code/Electron<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>é¡µé¢å¼€å‘</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/MyNotes/web/VuePress" class="nav-link" aria-label="/web/VuePress"><!---->/web/VuePress<!----></a></li><li class="dropdown-subitem"><a href="/MyNotes/web/docsify" class="nav-link" aria-label="/web/docsify"><!---->/web/docsify<!----></a></li><li class="dropdown-subitem"><a href="/MyNotes/deploy/VPS" class="nav-link" aria-label="/deploy/VPS"><!---->/deploy/VPS<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="åº”ç”¨"><span class="title"><span class="font-icon icon iconfont icon-app" style=""></span>åº”ç”¨</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/MyNotes/apps/Applist" class="nav-link" aria-label="/apps/Applist"><!---->/apps/Applist<!----></a></li><li class="dropdown-item"><a href="/MyNotes/apps/ChatGPT" class="nav-link" aria-label="/apps/ChatGPT"><!---->/apps/ChatGPT<!----></a></li><li class="dropdown-item"><a href="/MyNotes/apps/livestreaming/1_obs_basic" class="nav-link" aria-label="ç›´æ’­æ‰‹å†Œ"><span class="font-icon icon iconfont icon-quote" style=""></span>ç›´æ’­æ‰‹å†Œ<!----></a></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>æœåŠ¡/ç³»ç»Ÿ</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/MyNotes/services/NAS" class="nav-link" aria-label="/services/NAS"><!---->/services/NAS<!----></a></li><li class="dropdown-subitem"><a href="/MyNotes/windows/faq" class="nav-link" aria-label="/windows/faq"><!---->/windows/faq<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="ç”Ÿæ´»"><span class="title"><span class="font-icon icon iconfont icon-emmet" style=""></span>ç”Ÿæ´»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/MyNotes/family/Diet" class="nav-link" aria-label="/family/Diet"><!---->/family/Diet<!----></a></li><li class="dropdown-item"><a href="/MyNotes/family/Shoppinglist" class="nav-link" aria-label="/family/Shoppinglist"><!---->/family/Shoppinglist<!----></a></li><li class="dropdown-item"><a href="/MyNotes/family/Coupon" class="nav-link" aria-label="/family/Coupon"><!---->/family/Coupon<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://nav.newzone.top/" rel="noopener noreferrer" target="_blank" aria-label="å·¥å…·æ”¶è—" class="nav-link"><span class="font-icon icon iconfont icon-tool" style=""></span>å·¥å…·æ”¶è—<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><div class="nav-item"><a class="repo-link" href="https://github.com/nocetfy" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">ğŸ§° ç®—æ³•ç¬”è®°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">ğŸš€ é¢è¯•ç¬”è®°</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">è®¡ç®—æœºåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">Java</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">MySQL</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">Redis</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ¶ˆæ¯é˜Ÿåˆ—</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ¡†æ¶</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20Cache.html" class="nav-link sidebar-link sidebar-page" aria-label="/interview/æ¡†æ¶/Spring Cache.md"><!---->/interview/æ¡†æ¶/Spring Cache.md<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20AOP.html" class="nav-link sidebar-link sidebar-page" aria-label="AOP"><!---->AOP<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20Boot.html" class="nav-link sidebar-link sidebar-page" aria-label="Boot"><!---->Boot<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Dubbo.html" class="nav-link sidebar-link sidebar-page" aria-label="Dubbo"><!---->Dubbo<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20MVC.html" class="nav-link sidebar-link sidebar-page" aria-label="MVC"><!---->MVC<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Mybatis.html" class="nav-link sidebar-link sidebar-page" aria-label="Mybatis"><!---->Mybatis<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Spring IOC"><!---->Spring IOC<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#ioc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="IOC"><!---->IOC<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beandefinition" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanDefinition"><!---->BeanDefinition<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#annotatedbeandefinitionreader" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AnnotatedBeanDefinitionReader"><!---->AnnotatedBeanDefinitionReader<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#classpathbeandefinitionscanner" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ClassPathBeanDefinitionScanner"><!---->ClassPathBeanDefinitionScanner<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beandefinitionregistry" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanDefinitionRegistry"><!---->BeanDefinitionRegistry<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#aware" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Aware"><!---->Aware<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beandefinitionregistrypostprocessor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanDefinitionRegistryPostProcessor"><!---->BeanDefinitionRegistryPostProcessor<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beanfactorypostprocessor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanFactoryPostProcessor"><!---->BeanFactoryPostProcessor<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beanpostprocessor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanPostProcessor"><!---->BeanPostProcessor<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beanfactory" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanFactory"><!---->BeanFactory<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#applicationcontext" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ApplicationContext"><!---->ApplicationContext<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#å¸¸è§é—®é¢˜" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å¸¸è§é—®é¢˜"><!---->å¸¸è§é—®é¢˜<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="å¸¸ç”¨å·¥å…·ç±»"><!---->å¸¸ç”¨å·¥å…·ç±»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20%E6%9D%82%E9%A1%B9.html" class="nav-link sidebar-link sidebar-page" aria-label="æ‚é¡¹"><!---->æ‚é¡¹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ•°æ®ç»“æ„ä¸ç®—æ³•</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">ç½‘ç»œ</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">æ¶æ„</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">åˆ†å¸ƒå¼</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">è¿ç»´å¼€å‘</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="font-icon icon iconfont icon-ability" style=""></span><span class="title">å¼€æ”¾è®¾è®¡</span><span class="arrow right"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Spring IOC</h1><div class="page-info"><!----><!----><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 41626 å­—</span><meta property="wordCount" content="41626"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 139 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT139M"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#ioc" class="router-link-active router-link-exact-active toc-link level2">IOC</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beandefinition" class="router-link-active router-link-exact-active toc-link level3">BeanDefinition</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#annotatedbeandefinitionreader" class="router-link-active router-link-exact-active toc-link level3">AnnotatedBeanDefinitionReader</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#classpathbeandefinitionscanner" class="router-link-active router-link-exact-active toc-link level3">ClassPathBeanDefinitionScanner</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beandefinitionregistry" class="router-link-active router-link-exact-active toc-link level3">BeanDefinitionRegistry</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#aware" class="router-link-active router-link-exact-active toc-link level3">Aware</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beandefinitionregistrypostprocessor" class="router-link-active router-link-exact-active toc-link level3">BeanDefinitionRegistryPostProcessor</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beanfactorypostprocessor" class="router-link-active router-link-exact-active toc-link level3">BeanFactoryPostProcessor</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beanpostprocessor" class="router-link-active router-link-exact-active toc-link level3">BeanPostProcessor</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#beanfactory" class="router-link-active router-link-exact-active toc-link level3">BeanFactory</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#applicationcontext" class="router-link-active router-link-exact-active toc-link level3">ApplicationContext</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Spring%20IOC.html#å¸¸è§é—®é¢˜" class="router-link-active router-link-exact-active toc-link level3">å¸¸è§é—®é¢˜</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="spring-ioc" tabindex="-1"><a class="header-anchor" href="#spring-ioc" aria-hidden="true">#</a> Spring IOC</h1><p>[toc]</p><h2 id="ioc" tabindex="-1"><a class="header-anchor" href="#ioc" aria-hidden="true">#</a> IOC</h2><h3 id="beandefinition" tabindex="-1"><a class="header-anchor" href="#beandefinition" aria-hidden="true">#</a> BeanDefinition</h3><p>Springä¸­å…³äº<code>Bean</code>çš„å®šä¹‰æ¥å£ï¼Œå®é™…ä½¿ç”¨çš„<code>Bean</code>åœ¨Springæ¡†æ¶å†…éƒ¨å°±æ˜¯<code>BeanDefinition</code>ã€‚BeanDefinitionå°±æ˜¯<code>Bean</code>ä¸­å…ƒæ•°æ®çš„ä½“ç°ã€‚</p><blockquote><p>bean -&gt; beanDefinition class -&gt; klass people -&gt; dna</p></blockquote><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230709173336106.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanDefinition</span> <span class="token keyword">extends</span> <span class="token class-name">AttributeAccessor</span><span class="token punctuation">,</span> <span class="token class-name">BeanMetadataElement</span> <span class="token punctuation">{</span>

<span class="token comment">// å•ä¾‹Beanè¿˜æ˜¯åŸå‹Bean</span>
 <span class="token class-name">String</span> <span class="token constant">SCOPE_SINGLETON</span> <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_SINGLETON</span><span class="token punctuation">;</span>
 <span class="token class-name">String</span> <span class="token constant">SCOPE_PROTOTYPE</span> <span class="token operator">=</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">;</span>

<span class="token comment">// Beanè§’è‰²</span>
 <span class="token keyword">int</span> <span class="token constant">ROLE_APPLICATION</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ Bean</span>
 <span class="token keyword">int</span> <span class="token constant">ROLE_SUPPORT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// æ¥æºäºé…ç½®æ–‡ä»¶çš„ Bean</span>
 <span class="token keyword">int</span> <span class="token constant">ROLE_INFRASTRUCTURE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">// Spring å†…éƒ¨çš„ Bean</span>

<span class="token comment">// é…ç½® /è·å–çˆ¶BeanDefinitionçš„åç§°   XMLä¸­çš„ &lt;bean parent=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setParentName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> parentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getParentName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– Bean çš„ Class å…¨è·¯å¾„  XML ä¸­çš„ &lt;bean class=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setBeanClassName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å–  Bean çš„ä½œç”¨åŸŸ  XMLä¸­çš„ &lt;bean scope=&quot;&quot;&gt; é…ç½®ã€‚</span>
 <span class="token keyword">void</span> <span class="token function">setScope</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½® / è·å– Bean æ˜¯å¦æ‡’åŠ è½½ï¼ˆé»˜è®¤falseï¼Œç«‹é©¬åŠ è½½ï¼‰</span>
<span class="token comment">// XML ä¸­çš„ &lt;bean lazy-init=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> lazyInit<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> <span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– Bean çš„ä¾èµ–å¯¹è±¡  XMLä¸­çš„ &lt;bean depends-on=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setDependsOn</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– Bean æ˜¯å¦æ˜¯è‡ªåŠ¨è£…é…çš„å€™é€‰è€… é»˜è®¤ä¸º true XMLä¸­çš„ &lt;bean autowire-candidate=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> autowireCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å¦‚æœæ‰¾åˆ°äº†å¤šä¸ªå¯æ³¨å…¥beanï¼Œé‚£ä¹ˆåˆ™é€‰æ‹©è¢«Primaryæ ‡è®°çš„bean/è·å–å½“</span>
<span class="token comment">// å‰ Bean æ˜¯å¦ä¸ºé¦–é€‰çš„ Bean  XMLä¸­çš„ &lt;bean primary=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> primary<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">boolean</span> <span class="token function">isPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– FactoryBean çš„åå­—  XMLä¸­çš„&lt;bean factory-bean=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setFactoryBeanName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> factoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getFactoryBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– FactoryMethod çš„åå­—ï¼Œå¯ä»¥æ˜¯æŸä¸ªå®ä¾‹çš„æ–¹æ³•ï¼ˆå’ŒfactoryBeané…åˆä½¿ç”¨ï¼‰</span>
<span class="token comment">// ä¹Ÿå¯ä»¥æ˜¯é™æ€æ–¹æ³•ã€‚ XML ä¸­çš„&lt;bean factory-method=&quot;&quot;&gt; </span>
 <span class="token keyword">void</span> <span class="token function">setFactoryMethodName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> factoryMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿”å›è¯¥ Bean æ„é€ æ–¹æ³•çš„å‚æ•°å€¼</span>
 <span class="token class-name">ConstructorArgumentValues</span> <span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ¤æ–­ getConstructorArgumentValues æ˜¯å¦æ˜¯ç©ºå¯¹è±¡ã€‚</span>
 <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">getConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token comment">// è·å–æ™®é€šå±æ€§çš„é›†åˆ</span>
 <span class="token class-name">MutablePropertyValues</span> <span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ¤æ–­ getPropertyValues æ˜¯å¦ä¸ºç©ºå¯¹è±¡</span>
 <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token comment">// é…ç½®/è·å– Bean çš„åˆå§‹åŒ–æ–¹æ³• XMLä¸­çš„&lt;bean init-method=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setInitMethodName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> initMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getInitMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– Bean çš„é”€æ¯æ–¹æ³•  XMLä¸­çš„&lt;bean destroy-method=&quot;&quot;&gt;</span>
 <span class="token keyword">void</span> <span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> destroyMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getDestroyMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– Beançš„è§’è‰²</span>
 <span class="token keyword">void</span> <span class="token function">setRole</span><span class="token punctuation">(</span><span class="token keyword">int</span> role<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> <span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é…ç½®/è·å– Bean çš„æè¿°</span>
 <span class="token keyword">void</span> <span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> description<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ç”¨æ¥è§£æä¸€ä¸ªBeanå¯¹åº”çš„ç±»å‹ä¸Šçš„å„ç§ä¿¡æ¯ï¼Œæ¯”å¦‚æ³›å‹</span>
 <span class="token class-name">ResolvableType</span> <span class="token function">getResolvableType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ˜¯å¦ä¸ºå•ä¾‹</span>
 <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ˜¯å¦ä¸ºåŸå‹</span>
 <span class="token keyword">boolean</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ˜¯å¦æŠ½è±¡  XML ä¸­çš„&lt;bean abstract=&quot;true&quot;&gt;</span>
 <span class="token keyword">boolean</span> <span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è¿”å›å®šä¹‰ Bean çš„èµ„æºæè¿°</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">String</span> <span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å¦‚æœå½“å‰ BeanDefinition æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•å¯ä»¥ç”¨æ¥è¿”å›åŸå§‹çš„ BeanDefinition</span>
 <span class="token annotation punctuation">@Nullable</span>
 <span class="token class-name">BeanDefinition</span> <span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code> AbstractBeanDefinition</code> æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œ<code>BeanDefinition</code> ä¸­åªæ˜¯å®šä¹‰äº†ä¸€ç³»åˆ—çš„ get/set æ–¹æ³•ï¼Œå¹¶æ²¡æœ‰æä¾›å¯¹åº”çš„å±æ€§ï¼Œåœ¨ <code>AbstractBeanDefinition</code> ä¸­å°†æ‰€æœ‰çš„å±æ€§å®šä¹‰å‡ºæ¥äº†ã€‚è¯¥æŠ½è±¡ç±»ä¸‹æœ‰ä¸ªä¸‰ä¸ªå­ç±»ï¼š<code>GenericBeanDefinition</code>ã€<code>RootBeanDefinition</code>ã€<code>ChildBeanDefinition</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token keyword">extends</span> <span class="token class-name">BeanMetadataAttributeAccessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">,</span> <span class="token class-name">Cloneable</span> <span class="token punctuation">{</span>

  <span class="token comment">// é»˜è®¤ä½œç”¨åŸŸåç§°çš„å¸¸é‡ï¼šç­‰æ•ˆäºå•ä¾‹</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SCOPE_DEFAULT</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  
  <span class="token comment">// è‡ªåŠ¨è£…é…çš„ä¸€äº›å¸¸é‡</span>
  <span class="token comment">// autowireMode = 0ï¼Œé»˜è®¤å€¼ï¼Œæœªæ¿€æ´»Autowiringã€‚</span>
  <span class="token comment">// bean æ ‡ç­¾çš„ autowire å±æ€§å€¼ä¸º no</span>
  <span class="token comment">// 1ã€åœ¨xmlä¸­éœ€è¦æ‰‹åŠ¨æŒ‡å®šä¾èµ–æ³¨å…¥å¯¹è±¡ é…ç½® propertyæ ‡ç­¾æˆ–è€… constructor-argæ ‡ç­¾</span>
  <span class="token comment">// 2ã€ä½¿ç”¨ @Autowired æ³¨è§£ï¼ŒautowireMode çš„å€¼ä¹Ÿæ˜¯ 0</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTOWIRE_NO</span> <span class="token operator">=</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_NO</span><span class="token punctuation">;</span>
  
  <span class="token comment">// autowireMode  = 1ï¼Œæ ¹æ®setæ–¹æ³•çš„çš„åç§°ä½œä¸ºBeanåç§°è¿›è¡Œä¾èµ–æŸ¥æ‰¾</span>
  <span class="token comment">// (å»æ‰setï¼Œå¹¶å°è¯•å°†é¦–å­—æ¯å˜ä¸ºå°å†™)ï¼Œå¹¶å°†å¯¹è±¡è®¾ç½®åˆ°è¯¥setæ–¹æ³•çš„å‚æ•°ä¸Š</span>
  <span class="token comment">// bean æ ‡ç­¾çš„ autowire å±æ€§å€¼é…ç½®ä¸º byName</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTOWIRE_BY_NAME</span> <span class="token operator">=</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_NAME</span><span class="token punctuation">;</span>
  
  <span class="token comment">// autowireMode  = 2ï¼Œæ ¹æ®setæ–¹æ³•å‚æ•°çš„ç±»å‹ä½œä¸ºBeanç±»å‹è¿›è¡Œä¾èµ–æŸ¥æ‰¾</span>
  <span class="token comment">// å¹¶å°†å¯¹è±¡è®¾ç½®åˆ°è¯¥setæ–¹æ³•çš„å‚æ•°ä¸Š</span>
  <span class="token comment">// bean æ ‡ç­¾çš„ autowire å±æ€§å€¼é…ç½®ä¸º byType</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTOWIRE_BY_TYPE</span> <span class="token operator">=</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">;</span>
  
  <span class="token comment">// autowireMode  = 3ï¼Œæ„é€ å™¨æ³¨å…¥</span>
  <span class="token comment">// bean æ ‡ç­¾çš„ autowire å±æ€§å€¼é…ç½®ä¸º constructor</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">=</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span><span class="token punctuation">;</span>
  
  <span class="token comment">// è¡¨æ˜é€šè¿‡Beançš„classçš„å†…éƒ¨æ¥è‡ªåŠ¨è£…é… Spring3.0è¢«å¼ƒç”¨ã€‚</span>
  <span class="token comment">// bean æ ‡ç­¾çš„ autowire å±æ€§å€¼é…ç½®ä¸º autodetect</span>
  <span class="token annotation punctuation">@Deprecated</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">AUTOWIRE_AUTODETECT</span> <span class="token operator">=</span> <span class="token class-name">AutowireCapableBeanFactory</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_AUTODETECT</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ£€æŸ¥ä¾èµ–æ˜¯å¦åˆæ³•ï¼Œåœ¨æœ¬ç±»ä¸­ï¼Œé»˜è®¤ä¸è¿›è¡Œä¾èµ–æ£€æŸ¥</span>
  <span class="token comment">// ä¸è¿›è¡Œæ£€æŸ¥</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEPENDENCY_CHECK_NONE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å¯¹å¯¹è±¡å¼•ç”¨è¿›è¡Œä¾èµ–æ€§æ£€æŸ¥</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEPENDENCY_CHECK_OBJECTS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å¯¹â€œç®€å•â€å±æ€§è¿›è¡Œä¾èµ–æ€§æ£€æŸ¥</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEPENDENCY_CHECK_SIMPLE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å¯¹æ‰€æœ‰å±æ€§è¿›è¡Œä¾èµ–æ£€æŸ¥</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEPENDENCY_CHECK_ALL</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  
  <span class="token comment">// è‹¥BeanæœªæŒ‡å®šé”€æ¯æ–¹æ³•ï¼Œå®¹å™¨åº”è¯¥å°è¯•æ¨æ–­Beançš„é”€æ¯æ–¹æ³•çš„åå­—ï¼Œ</span>
  <span class="token comment">// ç›®å‰ï¼Œæ¨æ–­çš„é”€æ¯æ–¹æ³•çš„åå­—ä¸€èˆ¬ä¸ºcloseæˆ–æ˜¯shutdown</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">INFER_METHOD</span> <span class="token operator">=</span> <span class="token string">&quot;(inferred)&quot;</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Beançš„classå¯¹è±¡æˆ–æ˜¯ç±»çš„å…¨é™å®šå</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Object</span> beanClass<span class="token punctuation">;</span>
  
  <span class="token comment">// é»˜è®¤çš„scopeæ˜¯å•ä¾‹,å¯¹åº”beanå±æ€§scope</span>
  <span class="token comment">// @Scope</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> scope <span class="token operator">=</span> <span class="token constant">SCOPE_DEFAULT</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦æ˜¯æŠ½è±¡ï¼Œå¯¹åº”beanå±æ€§abstract</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> abstractFlag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦æ‡’åŠ è½½ï¼Œå¯¹åº”beanå±æ€§lazy-init,é»˜è®¤ä¸æ˜¯æ‡’åŠ è½½</span>
  <span class="token comment">// @Lazy</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">Boolean</span> lazyInit<span class="token punctuation">;</span>
  
  <span class="token comment">// è‡ªåŠ¨æ³¨å…¥æ¨¡å¼ï¼Œå¯¹åº”beanå±æ€§autowire,é»˜è®¤ä¸è¿›è¡Œè‡ªåŠ¨è£…é…</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> autowireMode <span class="token operator">=</span> <span class="token constant">AUTOWIRE_NO</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦è¿›è¡Œä¾èµ–æ£€æŸ¥,é»˜è®¤ä¸è¿›è¡Œä¾èµ–æ£€æŸ¥</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> dependencyCheck <span class="token operator">=</span> <span class="token constant">DEPENDENCY_CHECK_NONE</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªbeançš„å®ä¾‹åŒ–æ˜¯å¦ä¾é å¦ä¸€ä¸ªbeançš„å®ä¾‹åŒ–ï¼Œå…ˆåŠ è½½dependsOnçš„beanï¼Œ</span>
  <span class="token comment">// å¯¹åº”beanå±æ€§depend-on</span>
  <span class="token comment">// @DependsOn</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn<span class="token punctuation">;</span>
  
  <span class="token doc-comment comment">/**
   * autowire-candidateå±æ€§è®¾ç½®ä¸ºfalseï¼Œè¿™æ ·å®¹å™¨åœ¨æŸ¥æ‰¾è‡ªåŠ¨è£…é…å¯¹è±¡æ—¶ï¼Œ
   * å°†ä¸è€ƒè™‘è¯¥beanï¼Œå³å®ƒä¸ä¼šè¢«è€ƒè™‘ä½œä¸ºå…¶ä»–beanè‡ªåŠ¨è£…é…çš„å€™é€‰è€…ï¼Œ
   * ä½†æ˜¯è¯¥beanæœ¬èº«è¿˜æ˜¯å¯ä»¥ä½¿ç”¨è‡ªåŠ¨è£…é…æ¥æ³¨å…¥å…¶ä»–beançš„
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> autowireCandidate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token doc-comment comment">/**
   * è‡ªåŠ¨è£…é…æ—¶å‡ºç°å¤šä¸ªbeanå€™é€‰è€…æ—¶ï¼Œå°†ä½œä¸ºé¦–é€‰è€…ï¼Œå¯¹åº”beanå±æ€§primaryï¼Œé»˜è®¤ä¸æ˜¯é¦–é€‰çš„
   * @Primary
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> primary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token doc-comment comment">/**
   * ç”¨äºè®°å½•Qualifierï¼Œå¯¹åº”å­å…ƒç´ qualifier <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>qualifier</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>qualifier</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
   * å¦‚æœå®¹å™¨ä¸­æœ‰å¤šä¸ªç›¸åŒç±»å‹çš„ bean,è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨qualifierå±æ€§æ¥è®¾ç½®åŠ è½½æŒ‡å®šBeanåç§°çš„bean
   * @Qualifier
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span> <span class="token generics"><span class="token punctuation">&lt;</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AutowireCandidateQualifier</span> <span class="token punctuation">&gt;</span></span> qualifiers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// java8çš„å‡½æ•°å¼æ¥å£ï¼Œåˆ›å»ºbeanå®ä¾‹çš„æ–¹å¼ä¹‹ä¸€</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">Supplier</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token punctuation">&gt;</span></span> instanceSupplier<span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦å…è®¸è®¿é—®épublicæ–¹æ³•å’Œå±æ€§, é»˜è®¤æ˜¯true</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> nonPublicAccessAllowed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token doc-comment comment">/**
   * æ˜¯å¦ä»¥ä¸€ç§å®½æ¾çš„æ¨¡å¼è§£ææ„é€ å‡½æ•°ï¼Œé»˜è®¤ä¸ºtrueï¼Œ
   * å¦‚æœä¸ºfalseï¼Œåˆ™åœ¨ä»¥ä¸‹æƒ…å†µ
   * interface ITest<span class="token punctuation">{</span><span class="token punctuation">}</span>
   * class ITestImpl implements ITest<span class="token punctuation">{</span><span class="token punctuation">}</span>;
   * class Main <span class="token punctuation">{</span>
   *     Main(ITest i) <span class="token punctuation">{</span><span class="token punctuation">}</span>
   *     Main(ITestImpl i) <span class="token punctuation">{</span><span class="token punctuation">}</span>
   * <span class="token punctuation">}</span>
   * æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºSpringæ— æ³•å‡†ç¡®å®šä½å“ªä¸ªæ„é€ å‡½æ•°ç¨‹åºè®¾ç½®
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> lenientConstructorResolution <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token comment">// å·¥å‚ç±»å,å¯¹åº”beanå±æ€§factory-bean</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> factoryBeanName<span class="token punctuation">;</span>
  
  <span class="token comment">// å·¥å‚æ–¹æ³•å,å¯¹åº”beanå±æ€§factory-method</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> factoryMethodName<span class="token punctuation">;</span>
  
  <span class="token comment">// è®°å½•æ„é€ å‡½æ•°æ³¨å…¥å±æ€§ï¼Œå¯¹åº”beanå±æ€§constructor-arg</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">ConstructorArgumentValues</span> constructorArgumentValues<span class="token punctuation">;</span>
  
  <span class="token comment">// Beanå±æ€§çš„åç§°ä»¥åŠå¯¹åº”çš„å€¼ï¼Œè¿™é‡Œä¸ä¼šå­˜æ”¾æ„é€ å‡½æ•°ç›¸å…³çš„å‚æ•°å€¼ï¼Œåªä¼šå­˜æ”¾é€šè¿‡setteræ³¨å…¥çš„å€¼</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">MutablePropertyValues</span> propertyValues<span class="token punctuation">;</span>
  
  <span class="token comment">// æ–¹æ³•é‡å†™çš„æŒæœ‰è€…ï¼Œè®°å½•lookup-methodã€replaced-methodå…ƒç´   @Lookup</span>
  <span class="token keyword">private</span> <span class="token class-name">MethodOverrides</span> methodOverrides <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯¹åº”beanå±æ€§init-method</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> initMethodName<span class="token punctuation">;</span>
  
  <span class="token comment">// é”€æ¯æ–¹æ³•ï¼Œå¯¹åº”beanå±æ€§destroy-method</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> destroyMethodName<span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦æ‰§è¡Œinit-method,é»˜è®¤ä¸ºtrue</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> enforceInitMethod <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦æ‰§è¡Œdestroy-method,é»˜è®¤ä¸ºtrue</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> enforceDestroyMethod <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
  <span class="token comment">// æ˜¯å¦æ˜¯ç”¨æˆ·å®šä¹‰çš„è€Œä¸æ˜¯åº”ç”¨ç¨‹åºæœ¬èº«å®šä¹‰çš„ï¼Œåˆ›å»ºAOPæ—¶å€™ä¸ºtrue</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> synthetic <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Beançš„è§’è‰²ï¼Œä¸ºç”¨æˆ·è‡ªå®šä¹‰Bean</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> role <span class="token operator">=</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_APPLICATION</span><span class="token punctuation">;</span>
  
  <span class="token comment">// Beançš„æè¿°ä¿¡æ¯</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>
  
  <span class="token comment">// è¿™ä¸ªbeanå®šä¹‰çš„èµ„æº</span>
  <span class="token annotation punctuation">@Nullable</span>
  <span class="token keyword">private</span> <span class="token class-name">Resource</span> resource<span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ScannedGenericBeanDefinition</li></ul><blockquote><p>ç”¨æ¥æè¿°æ ‡æ³¨<code>@Componentã€@Serviceã€@Controller</code>ç­‰æ³¨è§£æ ‡è®°çš„ç±»ä¼šè§£æä¸º<code> ScannedGenericBeanDefinition</code></p></blockquote><ul><li>AnnotatedGenericBeanDefinition</li></ul><blockquote><p>ç”¨æ¥æè¿°æ ‡æ³¨ä½¿ç”¨äº†<code> @Configuration</code> æ³¨è§£æ ‡è®°é…ç½®ç±»ä¼šè§£æä¸º <code>AnnotatedGenericBeanDefinition</code></p></blockquote><ul><li>ConfigurationClassBeanDefinition</li></ul><blockquote><p>è¿™ä¸ªç±»è´Ÿè´£å°†<code>@Bean</code>æ³¨è§£çš„æ–¹æ³•è½¬æ¢ä¸ºå¯¹åº”çš„<code>ConfigurationClassBeanDefinition</code> ç±»</p></blockquote><p>â€‹ springåˆå§‹åŒ–æ—¶ï¼Œä¼šç”¨GenericBeanDefinitionæˆ–æ˜¯ConfigurationClassBeanDefinitionï¼ˆç”¨@Beanæ³¨è§£æ³¨é‡Šçš„ç±»ï¼‰å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„Beanï¼Œåœ¨åˆå§‹åŒ–Beanæ—¶ï¼Œåˆä¼šå°†å…¶è½¬æ¢ä¸ºRootBeanDefinitionã€‚</p><ul><li>Merged bean definition</li></ul><blockquote><p>â€‹ å®ƒä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œè€Œæ˜¯ Spring å¯¹ BeanDefinition è¿›è¡Œçš„ä¸€ç§åˆå¹¶æ“ä½œã€‚merge æ“ä½œä¼šå°† child çš„å±æ€§ä¸ parent çš„å±æ€§è¿›è¡Œåˆå¹¶ï¼Œå½“æœ‰ç›¸åŒå±æ€§æ—¶ï¼Œä»¥ child çš„ä¸ºå‡†ã€‚<code>AbstractBeanFactory#getMergedLocalBeanDefinition()</code>ï¼Œè¿™æ ·ä½“ç°äº†ç»§æ‰¿çš„å¼ºå¤§ã€‚å±æ€§ä¹Ÿæ‰å®Œæ•´ã€‚</p></blockquote><h4 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h4><p>â€‹ IOCå®¹å™¨è¯»å…¥beançš„æµç¨‹ï¼Œéœ€è¦é¦–å…ˆå®šä¹‰æ”¯æŒçš„èµ„æºï¼Œå¦‚ï¼šClassã€xmlã€Groovyã€jsonç­‰ï¼Œç„¶åå®šä¹‰è¯»å–çš„Pathï¼Œç„¶åä¸ºæ¯ç§ç±»å‹å®šä¹‰Readerè¯»åˆ°å†…å­˜ï¼Œä½¿ç”¨ç›¸å¯¹åº”çš„Parserè½¬åŒ–ä¸ºBeanDefinitionï¼Œå°†å…¶å­˜å‚¨åˆ°ä¸€ä¸ªListä¸­ï¼Œè¯»å–å®Œæˆåï¼Œå¯¹å–çš„å®ä¾‹è¿›è¡Œå®ä¾‹åŒ–(å•ä¾‹)ï¼Œå¯ä»¥é€šè¿‡new/åå°„/åŠ¨æ€ä»£ç†ç­‰å¤šç§æ–¹å¼ï¼Œç„¶åå­˜å‚¨åˆ°Mapä¸­ï¼Œä¿å­˜BeanDefinitionå’Œå…·ä½“å®ä¾‹çš„æ˜ å°„å…³ç³»ã€‚</p><blockquote><p>Resource -&gt; Path -&gt; Parser -&gt; Reader/Scanner -&gt; BeanDefinition -&gt; Register -&gt; ConcurrentHashMap</p></blockquote><hr><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æŠŠè¯¥é…ç½®ç±»ï¼ˆä»¬ï¼‰æ³¨å†Œè¿›æ¥</span>
        <span class="token function">register</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å®¹å™¨å¯åŠ¨æ ¸å¿ƒæ–¹æ³•</span>
        <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//AnnotatedBeanDefinitionReaderæ˜¯ä¸€ä¸ªè¯»å–æ³¨è§£çš„Beanè¯»å–å™¨ï¼Œè¿™é‡Œå°†thisä¼ äº†è¿›å»ã€‚</span>
    <span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä»ä¸Šé¢è¿™ä¸ªæ„é€ å‡½æ•°å¯ä»¥é¡ºä¾¿æä¸€å¥ï¼šå¦‚æœä½ ä»…ä»…æ˜¯è¿™æ ·ApplicationContext applicationContext = new AnnotationConfigApplicationContext()</span>
    <span class="token comment">// å®¹å™¨æ˜¯ä¸ä¼šå¯åŠ¨çš„ï¼ˆä¹Ÿå°±æ˜¯ä¸ä¼šæ‰§è¡Œrefresh()çš„ï¼‰ï¼Œè¿™æ—¶å€™éœ€è¦è‡ªå·±ä¹‹åå†æ‰‹åŠ¨å¯åŠ¨å®¹å™¨</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">,</span> <span class="token string">&quot;At least one annotated class must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> annotatedClass <span class="token operator">:</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">registerBean</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> annotatedClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doRegisterBean</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// å®é™…é€»è¾‘</span>
    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">doRegisterBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> annotatedClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> instanceSupplier<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span>
                            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> qualifiers<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionCustomizer</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> definitionCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// å…ˆæŠŠæ­¤å®ä½“ç±»å‹è½¬æ¢ä¸ºä¸€ä¸ªBeanDefinition</span>
        <span class="token class-name">AnnotatedGenericBeanDefinition</span> abd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedGenericBeanDefinition</span><span class="token punctuation">(</span>annotatedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// abd.getMetadata() å…ƒæ•°æ®åŒ…æ‹¬æ³¨è§£ä¿¡æ¯ã€æ˜¯å¦å†…éƒ¨ç±»ã€ç±»ClassåŸºæœ¬ä¿¡æ¯ç­‰ç­‰</span>
        <span class="token comment">// æ­¤å¤„ç”±conditionEvaluator#shouldSkipå»è¿‡æ»¤ï¼Œæ­¤Classæ˜¯å¦æ˜¯é…ç½®ç±»ã€‚</span>
        <span class="token comment">// å¤§ä½“é€»è¾‘ä¸ºï¼šå¿…é¡»æœ‰@Configurationä¿®é¥°ã€‚ç„¶åè§£æä¸€äº›Conditionæ³¨è§£ï¼Œçœ‹æ˜¯å¦æ’é™¤~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>abd<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        abd<span class="token punctuation">.</span><span class="token function">setInstanceSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è§£æScope</span>
        <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        abd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¾—åˆ°Beançš„åç§° ä¸€èˆ¬ä¸ºé¦–å­—æ¯å°å†™ï¼ˆæ­¤å¤„ä¸ºAnnotationBeanNameGeneratorï¼‰</span>
        <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> name <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è®¾å®šä¸€äº›æ³¨è§£é»˜è®¤å€¼ï¼Œå¦‚lazyã€Primaryç­‰ç­‰</span>
        <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è§£æqualifiersï¼Œè‹¥æœ‰æ­¤æ³¨è§£  åˆ™primaryéƒ½æˆä¸ºtrueäº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>qualifiers <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> qualifier <span class="token operator">:</span> qualifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Primary</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    abd<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Lazy</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    abd<span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    abd<span class="token punctuation">.</span><span class="token function">addQualifier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutowireCandidateQualifier</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‡ªå®šä¹‰å®šåˆ¶ä¿¡æ¯(ä¸€èˆ¬éƒ½ä¸éœ€è¦)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionCustomizer</span> customizer <span class="token operator">:</span> definitionCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            customizer<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>abd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä¸‹é¢ä½è§£æScopeæ˜¯å¦éœ€è¦ä»£ç†ï¼Œæœ€åæŠŠè¿™ä¸ªBeanæ³¨å†Œè¿›å»</span>
        <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>abd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanDefinitionReaderUtils</span><span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="annotatedbeandefinitionreader" tabindex="-1"><a class="header-anchor" href="#annotatedbeandefinitionreader" aria-hidden="true">#</a> AnnotatedBeanDefinitionReader</h3><p>æ„é€ å™¨å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token function">getOrCreateEnvironment</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">&quot;BeanDefinitionRegistry must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>environment<span class="token punctuation">,</span> <span class="token string">&quot;Environment must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>

        <span class="token comment">// ConditionEvaluatorå®Œæˆæ¡ä»¶æ³¨è§£çš„åˆ¤æ–­ï¼Œåœ¨åé¢çš„Spring Bootä¸­æœ‰å¤§é‡çš„åº”ç”¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConditionEvaluator</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> environment<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™å¥ä¼šæŠŠä¸€äº›è‡ªåŠ¨æ³¨è§£å¤„ç†å™¨åŠ å…¥åˆ°AnnotationConfigApplicationContextä¸‹çš„BeanFactoryçš„BeanDefinitionsä¸­  å…·ä½“è§ä¸‹é¢</span>
        <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œå°†AnnotationConfigApplicationContextæ³¨å†Œä¸ºç®¡ç†BeanDefinitionçš„BeanDefinitionRegistryï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œspringä¸­beançš„ç®¡ç†å®Œå…¨äº¤ç»™äº†<code>AnnotationConfigApplicationContext</code></p><p><code> AnnotationConfigUtils#registerAnnotationConfigProcessors()</code> æˆ‘ä»¬è¦ç”¨ä¸€äº›æ³¨è§£æ¯”å¦‚ï¼š<code>@Autowired</code>/<code>@Required</code>/<code>@Resource</code>éƒ½ä¾èµ–äºå„ç§å„æ ·çš„<code>BeanPostProcessor</code>æ¥è§£æï¼ˆAutowiredAnnotationã€RequiredAnnotationã€CommonAnnotationBeanPostProcessorç­‰ç­‰ï¼‰</p><p>â€‹ ä½†æ˜¯å‘è¿™ç§éå¸¸å¸¸ç”¨çš„ï¼Œè®©è°ƒç”¨è€…è‡ªå·±å»ç”³æ˜ï¼Œæ˜¾ç„¶ä½¿ç”¨èµ·æ¥å°±è¿‡é‡äº†ã€‚æ‰€ä»¥Springä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§æä¸ºæ–¹ä¾¿æ³¨å†Œè¿™äº›BeanPostProcessorçš„æ–¹å¼ï¼ˆè‹¥æ˜¯xmlæ–¹å¼ï¼Œé…ç½®<code>&lt;context:annotation- config/&gt;</code>ï¼Œè‹¥æ˜¯å…¨æ³¨è§£é©±åŠ¨çš„ApplicationContextï¼Œå°±é»˜è®¤ä¼šæ‰§è¡Œï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerAnnotationConfigProcessors</span><span class="token punctuation">(</span>
            <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// æŠŠæˆ‘ä»¬çš„beanFactoryä»registryé‡Œè§£æå‡ºæ¥</span>
        <span class="token class-name">DefaultListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">unwrapDefaultListableBeanFactory</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getDependencyComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">setDependencyComparator</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAwareOrderComparator</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ç›¸å½“äºå¦‚æœæ²¡æœ‰è¿™ä¸ªAutowireCandidateResolverï¼Œå°±ç»™è®¾ç½®ä¸€ä»½ContextAnnotationAutowireCandidateResolver</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ContextAnnotationAutowireCandidateResolver</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">setAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextAnnotationAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¿™é‡Œåˆå§‹é•¿åº¦æ”¾4  æ˜¯å› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªä¼šæ³¨å†Œ4ä¸ªBeanPostProcessor å¦‚ä¸‹(ä¸å¤šè¯´äº†)</span>
        <span class="token comment">// BeanDefinitionHolderè§£é‡Šï¼šæŒæœ‰nameå’Œaliases,ä¸ºæ³¨å†Œåšå‡†å¤‡</span>
        <span class="token comment">// Spring 4.2ä¹‹åè¿™ä¸ªæ”¹æˆ6æˆ‘è§‰å¾—æ›´å‡†ç¡®ç‚¹</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClassPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RequiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">REQUIRED_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Check for JSR-250 support, and if present add the CommonAnnotationBeanPostProcessor.</span>
        <span class="token comment">// æ”¯æŒJSR-250çš„ä¸€äº›æ³¨è§£ï¼š@Resourceã€@PostConstructã€@PreDestroyç­‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jsr250Present <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">CommonAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">COMMON_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Check for JPA support, and if present add the PersistenceAnnotationBeanPostProcessor.</span>
        <span class="token comment">// è‹¥å¯¼å…¥äº†å¯¹JPAçš„æ”¯æŒï¼Œé‚£å°±æ³¨å†ŒJPAç›¸å…³æ³¨è§£çš„å¤„ç†å™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>jpaPresent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                def<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="token punctuation">,</span>
                        <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Cannot load optional framework class: &quot;</span> <span class="token operator">+</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_CLASS_NAME</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">PERSISTENCE_ANNOTATION_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// ä¸‹é¢ä¸¤ä¸ªç±»ï¼Œæ˜¯Spring4.2ä¹‹ååŠ å…¥è¿›æ¥çš„ï¼Œä¸ºäº†æ›´å¥½çš„ä½¿ç”¨Springçš„äº‹ä»¶è€Œæä¾›æ”¯æŒ </span>
        <span class="token comment">// æ”¯æŒäº†@EventListeneræ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ­¤æ³¨è§£æ›´æ–¹ä¾¿çš„ç›‘å¬äº‹ä»¶äº†ï¼ˆSpring4.2ä¹‹åï¼‰</span>
        <span class="token comment">// å…·ä½“è¿™ä¸ªProcessorå’ŒListenerFactoryæ€ä¹ˆèµ·ä½œç”¨çš„ï¼Œä¸”å¬äº‹ä»¶ä¸“é¢˜åˆ†è§£</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">EventListenerMethodProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">EVENT_LISTENER_PROCESSOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">RootBeanDefinition</span> def <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">DefaultEventListenerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            def<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
            beanDefs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">registerPostProcessor</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> def<span class="token punctuation">,</span> <span class="token constant">EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> beanDefs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>ConfigurationClassPostProcessor</code>æ˜¯ä¸€ä¸ª<code>BeanFactoryPostProcessor</code>å’Œ<code>BeanDefinitionRegistryPostProcessor</code>å¤„ç†å™¨ï¼Œ<code>BeanDefinitionRegistryPostProcessor</code>çš„å¤„ç†æ–¹æ³•èƒ½å¤„ç†<code>@Configuration</code>ç­‰æ³¨è§£ã€‚<code>ConfigurationClassPostProcessor#postProcessBeanDefinitionRegistry()</code>æ–¹æ³•å†…éƒ¨å¤„ç†<code>@Configuration</code>ï¼Œ<code>@Import</code>ï¼Œ<code>@ImportResource</code>å’Œç±»å†…éƒ¨çš„<code>@Bean</code>ã€‚</li></ul><blockquote><p>â€‹ ConfigurationClassPostProcessorç±»ç»§æ‰¿äº†BeanDefinitionRegistryPostProcessorã€‚BeanDefinitionRegistryPostProcessorç±»ç»§æ‰¿äº†BeanFactoryPostProcessorã€‚ é€šè¿‡<code>BeanDefinitionRegistryPostProcessor</code>å¯ä»¥åˆ›å»ºä¸€ä¸ªç‰¹åˆ«åç½®å¤„ç†å™¨æ¥å°†<code>BeanDefinition</code>æ·»åŠ åˆ°<code>BeanDefinitionRegistry</code>ä¸­ã€‚<strong>å®ƒå’ŒBeanPostProcessorä¸åŒ</strong>ï¼Œ<code>BeanPostProcessor</code>åªæ˜¯åœ¨Beanåˆå§‹åŒ–çš„æ—¶å€™æœ‰ä¸ªé’©å­è®©æˆ‘ä»¬<strong>åŠ å…¥ä¸€äº›è‡ªå®šä¹‰æ“ä½œ</strong>ï¼›è€Œ<code>BeanDefinitionRegistryPostProcessor</code>å¯ä»¥è®©æˆ‘ä»¬åœ¨<code>BeanDefinition</code>ä¸­æ·»åŠ ä¸€äº›è‡ªå®šä¹‰æ“ä½œã€‚åœ¨Mybatisä¸Springçš„æ•´åˆä¸­ï¼Œå°±åˆ©ç”¨åˆ°äº†BeanDefinitionRegistryPostProcessoræ¥å¯¹<strong>Mapperçš„BeanDefinitionè¿›è¡Œäº†åç½®çš„è‡ªå®šä¹‰å¤„ç†</strong>ã€‚</p></blockquote><ul><li><code>AutowiredAnnotationBeanPostProcessor</code>æ˜¯ç”¨æ¥å¤„ç†<code>@Autowired</code>æ³¨è§£å’Œ<code>@Value</code>æ³¨è§£çš„</li><li>RequiredAnnotationBeanPostProcessorè¿™æ˜¯ç”¨æ¥å¤„ç†@Requiredæ³¨è§£</li><li>CommonAnnotationBeanPostProcessoræä¾›å¯¹JSR-250è§„èŒƒæ³¨è§£çš„æ”¯æŒ@Resourceã€@PostConstructå’Œ@PreDestroyç­‰çš„æ”¯æŒã€‚</li><li><code>EventListenerMethodProcessor</code>æä¾›<code>@PersistenceContext</code>çš„æ”¯æŒã€‚</li><li><code>EventListenerMethodProcessor</code>æä¾›<code>@EventListener</code> çš„æ”¯æŒã€‚<code>@EventListener</code>å®åœ¨spring4.2ä¹‹åå‡ºç°çš„ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªBeançš„<strong>æ–¹æ³•ä¸Š</strong>ä½¿ç”¨<code>@EventListener</code>æ³¨è§£æ¥è‡ªåŠ¨æ³¨å†Œä¸€ä¸ª<code>ApplicationListener</code>ã€‚</li></ul><p>â€‹ åˆ°æ­¤<code>AnnotatedBeanDefinitionReader</code>åˆå§‹åŒ–å®Œæ¯•ã€‚ æ€»ç»“ä¸€ä¸‹ï¼Œ<code>AnnotatedBeanDefinitionReader</code>è¯»å–å™¨ç”¨æ¥åŠ è½½classç±»å‹çš„é…ç½®ï¼Œ<strong>åœ¨å®ƒåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šé¢„å…ˆæ³¨å†Œä¸€äº›<code>BeanPostProcessor</code>å’Œ<code>BeanFactoryPostProcessor</code>ï¼Œè¿™äº›å¤„ç†å™¨ä¼šåœ¨æ¥ä¸‹æ¥çš„springåˆå§‹åŒ–æµç¨‹ä¸­è¢«è°ƒç”¨</strong>ã€‚</p><hr><h3 id="classpathbeandefinitionscanner" tabindex="-1"><a class="header-anchor" href="#classpathbeandefinitionscanner" aria-hidden="true">#</a> ClassPathBeanDefinitionScanner</h3><p>æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">,</span>
                                          <span class="token class-name">Environment</span> environment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">&quot;BeanDefinitionRegistry must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>

        <span class="token comment">//useDefaultFiltersä¸ºtrueï¼Œæ‰€ä»¥æ­¤å¤„ä¸€èˆ¬éƒ½ä¼šæ‰§è¡Œ</span>
        <span class="token comment">// å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºfalseï¼Œæ¯”å¦‚@ComponentScané‡Œå°±å¯ä»¥è®¾ç½®ä¸ºfalseï¼Œåªæ‰«ææŒ‡å®šçš„æ³¨è§£/ç±»ç­‰ç­‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è®¾ç½®ç¯å¢ƒ</span>
        <span class="token function">setEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¯¦æƒ…å¦‚ä¸‹ï¼š  è¿™é‡ŒresourceLoaderä¼ å€¼ï¼Œè¿˜æ˜¯æˆ‘ä»¬çš„å·¥å‚ã€‚å¦åˆ™ä¸ºnull</span>
        <span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯æ·»åŠ äº†@Componentè¿™ä¸ªæ³¨è§£çš„</span>
        <span class="token comment">//ï¼ˆç›¸å½“äº@Service @Controller @Respositoryç­‰éƒ½ä¼šæ‰«æï¼Œå› ä¸ºè¿™äº›æ³¨è§£éƒ½å±äº@Componentï¼‰  å¦å¤–@Configurationä¹Ÿå±äºå“¦</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¸‹é¢ä¸¤ä¸ª æ˜¯å…¼å®¹JSR-250çš„@ManagedBeanå’Œ330çš„@Namedæ³¨è§£</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.annotation.ManagedBean&quot;</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-250 &#39;javax.annotation.ManagedBean&#39; found and supported for component scanning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.inject.Named&quot;</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-330 &#39;javax.inject.Named&#39; annotation found and supported for component scanning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// JSR-330 API not available - simply skip.</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³Springè¿ä½ è‡ªå®šä¹‰çš„æ³¨è§£éƒ½æ‰«æï¼Œè‡ªå·±å®ç°ä¸€ä¸ªAnnotationTypeFilterå°±å¯ä»¥å•¦</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <code>ClassPathBeanDefinitionScanner</code>ç»§æ‰¿äº<code>ClassPathScanningCandidateComponentProvider</code>ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤æœ‰ä¸¤ä¸ªfinalç±»å‹çš„Listï¼šè¿™ä¸¤ä¸ªå¯¹è±¡åœ¨æ‰§è¡Œæœ¬ç±»çš„<code>scanCandidateComponents()</code>æ–¹æ³•æ—¶å°±ä¼šèµ·ä½œç”¨ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">// ç»§æ‰¿è‡ªClassPathScanningCandidateComponentProviderï¼Œä¸ºResourcePatternResolverï¼ŒMetadataReaderFactoryå’ŒCandidateComponentsIndexè®¾å®šåˆå§‹å€¼ã€‚</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setResourceLoader</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePatternResolver <span class="token operator">=</span> <span class="token class-name">ResourcePatternUtils</span><span class="token punctuation">.</span><span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Spring5ä»¥åæ‰æœ‰è¿™å¥ï¼Œä¼˜åŒ–äº†beanæ‰«æ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex <span class="token operator">=</span> <span class="token class-name">CandidateComponentsIndexLoader</span><span class="token punctuation">.</span><span class="token function">loadIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePatternResolver<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>ResourcePatternResolver</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç»§æ‰¿äº†<code>ResourceLoader</code>ï¼Œå¯ä»¥ç”¨æ¥è·å–Resource å®ä¾‹ã€‚è¿”å›çš„å®ä¾‹ä¸º<code>PathMatchingResourcePatternResolver</code>ç±»å‹</li><li><code>MetadataReaderFactory</code>ç”¨äºè§£æèµ„æºä¿¡æ¯å¯¹åº”çš„å…ƒæ•°æ®ï¼Œè¿™é‡Œè¿”å›çš„å®ä¾‹ä¸ºï¼š<code>CachingMetadataReaderFactory</code>ï¼Œå¸¦æœ‰ç¼“å­˜çš„</li><li>CandidateComponentsIndexLoader.loadIndex () æ–¹æ³•æ˜¯<code>spring5.0</code>ä»¥ååŠ å…¥çš„æ–°ç‰¹æ€§ï¼ŒSpring Framework 5 æ”¹è¿›äº†æ‰«æå’Œè¯†åˆ«ç»„ä»¶çš„æ–¹æ³•ï¼Œ<strong>ä½¿å¤§å‹é¡¹ç›®çš„æ€§èƒ½å¾—åˆ°æå‡</strong>ã€‚ï¼ˆå…·ä½“æ˜¯é€šè¿‡ç¼–è¯‘å™¨å®Œæˆæ‰«æï¼Œå¹¶ä¸”å¾€æœ¬åœ°å†™ç´¢å¼•ï¼Œç„¶åå¯åŠ¨çš„æ—¶å€™å†å»æ‰«æç´¢å¼•å³å¯çš„æ€è·¯ï¼‰</li></ul><p>â€‹ <strong>è‡³æ­¤ï¼ŒClassPathBeanDefinitionScanneråˆå§‹åŒ–å®Œæ¯•ï¼Œæ€»ç»“ä¸€ä¸‹ï¼š</strong> <code>ClassPathBeanDefinitionScanner</code>æ˜¯ä¸€ä¸ªæ‰«ææŒ‡å®šç±»è·¯å¾„ä¸­æ³¨è§£Beanå®šä¹‰çš„<strong>æ‰«æå™¨</strong>ï¼Œåœ¨å®ƒåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–ä¸€äº›<strong>éœ€è¦è¢«æ‰«æçš„æ³¨è§£</strong>ï¼Œåˆå§‹åŒ–ç”¨äºåŠ è½½åŒ…ä¸‹çš„èµ„æºçš„<code>Loader</code>ã€‚</p><blockquote><p>AnnotatedBeanDefinitionReaderå’ŒClassPathBeanDefinitionScannerçš„åˆå§‹åŒ–æ˜¯springä¸Šçº¿æ–‡åˆå§‹åŒ–çš„<strong>èµ·ç‚¹</strong>ï¼Œå¾ˆå¤š<strong>é¢„åŠ è½½çš„ç±»</strong>ä¼šåœ¨springæ¥ä¸‹æ¥çš„åˆå§‹åŒ–ä¸­å‘æŒ¥é‡è¦ä½œç”¨</p></blockquote><h5 id="åŒ…æ‰«æ" tabindex="-1"><a class="header-anchor" href="#åŒ…æ‰«æ" aria-hidden="true">#</a> åŒ…æ‰«æ</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> <span class="token string">&quot;At least one base package must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¸å¿ƒåœ¨è¿™ä¸ªscanæ–¹æ³•é‡Œï¼Œè§ä¸‹é¢</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>doScançš„é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> <span class="token string">&quot;At least one base package must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è£…è½½æ‰«æåˆ°çš„Bean</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// è¿™ä¸ªæ–¹æ³•æ˜¯æœ€é‡ç‚¹ï¼ŒæŠŠæ‰«æåˆ°çš„Beanå°±æ”¾è¿›æ¥äº†ï¼ˆæ¯”å¦‚æ­¤å¤„åªæœ‰RootConfigä¸€ä¸ªBeanå®šä¹‰ï¼Œæ˜¯ä¸ªé…ç½®ç±»ï¼‰</span>
            <span class="token comment">// è¿™ä¸ªæ˜¯é‡ç‚¹ï¼Œä¼šæŠŠè¯¥åŒ…ä¸‹é¢æ‰€æœ‰çš„Beanéƒ½æ‰«æè¿›å»ã€‚Spring5å’Œä»¥ä¸‹çš„å¤„ç†æ–¹å¼ä¸ä¸€æ ·å“¦~</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‹¿åˆ°Scopeå…ƒæ•°æ®ï¼šæ­¤å¤„ä¸ºsingleton</span>
                <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                candidate<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ç”ŸæˆBeançš„åç§°ï¼Œé»˜è®¤ä¸ºé¦–å­—æ¯å°å†™ã€‚æ­¤å¤„ä¸º&quot;rootConfig&quot;</span>
                <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// æ­¤å¤„ä¸ºæ‰«æçš„Beanï¼Œä¸ºScannedGenericBeanDefinitionï¼Œæ‰€ä»¥è‚¯å®šä¸ºtrue</span>
                <span class="token comment">// å› æ­¤è¿›æ¥ï¼Œæ‰§è¡ŒpostProcessBeanDefinitionï¼ˆå¯¹Beanå®šä¹‰ä¿¡æ¯åšï¼‰   å¦‚ä¸‹è¯¦è§£</span>
                <span class="token comment">// æ³¨æ„ï¼šåªæ˜¯æ·»åŠ äº›é»˜è®¤çš„Beanå®šä¹‰ä¿¡æ¯ï¼Œå¹¶ä¸æ˜¯æ‰§è¡Œåç½®å¤„ç†å™¨~~~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æ˜¾ç„¶ï¼Œæ­¤å¤„ä¹Ÿæ˜¯true  ä¹Ÿæ˜¯å®Œå–„æ¯”å¦‚Beanä¸Šçš„ä¸€äº›æ³¨è§£ä¿¡æ¯ï¼šæ¯”å¦‚@Lazyã€@Primaryã€@DependsOnã€@Roleã€@Description   @Roleæ³¨è§£ç”¨äºBeançš„åˆ†ç±»åˆ†ç»„ï¼Œæ²¡æœ‰å¤ªå¤§çš„ä½œç”¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æ£€æŸ¥è¿™ä¸ªBean  æ¯”å¦‚</span>
                <span class="token comment">// å¦‚æœdaoåŒ…ï¼ˆä¸€èˆ¬é…ç½®çš„basePakageæ˜¯è¿™ä¸ªï¼‰ä¸‹çš„ç±»æ˜¯ç¬¦åˆmybaitsè¦æ±‚çš„åˆ™å‘spring IOCå®¹å™¨ä¸­æ³¨å†Œå®ƒçš„BeanDefinition  æ‰€ä»¥è¿™æ­¥æ£€æŸ¥ç¬¬ä¸‰æ–¹Beançš„æ—¶å€™æœ‰å¿…è¦æ£€æŸ¥ä¸€ä¸‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// AnnotationConfigUtilsç±»çš„applyScopedProxyModeæ–¹æ³•æ ¹æ®æ³¨è§£Beanå®šä¹‰ç±»ä¸­é…ç½®çš„ä½œç”¨åŸŸ@Scopeæ³¨è§£çš„å€¼ï¼Œä¸ºBeanå®šä¹‰åº”ç”¨ç›¸åº”çš„ä»£ç†æ¨¡å¼ï¼Œä¸»è¦æ˜¯åœ¨Springé¢å‘åˆ‡é¢ç¼–ç¨‹(AOP)ä¸­ä½¿ç”¨</span>
                    definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    beanDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// æ³¨æ„ æ³¨æ„ æ³¨æ„ï¼šè¿™é‡Œå·²ç»æŠŠBeanæ³¨å†Œè¿›å»å·¥å‚äº†ï¼Œæ‰€æœ‰doScan()æ–¹æ³•ä¸æ¥æ”¶è¿”å›å€¼ï¼Œä¹Ÿæ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ã€‚ã€‚ã€‚ã€‚</span>
                    <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * ClassPathScanningCandidateComponentProvider#findCandidateComponents
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸Šé¢è¯´è¿‡äº†CandidateComponentsIndexæ˜¯Spring5æä¾›çš„ä¼˜åŒ–æ‰«æçš„åŠŸèƒ½</span>
        <span class="token comment">// æ˜¾ç„¶è¿™é‡Œç¼–è¯‘å™¨æˆ‘ä»¬æ²¡æœ‰å†™META-INF/spring.componentsç´¢å¼•æ–‡ä»¶ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ä¼šæ‰§è¡ŒSpring5 çš„æ‰«ææ–¹å¼ï¼Œæ‰€ä»¥æˆ‘æš‚æ—¶ä¸çœ‹äº†ï¼ˆè¶…å¤§å‹é¡¹ç›®æ‰ä¼šä½¿ç”¨Spring5çš„æ–¹å¼ï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">indexSupportsIncludeFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">addCandidateComponentsFromIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex<span class="token punctuation">,</span> basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Spring 5ä¹‹å‰çš„æ–¹å¼ï¼ˆç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯æ­¤æ–¹å¼ï¼‰</span>
            <span class="token keyword">return</span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * scanCandidateComponentsï¼šæ ¹æ®basePackageæ‰«æå€™é€‰çš„ç»„ä»¶ä»¬ï¼ˆéå¸¸é‡è¦ï¼‰
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.æ ¹æ®æŒ‡å®šåŒ…å ç”ŸæˆåŒ…æœç´¢è·¯å¾„</span>
            <span class="token comment">// é€šè¿‡è§‚å¯ŸresolveBasePackage()æ–¹æ³•çš„å®ç°, æˆ‘ä»¬å¯ä»¥åœ¨è®¾ç½®basePackageæ—¶, ä½¿ç”¨å½¢å¦‚${}çš„å ä½ç¬¦, Springä¼šåœ¨è¿™é‡Œè¿›è¡Œæ›¿æ¢ åªè¦åœ¨Enviromenté‡Œé¢å°±è¡Œ</span>
            <span class="token comment">// æœ¬æ¬¡å€¼ä¸ºï¼šclasspath*:com/fsx/config/**/*.class</span>
            <span class="token class-name">String</span> packageSearchPath <span class="token operator">=</span> <span class="token class-name">ResourcePatternResolver</span><span class="token punctuation">.</span><span class="token constant">CLASSPATH_ALL_URL_PREFIX</span> <span class="token operator">+</span>
                    <span class="token function">resolveBasePackage</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">&#39;/&#39;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePattern<span class="token punctuation">;</span>

            <span class="token comment">// 2.èµ„æºåŠ è½½å™¨ åŠ è½½æœç´¢è·¯å¾„ä¸‹çš„ æ‰€æœ‰class è½¬æ¢ä¸º Resource[]</span>
            <span class="token comment">// æ‹¿ç€ä¸Šé¢çš„è·¯å¾„ï¼Œå°±å¯ä»¥getResourcesè·å–å‡ºæ‰€æœ‰çš„.classç±»ï¼Œè¿™ä¸ªå¾ˆå¼ºå¤§~~~</span>
            <span class="token comment">// çœŸæ­£å¹²äº‹çš„ä¸ºï¼šPathMatchingResourcePatternResolver#getResourcesæ–¹æ³•</span>
            <span class="token comment">// æ­¤å¤„èƒ½æ‰«æåˆ°ä¸¤ä¸ªç±»AppConfigï¼ˆæ™®é€šç±»ï¼Œæ²¡ä»»ä½•æ³¨è§£æ ‡æ³¨ï¼‰å’ŒRootConfigã€‚æ‰€ä»¥æ¥ä¸‹é‡Œå°±æ˜¯è¦è§£æç±»ä¸Šçš„æ³¨è§£ï¼Œä»¥åŠè¿‡æ»¤æ‰ä¸æ˜¯å€™é€‰çš„ç±»ï¼ˆæ¯”å¦‚AppConfigï¼‰</span>

            <span class="token comment">// æ³¨æ„ï¼šè¿™é‡Œä¼šæ‹¿åˆ°ç±»è·¯å¾„ä¸‹ï¼ˆä¸åŒ…å«jaråŒ…å†…çš„ï¼‰çš„æ‰€æœ‰çš„.classæ–‡ä»¶ å¯èƒ½æœ‰ä¸Šç™¾ä¸ªï¼Œç„¶ååé¢å†äº¤ç»™åé¢è¿›è¡Œç­›é€‰~~~~~~~~~~~~~~~~ï¼ˆè¿™ä¸ªæ–¹æ³•ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼‰</span>
            <span class="token comment">// å½“ç„¶å’ŒgetResourcePatternResolverå’Œè¿™ä¸ªæ¨¡ç‰ˆæœ‰å…³</span>
            <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> <span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>packageSearchPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// è®°å½•æ—¥å¿—ï¼ˆä¸‹é¢æˆ‘æŠŠæ‰“å°æ—¥å¿—åœ°æ–¹éƒ½åˆ é™¤ï¼‰</span>
            <span class="token keyword">boolean</span> traceEnabled <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> debugEnabled <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ¥ä¸‹æ¥çš„è¿™ä¸ªforå¾ªç¯ï¼šå°±æ˜¯æŠŠä¸€ä¸ªä¸ªçš„resourceç»„è£…æˆ</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Resource</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ–‡ä»¶å¿…é¡»å¯è¯» å¦åˆ™ç›´æ¥è¿”å›ç©ºäº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>

                        <span class="token comment">// è¯»å–ç±»çš„ æ³¨è§£ä¿¡æ¯ å’Œ ç±»ä¿¡æ¯ ï¼Œä¸¤å¤§ä¿¡æ¯å‚¨å­˜åˆ°  MetadataReader</span>
                        <span class="token class-name">MetadataReader</span> metadataReader <span class="token operator">=</span> <span class="token function">getMetadataReaderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadataReader</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// æ ¹æ®TypeFilterè¿‡æ»¤æ’é™¤ç»„ä»¶ã€‚å› ä¸ºAppConfigæ²¡æœ‰æ ‡å‡†@Componentæˆ–è€…å­æ³¨è§£ï¼Œæ‰€ä»¥è‚¯å®šä¸å±äºå€™é€‰ç»„ä»¶  è¿”å›false</span>
                        <span class="token comment">// æ³¨æ„ï¼šè¿™é‡Œä¸€èˆ¬(é»˜è®¤å¤„ç†çš„æƒ…å†µä¸‹)æ ‡æ³¨äº†é»˜è®¤æ³¨è§£çš„æ‰ä¼štrueï¼Œä»€ä¹ˆå«é»˜è®¤æ³¨è§£å‘¢ï¼Ÿå°±æ˜¯@Componentæˆ–è€…æ´¾ç”Ÿæ³¨è§£ã€‚è¿˜æœ‰javax....çš„ï¼Œè¿™é‡Œçœç•¥å•¦</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCandidateComponent</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token comment">// æŠŠç¬¦åˆæ¡ä»¶çš„ ç±»è½¬æ¢æˆ BeanDefinition</span>
                            <span class="token class-name">ScannedGenericBeanDefinition</span> sbd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScannedGenericBeanDefinition</span><span class="token punctuation">(</span>metadataReader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sbd<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            sbd<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token comment">// å†æ¬¡åˆ¤æ–­ å¦‚æœæ˜¯å®ä½“ç±» è¿”å›true,å¦‚æœæ˜¯æŠ½è±¡ç±»ï¼Œä½†æ˜¯æŠ½è±¡æ–¹æ³• è¢« @Lookup æ³¨è§£æ³¨é‡Šè¿”å›true ï¼ˆæ³¨æ„ è¿™ä¸ªå’Œä¸Šé¢é‚£ä¸ªæ˜¯é‡è½½çš„æ–¹æ³•ï¼‰ </span>
                            <span class="token comment">// è¿™å’Œä¸Šé¢æ˜¯ä¸ªé‡è½½æ–¹æ³•  ä¸ªäººè§‰å¾—æ—¨åœ¨å¤„ç†å¾ªç¯å¼•ç”¨ä»¥åŠ@Lookupä¸Š</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCandidateComponent</span><span class="token punctuation">(</span>sbd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> candidates<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å¤‡æ³¨ï¼šæ­¤æ—¶ComponentScanè¿™ä¸ªæ³¨è§£è¿˜å¹¶æ²¡æœ‰è§£æ</span>



    <span class="token doc-comment comment">/**
     * ClassPathBeanDefinitionScanner#postProcessBeanDefinition
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä¸ºBeanå®šä¹‰ æ‰§è¡Œäº›é»˜è®¤çš„ä¿¡æ¯</span>
        <span class="token comment">// BeanDefinitionDefaultsæ˜¯ä¸ªæ ‡å‡†çš„javaBeanï¼Œæœ‰ä¸€äº›é»˜è®¤å€¼</span>
        beanDefinition<span class="token punctuation">.</span><span class="token function">applyDefaults</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionDefaults<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è‡ªåŠ¨ä¾èµ–æ³¨å…¥ åŒ¹é…è·¯å¾„ï¼ˆæ­¤å¤„ä¸ºnullï¼Œä¸è¿›æ¥ï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autowireCandidatePatterns <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            beanDefinition<span class="token punctuation">.</span><span class="token function">setAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">PatternMatchUtils</span><span class="token punctuation">.</span><span class="token function">simpleMatch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autowireCandidatePatterns<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * AbstractBeanDefinition#applyDefaultsï¼š
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyDefaults</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionDefaults</span> defaults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setLazyInit</span><span class="token punctuation">(</span>defaults<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setAutowireMode</span><span class="token punctuation">(</span>defaults<span class="token punctuation">.</span><span class="token function">getAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setDependencyCheck</span><span class="token punctuation">(</span>defaults<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setInitMethodName</span><span class="token punctuation">(</span>defaults<span class="token punctuation">.</span><span class="token function">getInitMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setEnforceInitMethod</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setDestroyMethodName</span><span class="token punctuation">(</span>defaults<span class="token punctuation">.</span><span class="token function">getDestroyMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setEnforceDestroyMethod</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ç†è§£<code>ClassPathBeanDefinitionScanner</code>çš„å·¥ä½œåŸç†ï¼Œå¯ä»¥å¸®åŠ©ç†è§£<code>Spring IOC</code> å®¹å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚ åŒæ—¶å¯¹ç†è§£MyBatis çš„ Mapper æ‰«æ ä¹Ÿæ˜¯æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚ å› ä¸º <code>MyBatis</code> çš„<code>MapperScannerConfigurer</code>çš„<strong>åº•å±‚å®ç°</strong>ä¹Ÿæ˜¯ä¸€ä¸ª<code>ClassPathBeanDefinitionScanner</code>çš„å­ç±»ã€‚<strong>å°±åƒæˆ‘ä»¬è‡ªå®šä¹‰æ‰«æå™¨é‚£æ ·ï¼Œè‡ªå®šå®šä¹‰äº†è¿‡æ»¤å™¨çš„è¿‡æ»¤è§„åˆ™</strong>ã€‚</p><hr><h3 id="beandefinitionregistry" tabindex="-1"><a class="header-anchor" href="#beandefinitionregistry" aria-hidden="true">#</a> BeanDefinitionRegistry</h3><p><code>BeanDefinitionRegistry</code>æ¥å£æä¾›äº†å‘å®¹å™¨æ³¨å†Œï¼Œåˆ é™¤ï¼Œè·å–BeanDefinitionå¯¹è±¡çš„æ–¹æ³•ã€‚å®ƒå¤§æ¦‚æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ol><li>ä»¥Map&lt;String, BeanDefinition&gt;çš„å½¢å¼æ³¨å†Œbean</li><li>æ ¹æ®beanNameåˆ é™¤å’Œè·å–beanDefiniation</li><li>å¾—åˆ°æŒæœ‰çš„beanDefiniationçš„æ•°ç›®</li><li>æ ¹æ®beanName åˆ¤æ–­æ˜¯å¦åŒ…å«beanDefiniation</li></ol><p>å®ƒçš„é»˜è®¤å®ç°ç±»ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªï¼š<code>SimpleBeanDefinitionRegistry</code>ã€<code>DefaultListableBeanFactory</code>ã€<code>GenericApplicationContext</code></p><h4 id="defaultlistablebeanfactory" tabindex="-1"><a class="header-anchor" href="#defaultlistablebeanfactory" aria-hidden="true">#</a> DefaultListableBeanFactory</h4><p>è¯¥ç±»æ˜¯ <code>BeanDefinitionRegistry</code> æ¥å£çš„åŸºæœ¬å®ç°ç±»ï¼Œä½†åŒæ—¶ä¹Ÿå®ç°å…¶ä»–äº†æ¥å£çš„åŠŸèƒ½ï¼Œè¿™é‡Œåªæ¢ç©¶ä¸‹å…¶å…³äºæ³¨å†Œ <code>BeanDefinition</code> å®ä¾‹çš„ç›¸å…³æ–¹æ³•ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultListableBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAutowireCapableBeanFactory</span>
        <span class="token keyword">implements</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token doc-comment comment">/** Map of bean definition objects, keyed by bean name */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> beanDefinitionMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä¿å­˜æ‰€æœ‰çš„Beanåç§°</span>
    <span class="token doc-comment comment">/** List of bean definition names, in registration order */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> beanDefinitionNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯~~</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">BeanDefinition</span> oldBeanDefinition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœä¸ä¸ºnullï¼Œè¯´æ˜è¿™ä¸ªbeanNameå¯¹åº”çš„Beanå®šä¹‰ä¿¡æ¯å·²ç»å­˜åœ¨äº†~~~~~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ˜¯å¦å…è®¸è¦†ç›–ï¼ˆé»˜è®¤æ˜¯true è¡¨ç¤ºå…è®¸çš„ï¼‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAllowBeanDefinitionOverriding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æŠ›å¼‚å¸¸</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è‹¥å…è®¸è¦†ç›–  é‚£è¿˜å¾—æ¯”è¾ƒä¸‹role  å¦‚æœæ–°è¿›æ¥çš„è¿™ä¸ªBeançš„roleæ›´å¤§	</span>
            <span class="token comment">// æ¯”å¦‚è€çš„æ˜¯ROLE_APPLICATIONï¼ˆ0ï¼‰  æ–°çš„æ˜¯ROLE_INFRASTRUCTURE(2) </span>
            <span class="token comment">// æœ€ç»ˆä¼šæ‰§è¡Œåˆ°putï¼Œä½†æ˜¯æ­¤å¤„è¾“å‡ºä¸€ä¸ªwarnæ—¥å¿—ï¼Œå‘ŠçŸ¥ä½ çš„beanè¢«è¦†ç›–å•¦~~~~~~~ï¼ˆæˆ‘ä»¬è‡ªå·±è¦†ç›–Springæ¡†æ¶å†…çš„beanæ˜¾ç„¶å°±ä¸éœ€è¦warnæç¤ºäº†ï¼‰</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ä»…ä»…è¾“å‡ºä¸€ä¸ªlogger.warn</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æœ€ç»ˆä¼šæ‰§è¡Œputï¼Œä½†æ˜¯å†…å®¹è¿˜ä¸ç›¸åŒ  é‚£å°±æé†’ä¸€ä¸ªinfoä¿¡æ¯å§</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beanDefinition<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>oldBeanDefinition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¾“å‡ºä¸€ä¸ªinfoä¿¡æ¯</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¾“å‡ºä¸€ä¸ªdebugä¿¡æ¯</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æœ€ç»ˆæ·»åŠ è¿›å» ï¼ˆå“ªæ€•å·²ç»å­˜åœ¨äº†~ï¼‰ </span>
            <span class="token comment">// ä»è¿™é‡Œèƒ½çœ‹å‡ºSpringå¯¹æ—¥å¿—è¾“å‡ºçš„ä¸€ä¸ªä¼˜ç§€å¤„ç†ï¼Œæ–¹ä¾¿æˆ‘ä»¬å®šä½é—®é¢˜~~~</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¯·æ³¨æ„ï¼šè¿™é‡ŒbeanNameå¹¶æ²¡æœ‰å†addäº†ï¼Œå› ä¸ºå·²ç»å­˜åœ¨äº†  æ²¡å¿…è¦äº†å˜›</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// hasBeanCreationStarted:è¡¨ç¤ºå·²ç»å­˜åœ¨beanå¼€å§‹åˆ›å»ºäº†ï¼ˆå¼€å§‹getBean()äº†å§~~~ï¼‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanCreationStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ³¨å†Œè¿‡ç¨‹éœ€è¦synchronizedï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§	synchronized (this.beanDefinitionMap) {</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ”¾è¿›å»</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                updatedDefinitions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                updatedDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames <span class="token operator">=</span> updatedDefinitions<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedSingletons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    updatedSingletons<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames <span class="token operator">=</span> updatedSingletons<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Still in startup registration phase</span>
            <span class="token comment">// è¡¨ç¤ºä»ç„¶åœ¨å¯åŠ¨  æ³¨å†Œçš„çŠ¶æ€~~~å°±å¾ˆå¥½å¤„ç†äº† putä»…éœ€ï¼Œåå­—addè¿›å»</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ‰‹åŠ¨æ³¨å†Œçš„BeanNamesé‡Œé¢ç§»é™¤~~~ å› ä¸ºæœ‰Beanå®šä¹‰ä¿¡æ¯äº†ï¼Œæ‰€ä»¥ç°åœ¨ä¸æ˜¯æ‰‹åŠ¨ç›´æ¥æ³¨å†Œçš„Beanå•ä¾‹~~~~</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>manualSingletonNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¿™é‡Œçš„æ„æ€æ˜¯ï¼šä½†å‡¡ä½ æ–°å¢äº†ä¸€ä¸ªæ–°çš„Beanå®šä¹‰ä¿¡æ¯ï¼Œä¹‹å‰å·²ç»å†»ç»“çš„å°±æ¸…ç©ºå‘—~~~</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æœ€åä¸€æ­¥å¾ˆæœ‰æ„æ€ï¼šè€çš„beanå®šä¹‰ä¿¡æ¯ä¸ä¸ºnullï¼ˆbeanNameå·²ç»å­˜åœ¨äº†ï¼‰,æˆ–è€…è¿™ä¸ªbeanNameç›´æ¥æ˜¯ä¸€ä¸ªå•ä¾‹Beanäº†~</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>oldBeanDefinition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åšæ¸…ç†å·¥ä½œï¼š</span>
        <span class="token comment">// clearMergedBeanDefinition(beanName)</span>
        <span class="token comment">// destroySingleton(beanName);  é”€æ¯è¿™ä¸ªå•ä¾‹Bean  å› ä¸ºæœ‰äº†è¯¥beanå®šä¹‰ä¿¡æ¯  æœ€ç»ˆè¿˜æ˜¯ä¼šåˆ›å»ºçš„</span>
        <span class="token comment">// Reset all bean definitions that have the given bean as parent (recursively).  å¤„ç†è¯¥Beanå®šä¹‰çš„getParentName  æœ‰ç›¸åŒçš„ä¹Ÿå¾—åšæ¸…æ¥š  æ‰€ä»¥è¿™é‡Œæ˜¯ä¸ªé€’å½’</span>
        <span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç§»é™¤æ•´ä½“ä¸Šæ¯”è¾ƒç®€å•ï¼šbeanDefinitionMap.remove</span>
        <span class="token comment">// beanDefinitionNames.remove</span>
        <span class="token comment">// resetBeanDefinition(beanName);</span>

        <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™é‡Œå‘ç°ç§»é™¤ï¼Œè‹¥è¿™ä¸ªBeanå®šä¹‰æœ¬æ¥å°±ä¸å­˜åœ¨ï¼Œäº‹æŠ›å¼‚å¸¸ï¼Œè€Œä¸æ˜¯è¿”å›null éœ€è¦æ³¨æ„~~~~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasBeanCreationStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updatedDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                updatedDefinitions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames <span class="token operator">=</span> updatedDefinitions<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">resetBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™ä¸ªå®ç°éå¸¸çš„ç®€å•ï¼Œç›´æ¥ä»mapé‡Œæ‹¿</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> frozenNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>frozenBeanDefinitionNames<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frozenNames <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> frozenNames<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ==========è¿™ä¸ªæ–¹æ³•éå¸¸æœ‰æ„æ€ï¼šå®ƒæ˜¯é—´æ¥çš„å®ç°çš„===============</span>
    <span class="token comment">// å› ä¸ºBeanDefinitionRegistryæœ‰è¿™ä¸ªæ–¹æ³•ï¼Œè€Œå®ƒçš„çˆ¶ç±»AbstractBeanFactoryä¹Ÿæœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¸€ä¸å°å¿ƒï¼Œå°±é—´æ¥çš„å®ç°äº†è¿™ä¸ªæ¥å£æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isBeanNameInUse</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¢åŠ äº†ä¸€ä¸ªhasDependentBean(beanName);  æˆ–è€…è¿™ä¸ªBeanNameæ˜¯ä¾èµ–çš„Bean ä¹Ÿä¼šè®¤ä¸ºè¢«ä½¿ç”¨äº†</span>
        <span class="token keyword">return</span> <span class="token function">isAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">containsLocalBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="genericapplicationcontext" tabindex="-1"><a class="header-anchor" href="#genericapplicationcontext" aria-hidden="true">#</a> GenericApplicationContext</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericApplicationContext</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractApplicationContext</span> <span class="token keyword">implements</span> <span class="token class-name">BeanDefinitionRegistry</span> <span class="token punctuation">{</span>

	<span class="token comment">// è¿™ä¸ªå¾ˆé‡è¦ï¼šå®ƒæŒæœ‰ä¸€ä¸ªDefaultListableBeanFactoryçš„å¼•ç”¨</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DefaultListableBeanFactory</span> beanFactory<span class="token punctuation">;</span>
	
	<span class="token comment">// æ‰€ä»¥ä¸‹é¢æ‰€æœ‰çš„ BeanDefinitionRegistry ç›¸å…³çš„æ–¹æ³•éƒ½æ˜¯å§”æ‰˜ç»™beanFactoryå»åšäº†çš„ï¼Œå› æ­¤çœç•¥~~~</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>AbstractApplicationContext</code>æœ€ç»ˆä¹Ÿæ˜¯å§”æ‰˜ç»™<code>getBeanFactory()</code>å»åšè¿™äº›äº‹ã€‚è€Œæœ€ç»ˆçš„å®ç°éƒ½æ˜¯å®ƒï¼š<code>DefaultListableBeanFactory</code></p><p>å¤‡æ³¨ï¼š<code>AnnotationConfigWebApplicationContext</code>ã€<code>XmlWebApplicationContext</code>éƒ½ç»§æ‰¿è‡ª<code>AbstractRefreshableConfigApplicationContext</code>ï¼Œä»è€Œä¹Ÿæœ€ç»ˆç»§æ‰¿äº†<code>AbstractApplicationContext</code>ã€‚</p><p><code>ApplicationContext</code>ä½“ç³»é‡Œåªæœ‰å­ä½“ç³»<code>GenericApplicationContext</code>ä¸‹æ‰èƒ½ç›´æ¥æ“ä½œæ³¨å†Œä¸­å¿ƒã€‚æ¯”å¦‚å¸¸ç”¨çš„ï¼š<code>GenericXmlApplicationContext</code>å’Œ<code>AnnotationConfigApplicationContext</code>ï¼Œ<code>AnnotationConfigApplicationContext</code>ä½¿ç”¨æ³¨è§£é©±åŠ¨å»æ‰«æBeançš„å®šä¹‰ä¿¡æ¯ã€‚å…ˆç”¨<code>ClassPathBeanDefinitionScanner</code>æŠŠæ–‡ä»¶éƒ½æ‰«æè¿›æ¥ï¼Œç„¶åç”¨<code>AnnotatedBeanDefinitionReader</code>å»loadæ²¡æœ‰é‡Œé¢çš„Beanå®šä¹‰ä¿¡æ¯ã€‚</p></blockquote><h4 id="singletonbeanregistry" tabindex="-1"><a class="header-anchor" href="#singletonbeanregistry" aria-hidden="true">#</a> SingletonBeanRegistry</h4><p>æ­¤æ¥å£æ˜¯é’ˆå¯¹Springä¸­çš„å•ä¾‹Beanè®¾è®¡çš„ã€‚æä¾›äº†ç»Ÿä¸€è®¿é—®å•ä¾‹Beançš„åŠŸèƒ½ã€‚æ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„æ¥å£<code>ConfigurableBeanFactory</code>å°±ç»§æ‰¿äº†æ­¤æ¥å£</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// @since 2.0 Spring2ä¹‹åæ‰å‡ºæ¥è¿™ä¸ªæ¥å£</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SingletonBeanRegistry</span> <span class="token punctuation">{</span>

	<span class="token comment">//  ä»¥æŒ‡å®šçš„åå­—  æŠŠObjectæ”¾è¿›å»</span>
	<span class="token comment">// 1ã€ç»™å®šçš„Objectå¿…é¡»æ˜¯è¢«å®Œå…¨åˆå§‹åŒ–äº†çš„(æ¯”å¦‚newå‡ºæ¥çš„)</span>
	<span class="token comment">// 2ã€æ­¤æ³¨å†Œæ¥å£ä¸ä¼šæä¾›ä»»ä½•ç”¨ä»¥åˆå§‹åŒ–çš„å›è°ƒå‡½æ•°(æ¯”å¦‚ï¼šInitializingBeanã€afterPropertiesSetéƒ½æ˜¯ä¸ä¼šæ‰§è¡Œçš„)</span>
	<span class="token comment">// 3ã€å¦‚æœæ­¤æ¥å£çš„å®ç°ç±»æ˜¯ä¸€ä¸ªBeanFactoryï¼Œæœ€å¥½æœ€å¥½æœ€å¥½å°†ä½ çš„ç±»æ³¨å†ŒæˆBean Definitionè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨å¯¹è±¡(è¿™æ ·å°±å¯ä»¥ä½¿ä½ å®šä¹‰çš„Beanæ”¶åˆ°initializationå’Œdestructionå›è°ƒ)</span>
	<span class="token keyword">void</span> <span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// ä»…ä»…è¿”å›å·²ç»åˆå§‹åŒ–å®Œæˆçš„Beanï¼Œå¯¹äºè¿˜æ²¡æœ‰åˆå§‹åŒ–çš„Bean Definitionä¸äºˆä»¥è€ƒè™‘</span>
	<span class="token comment">// ä½†æ˜¯è¦æ³¨æ„ï¼Œæ­¤æ–¹æ³•**å¹¶ä¸æ”¯æŒä½¿ç”¨åˆ«å**å¯¹Beanè¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœåªæœ‰åˆ«åçš„è¯ï¼Œè¦å…ˆé€šè¿‡BeanFactoryçš„æ¥å£è·å–åˆ°Beanå¯¹åº”çš„å…¨é™å®šåç§°ï¼ˆtransformedBeanName()ï¼‰</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// æ£€æŸ¥æ­¤å®ä¾‹æ˜¯å¦åŒ…å«æŒ‡å®šåå­—çš„å¹¶ä¸”ï¼ï¼ï¼å·²ç»åˆå§‹åŒ–å®Œæˆçš„å•ä¾‹Beanï¼ˆä¸æ”¯æŒåˆ«åæŸ¥æ‰¾ï¼‰</span>
	<span class="token comment">// BeanFactory#containsBeanæ˜¯containsSingleton(beanName) || containsBeanDefinition(beanName)</span>
	<span class="token keyword">boolean</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// è¿”å›å®¹å™¨å†…æ‰€æœ‰å•ä¾‹ç±»çš„åå­—</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getSingletonNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// è¿”å›å®¹å™¨å†…æ³¨å†Œçš„å•ä¾‹ç±»æ•°é‡</span>
	<span class="token keyword">int</span> <span class="token function">getSingletonCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//@since 4.2 mutexï¼šäº’æ–¥é‡  äº’æ–¥ä½“</span>
	<span class="token class-name">Object</span> <span class="token function">getSingletonMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="defaultsingletonbeanregistry" tabindex="-1"><a class="header-anchor" href="#defaultsingletonbeanregistry" aria-hidden="true">#</a> DefaultSingletonBeanRegistry</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å…±äº«beanå®ä¾‹çš„é€šç”¨æ³¨å†Œè¡¨ å®ç°äº†SingletonBeanRegistry. å…è®¸æ³¨å†Œè¡¨ä¸­æ³¨å†Œçš„å•ä¾‹åº”è¯¥è¢«æ‰€æœ‰è°ƒç”¨è€…å…±äº«ï¼Œé€šè¿‡beanåç§°è·å¾—ã€‚ </span>
<span class="token comment">// å¯ä»¥æ³¨å†Œbeanä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæ‰§è¡Œé€‚å½“çš„æ³¨å…¥ã€å…³é—­é¡ºåº</span>
<span class="token comment">// è¿™ä¸ªç±»ä¸»è¦ç”¨ä½œåŸºç±»çš„BeanFactoryå®ç°ï¼Œ æä¾›åŸºæœ¬çš„ç®¡ç† singleton bean å®ä¾‹åŠŸèƒ½</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSingletonBeanRegistry</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleAliasRegistry</span> <span class="token keyword">implements</span> <span class="token class-name">SingletonBeanRegistry</span> <span class="token punctuation">{</span>

    <span class="token comment">// ==========å®ƒé‡Œé¢ç»´æŠ¤äº†éå¸¸éå¸¸å¤šçš„Mapã€Listç­‰  è¿™äº›æ„æˆäº†æˆ‘ä»¬æ‰€è°“çš„å®¹å™¨==========</span>

    <span class="token comment">// å¾ˆæ˜¾ç„¶ï¼šæ‰€æœ‰çš„å•ä¾‹beanæœ€ç»ˆéƒ½ä¼šåˆ°è¿™é‡Œæ¥</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> singletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//ç¼“å­˜äº†beançš„name å’Œ  ObjectFactoryã€‚  å› ä¸ºæœ€ç»ˆçš„Beanéƒ½æ˜¯é€šè¿‡ObjectFactoryçš„å›è°ƒæ–¹æ³•æ¥åˆ›å»ºçš„</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> singletonFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç¼“å­˜äº†å·²ç»å­˜åœ¨å•ä¾‹ï¼Œç”¨äºè§£å†³å¾ªç¯ä¾èµ–çš„æ–¹æ³• å¾ªç¯ä¾èµ–</span>
    <span class="token comment">// æ˜¯å­˜æ”¾singletonFactory åˆ¶é€ å‡ºæ¥çš„ singleton çš„ç¼“å­˜æ—©æœŸå•ä¾‹å¯¹è±¡ç¼“å­˜</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> earlySingletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å·²ç»æ³¨å†Œå¥½çš„å•ä¾‹beançš„åç§°ä»¬  å’Œ singletonObjectsä¿æŒåŒæ­¥</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> registeredSingletons <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ===================ä»¥ä¸Šå››ä¸ªç¼“å­˜æ˜¯è¿™ä¸ªç±»å­˜æ”¾å•ä¾‹beançš„ä¸»è¦Map  ===========================</span>

    <span class="token comment">// ç›®å‰æ­£åœ¨åˆ›å»ºä¸­çš„å•ä¾‹beançš„åç§°çš„é›†åˆ   å­˜ç€æ­£åœ¨åˆå§‹åŒ–çš„Beançº§ä¸è¦å†æ¬¡å‘èµ·åˆå§‹åŒ–äº† ===æ³¨æ„æ˜¯æ­£åœ¨===</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> singletonsCurrentlyInCreation <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ç›´æ¥ç¼“å­˜å½“å‰ä¸èƒ½åŠ è½½çš„bean</span>
    <span class="token comment">// è¿™ä¸ªå€¼æ˜¯ç•™ç»™å¼€å‘è€…è‡ªå·±setçš„ï¼ŒSpringè‡ªå·±ä¸ä¼šå¾€é‡Œé¢æ”¾å€¼~~~~</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> inCreationCheckExclusions <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//å­˜æ”¾å¼‚å¸¸å‡ºç°çš„ç›¸å…³çš„åŸå› çš„é›†åˆ</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span> suppressedExceptions<span class="token punctuation">;</span>
    <span class="token comment">//æ ‡å¿—ï¼ŒæŒ‡ç¤ºæˆ‘ä»¬ç›®å‰æ˜¯å¦åœ¨é”€æ¯å•ä¾‹ä¸­&lt;/span&gt;&lt;span&gt;  </span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> singletonsCurrentlyInDestruction <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// ä¸€æ¬¡æ€§Bean  ä¹Ÿå°±æ˜¯è¯´Beanæ˜¯DisposableBeanæ¥å£çš„å®ç°</span>
    <span class="token comment">// å®ç°DisposableBeanæ¥å£çš„ç±»ï¼Œåœ¨ç±»é”€æ¯æ—¶ï¼Œä¼šè°ƒç”¨destroy()æ–¹æ³•ï¼Œå¼€å‘äººå‘˜å¯ä»¥é‡æ–°è¯¥æ–¹æ³•å®Œæˆè‡ªå·±çš„å·¥ä½œ</span>
    <span class="token comment">// ç›®å‰åƒé‡Œæ·»åŠ çš„åªæœ‰`AbstractBeanFactory#registerDisposableBeanIfNecessary`  å…¶å®è¿˜æ˜¯æ¥è‡ªäº  doCreateBeanæ–¹æ³•</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> disposableBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> containedBeanMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æŸ¥æ‰¾ä¾èµ–çš„ç±»   æˆ‘ä¾èµ–äº†å“ªäº›ä»¬</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dependentBeanMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//è¢«ä¾èµ–çš„bean keyä¸ºbeanName    æˆ‘è¢«å“ªäº›ä»¬ä¾èµ–äº†</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dependenciesForBeanMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ·»åŠ ä¸€ä¸ªå•ä¾‹å¯¹è±¡</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> singletonObject<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>

        <span class="token comment">// æ­¤å¤„åŠ é”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> oldObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ³¨æ„ï¼šæ­¤å¤„æ˜¯å¦‚æœæ­¤å•ä¾‹beanå·²ç»å­˜åœ¨äº†ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸~~~~~</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldObject <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not register object [&quot;</span> <span class="token operator">+</span> singletonObject <span class="token operator">+</span>
                        <span class="token string">&quot;] under bean name &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;: there is already object [&quot;</span> <span class="token operator">+</span> oldObject <span class="token operator">+</span> <span class="token string">&quot;] bound&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ·»åŠ è¿›å»ä¸€ä¸ªå®ä¾‹ï¼Œå®é™…ä¸Šå®ƒåšäº†å¥½å‡ æ­¥æ“ä½œå‘¢</span>
    <span class="token comment">// singletonObjectså’ŒsingletonFactoriesæ˜¯å¯¹ç«‹å…³ç³»  ä¸ä¼šåŒæ—¶å­˜åœ¨</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> singletonObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ³¨æ„æ­¤å¤„ç»§ç»­ä¸Šé”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ·»åŠ è¿›mapç¼“å­˜èµ·æ¥</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å› ä¸ºå·²ç»æ·»åŠ è¿›å»äº†ï¼Œæ‰€ä»¥Factorieså°±å¯è®®ç§»é™¤äº†~~~</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å·²ç»å­˜åœ¨å•ä¾‹ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ä¹Ÿå¯ä»¥ç§»é™¤äº†~~~</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// beanNameæ”¾è¿›å•ä¾‹æ³¨å†Œè¡¨ä¸­  </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ³¨æ„ï¼šå®ƒæ˜¯ä¸€ä¸ªprotectedæ–¹æ³•ï¼Œå¹¶ä¸æ˜¯æ¥å£æ–¹æ³•ã€‚å­ç±»ä¼šå‘è¿™é‡Œæ·»åŠ å·¥å‚çš„~~~</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é¦–å…ˆåˆ¤æ–­ä¸€ä¸‹ï¼šè¿™ä¸ªbeanæ²¡æœ‰è¢«äº§ç”Ÿæ‰éœ€è¦æ·»åŠ å·¥å‚ï¼Œå¦åˆ™å•¥éƒ½ä¸åš~~~</span>
            <span class="token comment">//  åˆ¤æ–­singletonObjectså†…åå­—ä¸ºbeanNameæ˜¯å¦è¢«å ç”¨ï¼Œè‹¥æ²¡æœ‰ï¼Œè¿›è¡Œæ³¨å†Œæ“ä½œ  </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å·²ç»å­˜åœ¨å•ä¾‹ï¼ˆå¾ªç¯ä¾èµ–ï¼‰ä¹Ÿå¯ä»¥ç§»é™¤äº†~~~ </span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ³¨æ„æ³¨æ„æ³¨æ„ï¼šæ­¤å¤„beanNameä¹Ÿç¼“å­˜äº†å“¦~~~ä¸€å®šè¦æ³¨æ„</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// SingletonBeanRegistryæ¥å£çš„getSingletonæ–¹æ³•çš„å®ç° </span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// allowEarlyReferenceï¼šæ˜¯å¦è¦åˆ›å»ºæ—©æœŸå¼•ç”¨</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…ˆæ ¹æ®è¿™ä¸ªbeanNameå»æŸ¥æ‰¾ï¼Œæ‰¾åˆ°valueå€¼</span>
        <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ­¤å¤„ï¼šå¦‚æœæ­¤å•ä¾‹ä¸å­˜åœ¨ï¼Œä¹Ÿä¸è¦ç«‹é©¬å°±è¿”å›nulläº†  è¿˜æœ‰å·¥ä½œéœ€è¦å¤„ç†å‘¢</span>
        <span class="token comment">// è¿™é‡Œçš„æ¡ä»¶æ˜¯ï¼šå¦‚æœå•ä¾‹ä¸å­˜åœ¨ï¼Œå¹¶ä¸”å¹¶ä¸”è¿™ä¸ªbeanæ­£åœ¨åˆ›å»ºä¸­~~~(åœ¨è¿™ä¸ªsingletonsCurrentlyInCreationé›†åˆäº†ï¼Œè¡¨ç¤ºå®ƒæ­£åœ¨åˆ›å»ºä¸­) </span>
        <span class="token comment">// ä»€ä¹ˆæ—¶å€™æ”¾è¿›è¿™ä¸ªé›†åˆè¡¨ç¤ºåˆ›å»ºä¸­å‘¢ï¼Ÿè°ƒç”¨beforeSingletonCreation()æ–¹æ³•ï¼Œå› ä¸ºä»–æ˜¯protectedæ–¹æ³•ï¼Œæ‰€ä»¥åªå…è®¸æœ¬ç±»å’Œå­ç±»è°ƒç”¨~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¿™é‡Œå†å»earlySingletonObjectså»çœ‹ä¸€ä¸‹ï¼Œçœ‹æ˜¯å¦æœ‰å‘¢   å¦‚æœæœ‰ç›´æ¥è¿”å›å³å¯</span>
                singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// å¦‚æœè¿˜ä¸ºnullï¼Œå¹¶ä¸” å¹¶ä¸”allowEarlyReferenceæ˜¯å…è®¸çš„  ä¹Ÿå°±æ˜¯è¯´æ˜¯å…è®¸åˆ›å»ºä¸€ä¸ªæ—©æœŸå¼•ç”¨çš„ï¼ˆç®€å•çš„è¯´å°±æ˜¯å…ˆå¯ä»¥æŠŠå¼•ç”¨æä¾›å‡ºå»ï¼Œä½†æ˜¯å¹¶è¿˜æ²¡æœ‰å®ŒæˆçœŸæ­£çš„åˆå§‹åŒ–~~~~ï¼‰</span>
                <span class="token comment">// è¿™é‡ŒObjectFactoryå°±å‘æŒ¥å¾ˆå¤§çš„ä½œç”¨äº†~~~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// è‹¥æœ‰å¯¹åº”çš„ObjectFactory é‚£å°±å¯ä»¥ç»§ç»­å¤„ç†</span>
                    <span class="token comment">// å¤‡æ³¨ï¼šsingletonFactoriesè¿™ä¸ªMapåªæœ‰è°ƒç”¨`addSingletonFactory()`æ–¹æ³•çš„æ—¶å€™æ‰å¾€é‡Œæ·»åŠ </span>
                    <span class="token comment">// å®ƒæ˜¯ä¸€ä¸ªprotectedæ–¹æ³•ï¼Œç›®å‰Springè¿˜åªæœ‰åœ¨`AbstractAutowireCapableBeanFactory#doCreateBean`é‡Œæœ‰è¿‡è°ƒç”¨</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// æ³¨æ„æ­¤å¤„ï¼šæŠŠç”Ÿäº§å‡ºæ¥çš„æ”¾è¿›earlySingletonObjectsé‡Œé¢å»ï¼Œè¡¨ç¤ºç”Ÿäº§å‡ºæ¥äº†ä¸€ä¸ªå¼•ç”¨</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// ç„¶åæŠŠsingletonFactorieså¯ä»¥ç§»é™¤äº†ï¼Œå› ä¸ºå¼•ç”¨å·²ç»äº§ç”Ÿäº†~~~</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™ä¸ªæ–¹æ³•è›®é‡è¦çš„ã€‚é¦–å…ˆå®ƒä¸æ˜¯æ¥å£æ–¹æ³•ï¼Œè€Œæ˜¯ä¸€ä¸ªå•çº¯çš„publicæ–¹æ³•~~~</span>
    <span class="token comment">// å®ƒçš„è°ƒç”¨å¤„åªæœ‰ä¸€ä¸ªåœ°æ–¹ï¼šAbstractBeanFactory#doGetBean  åœ¨çœŸæ­£ `if (mbd.isSingleton()) { sharedInstance = getSingleton(...) }`</span>
    <span class="token comment">// å®ƒç¬¬äºŒä¸ªå‚æ•°ä¼ çš„æ˜¯ObjectFactory~~~~~~~å®ç°æœ‰åˆ›å»ºBeanå®ä¾‹çš„é€»è¾‘~~~</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åœ¨é”å†…å·¥ä½œ~~~~</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å¾ˆæ˜¾ç„¶å¦‚æœéƒ½ä¸ä¸ºnulläº†ï¼Œé‚£è¿˜åšä»€ä¹ˆå‘¢  ç›´æ¥è¿”å›å§</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœç›®å‰åœ¨é”€æ¯singellton é‚£å°±æŠ›å¼‚å¸¸å‘—~~~~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInDestruction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//  æŠ›å¼‚å¸¸</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æ ‡è®°è¿™ä¸ªbeanæ­£åœ¨è¢«åˆ›å»º~~~~</span>
                <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> newSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newSingleton <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// çœç•¥	</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment">// é‡Šæ”¾è¿™ä¸ªçŠ¶æ€  è¯´æ˜è¿™ä¸ªbeanå·²ç»åˆ›å»ºå®Œæˆäº†</span>
                    <span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// å¦‚æœæ˜¯æ–°åˆ›å»ºäº†  è¿™é‡Œæ‰§è¡Œä¸€ä¸‹æ·»åŠ   ç¼“å­˜èµ·æ¥~~~~</span>
                <span class="token comment">// å¦‚æœæ˜¯æ—§çš„  æ˜¯ä¸ç”¨æ·»åŠ çš„~~~~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newSingleton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™ä¸¤ä¸ªæ–¹æ³• ä¸€ä¸ªåœ¨Beanåˆ›å»ºå¼€å§‹ä¹‹å‰è¿˜è¡Œã€‚ä¸€ä¸ªåœ¨åˆ›å»ºå®Œæˆåæ‰§è¡Œ finallyé‡Œæ‰§è¡Œ</span>

    <span class="token comment">// è¡¨ç¤ºï¼›beforeSingletonCreation()æ–¹æ³•ç”¨äºè®°å½•åŠ è½½çš„çŠ¶æ€  è¡¨ç¤ºè¯¥Beanå½“å‰æ­£åœ¨åˆå§‹åŒ–ä¸­~~~</span>
    <span class="token comment">// è°ƒç”¨this.singletonsCurrentlyInCreation.add(beanName)å°†å½“å‰æ­£è¦åˆ›å»ºçš„beanè®°å½•åœ¨ç¼“å­˜ä¸­ï¼Œè¿™æ ·ä¾¿å¯ä»¥å¯¹å¾ªç¯ä¾èµ–è¿›è¡Œæ£€æµ‹å•¦</span>
    <span class="token comment">// afterSingletonCreationæ˜¾ç„¶å°±æ˜¯</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inCreationCheckExclusions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inCreationCheckExclusions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Singleton &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; isn&#39;t currently in creation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç›´æ¥æ£€æŸ¥ singleton object å­˜å‚¨å™¨äº†ï¼Œå…¶ä»–çš„å­˜å‚¨å™¨ä¸åšæ£€æŸ¥</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getSingletonNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSingletonCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™ä¸ªæ–¹æ³•  åªæ˜¯ç®€å•çš„æŠŠè¿™ä¸ªMapè¿”å›å‡ºå»äº†~~~~~</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">getSingletonMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="factorybeanregistrysupport" tabindex="-1"><a class="header-anchor" href="#factorybeanregistrysupport" aria-hidden="true">#</a> FactoryBeanRegistrySupport</h5><p>FactoryBeanRegistrySupportæ˜¯ <code>å·¥å‚beanï¼ˆFactoryBeanï¼‰</code>æ³¨å†Œçš„ä¸€ä¸ªè¶…ç±»ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå†…éƒ¨å¤šäº†ä¸€ä¸ªæˆå‘˜å˜é‡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> factoryBeanObjectCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®ƒè´Ÿè´£ç¼“å­˜ç”±<code>å·¥å‚bean</code>äº§ç”Ÿçš„å•ä¾‹beanã€‚å®ƒè¿˜é¢å¤–å¢åŠ äº†ä¸€äº›æ–¹æ³•ï¼Œç”¨äºé€šè¿‡ å·¥å‚beanè·å– å·¥å‚beanæ‰€åˆ›å»ºçš„å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¸‹é¢çœ‹çœ‹æºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ç»§æ‰¿è‡ª`DefaultSingletonBeanRegistry` `</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">FactoryBeanRegistrySupport</span> <span class="token keyword">extends</span> <span class="token class-name">DefaultSingletonBeanRegistry</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> factoryBeanObjectCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è·å–factoryBeançš„ç±»å‹ã€‚  å®ƒç›¸å¯¹äºfactoryBean.getObjectType()ä¸»è¦æ˜¯å¢åŠ äº†ä¸€äº›å®‰å…¨æ ¡éªŒ   è¿™é‡Œç›¸å…³æºç æˆ‘éƒ½çœç•¥äº†</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTypeForFactoryBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factoryBean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">.</span><span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿  å·¥å‚Beanåˆ¶é€ å‡ºæ¥çš„å¯¹è±¡</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getCachedObjectForFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ¸å¿ƒæ–¹æ³•ï¼šä»å·¥å‚Beané‡Œé¢æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡~</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> shouldPostProcess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ˜¯å•ä¾‹ï¼Œå¹¶ä¸”å·²ç»å­˜åœ¨è¯¥beanNameäº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// ä»ç„¶é‡‡ç”¨è¿™æŠŠé”  äº’æ–¥é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getSingletonMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> object <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ˜¾ç„¶åªæœ‰factoryBeanObjectCacheé‡Œä¸å­˜åœ¨æ­¤beanï¼Œæ‰éœ€è¦ç»§ç»­å»å·¥å‚Beané‡Œé¢æ‰¾~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å…¶å®å°±åŸºæœ¬ç›¸å½“äº factory.getObject()</span>
                    object <span class="token operator">=</span> <span class="token function">doGetObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> object<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * Post-process the given object that has been obtained from the FactoryBean.
     * The resulting object will get exposed for bean references.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The default implementation simply returns the given object as-is.
     * Subclasses may override this, for example, to apply post-processors.
     * <span class="token keyword">@param</span> <span class="token parameter">object</span> the object obtained from the FactoryBean.
     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span> the name of the bean
     * <span class="token keyword">@return</span> the object to expose
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeansException</span></span> if any post-processing failed
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">postProcessObjectFromFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Overridden to clear the FactoryBean object cache as well.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">removeSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getSingletonMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">removeSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™é‡Œå¤å†™äº†çˆ¶ç±»çš„æ–¹æ³•ã€‚æ³¨æ„ï¼šè°ƒç”¨äº†superçš„æ–¹æ³•</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">clearSingletonCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getSingletonMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">clearSingletonCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanObjectCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è·å–å®‰å…¨ä¸Šä¸‹æ–‡</span>
    <span class="token keyword">protected</span> <span class="token class-name">AccessControlContext</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ å®ƒæœ‰ä¸ªå”¯ä¸€å­ç±»ï¼š<code>AbstractBeanFactory</code>ï¼Œå®ƒå¯è®®è¯´æ˜¯æ•´ä¸ªBeanFactoryå®ç°çš„å¤§è„‘ã€‚å› ä¸º<code>AbstractBeanFactory</code>ç»§æ‰¿è‡ª<code>FactoryBeanRegistrySupport</code>ï¼Œæ‰€ä»¥ä¸ä»…ä»…æœ‰æ³¨å†Œå•ä¾‹Beançš„èƒ½åŠ›ï¼Œä¹Ÿæœ‰æ³¨å†Œå·¥å‚Beançš„èƒ½åŠ›äº†ã€‚</p><hr><h4 id="æ‰‹åŠ¨æ³¨å†Œbeandefinition-ç¼–ç¨‹æ–¹å¼æ³¨å†Œbeanå®šä¹‰" tabindex="-1"><a class="header-anchor" href="#æ‰‹åŠ¨æ³¨å†Œbeandefinition-ç¼–ç¨‹æ–¹å¼æ³¨å†Œbeanå®šä¹‰" aria-hidden="true">#</a> æ‰‹åŠ¨æ³¨å†ŒBeanDefinitionï¼ˆç¼–ç¨‹æ–¹å¼æ³¨å†ŒBeanå®šä¹‰ï¼‰</h4><p>æ‰‹åŠ¨æ³¨å†Œbeançš„ä¸¤ç§æ–¹å¼ï¼š</p><ol><li>å®ç°<code>ImportBeanDefinitionRegistrar</code></li><li>å®ç°<code>BeanDefinitionRegistryPostProcessor</code></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//  BeanDefinitionRegistryPostProcessorå®ƒç»§æ‰¿è‡ªBeanFactoryPostProcessorï¼Œæä¾›æ–¹æ³•ï¼š</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanDefinitionRegistryPostProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">BeanFactoryPostProcessor</span> <span class="token punctuation">{</span>
	<span class="token comment">// è¿™é‡Œå¯ä»¥é€šè¿‡registryï¼Œæˆ‘ä»¬æ‰‹åŠ¨çš„å‘å·¥å‚é‡Œæ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯</span>
	<span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>â€‹ æœ‰ä¸ªé‡è¦å®ç°ç±»:<code>ConfigurationClassPostProcessor</code>ï¼Œå®ƒæ˜¯æ¥å¤„ç†<code>@Configuration</code>é…ç½®æ–‡ä»¶çš„ã€‚å®ƒæœ€ç»ˆå°±æ˜¯è§£æé…ç½®æ–‡ä»¶é‡Œçš„<code>@Importã€@Bean</code>ç­‰ï¼Œç„¶åæŠŠå®šä¹‰ä¿¡æ¯éƒ½æ³¨å†Œè¿›å»ã€‚</p></blockquote><hr><h3 id="aware" tabindex="-1"><a class="header-anchor" href="#aware" aria-hidden="true">#</a> Aware</h3><p>Awareæ¥å£å¯ä»¥è®©beanåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­æ„ŸçŸ¥åˆ°å¤–ç•Œä¿¡æ¯ï¼Œä¸åŒçš„Awareæ¥å£æœ‰ä¸åŒçš„æ„ŸçŸ¥èƒ½åŠ›ã€‚</p><ul><li>ApplicationContextAware</li></ul><blockquote><p>ä¿å­˜å…¨å±€ApplicationContextï¼Œä»è€Œåœ¨éSpringç±»ä¸­è·å–bean</p></blockquote><ul><li>BeanFactoryAware</li></ul><blockquote><p>æŒæœ‰å¯¹beanFactoryï¼Œéœ€è¦å¯¹beanFactoryåšæ“ä½œæ—¶è·å–å®ƒ</p></blockquote><ul><li>BeanNameAwareï¼šå¯ä»¥æ„ŸçŸ¥beanName</li><li>BeanClassLoaderAwareï¼šå¯ä»¥æ„ŸçŸ¥beanClassLoader</li><li>EnvironmentAwareï¼šå¯ä»¥æ„ŸçŸ¥Environment</li><li>ServletContextAwareï¼šå¯ä»¥æ„ŸçŸ¥servletContext</li><li>EmbeddedValueResolverAwareï¼šå¯ä»¥æ„ŸçŸ¥EmbeddedValueResolver</li></ul><hr><h3 id="beandefinitionregistrypostprocessor" tabindex="-1"><a class="header-anchor" href="#beandefinitionregistrypostprocessor" aria-hidden="true">#</a> BeanDefinitionRegistryPostProcessor</h3><blockquote><p>åˆ é™¤beanã€æ›¿æ¢beanå®šä¹‰æˆ–è€…å®ç°ç±»</p></blockquote><h4 id="configurationclasspostprocessor" tabindex="-1"><a class="header-anchor" href="#configurationclasspostprocessor" aria-hidden="true">#</a> ConfigurationClassPostProcessor</h4><p>â€‹ ConfigurationClassPostProcessoræ˜¯Springå†…éƒ¨å¯¹BeanDefinitionRegistryPostProcessoræ¥å£çš„å”¯ä¸€å®ç°ã€‚å…³é”®ä¿¡æ¯æ˜¯ä¸¤æ­¥: <code>parse</code>è§£æ<code>BeanDefinition</code>ï¼Œ<code>reader</code>åŠ è½½åˆ°æ³¨å†Œä¸­å¿ƒã€‚</p><p>è°ƒç”¨è·¯å¾„ï¼š</p><blockquote><p>AbstractApplicationContext#refresh -&gt;</p><p>(ç¬¬5æ­¥) AbstractApplicationContext#invokeBeanFactoryPostProcessors -&gt;</p><p>PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors -&gt;</p><p>BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ ¹æ®BeanDefinitionRegistry,ç”ŸæˆregistryId æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚</span>
        <span class="token keyword">int</span> registryId <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­ï¼Œå¦‚æœè¿™ä¸ªregistryId å·²ç»è¢«æ‰§è¡Œè¿‡äº†ï¼Œå°±ä¸èƒ½å¤Ÿå†æ‰§è¡Œäº†ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å·²ç»æ‰§è¡Œè¿‡çš„registry  é˜²æ­¢é‡å¤æ‰§è¡Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è°ƒç”¨processConfigBeanDefinitions è¿›è¡ŒBeanå®šä¹‰çš„åŠ è½½.ä»£ç å¦‚ä¸‹</span>
        <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ ¹æ®BeanDefinitionRegistry,ç”ŸæˆregistryId æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚</span>
        <span class="token keyword">int</span> registryId <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­ï¼Œå¦‚æœè¿™ä¸ªregistryId å·²ç»è¢«æ‰§è¡Œè¿‡äº†ï¼Œå°±ä¸èƒ½å¤Ÿå†æ‰§è¡Œäº†ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å·²ç»æ‰§è¡Œè¿‡çš„registry  é˜²æ­¢é‡å¤æ‰§è¡Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è°ƒç”¨processConfigBeanDefinitions è¿›è¡ŒBeanå®šä¹‰çš„åŠ è½½.ä»£ç å¦‚ä¸‹</span>
        <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> configCandidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–å·²ç»æ³¨å†Œçš„beanåç§°ï¼ˆæ­¤å¤„è‡³å°‘æœ‰7ä¸ª   6ä¸ªBean+ Applicationï¼‰</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BeanDefinition</span> beanDef <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿™ä¸ªåˆ¤æ–­å¾ˆæœ‰æ„æ€~~~ å¦‚æœä½ çš„beanDefç°åœ¨å°±å·²ç»ç¡®å®šäº†æ˜¯fullæ¨¡å¼ï¼Œè¯´æ˜ä½ è‚¯å®šå·²ç»è¢«è§£æè¿‡äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDef<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> <span class="token operator">+</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ£€æŸ¥æ˜¯å¦æ˜¯@Configurationçš„Class,å¦‚æœæ˜¯å°±æ ‡è®°ä¸‹å±æ€§ï¼šfull æˆ–è€…liteã€‚beanDef.setAttribute(CONFIGURATION_CLASS_ATTRIBUTE, CONFIGURATION_CLASS_FULL) </span>
            <span class="token comment">// åŠ å…¥åˆ°configCandidatesé‡Œä¿å­˜é…ç½®æ–‡ä»¶ç±»çš„å®šä¹‰</span>
            <span class="token comment">// spring bootç¯å¢ƒè‡³å°‘æœ‰Applicationç±»æ˜¯æ»¡è¶³æ¡ä»¶çš„</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                configCandidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Return immediately if no @Configuration classes were found</span>
        <span class="token comment">// å¦‚æœä¸€ä¸ªé…ç½®æ–‡ä»¶ç±»éƒ½æ²¡æ‰¾åˆ°ï¼Œç°åœ¨å°±ä¸éœ€è¦å†ç»§ç»­ä¸‹å»äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Sort by previously determined @Order value, if applicable</span>
        <span class="token comment">// æŠŠé…ç½®æ–‡ä»¶ä»¬ï¼šæŒ‰ç…§@Orderæ³¨è§£è¿›è¡Œæ’åº  è¿™ä¸ªæ„æ€æ˜¯ï¼Œæˆ‘ä»¬@Configurationæ³¨è§£çš„é…ç½®æ–‡ä»¶æ˜¯æ”¯æŒorderæ’åºçš„ã€‚ï¼ˆå¤‡æ³¨ï¼šæ™®é€šbeanä¸è¡Œçš„~~~ï¼‰</span>
        configCandidates<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bd1<span class="token punctuation">,</span> bd2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd1<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd2<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> i2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
        <span class="token comment">// æ­¤å¤„registryæ˜¯DefaultListableBeanFactory è¿™é‡Œä¼šè¿›å»</span>
        <span class="token comment">// å°è¯•ç€ç»™Beanæ‰«ææ–¹å¼ï¼Œä»¥åŠimportæ–¹æ³•çš„BeanNameGeneratorèµ‹å€¼(è‹¥æˆ‘ä»¬éƒ½æ²¡æŒ‡å®šï¼Œé‚£å°±æ˜¯é»˜è®¤çš„AnnotationBeanNameGeneratorï¼šæ‰«æä¸ºé¦–å­—æ¯å°å†™ï¼Œimportä¸ºå…¨ç±»å)</span>
        <span class="token class-name">SingletonBeanRegistry</span> sbr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>registry <span class="token keyword">instanceof</span> <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sbr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> registry<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>localBeanNameGeneratorSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">BeanNameGenerator</span> generator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanNameGenerator</span><span class="token punctuation">)</span> sbr<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>generator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// webç¯å¢ƒï¼Œè¿™é‡Œéƒ½è®¾ç½®äº†StandardServletEnvironment</span>
        <span class="token comment">// ä¸€èˆ¬æ¥è¯´åˆ°æ­¤å¤„ï¼Œenvç¯å¢ƒä¸å¯èƒ½ä¸ºnulläº†~~~ æ­¤å¤„åšä¸€ä¸ªå®¹é”™å¤„ç†~~~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Parse each @Configuration class</span>
        <span class="token comment">// è¿™æ˜¯é‡ç‚¹ï¼šçœŸæ­£è§£æ@Configurationç±»çš„ï¼Œå…¶å®æ˜¯ConfigurationClassParser è¿™ä¸ªè§£æå™¨æ¥åšçš„</span>
        <span class="token comment">// parser åé¢ç”¨äºè§£ææ¯ä¸€ä¸ªé…ç½®ç±»~~~~</span>
        <span class="token class-name">ConfigurationClassParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>problemReporter<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è£…è½½å·²ç»å¤„ç†è¿‡çš„é…ç½®ç±»ï¼Œæœ€å¤§é•¿åº¦ä¸ºï¼šconfigCandidates.size()</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> alreadyParsed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ ¸å¿ƒæ–¹æ³•ï¼šå…·ä½“è¯¦è§£å¦‚ä¸‹</span>
            parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ ¡éªŒ é…ç½®ç±»ä¸èƒ½ä½¿finalçš„ï¼Œå› ä¸ºéœ€è¦ä½¿ç”¨CGLIBç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œè§postProcessBeanFactoryæ–¹æ³•</span>
            parser<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getConfigurationClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configClasses<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>alreadyParsed<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Read the model and create bean definitions based on its content</span>
            <span class="token comment">// å¦‚æœReaderä¸ºnullï¼Œé‚£å°±å®ä¾‹åŒ–ConfigurationClassBeanDefinitionReaderæ¥åŠ è½½Beanï¼Œå¹¶åŠ å…¥åˆ°alreadyParsedä¸­,ç”¨äºå»é‡ï¼ˆé¿å…è­¬å¦‚@ComponentScanç›´æ¥äº’æ‰«ï¼‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassBeanDefinitionReader</span><span class="token punctuation">(</span>
                        registry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sourceExtractor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator<span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// æ­¤å¤„æ³¨æ„ï¼šè°ƒç”¨äº†ConfigurationClassBeanDefinitionReaderçš„loadBeanDefinitionsdçš„åŠ è½½é…ç½®æ–‡ä»¶é‡Œé¢çš„@Bean/@Importä»¬ï¼Œå…·ä½“è®²è§£è¯·å‚è§ä¸‹é¢</span>
            <span class="token comment">// è¿™ä¸ªæ–¹æ³•æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒå†³å®šäº†å‘å®¹å™¨æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯çš„é¡ºåºé—®é¢˜~~~</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
            alreadyParsed<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>

            candidates<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// å¦‚æœregistryä¸­æ³¨å†Œçš„beançš„æ•°é‡ å¤§äº ä¹‹å‰è·å¾—çš„æ•°é‡,åˆ™æ„å‘³ç€åœ¨è§£æè¿‡ç¨‹ä¸­åˆæ–°åŠ å…¥äº†å¾ˆå¤š,é‚£ä¹ˆå°±éœ€è¦å¯¹å…¶è¿›è¡Œè§£ç»§ç»­æ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> candidateNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newCandidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oldCandidateNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>candidateNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> alreadyParsedClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configurationClass <span class="token operator">:</span> alreadyParsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurationClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> candidateName <span class="token operator">:</span> newCandidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token comment">// è¿™ä¸€æ­¥æŒºæœ‰æ„æ€ï¼šè‹¥è€çš„oldCandidateNamesä¸åŒ…å«ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ æ˜¯æ–°è¿›æ¥çš„å€™é€‰çš„Beanå®šä¹‰ä»¬ï¼Œé‚£å°±è¿›ä¸€æ­¥çš„è¿›è¡Œä¸€ä¸ªå¤„ç†</span>
                    <span class="token comment">// æ¯”å¦‚è¿™é‡Œçš„DelegatingWebMvcConfigurationï¼Œä»–å°±æ˜¯æ–°è¿›çš„ï¼Œå› æ­¤å®ƒç»§ç»­å¾€ä¸‹èµ°</span>
                    <span class="token comment">// è¿™ä¸ª@Importè¿›æ¥çš„é…ç½®ç±»æœ€ç»ˆä¼šè¢«ConfigurationClassPostProcessorè¿™ä¸ªåç½®å¤„ç†å™¨çš„postProcessBeanFactory æ–¹æ³•ï¼Œè¿›è¡Œå¤„ç†å’Œcglibå¢å¼º</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldCandidateNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                <span class="token operator">!</span>alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                candidateNames <span class="token operator">=</span> newCandidateNames<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
        <span class="token comment">// å¦‚æœSingletonBeanRegistry ä¸åŒ…å«org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry,</span>
        <span class="token comment">// åˆ™æ³¨å†Œä¸€ä¸ª,bean ä¸º ImportRegistry. ä¸€èˆ¬éƒ½ä¼šè¿›è¡Œæ³¨å†Œçš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sbr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sbr<span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span><span class="token constant">IMPORT_REGISTRY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sbr<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">IMPORT_REGISTRY_BEAN_NAME</span><span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ¸…é™¤ç¼“å­˜ å…ƒæ•°æ®ç¼“å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token keyword">instanceof</span> <span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
            <span class="token comment">// for a shared cache since it&#39;ll be cleared by the ApplicationContext.</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>å¦‚æœç±»ä¸Šæœ‰<code>@Configuration</code>æ³¨è§£è¯´æ˜æ˜¯ä¸€ä¸ªå®Œå…¨<strong>Full</strong>çš„é…ç½®ç±»</li><li>å¦‚æœå¦‚æœç±»ä¸Šé¢æœ‰<code>@Componentï¼Œ@ComponentScanï¼Œ@Importï¼Œ@ImportResource</code>è¿™äº›æ³¨è§£ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªç®€åŒ–é…ç½®ç±»ã€‚å¦‚æœä¸æ˜¯ä¸Šé¢ä¸¤ç§æƒ…å†µï¼Œé‚£ä¹ˆæœ‰<code>@Bean</code>æ³¨è§£ä¿®é¥°çš„æ–¹æ³•ä¹Ÿæ˜¯ç®€åŒ–é…ç½®ç±»ã€‚</li></ol><p>â€‹ Fullæ¨¡å¼å’ŒLiteæ¨¡å¼çš„å”¯ä¸€åŒºåˆ«ï¼šFullæ¨¡å¼çš„é…ç½®ç»„ä»¶ä¼šè¢«enhanceï¼ˆåŠ å¼º/ä»£ç†ï¼‰ï¼Œè€ŒLiteræ¨¡å¼ä¸ä¼šã€‚å…¶ä½™ä½¿ç”¨æ–¹å¼éƒ½ä¸€æ ·ï¼Œæ¯”å¦‚@Beanã€@Importç­‰ç­‰ã€‚å’ŒFullæ¨¡å¼ä¸åŒçš„æ˜¯ï¼Œ<strong>Liteæ¨¡å¼</strong>ä¸èƒ½å£°æ˜Beanä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>å…¥å‚ã€Javaæ–¹æ³•è°ƒç”¨ï¼Œéƒ½ä¸èƒ½è¾¾åˆ°ç›´æ¥æ³¨å…¥çš„æ•ˆæœ</strong>ã€‚ç‰¹åˆ«æ˜¯Javaæ–¹æ³•è°ƒç”¨ï¼Œå°±ç›´æ¥è¿›æ–¹æ³•ä½“äº†ã€‚</p><h5 id="configurationclassparser-parse" tabindex="-1"><a class="header-anchor" href="#configurationclassparser-parse" aria-hidden="true">#</a> ConfigurationClassParser#parse</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> configCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>deferredImportSelectors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> configCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æˆ‘ä»¬ä½¿ç”¨çš„æ³¨è§£é©±åŠ¨ï¼Œæ‰€ä»¥ä¼šåˆ°è¿™ä¸ªparseè¿›æ¥å¤„ç†ã€‚å…¶å®å†…éƒ¨è°ƒç”¨éƒ½æ˜¯processConfigurationClassè¿›è¡Œè§£æçš„</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä½†å‡¡æœ‰æ³¨è§£æ ‡æ³¨çš„ï¼Œéƒ½ä¼šèµ°è¿™é‡Œæ¥è§£æ</span>
                    <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">parse</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Failed to parse configuration class [&quot;</span> <span class="token operator">+</span> bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æœ€æœ€æœ€åé¢æ‰å¤„ç†å®ç°äº†DeferredImportSelectoræ¥å£çš„ç±»ï¼Œæœ€æœ€åå“¦~~</span>
        <span class="token function">processDeferredImportSelectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// ConfigurationConditionç»§æ‰¿è‡ªConditionæ¥å£</span>
        <span class="token comment">// ConfigurationPhaseæšä¸¾ç±»å‹çš„ä½œç”¨ï¼šConfigurationPhaseçš„ä½œç”¨å°±æ˜¯æ ¹æ®æ¡ä»¶æ¥åˆ¤æ–­æ˜¯å¦åŠ è½½è¿™ä¸ªé…ç½®ç±»</span>
        <span class="token comment">// ä¸¤ä¸ªå€¼ï¼šPARSE_CONFIGURATION è‹¥æ¡ä»¶ä¸åŒ¹é…å°±ä¸åŠ è½½æ­¤@Configuration</span>
        <span class="token comment">// REGISTER_BEANï¼šæ— è®ºå¦‚ä½•ï¼Œæ‰€æœ‰@Configurationséƒ½å°†è¢«è§£æã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">PARSE_CONFIGURATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœè¿™ä¸ªé…ç½®ç±»å·²ç»å­˜åœ¨äº†,åé¢åˆè¢«@Importè¿›æ¥äº†~~~ä¼šèµ°è¿™é‡Œ ç„¶ååšå±æ€§åˆå¹¶~</span>
        <span class="token class-name">ConfigurationClass</span> existingClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existingClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    existingClass<span class="token punctuation">.</span><span class="token function">mergeImportedBy</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Otherwise ignore new imported config class; existing non-imported class overrides it.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Explicit bean definition found, probably replacing an import.</span>
                <span class="token comment">// Let&#39;s remove the old one and go with the new one.</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>configClass<span class="token operator">::</span><span class="token function">equals</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Recursively process the configuration class and its superclass hierarchy.</span>
        <span class="token comment">// è¯·æ³¨æ„æ­¤å¤„ï¼šwhileé€’å½’ï¼Œåªè¦æ–¹æ³•ä¸è¿”å›nullï¼Œå°±ä¼šä¸€ç›´doä¸‹å»~~~~~~~~</span>
        <span class="token class-name">SourceClass</span> sourceClass <span class="token operator">=</span> <span class="token function">asSourceClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// doProcessConfigurationClasszè¿™ä¸ªæ–¹æ³•æ˜¯è§£æé…ç½®æ–‡ä»¶çš„æ ¸å¿ƒæ–¹æ³•ï¼Œæ­¤å¤„ä¸åšè¯¦ç»†åˆ†æ</span>
            sourceClass <span class="token operator">=</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>sourceClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¿å­˜æˆ‘ä»¬æ‰€æœ‰çš„é…ç½®ç±»  æ³¨æ„ï¼šå®ƒæ˜¯ä¸€ä¸ªLinkedHashMapï¼Œæ‰€ä»¥æ˜¯æœ‰åºçš„  è¿™ç‚¹è¿˜æ¯”è¾ƒé‡è¦~~~~å’Œbeanå®šä¹‰ä¿¡æ¯æ¯æ¯ç›¸å…³</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// è§£æ@Configurationé…ç½®æ–‡ä»¶ï¼Œç„¶ååŠ è½½è¿›Beançš„å®šä¹‰ä¿¡æ¯ä»¬</span>
    <span class="token comment">// è¿™ä¸ªæ–¹æ³•éå¸¸çš„é‡è¦ï¼Œå¯ä»¥çœ‹åˆ°å®ƒåŠ è½½Beanå®šä¹‰ä¿¡æ¯çš„ä¸€ä¸ªé¡ºåº~~~~</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SourceClass</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">// å…ˆå»çœ‹çœ‹å†…éƒ¨ç±»  è¿™ä¸ªifåˆ¤æ–­æ˜¯Spring5.xåŠ ä¸Šå»çš„ï¼Œè¿™ä¸ªæˆ‘è®¤ä¸ºè¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</span>
        <span class="token comment">// å› ä¸º@Importã€@ImportResourceè¿™ç§å±äºliteæ¨¡å¼çš„é…ç½®ç±»ï¼Œä½†æ˜¯æˆ‘ä»¬å´ä¸è®©ä»–æ”¯æŒå†…éƒ¨ç±»äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAnnotated</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Recursively process any member (nested) classes first</span>
            <span class="token comment">// åŸºæœ¬é€»è¾‘ï¼šå†…éƒ¨ç±»ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼ˆæ”¯æŒliteæ¨¡å¼å’Œfullæ¨¡å¼ï¼Œä¹Ÿæ”¯æŒorderæ’åºï¼‰</span>
            <span class="token comment">// è‹¥ä¸æ˜¯è¢«importè¿‡çš„ï¼Œé‚£å°±é¡ºä¾¿ç›´æ¥è§£æå®ƒï¼ˆprocessConfigurationClassï¼ˆï¼‰ï¼‰  </span>
            <span class="token comment">// å¦å¤–ï¼šè¯¥å†…éƒ¨classå¯ä»¥æ˜¯private  ä¹Ÿå¯ä»¥æ˜¯static~~~(å»ºè®®ç”¨private)</span>
            <span class="token comment">// æ‰€ä»¥å¯ä»¥çœ‹åˆ°ï¼ŒæŠŠ@Beanç­‰å®šä¹‰åœ¨å†…éƒ¨ç±»é‡Œé¢ï¼Œæ˜¯æœ‰åŠ©äºæå‡Beançš„ä¼˜å…ˆçº§çš„~~~~~</span>
            <span class="token function">processMemberClasses</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Process any @PropertySource annotations</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> propertySource <span class="token operator">:</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>
                sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PropertySources</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>PropertySource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">processPropertySource</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring @PropertySource annotation on [&quot;</span> <span class="token operator">+</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Process any @ComponentScan annotations</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">&gt;</span></span> componentScans <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>
                sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScans</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentScans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">REGISTER_BEAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> componentScan <span class="token operator">:</span> componentScans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> scannedBeanDefinitions <span class="token operator">=</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>componentScan<span class="token punctuation">,</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> scannedBeanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinition</span> bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bdCand <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">parse</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Process any @Import annotations</span>
        <span class="token comment">//getImportsæ–¹æ³•çš„å®ç° å¾ˆæœ‰æ„æ€</span>
        <span class="token function">processImports</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">,</span> <span class="token function">getImports</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Process any @ImportResource annotations</span>
        <span class="token class-name">AnnotationAttributes</span> importResource <span class="token operator">=</span>
                <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ImportResource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>importResource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> importResource<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;locations&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanDefinitionReader</span><span class="token punctuation">&gt;</span></span> readerClass <span class="token operator">=</span> importResource<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;reader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> resolvedResource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">resolveRequiredPlaceholders</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                configClass<span class="token punctuation">.</span><span class="token function">addImportedResource</span><span class="token punctuation">(</span>resolvedResource<span class="token punctuation">,</span> readerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Process individual @Bean methods</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> beanMethods <span class="token operator">=</span> <span class="token function">retrieveBeanMethodMetadata</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodMetadata</span> methodMetadata <span class="token operator">:</span> beanMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            configClass<span class="token punctuation">.</span><span class="token function">addBeanMethod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanMethod</span><span class="token punctuation">(</span>methodMetadata<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Process default methods on interfaces</span>
        <span class="token function">processInterfaces</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Process superclass, if any</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasSuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> superclass <span class="token operator">=</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuperClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>superclass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>superclass<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;java&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>superclass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>superclass<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Superclass found, return its annotation metadata and recurse</span>
                <span class="token keyword">return</span> sourceClass<span class="token punctuation">.</span><span class="token function">getSuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// No superclass -&gt; processing is complete</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ConfigurationClass</code>ä»£è¡¨ä¸€ä¸ªé…ç½®ç±»ï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€äº›å·²ç»è§£æå¥½çš„ä½†æ˜¯è¿˜æ²¡æœ‰è¢«åŠ å…¥è¿›Beanå®šä¹‰ä¿¡æ¯çš„åŸå§‹ä¿¡æ¯ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// @since 3.0  å®ƒå°±æ˜¯æ™®é€šçš„ç±»ï¼ŒåŸºæœ¬åªæœ‰get setæ–¹æ³•</span>
final <span class="token keyword">class</span> <span class="token class-name">ConfigurationClass</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> final AnnotationMetadata metadata<span class="token punctuation">;</span>

	<span class="token keyword">private</span> final Resource resource<span class="token punctuation">;</span>

	@Nullable
	<span class="token keyword">private</span> String beanName<span class="token punctuation">;</span>

	<span class="token keyword">private</span> final Set<span class="token operator">&lt;</span>ConfigurationClass<span class="token operator">&gt;</span> importedBy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// å­˜å‚¨è¯¥é…ç½®ç±»é‡Œæ‰€æœ‰æ ‡æ³¨@Beanæ³¨è§£çš„æ–¹æ³•~~~~</span>
	<span class="token keyword">private</span> final Set<span class="token operator">&lt;</span>BeanMethod<span class="token operator">&gt;</span> beanMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// ç”¨Mapä¿å­˜ç€@ImportResource å¯¼å…¥è¿›æ¥çš„èµ„æºä»¬~</span>
	<span class="token keyword">private</span> final Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanDefinitionReader</span><span class="token operator">&gt;&gt;</span> importedResources <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ç”¨Mapä¿å­˜ç€@Importä¸­å®ç°äº†`ImportBeanDefinitionRegistrar`æ¥å£çš„å†…å®¹~</span>
	<span class="token keyword">private</span> final Map<span class="token operator">&lt;</span>ImportBeanDefinitionRegistrar<span class="token punctuation">,</span> AnnotationMetadata<span class="token operator">&gt;</span> importBeanDefinitionRegistrars <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	final Set<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> skippedBeanMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€ç»ˆå½’çº³å‡ºä¸€ä¸ªæ‰«æBeançš„é¡ºåºï¼ˆ<strong>æ³¨æ„å¹¶ä¸æ˜¯Beanå®šä¹‰çœŸæ­£æ³¨å†Œçš„é¡ºåº</strong>ï¼‰ï¼Œè§£æ<code>@Configuration</code>é…ç½®æ–‡ä»¶çš„é¡ºåºï¼š</p><ol><li>å†…éƒ¨é…ç½®ç±»ï¼šå®ƒé‡Œé¢è¿˜å¯ä»¥æœ‰æ™®é€šé…ç½®ç±»ä¸€æ¨¡ä¸€æ ·çš„åŠŸèƒ½ï¼Œä½†ä¼˜å…ˆçº§æœ€é«˜ï¼Œæœ€ç»ˆä¼šæ”¾åœ¨<code>configurationClasses</code>è¿™ä¸ªmapçš„ç¬¬ä¸€ä½</li><li><code>@PropertySource</code>ï¼šè¿™ä¸ªå’ŒBeanå®šä¹‰æ²¡å•¥å…³ç³»äº†ï¼Œå±äºSpringé…ç½®<code>PropertySource</code>çš„èŒƒç•´ã€‚è¿™ä¸ªå±æ€§ä¼˜å…ˆçº§ç›¸å¯¹è¾ƒä½</li><li><code>@ComponentScan</code>ï¼š<code>æ³¨æ„</code>ã€‚ è¿™é‡Œæ‰«æåˆ°çš„Beanå®šä¹‰ï¼Œå°±ç›´æ¥<code>register</code>æ³¨å†Œäº†ï¼Œç›´æ¥æ³¨å†Œäº†ï¼Œæ³¨è§£æ³¨å†Œäº†ã€‚æ‰€ä»¥å®ƒçš„æ—¶æœºæ˜¯éå¸¸æ—©çš„ã€‚ï¼ˆå¦å¤–ï¼šå¦‚æœæ³¨å†Œè¿›å»çš„Beanå®šä¹‰ä¿¡æ¯å¦‚æœè¿˜æ˜¯é…ç½®ç±»ï¼Œè¿™é‡Œä¼šç»§ç»­parse()ï¼Œæ‰€ä»¥æœ€ç»ˆèƒ½è¢«æ‰«æåˆ°çš„ç»„ä»¶ï¼Œæœ€ç»ˆéƒ½ä¼šå½“ä½œä¸€ä¸ªé…ç½®ç±»æ¥å¤„ç†ï¼Œæ‰€ä»¥æœ€ç»ˆéƒ½ä¼šæ”¾è¿›<code>configurationClasses</code>è¿™ä¸ªMapé‡Œé¢å»ï¼‰</li><li><code>@Import</code>ï¼šç›¸å¯¹å¤æ‚ç‚¹ï¼Œå¦‚ä¸‹ï¼š <ol><li>è‹¥å°±æ˜¯ä¸€ä¸ªæ™®é€šç±»ï¼ˆ<strong>æ ‡æ³¨@Configurationä¸å¦éƒ½æ— æ‰€è°“åæ­£ä¼šå½“ä½œä¸€ä¸ªé…ç½®ç±»æ¥å¤„ç†ï¼Œä¹Ÿä¼šæ”¾è¿›<code>configurationClasses</code>ç¼“å­˜è¿›å»</strong>ï¼‰</li><li>å®ç°äº†<code>ImportSelector</code>ï¼šé€’å½’æœ€çº¢éƒ½æˆä¸ºç¬¬ä¸€æ­¥çš„ç±»ã€‚è‹¥å®ç°çš„æ˜¯<code>DeferredImportSelector</code>æ¥å£ï¼Œå®ƒä¼šæ”¾åœ¨<code>deferredImportSelectors</code>å±æ€§é‡Œå…ˆä¿å­˜ç€ï¼Œç­‰ç€å¤–éƒ¨çš„æ‰€æœ‰çš„<code>configCandidates</code>é…ç½®ç±»å…¨éƒ¨è§£æå®Œæˆåï¼Œç»Ÿä¸€<code>processDeferredImportSelectors()</code>ã€‚å®ƒçš„å¤„ç†æ–¹å¼ä¸€æ ·çš„ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è½¬ä¸ºç¬¬ä¸€æ­¥çš„ç±»</li><li>å®ç°äº†<code>ImportBeanDefinitionRegistrar</code>ï¼šæ”¾åœ¨<code>ConfigurationClass.importBeanDefinitionRegistrars</code>å±æ€§é‡Œä¿å­˜ç€</li></ol></li><li><code>@ImportResource</code>ï¼šä¸€èˆ¬ç”¨æ¥å¯¼å…¥xmlæ–‡ä»¶ã€‚å®ƒæ˜¯å…ˆæ”¾åœ¨<code>ConfigurationClass.importedResources</code>å±æ€§é‡Œæ”¾ç€</li><li><code>@Bean</code>ï¼šæ‰¾åˆ°æ‰€æœ‰@Beançš„æ–¹æ³•ï¼Œç„¶åä¿å­˜åˆ°<code>ConfigurationClass.beanMethods</code>å±æ€§é‡Œ</li><li><code>processInterfaces</code>ï¼šå¤„ç†è¯¥ç±»å®ç°çš„æ¥å£ä»¬çš„<code>default</code>æ–¹æ³•ï¼ˆæ ‡æ³¨@Beançš„æœ‰æ•ˆï¼‰</li><li>å¤„ç†çˆ¶ç±»ï¼šæ‹¿åˆ°çˆ¶ç±»ï¼Œæ¯ä¸ªçˆ¶ç±»éƒ½æ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶æ¥å¤„ç†ï¼ˆæ¯”å¦‚è¦æœ‰ä»»ä½•æ³¨è§£ï¼‰ã€‚å¤‡æ³¨ï¼š<code>!superclass.startsWith(&quot;java&quot;)</code>å…¨ç±»åä¸ä»¥javaæ‰“å¤´ï¼Œä¸”<strong>æ²¡æœ‰è¢«å¤„ç†è¿‡</strong>(å› ä¸ºä¸€ä¸ªçˆ¶ç±»å¯è®®Nä¸ªå­ç±»ï¼Œä½†åªèƒ½è¢«å¤„ç†ä¸€æ¬¡)</li><li><code>return null</code>ï¼šè‹¥å…¨éƒ¨å¤„ç†å®Œæˆåå°±è¿”å›nullï¼Œåœæ­¢é€’å½’ã€‚</li></ol><p>ç”±ä¸Šå¯è§ï¼Œè¿™ä¹æ­¥ä¸­ï¼Œå”¯ç‹¬åªæœ‰<code>@ComponentScan</code>æ‰«æåˆ°çš„Beanè¿™ä¸ªæ—¶å€™çš„Beanå®šä¹‰ä¿¡æ¯æ˜¯<strong>å·²ç»æ³¨å†Œä¸Šå»</strong>äº†çš„ï¼Œå…¶ä½™çš„éƒ½è¿˜æ²¡æœ‰çœŸæ­£æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒã€‚</p><blockquote><p>é¡ºåºæ€»ç»“ï¼š@ComponentScan &gt; @Import &gt; @Bean</p></blockquote><h5 id="configurationclassbeandefinitionreader-loadbeandefinitions" tabindex="-1"><a class="header-anchor" href="#configurationclassbeandefinitionreader-loadbeandefinitions" aria-hidden="true">#</a> ConfigurationClassBeanDefinitionReader#loadBeanDefinitions</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ConfigurationClassBeanDefinitionReader</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¯¹æ¯ä¸ª@Configuration ç±»æ–‡ä»¶åšéå†ï¼ˆæ‰€ä»¥ Configé…ç½®æ–‡ä»¶çš„é¡ºåºè¿˜æ˜¯æŒºé‡è¦çš„ï¼‰</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackedConditionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass <span class="token operator">:</span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> trackedConditionEvaluator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// private æ–¹æ³•æ¥è§£ææ¯ä¸€ä¸ªå·²ç»è§£æå¥½çš„@Configurationé…ç½®æ–‡ä»¶~~~</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>
            <span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>trackedConditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> beanName <span class="token operator">=</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">removeBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>importRegistry<span class="token punctuation">.</span><span class="token function">removeImportingClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">registerBeanDefinitionForImportedConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanMethod</span> beanMethod <span class="token operator">:</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">loadBeanDefinitionsForBeanMethod</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">loadBeanDefinitionsFromImportedResources</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadBeanDefinitionsFromRegistrars</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportBeanDefinitionRegistrars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>æœ€å…ˆå¤„ç†æ³¨å†Œ<code>@Import</code>è¿›æ¥çš„Beanå®šä¹‰~ï¼Œåˆ¤æ–­ä¾æ®æ˜¯ï¼š<code>configClass.isImported()</code>ã€‚å®˜æ–¹è§£é‡Šä¸ºï¼š<code>Return whether this configuration class was registered via @{@link Import} or automatically registered due to being nested within another configuration class</code> è¿™å¥è¯çš„æ„æ€æ˜¯è¯´<code>@Import</code>æˆ–è€…å†…éƒ¨ç±»æˆ–è€…é€šè¿‡åˆ«çš„é…ç½®ç±»æ”¾è¿›æ¥çš„éƒ½æ˜¯è¢«å¯¼å…¥è¿›æ¥çš„~~~~</li><li>ç¬¬äºŒæ­¥å¼€å§‹æ³¨å†Œ<code>@Bean</code>è¿›æ¥çš„ï¼šè‹¥æ˜¯staticæ–¹æ³•ï¼Œ<code>beanDef.setBeanClassName(configClass.getMetadata().getClassName()) + beanDef.setFactoryMethodName(methodName)</code>ï¼›è‹¥æ˜¯å®ä¾‹æ–¹æ³•ï¼š<code>beanDef.setFactoryBeanName(configClass.getBeanName())+ beanDef.setUniqueFactoryMethodName(methodName)</code> æ€»ä¹‹å¯¹ä½¿ç”¨è€…æ¥è¯´ æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«</li><li>æ³¨å†Œ<code>importedResources</code>è¿›æ¥çš„beanä»¬ã€‚å°±æ˜¯<code>@ImportResource</code>è¿™é‡Œæ¥çš„Beanå®šä¹‰</li><li>æ‰§è¡Œ<code>ImportBeanDefinitionRegistrar#registerBeanDefinitions()</code>æ³¨å†ŒBeanå®šä¹‰ä¿¡æ¯~ï¼ˆä¹Ÿå°±æ˜¯æ­¤å¤„æ‰§è¡Œ<code>ImportBeanDefinitionRegistrar</code>çš„æ¥å£æ–¹æ³•ï¼‰</li></ol><h5 id="postprocessbeandefinitionregistry-å¤„ç†è¿‡ç¨‹æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#postprocessbeandefinitionregistry-å¤„ç†è¿‡ç¨‹æ€»ç»“" aria-hidden="true">#</a> postProcessBeanDefinitionRegistry()å¤„ç†è¿‡ç¨‹æ€»ç»“</h5><ol><li>ä½¿ç”¨å·¥å…·<code>ConfigurationClassParser</code>å°è¯•å‘ç°æ‰€æœ‰çš„é…ç½®(<code>@Configuration</code>)ç±»</li><li>ä½¿ç”¨å·¥å…·<code>ConfigurationClassBeanDefinitionReader</code>æ³¨å†Œæ‰€å‘ç°çš„é…ç½®ç±»ä¸­æ‰€æœ‰çš„beanå®šä¹‰</li><li>ç»“æŸæ‰§è¡Œçš„<strong>æ¡ä»¶æ˜¯</strong>æ‰€æœ‰é…ç½®ç±»éƒ½è¢«å‘ç°å’Œå¤„ç†,ç›¸åº”çš„<strong>beanå®šä¹‰</strong>æ³¨å†Œåˆ°å®¹å™¨ï¼ˆå†…éƒ¨æœ‰é€’å½’ï¼‰</li></ol><h5 id="configurationclasspostprocessor-postprocessbeanfactoryå¤„ç†é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#configurationclasspostprocessor-postprocessbeanfactoryå¤„ç†é€»è¾‘" aria-hidden="true">#</a> ConfigurationClassPostProcessor#postProcessBeanFactoryå¤„ç†é€»è¾‘</h5><p>è¿™é‡Œå°±æ˜¯å¢å¼ºé…ç½®ç±»ï¼Œæ·»åŠ ä¸€ä¸ª ImportAwareBeanPostProcessorï¼Œè¿™ä¸ªç±»ç”¨æ¥å¤„ç† <code>ImportAware</code> æ¥å£å®ç°ï¼Œæ­¤æ–¹æ³•çš„ä½œç”¨ç”¨ä¸€å¥è¯å¯æ¦‚æ‹¬ä¸ºï¼š<strong>ä¸ºFullæ¨¡å¼çš„Beanä½¿ç”¨CGLIBåšå­—èŠ‚ç æå‡ï¼Œç¡®ä¿æœ€ç»ˆç”Ÿæˆçš„æ˜¯ä»£ç†ç±»å®ä¾‹æ”¾è¿›å®¹å™¨å†…</strong>ã€‚</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>    @Override
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token parameter">ConfigurableListableBeanFactory beanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        int factoryId <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>factoryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>factoryId<span class="token punctuation">)</span><span class="token punctuation">;</span>\
        <span class="token comment">// è¿™ä¸€æ­¥çš„æ„æ€æ˜¯ï¼šå¦‚æœprocessConfigBeanDefinitionsæ²¡è¢«æ‰§è¡Œè¿‡ï¼ˆä¸æ”¯æŒhookçš„æ—¶å€™ä¸ä¼šæ‰§è¡Œï¼‰</span>
        <span class="token comment">// è¿™é‡Œä¼šè¡¥å……å»æ‰§è¡ŒprocessConfigBeanDefinitionsè¿™ä¸ªæ–¹æ³•</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>factoryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// BeanDefinitionRegistryPostProcessor hook apparently not supported...</span>
            <span class="token comment">// Simply call processConfigurationClasses lazily at this point then.</span>
            <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BeanDefinitionRegistry<span class="token punctuation">)</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¿™ä¸ªæ˜¯æ ¸å¿ƒæ–¹æ³•~~~~~~~~~~~~~~</span>
        <span class="token function">enhanceConfigurationClasses</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ·»åŠ ä¸€ä¸ªåç½®å¤„ç†å™¨ã€‚ImportAwareBeanPostProcessorå®ƒæ˜¯ä¸€ä¸ªé™æ€å†…éƒ¨ç±»</span>
        <span class="token comment">// è®°ä½ï¼šå®ƒå®ç°äº†SmartInstantiationAwareBeanPostProcessorè¿™ä¸ªæ¥å£å°±å¯ä»¥äº†ã€‚åé¢ä¼šæœ‰ä½œç”¨çš„</span>
        <span class="token comment">// InstantiationAwareBeanPostProcessoræ˜¯BeanPostProcessorçš„å­æ¥å£ï¼Œå¯ä»¥åœ¨Beanç”Ÿå‘½å‘¨æœŸçš„å¦å¤–ä¸¤ä¸ªæ—¶æœŸæä¾›æ‰©å±•çš„å›è°ƒæ¥å£</span>
        <span class="token comment">// å³å®ä¾‹åŒ–Beanä¹‹å‰ï¼ˆè°ƒç”¨postProcessBeforeInstantiationæ–¹æ³•ï¼‰å’Œå®ä¾‹åŒ–Beanä¹‹åï¼ˆè°ƒç”¨postProcessAfterInstantiationæ–¹æ³•ï¼‰</span>
        beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ImportAwareBeanPostProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>enhanceConfigurationClasses</code>å¦‚ä¸‹ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enhanceConfigurationClasses</span><span class="token punctuation">(</span><span class="token parameter">ConfigurableListableBeanFactory beanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> AbstractBeanDefinition<span class="token operator">&gt;</span> configBeanDefs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ‹¿åˆ°æ‰€æœ‰çš„Beanåç§°ï¼Œå½“å‰ç¯å¢ƒä¸€å…±9ä¸ªï¼ˆ6ä¸ªåŸºç¡€Bean+rootConfig+helloServiceImpl+parentè§†å›¾ç±»ï¼‰</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BeanDefinition beanDef <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ˜¾ç„¶ï¼Œèƒ½è¿›æ¥è¿™ä¸ªæ¡ä»¶çš„ï¼Œå°±åªå‰©rootConfigè¿™ä¸ªç±»å®šä¹‰äº†</span>
            <span class="token comment">// ä»æ­¤å¤„ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæ˜¯liteç‰ˆçš„@Configurationï¼Œæ˜¯ä¸ä¼šå¢å¼ºçš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ConfigurationClassUtils<span class="token punctuation">.</span><span class="token function">isFullConfigurationClass</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanDef <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot enhance @Configuration bean definition &#39;&quot;</span> <span class="token operator">+</span>
                            beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; since it is not stored in an AbstractBeanDefinition subclass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot enhance @Configuration bean definition &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                            <span class="token string">&quot;&#39; since its singleton instance has been created too early. The typical cause &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;is a non-static @Bean method with a BeanDefinitionRegistryPostProcessor &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;return type: Consider declaring such methods as &#39;static&#39;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                configBeanDefs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span>AbstractBeanDefinition<span class="token punctuation">)</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è£…è½½ç€ç­‰å¾…è¢«åŠ å¼ºçš„ä¸€äº›é…ç½®ç±»ä»¬</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configBeanDefs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// nothing to enhance -&gt; return immediately</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ConfigurationClassEnhancer enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> AbstractBeanDefinition<span class="token operator">&gt;</span> entry <span class="token operator">:</span> configBeanDefs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            AbstractBeanDefinition beanDef <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If a @Configuration class gets proxied, always proxy the target class</span>
            beanDef<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>AutoProxyUtils<span class="token punctuation">.</span><span class="token constant">PRESERVE_TARGET_CLASS_ATTRIBUTE</span><span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// Set enhanced subclass of the user-specified bean class</span>
                <span class="token comment">//  æ‹¿åˆ°åŸå§‹çš„rootConfigç±»</span>
                Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> configClass <span class="token operator">=</span> beanDef<span class="token punctuation">.</span><span class="token function">resolveBeanClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token comment">// å¯¹æ­¤ç±»è¿›è¡Œcglibå¢å¼º</span>
                    <span class="token comment">// æ³¨æ„å¢å¼ºåçš„ç±»ä¸ºï¼šclass com.fsx.config.RootConfig$$EnhancerBySpringCGLIB$$13993c97</span>
                    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> enhancedClass <span class="token operator">=</span> enhancer<span class="token punctuation">.</span><span class="token function">enhance</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass <span class="token operator">!=</span> enhancedClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Replacing bean definition &#39;%s&#39; existing class &#39;%s&#39; with &quot;</span> <span class="token operator">+</span>
                                    <span class="token string">&quot;enhanced class &#39;%s&#39;&quot;</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> enhancedClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// æŠŠå¢å¼ºåçš„ç±»é…ç½®ç±»setè¿›å»ã€‚</span>
                        <span class="token comment">// æ‰€ä»¥æˆ‘ä»¬getBean()é…ç½®ç±»ï¼Œæ‹¿å‡ºæ¥çš„æ˜¯é…ç½®ç±»çš„ä»£ç†å¯¹è±¡  æ˜¯è¢«CGLIBä»£ç†è¿‡çš„</span>
                        beanDef<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>enhancedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Throwable ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot load configuration class: &quot;</span> <span class="token operator">+</span> beanDef<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Springä¸ºä½•è¦ç”¨cglibå¢å¼ºé…ç½®æ–‡ä»¶<code>@Configuration</code>å‘¢ï¼Ÿ</strong></p><p>â€‹ å…¶å®ä¸Šé¢æåˆ°çš„Fullå’ŒLiteçš„åŒºåˆ«å·²ç»èƒ½å¤Ÿæœ‰æ‰€ç­”æ¡ˆäº†ï¼š æˆ‘ä»¬é€šè¿‡æºç å‘ç°ï¼šåªæœ‰Fullæ¨¡å¼çš„æ‰ä¼šå»å¢å¼ºï¼Œç„¶åå¢å¼ºå¸¦æ¥çš„å¥½å¤„æ˜¯ï¼šSpringå¯ä»¥æ›´å¥½çš„ç®¡ç†Beançš„ä¾èµ–å…³ç³»äº†ã€‚æ¯”å¦‚@Beanä¹‹é—´æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå…¶å®æ˜¯å»Springå®¹å™¨é‡Œå»æ‰¾Beanäº†ï¼Œè€Œå¹¶ä¸æ˜¯å†ç”Ÿæˆäº†ä¸€ä¸ªå®ä¾‹ã€‚ï¼ˆ<strong>å®ƒçš„ç¼ºç‚¹æ˜¯ä½¿ç”¨äº†ä»£ç†ï¼Œå¸¦æ¥çš„æ€§èƒ½å½±å“å®Œå…¨å¯ä»¥å¿½ç•¥</strong>ï¼‰</p><p>å…¶å®è¿™äº›å¯ä»¥é€šè¿‡æˆ‘ä»¬è‡ªå·±ä¹¦å†™ä»£ç æ¥é¿å…ï¼Œä½†æ˜¯Springä¸ºäº†è®©ä»–çš„è‡ªåŠ¨åŒ–è¯†åˆ«æ¥å¾—æ›´åŠ å¼ºå¤§ï¼Œæ‰€ä»¥é‡‡ç”¨ä»£ç†æŠ€æœ¯æ¥æ¥ç®¡è¿™äº›é…ç½®Beançš„ä¾èµ–ï¼Œå¯è°“å¯¹å¼€å‘è€…ååˆ†çš„å‹å¥½ã€‚</p><hr><h5 id="componentscançš„è§£æ" tabindex="-1"><a class="header-anchor" href="#componentscançš„è§£æ" aria-hidden="true">#</a> @ComponentScançš„è§£æ</h5><p>åœ¨<em>ConfigurationClassParser#doProcessConfigurationClass</em>ä¸­ï¼Œè§£æ<code>@ComponentScan</code>å¤§æ¦‚åœ¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SourceClass</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1ã€Process any @PropertySource annotations</span>
        <span class="token comment">//2ã€Process any @ComponentScan annotations ===</span>
	<span class="token operator">==</span><span class="token operator">==</span> è¿™ä¸€æ­¥è§£æï¼Œä¸‹é¢ä¼šå¯¹æºç è¿›è¡Œåˆ†æ <span class="token operator">==</span><span class="token operator">==</span>
        <span class="token comment">//3ã€Process any @Import annotations</span>
        <span class="token comment">//4ã€Process any @ImportResource annotations</span>
        <span class="token comment">//5ã€Process individual @Bean methods</span>
        <span class="token comment">//6ã€Process default methods on interfaces</span>
        <span class="token comment">//7ã€Process superclass, if any</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SourceClass</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
                <span class="token comment">// Process any @ComponentScan annotations</span>
                <span class="token comment">// æ‹¿åˆ°è¯¥ç±»ä¸Šé¢æ‰€æœ‰çš„@ComponentScanæ³¨è§£ï¼ŒåŒ…å«é‡å¤æ³¨è§£</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">&gt;</span></span> componentScans <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>
                sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScans</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¸ä¸ºç©ºï¼Œä¸”æ­¤ç±»ä¸ä¼šè¢«è·³è¿‡,å°±å¼€å§‹è§£æå§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentScans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">REGISTER_BEAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> componentScan <span class="token operator">:</span> componentScans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
                <span class="token comment">// æœ€ç»ˆå§”æ‰˜ç»™äº†componentScanParserå»å®Œæˆè¿™ä»¶äº‹ï¼šè‡³äºcomponentScanParseræ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢æœ‰è§£é‡Š</span>
                <span class="token comment">// å¤‡æ³¨ï¼šè¿™ä¸ªæ–¹æ³•è™½ç„¶æœ‰è¿”å›å€¼ï¼Œä½†æ˜¯å…¶å®å†…éƒ¨éƒ½å·²ç»æŠŠBeanå®šä¹‰ä¿¡æ¯åŠ å…¥åˆ°å·¥å‚é‡Œé¢å»äº†</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> scannedBeanDefinitions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>componentScan<span class="token punctuation">,</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
                <span class="token comment">// è¿™é‡Œé¢æœ‰ä¸€ä¸ªé‡è¦çš„ä¸€æ­¥ï¼Œè¿˜éœ€è¦æŠŠæ¯ä¸ªBeanæ£€æµ‹ä¸€éã€‚å› ä¸ºScanå‡ºæ¥çš„Beanï¼Œè¿˜æœ‰å¯èƒ½æ˜¯@Configurationçš„ï¼Œæˆ–è€…æ ‡æ³¨æœ‰@Importç­‰ç­‰ä¸€äº›åˆ—æ³¨è§£çš„ï¼Œå› æ­¤éœ€è¦å†æ¬¡äº¤ç»™parseä¸€éï¼Œé˜²æ­¢ç–æ¼</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> scannedBeanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinition</span> bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bdCand <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">parse</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="componentscanannotationparser" tabindex="-1"><a class="header-anchor" href="#componentscanannotationparser" aria-hidden="true">#</a> ComponentScanAnnotationParser</h6><p>ä»è®¿é—®æƒé™ï¼ˆDefaultï¼‰æ¥çœ‹ï¼Œå®ƒè¢«å®šä¹‰ä¸ºSpringçš„ä¸€ä¸ªè‡ªå·±å†…éƒ¨ä½¿ç”¨çš„å·¥å…·ç±»ã€‚å®ƒçš„æƒŸä¸€ä¸€ä¸ªpublicæ–¹æ³•ä¸ºï¼š<code>parse()</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> componentScan<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> declaringClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// ç¬¬ä¸€å¥ä»£ç å°±çœ‹å‡ºäº†ç«¯å€ªï¼šåŸæ¥æ‰«æçš„å·¥ä½œæœ€ç»ˆè¿˜æ˜¯å§”æ‰˜ç»™äº†ClassPathBeanDefinitionScannerå»åš</span>
        <span class="token comment">// æ³¨æ„ï¼šuseDefaultFiltersè¿™ä¸ªå€¼ç‰¹åˆ«çš„é‡è¦ï¼Œèƒ½å¤Ÿè§£é‡Šä¼™ä¼´ä»¬ä¸ºä½•è¦é…ç½®çš„åŸå› ~~~ä¸‹é¢è®²è§£å®ƒçš„æ—¶å€™ä¼šæœ‰è¯¦è§£</span>
        <span class="token class-name">ClassPathBeanDefinitionScanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">,</span> componentScan<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;useDefaultFilters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// BeanNameçš„ç”Ÿæˆå™¨ï¼Œæˆ‘ä»¬å¯ä»¥å•ç‹¬åˆ¶å®šã€‚è‹¥ä¸æŒ‡å®šï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½ä¸æŒ‡å®šï¼‰ï¼Œé‚£å°±æ˜¯é»˜è®¤çš„AnnotationBeanNameGenerator</span>
        <span class="token comment">// å®ƒçš„å¤„ç†æ–¹å¼æ˜¯ï¼šç±»åé¦–å­—æ¯å°å†™</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanNameGenerator</span><span class="token punctuation">&gt;</span></span> generatorClass <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;nameGenerator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> useInheritedGenerator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanNameGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> generatorClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scanner<span class="token punctuation">.</span><span class="token function">setBeanNameGenerator</span><span class="token punctuation">(</span>useInheritedGenerator <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator <span class="token operator">:</span>
                <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>generatorClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è¿™ä¸¤ä¸ªå±æ€§å’Œscopeä»£ç†ç›¸å…³çš„ï¼Œè¿™é‡Œç•¥è¿‡ï¼Œä½¿ç”¨è¾ƒå°‘</span>
        <span class="token class-name">ScopedProxyMode</span> scopedProxyMode <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;scopedProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>scopedProxyMode <span class="token operator">!=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scanner<span class="token punctuation">.</span><span class="token function">setScopedProxyMode</span><span class="token punctuation">(</span>scopedProxyMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ScopeMetadataResolver</span><span class="token punctuation">&gt;</span></span> resolverClass <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;scopeResolver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scanner<span class="token punctuation">.</span><span class="token function">setScopeMetadataResolver</span><span class="token punctuation">(</span><span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>resolverClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ§åˆ¶å»æ‰«æå“ªäº›.clsssæ–‡ä»¶çš„æ¨¡ç‰ˆã€‚ä¸€èˆ¬ä¸è®¾ç½®   é»˜è®¤å€¼ä¸ºï¼š**/*.class  å…¨æ‰«å˜›</span>
        scanner<span class="token punctuation">.</span><span class="token function">setResourcePattern</span><span class="token punctuation">(</span>componentScan<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;resourcePattern&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// includeFilterså’ŒexcludeFiltersç®—æ˜¯å†…éƒ¨å¤„ç†æœ€å¤æ‚çš„é€»è¾‘äº†ï¼Œä½†è¿˜å¥½ï¼Œå¯¹ä½¿ç”¨è€…æ˜¯ååˆ†å‹å¥½çš„</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> filter <span class="token operator">:</span> componentScan<span class="token punctuation">.</span><span class="token function">getAnnotationArray</span><span class="token punctuation">(</span><span class="token string">&quot;includeFilters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> typeFilter <span class="token operator">:</span> <span class="token function">typeFiltersFor</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                scanner<span class="token punctuation">.</span><span class="token function">addIncludeFilter</span><span class="token punctuation">(</span>typeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> filter <span class="token operator">:</span> componentScan<span class="token punctuation">.</span><span class="token function">getAnnotationArray</span><span class="token punctuation">(</span><span class="token string">&quot;excludeFilters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> typeFilter <span class="token operator">:</span> <span class="token function">typeFiltersFor</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                scanner<span class="token punctuation">.</span><span class="token function">addExcludeFilter</span><span class="token punctuation">(</span>typeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Spring4.1åå‡ºç°çš„ã€‚å“ªæ€•æˆ‘æ˜¯æ‰«æçš„Beanï¼Œä¹Ÿæ”¯æŒæ‡’åŠ è½½å•¦</span>
        <span class="token keyword">boolean</span> lazyInit <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;lazyInit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lazyInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scanner<span class="token punctuation">.</span><span class="token function">getBeanDefinitionDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¿™é‡Œå±äºæ ¸å¿ƒé€»è¾‘ï¼Œæ ¸å¿ƒé€»è¾‘ï¼Œæ ¸å¿ƒé€»è¾‘</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> basePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> basePackagesArray <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;basePackages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Springåœ¨æ­¤å¤„æœ‰å¼ºå¤§çš„å®¹é”™å¤„ç†ã€‚ç‘ç„¶ä»–æ˜¯æ”¯æŒæ•°ç»„çš„ï¼Œä½†æ˜¯å®ƒè¿™é‡Œä¹Ÿå®¹é”™å¤„ç†ï¼šæ”¯æŒ,;æ¢è¡Œç­‰çš„ç¬¦å·åˆ†éš”å¤„ç†</span>
        <span class="token comment">// å¹¶ä¸”æ›´å¼ºå¤§çš„åœ°æ–¹åœ¨äºï¼šå®ƒæ”¯æŒ${...}è¿™ç§å ä½ç¬¦çš„å½¢å¼ï¼Œéå¸¸çš„å¼ºå¤§ã€‚æˆ‘ä»¬å¯ä»¥åŠ¨æ€çš„è¿›è¡Œæ‰«åŒ…äº†~~~~~å‰å®³äº†æˆ‘çš„å“¥</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> pkg <span class="token operator">:</span> basePackagesArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokenized <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> tokenized<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// basePackageClassesæœ‰æ—¶å€™ä¹ŸæŒºå¥½ä½¿çš„ã€‚å®ƒå¯ä»¥æŒ‡å®šclassï¼Œç„¶åè¿™ä¸ªclassæ‰€åœ¨çš„åŒ…ï¼ˆå«å­åŒ…ï¼‰éƒ½ä¼šè¢«æ‰«æ</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">:</span> componentScan<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;basePackageClasses&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            basePackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœæˆ‘ä»¬æ²¡æœ‰æŒ‡å®šæ­¤å€¼ï¼Œå®ƒä¼šå–å½“å‰é…ç½®ç±»æ‰€åœ¨çš„åŒ…  æ¯”å¦‚SpringBootå°±æ˜¯è¿™ä¹ˆæ¥å¹²çš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>basePackages<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            basePackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span>declaringClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        scanner<span class="token punctuation">.</span><span class="token function">addExcludeFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AbstractTypeHierarchyTraversingFilter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">matchClassName</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> declaringClass<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æœ€åï¼Œæœ€åï¼ŒæŠŠ@ComponentScançš„å±æ€§éƒ½è§£æå¥½äº†ï¼Œå°±äº¤ç»™scannerå»æ‰«æå§  </span>
        <span class="token comment">// å› ä¸ºéƒ½å‡†å¤‡å¥½äº†ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥è°ƒç”¨çš„doScan()å“¦~</span>
        <span class="token keyword">return</span> scanner<span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="classpathbeandefinitionscanner-1" tabindex="-1"><a class="header-anchor" href="#classpathbeandefinitionscanner-1" aria-hidden="true">#</a> ClassPathBeanDefinitionScanner</h6><p>ç±»è·¯å¾„ä¸‹çš„Beanå®šä¹‰æ‰«æå™¨ï¼Œæ„é€ å‡½æ•°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token keyword">boolean</span> useDefaultFilters<span class="token punctuation">,</span>
                                          <span class="token class-name">Environment</span> environment<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ResourceLoader</span> resourceLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token string">&quot;BeanDefinitionRegistry must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>

        <span class="token comment">// æˆ‘ä»¬å‘ç°è¿™ä¸ªuseDefaultFiltersç‰¹åˆ«é‡è¦ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»–æ˜¯trueï¼Œåªä¼šæ‰«æé»˜è®¤çš„æ³¨è§£ä»¬</span>
        <span class="token comment">// è‡³äºæ˜¯å“ªäº›æ³¨è§£ï¼Œçœ‹ä¸‹é¢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useDefaultFilters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">setEnvironment</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setResourceLoader</span><span class="token punctuation">(</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//registerDefaultFilters();</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerDefaultFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @Componentæ˜¾ç„¶é»˜è®¤æ˜¯å¿…é¡»è¦æ‰«æçš„å˜›</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">ClassPathScanningCandidateComponentProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¸‹é¢ä¸¤ä¸ªæ˜¯ï¼Œé»˜è®¤ä¹Ÿæ”¯æŒJSR-250è§„èŒƒçš„`@ManagedBean`å’ŒJSR-330è§„èŒƒçš„@Namedæ³¨è§£(ä½†æ˜¯æˆ‘å¹¶ä¸å»ºè®®å¤§å®¶ä½¿ç”¨ï¼Œè¿˜æ˜¯ä½¿ç”¨Springæºç”Ÿçš„å§)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.annotation.ManagedBean&quot;</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-250 &#39;javax.annotation.ManagedBean&#39; found and supported for component scanning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.inject.Named&quot;</span><span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-330 &#39;javax.inject.Named&#39; annotation found and supported for component scanning&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// JSR-330 API not available - simply skip.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼š@Controllerã€@ControllerAdviceã€@Serviceã€@Repositoryéƒ½å±äº@ComponentèŒƒç•´ã€‚å½“ç„¶è¿˜æœ‰@Configurationå®ƒä¹Ÿæ˜¯ã€‚</p></blockquote><p><code>doScan</code>é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> <span class="token string">&quot;At least one base package must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿™é‡Œé¢findCandidateComponentsæ˜¯æ ¸å¿ƒã€‚</span>
            <span class="token comment">// æ€»ä¹‹å°±æ˜¯æ‰¾åˆ°å€™é€‰çš„Beanå®šä¹‰ä»¬</span>
            <span class="token comment">//findCandidateComponentsè¿™ä¸ªæ–¹æ³•éœ€è¦æ³¨æ„ï¼ŒSpring5ä»¥åèµ°çš„å¯èƒ½ä¼šä»ç´¢å¼•ä¸Šèµ° addCandidateComponentsFromIndex()</span>
            <span class="token comment">// å¦‚æœä¸æ˜¯Spring5  ä¼šèµ°åŸæ¥çš„é€»è¾‘scanCandidateComponents()</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                candidate<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ç»™åˆšæ‰«æå‡ºæ¥çš„Beanå®šä¹‰è®¾ç½®ä¸€äº›é»˜è®¤å€¼</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// è§£æ@Primaryã€@Lazy...ç­‰ç­‰åŸºç¡€æ³¨è§£</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// æ£€æŸ¥ä¸€äº›Beanå®šä¹‰ï¼Œè‹¥ä¹‹å‰å·²ç»å­˜åœ¨äº†ï¼Œçœ‹çœ‹é‡‡ç”¨ä»€ä¹ˆç­–ç•¥å§ï¼ˆè¦†ç›–orä¸ç®¡ï¼Ÿï¼‰</span>
                <span class="token comment">// åŸåˆ™ï¼šåœ¨åŒæ„æ–‡ä»¶å†…ï¼Œè¦†ç›–å§  åœ¨ä¸åŒæ–‡ä»¶å†…  ä¸ç®¡å§~~~~</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    beanDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// å†…éƒ¨å°±å·²ç»æŠŠè¯¥Beanå®šä¹‰æ³¨å†Œè¿›å»äº†ï¼Œæ‰€ä»¥å¤–éƒ¨å¯ä»¥ä¸ç”¨å†é‡å¤æ³¨å†Œäº†</span>
                    <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ˜¯Spring5  ä¼šèµ°è¿™é‡Œï¼ˆå½“ç„¶éœ€è¦ä½ æ‰‹åŠ¨å¼€å¯~~~ï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">indexSupportsIncludeFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">addCandidateComponentsFromIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex<span class="token punctuation">,</span> basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// è€æ–¹å¼ï¼Œç®€å•çš„è¯´ï¼Œå°±æ˜¯ä»ä»ç£ç›˜é‡Œæ‰¾ã€‚åˆ©ç”¨äº†`ResourceLoader`çš„å­æ¥å£ResourcePatternResolver</span>
            <span class="token keyword">return</span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç§æœ‰æ–¹æ³•ï¼Œæ ¹æ®åŸºç¡€åŒ…åï¼Œå»æ‰«ææ‰€æœ‰çš„ç¬¦åˆæ¡ä»¶çš„ç±»~~~</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// è¿™ä¸ªæ„å»ºå‡ºæ¥çš„  æ˜¯åŸºç¡€åŒ…è·¯å¾„ï¼Œå½¢å¦‚ï¼šclasspath*:com/fsx/demo1/**/*.class</span>
        <span class="token comment">// ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼šé¦–å…ˆå®ƒä¼šå»æ‰«æJaråŒ…ï¼ˆå› ä¸ºä»–æ˜¯classpath*ï¼‰,æ‰€ä»¥å¦‚æœæˆ‘ä»¬è·¯å¾„æ˜¯è¿™æ ·çš„ï¼š</span>
        <span class="token comment">// &quot;classpath*:org/springframework/**/*.class&quot;ï¼šå®ƒä¼šæŠŠæ‰€æœ‰çš„Springé‡Œé¢çš„ç±»éƒ½æ‹¿å‡ºæ¥~~~~ æ‰€ä»¥è¿™ä¸ªæ˜¯éœ€è¦æ³¨æ„çš„</span>
        <span class="token comment">// å°æŠ€å·§ï¼šclasspath*:**/*.classç›¸å½“äºæ‹¿åˆ°ä½ æ‰€æœ‰çš„æ‰€æœ‰çš„ç±»ã€‚å¯ä»¥å€ŸåŠ©è¿™ä¸ªçœ‹çœ‹ä½ å·¥ç¨‹é‡Œé¢ä¸€å…±å¤šå°‘ä¸ªç±»ã€‚Springé¡¹ç›®å¤§çº¦1ä¸‡ä¸ªå¾€ä¸Šèµ°~~~~</span>
        <span class="token class-name">String</span> packageSearchPath <span class="token operator">=</span> <span class="token class-name">ResourcePatternResolver</span><span class="token punctuation">.</span><span class="token constant">CLASSPATH_ALL_URL_PREFIX</span> <span class="token operator">+</span> <span class="token function">resolveBasePackage</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token char">&#39;/&#39;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourcePattern<span class="token punctuation">;</span>
        <span class="token comment">// è°ƒç”¨ResourcePatternResolveræ¥å¤„ç†</span>
        <span class="token comment">// æ³¨æ„ï¼šæ­¤å¤„ä½¿ç”¨çš„å®ä¾‹é»˜è®¤ä¸ºï¼šPathMatchingResourcePatternResolver  å½“ç„¶ä½ å¯ä»¥è‡ªå·±setæ¥æŒ‡å®š  ä½†æ˜¯ä¸€èˆ¬éƒ½æ²¡æœ‰å¿…è¦~~~~</span>
        <span class="token class-name">Resource</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> <span class="token function">getResourcePatternResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span>packageSearchPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// ç„¶åä¸€ä¸ªä¸ªéå†ï¼Œçœ‹çœ‹å“ªä¸ªæ˜¯@Componentç»„ä»¶ï¼Œç„¶åå°±æ³¨å†Œè¿›å»</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>@ComponentScan</code>æ”¯æŒæ‰«æJaråŒ…é‡Œé¢çš„<code>@Component</code>è¿›å®¹å™¨ï¼Œ(<code>@Import</code>å½“ç„¶ä¹Ÿå¯ä»¥)ã€‚</p><hr><h3 id="beanfactorypostprocessor" tabindex="-1"><a class="header-anchor" href="#beanfactorypostprocessor" aria-hidden="true">#</a> BeanFactoryPostProcessor</h3><blockquote><p>å¯¹BeanFactoryçš„è®¾ç½®ï¼Œå¦‚å¯¹scopeçš„è®¾ç½®ï¼Œ<code>ignoreDependencyInterface</code>çš„è®¾ç½®</p></blockquote><h3 id="beanpostprocessor" tabindex="-1"><a class="header-anchor" href="#beanpostprocessor" aria-hidden="true">#</a> BeanPostProcessor</h3><blockquote><p>è§£æè‡ªå®šä¹‰æ³¨è§£ç­‰ï¼Œä¸€å…±æœ‰5ä¸ªæ¥å£å…±10ä¸ªå›è°ƒæ–¹æ³•</p></blockquote><h4 id="beanpostprocessor-1" tabindex="-1"><a class="header-anchor" href="#beanpostprocessor-1" aria-hidden="true">#</a> BeanPostProcessor</h4><p>Beanåç½®å¤„ç†å™¨ï¼ˆå’Œåˆå§‹åŒ–ç›¸å…³ï¼‰</p><h5 id="postprocessbeforeinitialization" tabindex="-1"><a class="header-anchor" href="#postprocessbeforeinitialization" aria-hidden="true">#</a> postProcessBeforeInitialization</h5><p>â€‹ åœ¨è°ƒç”¨æ˜¾å¼çš„<code>åˆå§‹åŒ–ä¹‹å‰</code>ï¼ˆinit-methodã€InitializingBeanç­‰ä¹‹å‰ï¼‰å®Œæˆä¸€äº›å®šåˆ¶çš„åˆå§‹åŒ–ä»»åŠ¡ã€‚å¦‚ï¼š</p><ul><li><code>BeanValidationPostProcessor</code>å®ŒæˆJSR-303 @Validæ³¨è§£BeanéªŒè¯</li><li><code>InitDestroyAnnotationBeanPostProcessor</code>ï¼šå®Œæˆ<code>@PostConstruct</code>æ³¨è§£çš„åˆå§‹åŒ–æ–¹æ³•è°ƒç”¨(æ‰€ä»¥å®ƒæ˜¯åœ¨initæ˜¾ç¤ºè°ƒç”¨ä¹‹å‰æ‰§è¡Œçš„)</li><li><code>ApplicationContextAwareProcessor</code>å®Œæˆä¸€äº›Awareæ¥å£çš„æ³¨å…¥ï¼ˆå¦‚EnvironmentAwareã€ResourceLoaderAwareã€ApplicationContextAwareï¼‰</li></ul><h5 id="postprocessafterinitialization" tabindex="-1"><a class="header-anchor" href="#postprocessafterinitialization" aria-hidden="true">#</a> postProcessAfterInitialization</h5><p>â€‹ æ•´ä¸ªåˆå§‹åŒ–éƒ½å®Œå…¨å®Œæ¯•äº†ã€‚åšä¸€äº›äº‹æƒ…ï¼Œå¦‚ï¼š</p><ul><li><code>AspectJAwareAdvisorAutoProxyCreator</code>ï¼šå®Œæˆxmlé£æ ¼çš„AOPé…ç½®(``aop:config`)çš„ç›®æ ‡å¯¹è±¡åŒ…è£…åˆ°AOPä»£ç†å¯¹è±¡</li><li><code>AnnotationAwareAspectJAutoProxyCreator</code>ï¼šå®Œæˆ@Aspectjæ³¨è§£é£æ ¼ï¼ˆ<code>aop:aspectj-autoproxy</code> æˆ– <code>@Aspect</code>ï¼‰çš„AOPé…ç½®çš„ç›®æ ‡å¯¹è±¡åŒ…è£…åˆ°AOPä»£ç†å¯¹è±¡</li></ul><h4 id="mergedbeandefinitionpostprocessor" tabindex="-1"><a class="header-anchor" href="#mergedbeandefinitionpostprocessor" aria-hidden="true">#</a> MergedBeanDefinitionPostProcessor</h4><p>â€‹ åˆå¹¶Beanå®šä¹‰ï¼ˆç»§æ‰¿BeanPostProcessorï¼‰ã€‚<code>postProcessMergedBeanDefinition</code>æ‰§è¡ŒBeanå®šä¹‰çš„åˆå¹¶</p><h4 id="instantiationawarebeanpostprocessor" tabindex="-1"><a class="header-anchor" href="#instantiationawarebeanpostprocessor" aria-hidden="true">#</a> InstantiationAwareBeanPostProcessor</h4><p>â€‹ <code>å®ä¾‹åŒ–</code>Beanï¼ˆç»§æ‰¿è‡ªBeanPostProcessorï¼‰</p><h5 id="postprocessbeforeinstantiation" tabindex="-1"><a class="header-anchor" href="#postprocessbeforeinstantiation" aria-hidden="true">#</a> postProcessBeforeInstantiation</h5><p>â€‹ å®ä¾‹åŒ–ä¹‹å‰æ‰§è¡Œã€‚ç»™è°ƒç”¨è€…ä¸€ä¸ªæœºä¼šï¼Œè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆç›¸å½“äºå¯ä»¥æ‘†è„±Springçš„æŸç¼šï¼Œ<strong>å¯ä»¥è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘</strong>ï¼‰ è‹¥è¿”å›nullï¼Œç»§ç»­åç»­Springçš„é€»è¾‘ã€‚è‹¥è¿”å›ä¸ä¸ºnullï¼Œå°±æœ€åé¢éƒ½<code>ä»…ä»…åª</code>æ‰§è¡Œ <code>BeanPostProcessor #postProcessAfterInitialization</code>è¿™ä¸€ä¸ªå›è°ƒæ–¹æ³•äº†ã€‚å¦‚ï¼š</p><ul><li>å½“<code>AbstractAutoProxyCreator</code>çš„å®ç°è€…æ³¨å†Œäº†<code>TargetSourceCreator</code>ï¼ˆåˆ›å»ºè‡ªå®šä¹‰çš„TargetSourceï¼‰å°†ä¼šæŒ‰ç…§è¿™ä¸ªæµç¨‹å»æ‰§è¡Œã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹è°ƒç”¨è€…ä¸ä¼šè‡ªå·±å»å®ç°<code>TargetSourceCreator</code>ï¼Œè€Œæ˜¯Springé‡‡ç”¨é»˜è®¤çš„<code>SingletonTargetSource</code>å»ç”Ÿäº§AOPå¯¹è±¡ã€‚å½“ç„¶é™¤äº†<code>SingletonTargetSource</code>ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code>ThreadLocalTargetSource</code>ï¼ˆçº¿ç¨‹ç»‘å®šçš„Beanï¼‰ã€<code>CommonsPoolTargetSource</code>ï¼ˆå®ä¾‹æ± çš„Beanï¼‰ç­‰ç­‰ã€‚</li></ul><h5 id="postprocessafterinitialization-1" tabindex="-1"><a class="header-anchor" href="#postprocessafterinitialization-1" aria-hidden="true">#</a> postProcessAfterInitialization</h5><p>â€‹ å®ä¾‹åŒ–å®Œæ¯•åã€åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œã€‚ è‹¥æ–¹æ³•è¿”å›falseï¼Œè¡¨ç¤ºåç»­çš„<code>InstantiationAwareBeanPostProcessor</code>éƒ½ä¸ç”¨å†æ‰§è¡Œäº†ã€‚(ä¸€èˆ¬ä¸å»ºè®®å»è¿”å›falseï¼Œå®ƒçš„æ„ä¹‰åœ¨äºè‹¥è¿”å›fasleä¸ä»…åç»­çš„ä¸æ‰§è¡Œäº†ï¼Œå°±è¿è‡ªå·±ä¸ªä¸”åŒ…æ‹¬åç»­çš„å¤„ç†å™¨çš„<code>postProcessPropertyValues</code>æ–¹æ³•éƒ½å°†ä¸ä¼šå†æ‰§è¡Œäº†ï¼‰ <strong>populateBean()çš„æ—¶å€™è°ƒç”¨ï¼Œè‹¥æœ‰è¿”å›falseï¼Œä¸‹é¢çš„postProcessPropertyValueså°±éƒ½ä¸ä¼šè°ƒç”¨äº†</strong>ã€‚</p><h5 id="postprocesspropertyvalues" tabindex="-1"><a class="header-anchor" href="#postprocesspropertyvalues" aria-hidden="true">#</a> postProcessPropertyValues</h5><p>ç´§æ¥ç€ä¸Šé¢<code>postProcessAfterInitialization</code>æ‰§è¡Œçš„ï¼ˆfalseè§£é‡Šå¦‚ä¸Šï¼‰ã€‚å¦‚ï¼š</p><ul><li><code>AutowiredAnnotationBeanPostProcessor</code>æ‰§è¡Œ@Autowiredæ³¨è§£æ³¨å…¥</li><li><code>CommonAnnotationBeanPostProcessor</code>æ‰§è¡Œ@Resourceç­‰æ³¨è§£çš„æ³¨å…¥</li><li><code>PersistenceAnnotationBeanPostProcessor</code>æ‰§è¡Œ@PersistenceContextç­‰JPAæ³¨è§£çš„æ³¨å…¥</li><li><code>RequiredAnnotationBeanPostProcessor</code>æ‰§è¡Œ@Requiredæ³¨è§£çš„æ£€æŸ¥ç­‰ç­‰</li></ul><h4 id="smartinstantiationawarebeanpostprocessor" tabindex="-1"><a class="header-anchor" href="#smartinstantiationawarebeanpostprocessor" aria-hidden="true">#</a> SmartInstantiationAwareBeanPostProcessor</h4><p>æ™ºèƒ½å®ä¾‹åŒ–Beanï¼ˆç»§æ‰¿InstantiationAwareBeanPostProcessorï¼‰</p><h5 id="predictbeantype" tabindex="-1"><a class="header-anchor" href="#predictbeantype" aria-hidden="true">#</a> predictBeanType</h5><p>â€‹ é¢„æµ‹Beançš„ç±»å‹ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé¢„æµ‹æˆåŠŸçš„Classç±»å‹ï¼Œå¦‚æœä¸èƒ½é¢„æµ‹è¿”å›nullã€‚å½“ä½ è°ƒç”¨BeanFactory.getType(name)æ—¶<strong>å½“é€šè¿‡Beanå®šä¹‰æ— æ³•å¾—åˆ°Beanç±»å‹ä¿¡æ¯æ—¶</strong>å°±è°ƒç”¨è¯¥å›è°ƒæ–¹æ³•æ¥å†³å®šç±»å‹ä¿¡æ¯ã€‚<strong>æ–¹æ³•ï¼šgetBeanNamesForType()ä¼šå¾ªç¯è°ƒç”¨æ­¤æ–¹æ³•</strong>ã€‚å¦‚ï¼š</p><ul><li><code>BeanFactory.isTypeMatch(name, targetType)</code>ç”¨äºæ£€æµ‹ç»™å®šåå­—çš„Beanæ˜¯å¦åŒ¹é…ç›®æ ‡ç±»å‹ï¼ˆåœ¨ä¾èµ–æ³¨å…¥æ—¶éœ€è¦ä½¿ç”¨ï¼‰</li></ul><h5 id="determinecandidateconstructors" tabindex="-1"><a class="header-anchor" href="#determinecandidateconstructors" aria-hidden="true">#</a> determineCandidateConstructorsï¼š</h5><p>â€‹ æ£€æµ‹Beançš„æ„é€ å™¨ï¼Œå¯ä»¥æ£€æµ‹å‡ºå¤šä¸ªå€™é€‰æ„é€ å™¨ï¼Œå†æœ‰ç›¸åº”çš„ç­–ç•¥å†³å®šä½¿ç”¨å“ªä¸€ä¸ªã€‚ <strong>åœ¨</strong><code>createBeanInstance</code><strong>çš„æ—¶å€™ï¼Œä¼šé€šè¿‡æ­¤æ–¹æ³•å°è¯•å»æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„æ„é€ å‡½æ•°ã€‚è‹¥è¿”å›nullï¼Œå¯èƒ½å°±ç›´æ¥ä½¿ç”¨ç©ºæ„é€ å‡½æ•°å»å®ä¾‹åŒ–äº†</strong>ã€‚å¦‚ï¼š</p><ul><li>AutowiredAnnotationBeanPostProcessorï¼šå®ƒä¼šæ‰«æBeanä¸­ä½¿ç”¨äº†<code>@Autowired/@Value</code>æ³¨è§£çš„æ„é€ å™¨ä»è€Œå¯ä»¥<strong>å®Œæˆæ„é€ å™¨æ³¨å…¥</strong></li></ul><h5 id="getearlybeanreference" tabindex="-1"><a class="header-anchor" href="#getearlybeanreference" aria-hidden="true">#</a> getEarlyBeanReference</h5><p>â€‹ å’Œå¾ªç¯å¼•ç”¨ç›¸å…³äº†ã€‚<strong>å½“æ­£åœ¨åˆ›å»ºAæ—¶ï¼ŒAä¾èµ–B</strong>ã€‚æ­¤æ—¶ä¼šï¼šå°†Aä½œä¸º<code>ObjectFactory</code>æ”¾å…¥å•ä¾‹å·¥å‚ä¸­è¿›è¡Œ<code>early expose</code>ï¼Œæ­¤å¤„åˆéœ€è¦å¼•ç”¨Aï¼Œä½†Aæ­£åœ¨åˆ›å»ºï¼Œä»å•ä¾‹å·¥å‚æ‹¿åˆ°<code>ObjectFactory</code>(<strong>å…¶é€šè¿‡getEarlyBeanReferenceè·å–åŠæ—©æš´éœ²Bean</strong>)ä»è€Œå…è®¸å¾ªç¯ä¾èµ–ã€‚å¦‚ï¼š</p><ul><li><code>AspectJAwareAdvisorAutoProxyCreatoræˆ–AnnotationAwareAspectJAutoProxyCreator</code>ä»–ä»¬éƒ½æœ‰è°ƒç”¨æ­¤æ–¹æ³•ï¼Œé€šè¿‡early referenceèƒ½å¾—åˆ°æ­£ç¡®çš„ä»£ç†å¯¹è±¡ã€‚æœ‰ä¸ªå°ç»†èŠ‚ï¼šè¿™ä¸¤ä¸ªç±»ä¸­è‹¥æ‰§è¡Œäº†<code>getEarlyBeanReference</code>ï¼Œé‚£<code>postProcessAfterInitialization</code>å°±ä¸ä¼šå†æ‰§è¡Œäº†ã€‚</li></ul><blockquote><p>å› ä¸ºæˆ‘ä»¬ç»å¸¸å®ç°<code>SmartInstantiationAwareBeanPostProcessor</code>æˆ–è€…<code>InstantiationAwareBeanPostProcessor</code>åªæƒ³å®ç°å…¶ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œå› æ­¤æœ¬å¤„ä»‹ç»Springä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ä¸ªé€‚é…å™¨ï¼š<code>InstantiationAwareBeanPostProcessorAdapter</code>ï¼Œå®ƒåšäº†æ‰€æœ‰çš„ç©ºå®ç°ã€‚è¿™æ ·æˆ‘ä»¬éœ€è¦å“ªä¸ªè‡ªå·±å»å®ç°å¯¹åº”æ–¹æ³•å³å¯ï¼Œå‡å°‘äº†å¹²æ‰°ã€‚</p></blockquote><h4 id="destructionawarebeanpostprocessor" tabindex="-1"><a class="header-anchor" href="#destructionawarebeanpostprocessor" aria-hidden="true">#</a> DestructionAwareBeanPostProcessor</h4><p>â€‹ é”€æ¯Beanï¼ˆç»§æ‰¿BeanPostProcessorï¼‰ã€‚<code>postProcessBeforeDestruction</code>ï¼šé”€æ¯åå¤„ç†å›è°ƒæ–¹æ³•ï¼Œ<code>è¯¥å›è°ƒåªèƒ½åº”ç”¨åˆ°å•ä¾‹Bean</code>ã€‚å¦‚<code>InitDestroyAnnotationBeanPostProcessor</code>å®Œæˆ@PreDestroyæ³¨è§£çš„é”€æ¯æ–¹æ³•è°ƒç”¨ã€‚</p><h4 id="å¸¸è§çš„beanpostprocessor" tabindex="-1"><a class="header-anchor" href="#å¸¸è§çš„beanpostprocessor" aria-hidden="true">#</a> å¸¸è§çš„BeanPostProcessor</h4><p>Springå†…ç½®äº†éå¸¸éå¸¸å¤šçš„å¤„ç†å™¨ï¼Œå¦‚ï¼š</p><ul><li><strong>ApplicationContextAwareProcessor</strong></li></ul><blockquote><p>â€‹ å®ƒçš„<code>postProcessBeforeInitialization</code>æ–¹æ³•é‡Œå¤„ç†<code>ApplicationContextAwareã€MessageSourceAwareResourceLoaderAwareã€EnvironmentAwareã€EmbeddedValueResolverAwareã€ApplicationEventPublisherAware</code></p></blockquote><ul><li><strong>CommonAnnotationBeanPostProcessor</strong></li></ul><blockquote><p>â€‹ ç»§æ‰¿InitDestroyAnnotationBeanPostProcessorã€‚æä¾›å¯¹JSR-250è§„èŒƒæ³¨è§£çš„æ”¯æŒ<code>@Resourceã€@PostConstruct</code>å’Œ<code>@PreDestroy</code>ç­‰çš„æ”¯æŒ</p><ul><li><code>postProcessPropertyValues</code>ï¼šé€šè¿‡æ­¤æ–¹æ³•å›è°ƒè¿›è¡Œ<code>@Resource</code>æ³¨è§£çš„ä¾èµ–æ³¨å…¥</li><li><code>postProcessBeforeInitialization()</code>å°†ä¼šè°ƒç”¨beançš„@PostConstructæ–¹æ³•</li><li><code>postProcessBeforeDestruction()</code>å°†ä¼šè°ƒç”¨å•ä¾‹ Beançš„@PreDestroyæ–¹æ³•</li></ul></blockquote><ul><li><strong>AutowiredAnnotationBeanPostProcessor</strong></li></ul><blockquote><p>æä¾›å¯¹<code>JSR-330</code>è§„èŒƒæ³¨è§£ï¼ˆ<code>@Inject</code>ï¼‰çš„æ”¯æŒå’ŒSpringè‡ªå¸¦æ³¨è§£çš„æ”¯æŒï¼ˆ<code>@Autowiredå’Œ@Value</code>ï¼‰</p><ul><li><code>determineCandidateConstructors</code>ï¼šå†³å®šå€™é€‰æ„é€ å™¨</li><li><code>postProcessPropertyValues</code>ï¼šè¿›è¡Œä¾èµ–æ³¨å…¥</li></ul></blockquote><h5 id="è§£ææ³¨è§£å…ƒä¿¡æ¯é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#è§£ææ³¨è§£å…ƒä¿¡æ¯é˜¶æ®µ" aria-hidden="true">#</a> è§£ææ³¨è§£å…ƒä¿¡æ¯é˜¶æ®µ</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutowiredAnnotationBeanPostProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">InstantiationAwareBeanPostProcessorAdapter</span> <span class="token keyword">implements</span> <span class="token class-name">MergedBeanDefinitionPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">PriorityOrdered</span><span class="token punctuation">,</span> <span class="token class-name">BeanFactoryAware</span> <span class="token punctuation">{</span>

    <span class="token comment">// è¯¥å¤„ç†å™¨æ”¯æŒè§£æçš„æ³¨è§£ä»¬~~~ï¼ˆè¿™é‡Œé•¿åº¦è®¾ç½®ä¸º4ï¼‰  é»˜è®¤æ”¯æŒçš„æ˜¯3ä¸ªï¼ˆå½“ç„¶ä½ å¯ä»¥è‡ªå·±æ·»åŠ è‡ªå®šä¹‰çš„ä¾èµ–æ³¨å…¥çš„æ³¨è§£   è¿™ç‚¹éå¸¸å¼ºå¤§ï¼‰</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> autowiredAnnotationTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// @Autowired(required = false)è¿™ä¸ªæ³¨è§£çš„å±æ€§å€¼åç§°</span>
    <span class="token comment">// A &#39;required&#39; dependency means that autowiring should fail when no beans are found.</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> requiredParameterName <span class="token operator">=</span> <span class="token string">&quot;required&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿™ä¸ªå€¼ä¸€èˆ¬è¯·ä¸è¦æ”¹å˜ï¼ˆè‹¥æ”¹æˆfalseï¼Œæ•ˆæœrequired = falseçš„ä½œç”¨æ˜¯ç›¸åçš„äº†ï¼‰</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> requiredParameterValue <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> order <span class="token operator">=</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">LOWEST_PRECEDENCE</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">// å¯¹@Lookupæ–¹æ³•çš„æ”¯æŒ  æœ¬æ–‡ä¸è®¨è®º</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> lookupMethodsChecked <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ„é€ å‡½æ•°æ³¨å…¥ï¼Œæœ¬æ–‡ä¹Ÿä¸è®¨è®º</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> candidateConstructorsCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ–¹æ³•æ³¨å…¥ã€å­—æ®µfiledæ³¨å…¥  æœ¬æ–‡çš„é‡ä¸­ä¹‹é‡</span>
    <span class="token comment">// æ­¤å¤„InjectionMetadataè¿™ä¸ªç±»éå¸¸é‡è¦ï¼Œåˆ°äº†æ­¤å¤„@Autowiredæ³¨è§£å«ä¹‰å·²ç»æ²¡æœ‰äº†ï¼Œå®Œå…¨è¢«å‡†å¤‡æˆè¿™ä¸ªå…ƒæ•°æ®äº†  æ‰€ä»¥æ–¹ä¾¿æˆ‘ä»¬è‡ªå®šä¹‰æ³¨è§£çš„æ”¯æŒ~~~ä¼˜ç§€</span>
    <span class="token comment">// InjectionMetadataæŒæœ‰targetClassã€Collection&lt;InjectedElement&gt; injectedElementsç­‰ä¸¤ä¸ªé‡è¦å±æ€§</span>
    <span class="token comment">// å…¶ä¸­InjectedElementè¿™ä¸ªæŠ½è±¡ç±»æœ€é‡è¦çš„ä¸¤ä¸ªå®ç°ä¸ºï¼šAutowiredFieldElementå’ŒAutowiredMethodElement</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">InjectionMetadata</span><span class="token punctuation">&gt;</span></span> injectionMetadataCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è¿™æ˜¯å®ƒå”¯ä¸€æ„é€ å‡½æ•°  é»˜è®¤æ”¯æŒä¸‹é¢ä¸‰ç§ç§Ÿå€Ÿï¼ˆå½“ç„¶@Injectéœ€è¦é¢å¤–å¯¼åŒ…ï¼‰</span>
    <span class="token comment">// è¯·æ³¨æ„ï¼šæ­¤å¤„@Valueæ³¨è§£ä¹Ÿæ˜¯è¢«ä¾èµ–æ³¨å…¥è§£æçš„~~~~~~~~</span>
    <span class="token comment">// å½“ç„¶å¦‚æœä½ éœ€è¦æ”¯æŒåˆ°ä½ çš„è‡ªå®šä¹‰æ³¨è§£ï¼Œä½ è¿˜å¯ä»¥è°ƒç”¨ä¸‹é¢çš„setæ–¹æ³•æ·»åŠ ã€‚ã€‚ã€‚</span>
    <span class="token keyword">public</span> <span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Autowired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.inject.Inject&quot;</span><span class="token punctuation">,</span> <span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;JSR-330 &#39;javax.inject.Inject&#39; annotation found and supported for autowiring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// JSR-330 API not available - simply skip.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è‡ªå®šä¹‰æ”¯æŒçš„ä¾èµ–æ³¨å…¥æ³¨è§£ç±»å‹</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAutowiredAnnotationType</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> autowiredAnnotationType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>autowiredAnnotationType<span class="token punctuation">,</span> <span class="token string">&quot;&#39;autowiredAnnotationType&#39; must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>autowiredAnnotationType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAutowiredAnnotationTypes</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> autowiredAnnotationTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>autowiredAnnotationTypes<span class="token punctuation">,</span> <span class="token string">&quot;&#39;autowiredAnnotationTypes&#39; must not be empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>autowiredAnnotationTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// çœç•¥å…¶ä½™get/setæ–¹æ³•</span>

    <span class="token comment">// beanå·¥å‚å¿…é¡»æ˜¯ConfigurableListableBeanFactoryçš„ï¼ˆæ­¤å¤„æ”¾å¿ƒä½¿ç”¨ï¼Œå”¯ç‹¬åªæœ‰SimpleJndiBeanFactoryä¸æ˜¯å®ƒçš„å­ç±»è€Œå·²~ï¼‰</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;AutowiredAnnotationBeanPostProcessor requires a ConfigurableListableBeanFactory: &quot;</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç¬¬ä¸€ä¸ªéå¸¸é‡è¦çš„æ ¸å¿ƒæ–¹æ³•~~~  </span>
    <span class="token comment">//å®ƒè´Ÿè´£1ã€è§£æ@Autowiredç­‰æ³¨è§£ç„¶åè½¬æ¢</span>
    <span class="token comment">// 2ã€æŠŠæ³¨è§£ä¿¡æ¯è½¬æ¢ä¸ºInjectionMetadataç„¶åç¼“å­˜åˆ°ä¸Šé¢çš„injectionMetadataCacheé‡Œé¢</span>
    <span class="token comment">// postProcessMergedBeanDefinitionçš„æ‰§è¡Œæ—¶æœºéå¸¸æ—©ï¼Œåœ¨doCreateBean()å‰éƒ¨åˆ†å®Œæˆbeanå®šä¹‰ä¿¡æ¯çš„åˆå¹¶</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessMergedBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> beanDefinition<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// findAutowiringMetadataæ–¹æ³•é‡è¦ï¼Œå®Œæˆäº†è§£ææ³¨è§£ã€ç¼“å­˜ä¸‹æ¥çš„æ“ä½œ</span>
        <span class="token class-name">InjectionMetadata</span> metadata <span class="token operator">=</span> <span class="token function">findAutowiringMetadata</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ£€æŸ¥~~~(ä¸å¤ªé‡è¦ï¼Œå¯å¿½ç•¥)</span>
        metadata<span class="token punctuation">.</span><span class="token function">checkConfigMembers</span><span class="token punctuation">(</span>beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ–¹æ³•åä¸ºæŸ¥æ‰¾åˆ°è¯¥beançš„ä¾èµ–æ³¨å…¥å…ƒä¿¡æ¯ï¼Œå†…éƒ¨åªè¦æŸ¥æ‰¾åˆ°äº†å°±ä¼šåŠ å…¥åˆ°ç¼“å­˜å†…ï¼Œä¸‹æ¬¡æ²¡å¿…è¦å†é‡å¤æŸ¥æ‰¾äº†~</span>
    <span class="token comment">// å®ƒæ˜¯ä¸€ä¸ªæ¨¡ç‰ˆæ–¹æ³•ï¼ŒçœŸæ­£åšäº‹çš„æ–¹æ³•æ˜¯ï¼šbuildAutowiringMetadata  å®ƒå¤æ‚æŠŠæ ‡æ³¨æœ‰@Autowiredæ³¨è§£çš„å±æ€§è½¬æ¢ä¸ºMetadataå…ƒæ•°æ®ä¿¡æ¯  ä»è€Œæ¶ˆé™¤æ³¨è§£çš„å®šä¹‰</span>
    <span class="token comment">// æ­¤å¤„æŸ¥æ‰¾åŒ…æ‹¬äº†å­—æ®µä¾èµ–æ³¨å…¥å’Œæ–¹æ³•ä¾èµ–æ³¨å…¥~~~</span>
    <span class="token keyword">private</span> <span class="token class-name">InjectionMetadata</span> <span class="token function">findAutowiringMetadata</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> cacheKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">?</span> beanName <span class="token operator">:</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InjectionMetadata</span> metadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InjectionMetadata</span><span class="token punctuation">.</span><span class="token function">needsRefresh</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                metadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">InjectionMetadata</span><span class="token punctuation">.</span><span class="token function">needsRefresh</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        metadata<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    metadata <span class="token operator">=</span> <span class="token function">buildAutowiringMetadata</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>injectionMetadataCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> metadata<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™é‡Œæˆ‘è®¤ä¸ºæ˜¯æ•´ä¸ªä¾èµ–æ³¨å…¥å‰æœŸå·¥ä½œçš„ç²¾é«“æ‰€åœ¨ï¼Œç®€å•ç²—æš´çš„å¯ä»¥ç†è§£ä¸ºï¼šå®ƒæŠŠä»¥ä¾èµ–æ³¨å…¥éƒ½è½¬æ¢ä¸ºInjectionMetadataå…ƒä¿¡æ¯ï¼Œå¾…åç»­ä½¿ç”¨</span>
    <span class="token comment">// è¿™é‡Œä¼šå¤„ç†å­—æ®µæ³¨å…¥ã€æ–¹æ³•æ³¨å…¥~~~</span>
    <span class="token comment">// æ³¨æ„ï¼šAutowiredä½¿ç”¨åœ¨staticå­—æ®µ/æ–¹æ³•ä¸Šã€0ä¸ªå…¥å‚çš„æ–¹æ³•ä¸Šï¼ˆä¸ä¼šæŠ¥é”™ åªæ˜¯æ— æ•ˆï¼‰</span>
    <span class="token comment">// æ˜¾ç„¶æ–¹æ³•çš„è®¿é—®çº§åˆ«ã€æ˜¯å¦finaléƒ½æ˜¯å¯ä»¥æ­£å¸¸è¢«æ³¨å…¥è¿›æ¥çš„~~~</span>
    <span class="token keyword">private</span> <span class="token class-name">InjectionMetadata</span> <span class="token function">buildAutowiringMetadata</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectionMetadata<span class="token punctuation">.</span>InjectedElement</span><span class="token punctuation">&gt;</span></span> elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> clazz<span class="token punctuation">;</span>

        <span class="token comment">// å°ç»†èŠ‚ï¼šè¿™é‡Œæ˜¯ä¸ªdo whileå¾ªç¯ï¼Œæ‰€ä»¥å³ä½¿åœ¨çˆ¶ç±»ï¼Œçˆ¶çˆ¶ç±»ä¸Šä¾èµ–æ³¨å…¥ä¾æ—§æ˜¯å¥½ä½¿çš„ï¼ˆç›´åˆ°Objectååœæ­¢ï¼‰</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectionMetadata<span class="token punctuation">.</span>InjectedElement</span><span class="token punctuation">&gt;</span></span> currElements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">doWithLocalFields</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span> field <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">AnnotationAttributes</span> ann <span class="token operator">=</span> <span class="token function">findAutowiredAnnotation</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ann <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// staticå±æ€§ä¸å¥½ä½¿</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Autowired annotation is not supported on static fields: &quot;</span> <span class="token operator">+</span> field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// è§£ærequiredå±æ€§ï¼ˆè‹¥å­˜åœ¨ï¼‰  æœ€ç»ˆå°è£…æˆAutowiredFieldElement</span>
                    <span class="token keyword">boolean</span> required <span class="token operator">=</span> <span class="token function">determineRequiredStatus</span><span class="token punctuation">(</span>ann<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    currElements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutowiredFieldElement</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> required<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">doWithLocalMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span> method <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">Method</span> bridgedMethod <span class="token operator">=</span> <span class="token class-name">BridgeMethodResolver</span><span class="token punctuation">.</span><span class="token function">findBridgedMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">BridgeMethodResolver</span><span class="token punctuation">.</span><span class="token function">isVisibilityBridgeMethodPair</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> bridgedMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">AnnotationAttributes</span> ann <span class="token operator">=</span> <span class="token function">findAutowiredAnnotation</span><span class="token punctuation">(</span>bridgedMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ann <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getMostSpecificMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// staticæ–¹æ³•ä¸å¥½ä½¿</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Autowired annotation is not supported on static methods: &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// æ–¹æ³•æ²¡æœ‰å…¥å‚ä¸å¥½ä½¿</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Autowired annotation should only be used on methods with parameters: &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">boolean</span> required <span class="token operator">=</span> <span class="token function">determineRequiredStatus</span><span class="token punctuation">(</span>ann<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">PropertyDescriptor</span> pd <span class="token operator">=</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">findPropertyForMethod</span><span class="token punctuation">(</span>bridgedMethod<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// AutowiredMethodElementé‡Œå°è£…äº†ä¸€ä¸ªPropertyDescriptorï¼ˆæ¯”å­—æ®µå¤šäº†ä¸€ä¸ªå‚æ•°ï¼‰</span>
                    currElements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutowiredMethodElement</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> required<span class="token punctuation">,</span> pd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// å°ç»†èŠ‚ï¼šçˆ¶ç±»çš„éƒ½æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œæ‰€ä»¥çˆ¶ç±»æ˜¯æœ€å…ˆå®Œæˆä¾èµ–æ³¨å…¥çš„</span>
            elements<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> currElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
            targetClass <span class="token operator">=</span> targetClass<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>targetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> targetClass <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¯è§InjectionMetadataå°±æ˜¯å¯¹clazzå’Œelementsçš„ä¸€ä¸ªåŒ…è£…è€Œå·²</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InjectionMetadata</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åªè¦æ–¹æ³•/å±æ€§ä¸Šä½†å‡¡æ ‡æ³¨æœ‰ä¸€ä¸ªæ³¨è§£ï¼Œå°±ç«‹é©¬è¿”å›äº†~~ï¼ˆsoä½ æ ‡æ³¨å¤šä¸ªæœ€ç»ˆç”Ÿæ•ˆçš„åªä¼šæœ‰ä¸€ä¸ªå“¦ï¼‰</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">AnnotationAttributes</span> <span class="token function">findAutowiredAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AccessibleObject</span> ao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ao<span class="token punctuation">.</span><span class="token function">getAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// autowiring annotations have to be local</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AnnotationAttributes</span> attributes <span class="token operator">=</span> <span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">getMergedAnnotationAttributes</span><span class="token punctuation">(</span>ao<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> attributes<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å°ç»†èŠ‚è¿™ä¸ªæ–¹æ³•æ˜¯protectedçš„</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">determineRequiredStatus</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> ann<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">!</span>ann<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requiredParameterName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requiredParameterValue <span class="token operator">==</span> ann<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requiredParameterName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// å…³äºå†…éƒ¨ç±»injectçš„æœ€ç»ˆå¯ä»¥æ”¾åœ¨ä¸‹é¢çš„é‡ç‚¹</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ³¨å…¥é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#æ³¨å…¥é˜¶æ®µ" aria-hidden="true">#</a> æ³¨å…¥é˜¶æ®µ</h5><p>â€‹ è¿™æ˜¯æ ¸å¿ƒé˜¶æ®µï¼Œä¹Ÿæ˜¯æœ€ä¸ºå¤æ‚çš„é˜¶æ®µï¼Œå½“ç„¶å‰é¢çš„è§£æå·²ç»ä¸ºæœ¬æ­¥éª¤åšå¥½äº†å…ƒæ•°æ®çš„é“ºå«ã€‚æˆ‘ä»¬çŸ¥é“åœ¨Beançš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œå®ŒæˆBeançš„å®ä¾‹åŒ–åï¼Œä¼šè°ƒç”¨æ–¹æ³•<code>AbstractAutowireCapableBeanFactory#populateBean()</code>å®Œæˆå¯¹Beançš„<strong>å±æ€§èµ‹å€¼</strong>ï¼Œä»è€Œå°±ä¼šè§¦å‘<code>InstantiationAwareBeanPostProcessor.postProcessPropertyValues()</code>æ–¹æ³•ç»™å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œè¿™å¤„ä¹Ÿå°±æ˜¯æœ¬æ­¥éª¤çš„å…¥å£ã€‚ç»¼ä¸Šèƒ½å¤Ÿå‘ç°ï¼Œæœ€ç»ˆä¾èµ–æ³¨å…¥å®é™…åšäº‹çš„æ˜¯<code>InjectedElement</code>ï¼Œè¿™ä¸ªæŠ½è±¡ç±»æœ‰å¥½å‡ ä¸ªå®ç°ï¼Œæ­¤å¤„æˆ‘ä»¬ä»¥ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„<code>AutowiredFieldElement</code>è¿›è¡Œè¯´æ˜ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å®ƒçš„å®¿ä¸»ç±»æ˜¯AutowiredAnnotationBeanPostProcessor é«˜å†…èšä½è€¦åˆ</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AutowiredFieldElement</span> <span class="token keyword">extends</span> <span class="token class-name">InjectionMetadata<span class="token punctuation">.</span>InjectedElement</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> required<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> cached <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Object</span> cachedFieldValue<span class="token punctuation">;</span>

    <span class="token comment">//å”¯ä¸€æ„é€ æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token class-name">AutowiredFieldElement</span><span class="token punctuation">(</span><span class="token class-name">Field</span> field<span class="token punctuation">,</span> <span class="token keyword">boolean</span> required<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ­¤å¤„æ˜¾ç¤ºè°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>required <span class="token operator">=</span> required<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ¸å¿ƒæ–¹æ³•ï¼šå­—æ®µçš„ä¾èµ–æ³¨å…¥</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ˜¾ç„¶æ­¤å¤„çˆ¶ç±»çš„memberå°±æŒ‡çš„æ˜¯filed</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>member<span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

        <span class="token comment">// èµ°ç¼“å­˜ï¼Œå…³äºcachedFieldValueçš„å€¼  ä¸”å¬ä¸‹æ–‡åˆ†è§£</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token function">resolvedCachedArgument</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¯ä¸ªFieldéƒ½åŒ…è£…æˆä¸€ä¸ªDependencyDescriptor</span>
            <span class="token comment">// å¦‚æœæ˜¯MethodåŒ…è£…æˆDependencyDescriptor,æ¯•ç«Ÿä¸€ä¸ªæ–¹æ³•å¯ä»¥æœ‰å¤šä¸ªå…¥å‚</span>
            <span class="token comment">// æ­¤å¤„åŒ…è£…æˆå®ƒåï¼Œæ˜¾ç„¶å’Œå…ƒæ•°æ®éƒ½æ— å…³äº†ï¼Œåªå’ŒFieldæœ‰å…³äº†  å®Œå…¨éš”ç¦»</span>
            <span class="token class-name">DependencyDescriptor</span> desc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DependencyDescriptor</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>required<span class="token punctuation">)</span><span class="token punctuation">;</span>
            desc<span class="token punctuation">.</span><span class="token function">setContainingClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autowiredBeanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No BeanFactory available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è½¬æ¢å™¨ä½¿ç”¨çš„beanå·¥å‚çš„è½¬æ¢å™¨~~~</span>
            <span class="token class-name">TypeConverter</span> typeConverter <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å–ä¾èµ–çš„valueå€¼çš„å·¥ä½œ  æœ€ç»ˆè¿˜æ˜¯å§”æ‰˜ç»™beanFactory.resolveDependency()å»å®Œæˆçš„~~~~</span>
                <span class="token comment">// è¿™ä¸ªæ¥å£æ–¹æ³•ç”±AutowireCapableBeanFactoryæä¾›ï¼Œå®ƒæä¾›äº†ä»beanå·¥å‚é‡Œè·å–ä¾èµ–å€¼çš„èƒ½åŠ›~</span>
                value <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">resolveDependency</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">,</span> typeConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InjectionPoint</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// ä¸‹é¢ä»£ç æ˜¯æŠŠç¼“å­˜å€¼ç¼“å­˜èµ·æ¥  è®©åŒä¸€ä¸ªFieldæ³¨å…¥å¤šæ¬¡èƒ½æé«˜æ•ˆç‡</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token comment">// å¯ä»¥çœ‹åˆ°valueï¼=nullå¹¶ä¸”required=trueæ‰ä¼šè¿›è¡Œç¼“å­˜çš„å¤„ç†</span>
                    <span class="token comment">// æŒ‰ç…§ä¸Šä¾‹ æ­¤å¤„valueå€¼ä¸ºA@2277å®ä¾‹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>required<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue <span class="token operator">=</span> desc<span class="token punctuation">;</span> <span class="token comment">// å¯ä»¥çœ‹åˆ°ç¼“å­˜çš„å€¼æ˜¯ä¸Šé¢çš„DependencyDescriptorå¯¹è±¡~~~~</span>


                        <span class="token comment">// è¿™ä¸ªæ–¹æ³•æ˜¯å®¿ä¸»ç±»AutowiredAnnotationBeanPostProcessorçš„æ–¹æ³•</span>
                        <span class="token comment">// ç®€å•çš„è¯´å°±æ˜¯æ³¨å†Œåˆ°beanå·¥å‚å»ï¼Œæ¯”å¦‚æ­¤å¤„bæ˜¯ä¾èµ–açš„  æ‰€ä»¥å°±æ³¨å†Œè¿™ä¸ªä¾èµ–å…³ç³»è¿›å»äº†</span>
                        <span class="token comment">// å‚è€ƒthis.beanFactory.registerDependentBean(autowiredBeanName, beanName);</span>
                        <span class="token function">registerDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// autowiredBeanNamesé‡Œå¯èƒ½ä¼šæœ‰åˆ«åçš„åç§°~~~æ‰€ä»¥sizeå¯èƒ½å¤§äº1</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>autowiredBeanNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                            <span class="token comment">// beanFactory.isTypeMatchæŒºé‡è¦çš„~~~~å› ä¸º@Autowiredæ˜¯æŒ‰ç…§ç±»å‹æ³¨å…¥çš„</span>
                            <span class="token class-name">String</span> autowiredBeanName <span class="token operator">=</span> autowiredBeanNames<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShortcutDependencyDescriptor</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> autowiredBeanName<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä¸ä¸ºnullï¼Œå°±å®Œæˆæœ€ç»ˆçš„setå€¼  åˆ©ç”¨åå°„ç»™filedå±æ€§èµ‹å€¼~~~~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ å§”æ‰˜<code>AutowireCapableBeanFactory</code>æ¥è·å–åˆ°ä¾èµ–å€¼valueï¼Œä»è€Œæœ€ç»ˆå®Œæˆæ³¨å…¥ï¼ˆåå°„æ‰§è¡Œæ³¨å…¥~ï¼‰ã€‚ soï¼Œå…¶å®æœ€æ ¸å¿ƒè¿˜æ˜¯åœ¨Beanå·¥å‚é‡Œï¼Œä¹Ÿå°±æ˜¯å®ƒçš„å”¯ä¸€å†…å»ºå®ç°ç±»<code>DefaultListableBeanFactory</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultListableBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAutowireCapableBeanFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">resolveDependency</span><span class="token punctuation">(</span><span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> requestingBeanName<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autowiredBeanNames<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TypeConverter</span> typeConverter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ­¤å¤„ä½¿ç”¨çš„æ˜¯DefaultParameterNameDiscoverer æ¥è·å–å‚æ•°å</span>
        <span class="token comment">// è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨@Autowiredæ³¨å…¥ï¼Œå³ä½¿æœ‰å¤šä¸ªåŒç±»å‹çš„Beanï¼Œä¹Ÿå¯ä»¥é€šè¿‡fieldå±æ€§åè¿›è¡ŒåŒºåˆ†çš„æ ¹æœ¬åŸå› ï¼ˆå¯ä»¥ä¸éœ€è¦ä½¿ç”¨@Qualifieræ³¨è§£ï¼‰</span>
        descriptor<span class="token punctuation">.</span><span class="token function">initParameterNameDiscovery</span><span class="token punctuation">(</span><span class="token function">getParameterNameDiscoverer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ”¯æŒOptional  åŸæ¥è¿˜æ˜¯doResolveDependency  æš‚ç•¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">createOptionalDependency</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// åŸç†ä¹Ÿæ˜¯doResolveDependency  </span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token class-name">ObjectProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DependencyObjectProvider</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>javaxInjectProviderClass <span class="token operator">==</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Jsr330Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createDependencyProvider</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹  è‚¯å®šèµ°åˆ°è¿™é‡Œ~~~~</span>

            <span class="token comment">// æ­¤å¤„ç‰¹åˆ«ç‰¹åˆ«çš„éœ€è¦é‡è§†ï¼šè¿™æ˜¯@Lazyæ”¯æŒçš„æ ¹æœ¬åŸå› ~~</span>
            <span class="token comment">// å…³äºAutowireCandidateResolveræˆ‘å»ºè®®å°ä¼™ä¼´å…ˆçœ‹ä¸‹ä¸€ä¸ªç« èŠ‚~~~</span>
            <span class="token comment">// æ­¤å¤„è‹¥é€šè¿‡AutowireCandidateResolverè§£æåˆ°äº†å€¼å°±ç›´æ¥è¿”å›äº†ï¼ˆè‹¥æ ‡æ³¨äº†@Lazyï¼Œæ­¤å¤„çš„resultå°†ä¸ä¼šä¸ºnulläº†~~~ï¼‰</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLazyResolutionProxyIfNecessary</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// doResolveDependencyæ˜¯ç»å¤§å¤šæ•°æƒ…å†µä¸‹  æœ€ç»ˆä¼šå»æ‰§è¡Œçš„ä»£ç ï¼ˆè‹¥resultä»æ—§ä¸ºnullçš„è¯ï¼‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">doResolveDependency</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> requestingBeanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">,</span> typeConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>


    <span class="token comment">// æ­¤å¤„autowiredBeanNamesæ˜¯åœ¨injectçš„ä¸€ä¸ªç©ºçš„Set</span>
    <span class="token comment">// autowiredè¡¨ç¤ºæœ€ç»ˆå¯ä»¥æ³¨å…¥è¿›å»çš„beanåç§°ä»¬ï¼ˆå› ä¸ºå¯èƒ½æ˜¯ä¼šæœ‰å¤šä¸ªç¬¦åˆæ¡ä»¶çš„ï¼‰</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">doResolveDependency</span><span class="token punctuation">(</span><span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span>
                                      <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autowiredBeanNames<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TypeConverter</span> typeConverter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

        <span class="token comment">// è®°å½•æ³¨å…¥ç‚¹ï¼Œå…¶å®ä½¿ç”¨çš„ThreadLocal~</span>
        <span class="token class-name">InjectionPoint</span> previousInjectionPoint <span class="token operator">=</span> <span class="token class-name">ConstructorResolver</span><span class="token punctuation">.</span><span class="token function">setCurrentInjectionPoint</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// åªæœ‰ShortcutDependencyDescriptorå®ç°äº†resolveShortcutæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯æ ¹æ®</span>
            <span class="token comment">// å®ç°ä¹Ÿå°±ä¸€å¥è¯ï¼šbeanFactory.getBean(this.shortcut, this.requiredType)</span>
            <span class="token comment">// ShortcutDependencyDescriptorå®åœ¨injectå®Œæˆååˆ›å»ºçš„ï¼Œå°±æ˜¯æœ‰ç¼“å­˜çš„æ•ˆæœ~~~</span>
            <span class="token class-name">Object</span> shortcut <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">resolveShortcut</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shortcut <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> shortcut<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// interface com.fsx.dependency.AInterface</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// æ‹¿åˆ°@Valueæ³¨è§£çš„valueå€¼ï¼ˆæ˜¯ä¸ªå­—ç¬¦ä¸²ï¼‰  è‹¥æ²¡æœ‰æ ‡æ³¨@Value  æ˜¾ç„¶å°±ä¸ç”¨é‚£å•¥äº†</span>
            <span class="token comment">// ä»æ­¤å¤„å…¶å®ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œ@Valueæ³¨è§£çš„ä¼˜å…ˆçº§å¯¹äºæ‰¾åˆ°beanæ¥è¯´è¿˜æ˜¯è›®é«˜çš„</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> <span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuggestedValue</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token comment">// ============ è¿™éƒ¨åˆ†ä¸»è¦æ˜¯è§£æ@Valueæ³¨è§£</span>
            <span class="token comment">// è§£æå®ƒçš„å ä½ç¬¦ï¼Œè§£æå®ƒçš„SpELè¡¨è¾¾å¼</span>
            <span class="token comment">// ç›¸å…³å¤„ç†ç±»æ›¹é BeanExpressionResolverå’ŒStandardBeanExpressionResolver  StandardEvaluationContextç­‰</span>
            <span class="token comment">// å› ä¸ºå…³äº@Valueçš„æ–‡ç« é‡Œè¯¦ç»†è§£è¿‡ï¼Œæ­¤å¤„ä¸€ç¬”å¸¦è¿‡~~~</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> strVal <span class="token operator">=</span> <span class="token function">resolveEmbeddedValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> <span class="token punctuation">(</span>beanName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">containsBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">?</span>
                            <span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    value <span class="token operator">=</span> <span class="token function">evaluateBeanDefinitionString</span><span class="token punctuation">(</span>strVal<span class="token punctuation">,</span> bd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">TypeConverter</span> converter <span class="token operator">=</span> <span class="token punctuation">(</span>typeConverter <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> typeConverter <span class="token operator">:</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> converter<span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getTypeDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedOperationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// A custom TypeConverter which does not support TypeDescriptor resolution...</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
                            converter<span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                            converter<span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ============</span>


            <span class="token comment">// æ­¤å¤„å¤„ç†çš„æ˜¯å¤šå€¼æ³¨å…¥çš„æƒ…å†µï¼Œæ¯”å¦‚æ³¨å…¥Stream&lt;Object&gt;ã€Mapã€Arrayã€Collectionç­‰ç­‰  Springéƒ½æ˜¯æ”¯æŒçš„</span>
            <span class="token comment">// éœ€è¦ç¨å¾®æ³¨æ„ä¸€ç‚¹ï¼ŒStreamè¿™ç§ç±»å‹çš„æ³¨å…¥åœ¨Spring4ä»¥ä¸Šæ‰å¾—åˆ°æ”¯æŒçš„</span>
            <span class="token class-name">Object</span> multipleBeans <span class="token operator">=</span> <span class="token function">resolveMultipleBeans</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">,</span> typeConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>multipleBeans <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> multipleBeans<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// æ˜¾ç„¶ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½ä¼šèµ°åˆ°è¿™é‡Œï¼ˆå› ä¸ºå¤§éƒ¨åˆ†æˆ‘ä»¬éƒ½æ˜¯å•å€¼æ³¨å…¥~ï¼‰</span>
            <span class="token comment">// findAutowireCandidateså¯ä»¥è¯´åˆæ˜¯æ•´ä¸ªä¾èµ–æ³¨å…¥çš„çµé­‚ä¹‹ä¸€~~~~ å®ƒçš„æŸ¥æ‰¾æ­¥éª¤ç®€è¿°å¦‚ä¸‹ï¼š</span>
            <span class="token comment">// 1ã€BeanFactoryUtils.beanNamesForTypeIncludingAncestors() æ‰¾åˆ°è¿™ç§ç±»å‹çš„æ‰€æœ‰çš„beanNamesï¼ˆcandidateNamesï¼‰ï¼ˆå¯èƒ½æœ‰å¤šä¸ªå“Ÿï¼Œä½†å¤§å¤šæ•°æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªï¼‰</span>
            <span class="token comment">// 2ã€å¤„ç†resolvableDependenciesæ¯”å¦‚ApplicationContextçš„ä¾èµ–ï¼Œè®©ä»–ä»¬ä¹Ÿèƒ½å¤Ÿæ­£å¸¸æ³¨å…¥è¿›å»(ä»–ä»¬å¯ä¸ä½œä¸ºbeanå­˜åœ¨å®¹å™¨é‡Œ~)</span>
            <span class="token comment">// 3ã€éå†candidateNamesï¼šæ£€æŸ¥å®ƒæ˜¯å¦å¯ä»¥è¢«ä¾èµ–ã€å®¹å™¨å†…æ˜¯å¦å­˜åœ¨beanå®šä¹‰ï¼ˆæˆ–è€…Singletonï¼‰ è‹¥ç¬¦åˆï¼ŒgetBean()å‡ºæ¥æ”¾åœ¨mapé‡Œ</span>
            <span class="token comment">// 4ã€è‹¥è¿”å›çš„Mapä¸ä¸ºEmpty()äº†ï¼Œç›´æ¥return  è¡¨ç¤ºæ‰¾åˆ°äº†ï¼ˆå½“ç„¶è¿˜å¯èƒ½æ˜¯å¤šä¸ª~~ï¼‰</span>
            <span class="token comment">// è‹¥è¿”å›çš„è¿˜æ˜¯Empty,é‚£å°±ç»§ç»­æ£€æŸ¥requiredTypeæ˜¯å¦ä¸ºMapã€Collectionç­‰ç±»å‹ï¼Œä»å®ƒé‡Œé¢å»æ‰¾ã€‚ã€‚ã€‚ï¼ˆè¿™ç§æ³¨å…¥caseä½¿ç”¨å¤ªå°‘ï¼Œæ­¤å¤„æš‚ç•¥~ï¼‰</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> matchingBeans <span class="token operator">=</span> <span class="token function">findAutowireCandidates</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> type<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‰€ä»¥matchingBeansè¯æ˜æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ï¼Œä½†requied=trueï¼Œæ‰€ä»¥æ­¤å¤„å°±æŠ›å‡ºå¼‚å¸¸äº†~</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>matchingBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRequired</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">raiseNoMatchingBeanFound</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getResolvableType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> autowiredBeanName<span class="token punctuation">;</span>
            <span class="token class-name">Object</span> instanceCandidate<span class="token punctuation">;</span>

            <span class="token comment">// è‹¥æœ‰å¤šä¸ªåŒ¹é…</span>
            <span class="token comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼š@Qualifieræ³¨è§£åœ¨ä¸Šé¢å°±å·²ç»ç”Ÿæ•ˆäº†~~~~å› ä¸ºAutowireCandidateResolver.isAutowireCandidateæ˜¯åœ¨ä¸Šé¢ç”Ÿæ•ˆçš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>matchingBeans<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ç”±å®ƒè¿›è¡Œåˆ¤åˆ«  ä»å¼±æ°´ä¸‰åƒä¸­  å–å‡ºä¸€ç“¢</span>
                <span class="token comment">// 1ã€æ˜¯å¦æ ‡æ³¨æœ‰@Primary  æœ‰è¿™ç§beanå°±ç›´æ¥è¿”å›ï¼ˆ@Primaryåªå…è®¸æ ‡æ³¨åœ¨ä¸€ä¸ªåŒç±»å‹Beanä¸Šï¼‰</span>
                <span class="token comment">// 2ã€çœ‹æ˜¯å¦æœ‰æ ‡æ³¨æœ‰`javax.annotation.Priority`è¿™ä¸ªæ³¨è§£çš„</span>
                <span class="token comment">// 3ã€æ ¹æ®å­—æ®µfieldåï¼Œå»å’ŒbeanNameåŒ¹é…  åŒ¹é…ä¸Šäº†ä¹Ÿè¡Œï¼ˆè¿™å°±æ˜¯ä¸ºä½•æˆ‘ä»¬æœ‰æ—¶å€™ä¸ç”¨@Qulifierä¹Ÿæ²¡äº‹çš„åŸå› ä¹‹ä¸€ï¼‰</span>
                <span class="token comment">// æ­¤å¤„æ³¨æ„ï¼šdescriptor.getDependencyName()è¿™ä¸ªå±æ€§è¡¨ç¤ºå­—æ®µåï¼Œé çš„æ˜¯`DefaultParameterNameDiscoverer`å»æŠŠå­—æ®µåå–å‡ºæ¥çš„~</span>
                autowiredBeanName <span class="token operator">=</span> <span class="token function">determineAutowireCandidate</span><span class="token punctuation">(</span>matchingBeans<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>autowiredBeanName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRequired</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">indicatesMultipleBeans</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token comment">// æ­¤å¤„æŠ›å‡ºå¼‚å¸¸ï¼šNoUniqueBeanDefinitionException</span>
                        <span class="token keyword">return</span> descriptor<span class="token punctuation">.</span><span class="token function">resolveNotUnique</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span><span class="token function">getResolvableType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> matchingBeans<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// In case of an optional Collection/Map, silently ignore a non-unique case:</span>
                        <span class="token comment">// possibly it was meant to be an empty collection of multiple regular beans</span>
                        <span class="token comment">// (before 4.3 in particular when we didn&#39;t even look for collection beans).</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                instanceCandidate <span class="token operator">=</span> matchingBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// åªæœ‰ä¸€ä¸ªåŒ¹é…å°±å•¥éƒ½è¯´äº†  å¹²å°±å®Œäº†</span>
                <span class="token comment">// We have exactly one match.</span>
                <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">=</span> matchingBeans<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                autowiredBeanName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                instanceCandidate <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>autowiredBeanNames <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                autowiredBeanNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceCandidate <span class="token keyword">instanceof</span> <span class="token class-name">Class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ­¤å¤„getBean() æ‹¿åˆ°è¯¥ç±»å‹çš„å®ä¾‹å¯¹è±¡äº†~~~</span>
                instanceCandidate <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">resolveCandidate</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Object</span> result <span class="token operator">=</span> instanceCandidate<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">instanceof</span> <span class="token class-name">NullBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRequired</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">raiseNoMatchingBeanFound</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getResolvableType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isAssignableValue</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">,</span> type<span class="token punctuation">,</span> instanceCandidate<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConstructorResolver</span><span class="token punctuation">.</span><span class="token function">setCurrentInjectionPoint</span><span class="token punctuation">(</span>previousInjectionPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‹¥å‡ºç°å¤šä¸ªBeanï¼Œå°†ç”±ä¸‹é¢æ–¹æ³•å»åŒ¹é…å’Œå†³å®š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">//determineAutowireCandidate ä»å¤šä¸ªBeanä¸­ï¼Œç­›é€‰å‡ºä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„Bean</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">determineAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> candidates<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> requiredType <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// çœ‹çœ‹ä¼ å…¥çš„Beanä¸­æœ‰æ²¡æœ‰æ ‡æ³¨äº†@Primaryæ³¨è§£çš„</span>
        <span class="token class-name">String</span> primaryCandidate <span class="token operator">=</span> <span class="token function">determinePrimaryCandidate</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ‰¾åˆ°äº† å°±ç›´æ¥è¿”å›</span>
        <span class="token comment">// ç”±æ­¤å¯è§ï¼Œ@Primaryçš„ä¼˜å…ˆçº§è¿˜æ˜¯éå¸¸çš„é«˜çš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryCandidate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> primaryCandidate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æ‰¾åˆ°ä¸€ä¸ªæ ‡æ³¨äº†javax.annotation.Priorityæ³¨è§£çš„ã€‚ï¼ˆå¤‡æ³¨ï¼šä¼˜å…ˆçº§çš„å€¼ä¸èƒ½æœ‰ç›¸åŒçš„ï¼Œå¦åˆ™æŠ¥é”™ï¼‰</span>
        <span class="token class-name">String</span> priorityCandidate <span class="token operator">=</span> <span class="token function">determineHighestPriorityCandidate</span><span class="token punctuation">(</span>candidates<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>priorityCandidate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> priorityCandidate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Fallback</span>
        <span class="token comment">// è¿™é‡Œæ˜¯æœ€ç»ˆçš„å¤„ç†ï¼ˆç›¸ä¿¡ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œéƒ½ä¼šèµ°è¿™é‡Œ~~~~~~~~~~~~~~~~~~~~ï¼‰</span>
        <span class="token comment">// æ­¤å¤„å°±èƒ½çœ‹å‡ºresolvableDependencieså®ƒçš„æ•ˆèƒ½äº†ï¼Œä»–ä¼šæŠŠè§£æè¿‡çš„ä¾èµ–ä»¬ç¼“å­˜èµ·æ¥ï¼Œä¸ç”¨å†é‡å¤è§£æäº†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> candidates<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> candidateName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// åˆ°è¿™ä¸€æ­¥å°±æ¯”è¾ƒç®€å•äº†ï¼ŒmatchesBeanNameåŒ¹é…ä¸ŠMapçš„keyå°±è¡Œã€‚</span>
            <span class="token comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œbeanå¯èƒ½å­˜åœ¨å¾ˆå¤šåˆ«åï¼Œæ‰€ä»¥åªè¦æœ‰ä¸€ä¸ªåˆ«åç›¸åŒï¼Œå°±è®¤ä¸ºæ˜¯èƒ½å¤ŸåŒ¹é…ä¸Šçš„  å…·ä½“å‚è€ƒAbstractBeanFactory#getAliasesæ–¹æ³•</span>
            <span class="token comment">//descriptor.getDependencyName() è¿™ä¸ªç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœæ˜¯å­—æ®µï¼Œè¿™é‡Œè°ƒç”¨çš„this.field.getName() ç›´æ¥ç”¨çš„æ˜¯å­—æ®µçš„åç§°</span>
            <span class="token comment">// å› æ­¤æ­¤å¤„æˆ‘ä»¬çœ‹åˆ°çš„æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬é‡‡ç”¨@Autowiredè™½ç„¶åŒ¹é…åˆ°ä¸¤ä¸ªç±»å‹çš„Beanäº†ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨@Qualifieræ³¨è§£ï¼Œä¹Ÿä¼šæ ¹æ®å­—æ®µåæ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„ï¼ˆè‹¥æ²¡æ‰¾åˆ°ï¼Œå°±æŠ±é”™äº†ï¼‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>beanInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolvableDependencies<span class="token punctuation">.</span><span class="token function">containsValue</span><span class="token punctuation">(</span>beanInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    <span class="token function">matchesBeanName</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getDependencyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> candidateName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//determinePrimaryCandidateï¼šé¡¾åæ€ä¹‰ã€‚å®ƒæ˜¯ä»ç»™å®šçš„Beanä¸­çœ‹æœ‰æœ¨æœ‰æ ‡æ³¨äº†@Primaryæ³¨è§£çš„Beanï¼Œæœ‰é™é€‰æ‹©å®ƒ</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">determinePrimaryCandidate</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> candidates<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> primaryBeanName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> candidates<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> candidateBeanName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// isPrimaryå°±æ˜¯å»çœ‹çœ‹å®¹å™¨é‡Œï¼ˆåŒ…å«çˆ¶å®¹å™¨ï¼‰å¯¹åº”çš„Beanå®šä¹‰ä¿¡æ¯æ˜¯å¦æœ‰@Primaryæ ‡æ³¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrimary</span><span class="token punctuation">(</span>candidateBeanName<span class="token punctuation">,</span> beanInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryBeanName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> candidateLocal <span class="token operator">=</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>candidateBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> primaryLocal <span class="token operator">=</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>primaryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// è¿™ä¸ªç›¸å½“äºå¦‚æœå·²ç»æ‰¾åˆ°äº†ä¸€ä¸ª@Primaryçš„ï¼Œç„¶ååˆæ‰¾åˆ°äº†ä¸€ä¸ª é‚£å°±æŠ›å‡ºå¼‚å¸¸</span>
                    <span class="token comment">// @Primaryåªèƒ½æ ‡æ³¨åˆ°ä¸€ä¸ªåŒç±»å‹çš„Beanä¸Š</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateLocal <span class="token operator">&amp;&amp;</span> primaryLocal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoUniqueBeanDefinitionException</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">,</span> candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token string">&quot;more than one &#39;primary&#39; bean found among candidates: &quot;</span> <span class="token operator">+</span> candidates<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateLocal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        primaryBeanName <span class="token operator">=</span> candidateBeanName<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æŠŠæ‰¾å‡ºæ¥çš„æ ‡æ³¨äº†@Primaryçš„Beançš„åç§°è¿”å›å‡ºå»</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    primaryBeanName <span class="token operator">=</span> candidateBeanName<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> primaryBeanName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// determineHighestPriorityCandidateï¼šä»ç»™å®šçš„Beané‡Œé¢ç­›é€‰å‡ºä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„</span>
<span class="token comment">// ä»€ä¹ˆå«ä¼˜å…ˆçº§æœ€é«˜å‘¢ï¼Ÿä¸»è¦ä¸ºäº†å…¼å®¹JDK6æä¾›çš„æ³¨è§£javax.annotation.Priority</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">determineHighestPriorityCandidate</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> candidates<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> highestPriorityBeanName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> highestPriority <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> candida         tes<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> candidateBeanName <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanInstance <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//AnnotationAwareOrderComparator#getPriority</span>
                <span class="token comment">// è¿™é‡Œå°±æ˜¯ä¸ºäº†å…¼å®¹JDK6æä¾›çš„javax.annotation.Priorityè¿™ä¸ªæ³¨è§£ï¼Œç„¶ååšä¸€ä¸ªä¼˜å…ˆçº§æ’åº</span>
                <span class="token comment">// æ³¨æ„æ³¨æ„æ³¨æ„ï¼šè¿™é‡Œå¹¶ä¸æ˜¯@Orderï¼Œå’Œå®ƒæœ¨æœ‰ä»»ä½•å…³ç³»~~~</span>
                <span class="token comment">// å®ƒæœ‰çš„ä½œç”¨åƒSpringæä¾›çš„@Primaryæ³¨è§£</span>
                <span class="token class-name">Integer</span> candidatePriority <span class="token operator">=</span> <span class="token function">getPriority</span><span class="token punctuation">(</span>beanInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿™é‡Œéƒ½æ˜¯nullï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ@Primaryåªèƒ½æ ‡æ³¨ä¸€ä¸ªï¼Œè¿™ä¸ªè™½ç„¶å¯ä»¥æ ‡æ³¨å¤šä¸ªï¼Œä½†æ˜¯é‡Œé¢çš„ä¼˜å…ˆçº§å€¼ï¼Œä¸èƒ½å‡ºç°ç›¸åŒçš„ï¼ˆå¼ºçƒˆå»ºè®®ä¸è¦ä½¿ç”¨~~~~è€Œä½¿ç”¨@Primaryï¼‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidatePriority <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>highestPriorityBeanName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token comment">// å¦‚æœä¼˜å…ˆçº§çš„å€¼ç›¸ç­‰ï¼Œæ˜¯ä¸å…è®¸çš„ï¼Œè¿™é‡Œéœ€è¦å¼•èµ·æ³¨æ„ï¼Œä¸ªäººå»ºè®®ä¸€èˆ¬è¿˜æ˜¯ä½¿ç”¨@Primaryå§</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidatePriority<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>highestPriority<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoUniqueBeanDefinitionException</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">,</span> candidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;Multiple beans found with the same priority (&#39;&quot;</span> <span class="token operator">+</span> highestPriority <span class="token operator">+</span>
                                            <span class="token string">&quot;&#39;) among candidates: &quot;</span> <span class="token operator">+</span> candidates<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidatePriority <span class="token operator">&lt;</span> highestPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            highestPriorityBeanName <span class="token operator">=</span> candidateBeanName<span class="token punctuation">;</span>
                            highestPriority <span class="token operator">=</span> candidatePriority<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        highestPriorityBeanName <span class="token operator">=</span> candidateBeanName<span class="token punctuation">;</span>
                        highestPriority <span class="token operator">=</span> candidatePriority<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> highestPriorityBeanName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢ä»£ç çš„å¤„ç†è¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li>Springæ³¨å…¥ä¾èµ–åä¼šä¿å­˜ä¾èµ–çš„beanNameï¼Œä½œä¸ºä¸‹æ¬¡æ³¨å…¥ç›¸åŒå±æ€§çš„æ·å¾„ã€‚å¦‚æœå­˜åœ¨æ·å¾„çš„è¯ï¼Œç›´æ¥é€šè¿‡ä¿å­˜çš„beanNameè·å–beanå®ä¾‹</li><li>å¯¹@Valueæ³¨è§£çš„å¤„ç†ã€‚å¦‚æœå­˜åœ¨ï¼Œä¼šè·å–å¹¶è§£ævalueå€¼</li><li>å¯¹æ•°ç»„æˆ–å®¹å™¨ç±»å‹çš„å¤„ç†ã€‚å¦‚æœæ˜¯æ•°ç»„æˆ–å®¹å™¨ç±»å‹çš„è¯ï¼ŒSpringå¯ä»¥å°†æ‰€æœ‰ä¸ç›®æ ‡ç±»å‹åŒ¹é…çš„beanå®ä¾‹éƒ½æ³¨å…¥è¿›å»ï¼Œä¸éœ€è¦åˆ¤æ–­ <ol><li>è·å–æ•°ç»„æˆ–å®¹å™¨å•ä¸ªç»„ä»¶çš„ç±»å‹</li><li>è°ƒç”¨findAutowireCandidatesæ–¹æ³•ï¼Œè·å–ä¸ç»„ä»¶ç±»å‹åŒ¹é…çš„Map(beanName -&gt; beanå®ä¾‹)</li><li>ä¿å­˜ç±»å‹åŒ¹é…çš„beanNames</li></ol></li><li>éæ•°ç»„ã€å®¹å™¨ç±»å‹çš„å¤„ç† <ol><li>è°ƒç”¨findAutowireCandidatesæ–¹æ³•ï¼Œè·å–ä¸ç»„ä»¶ç±»å‹åŒ¹é…çš„Map(beanName -&gt; beanå®ä¾‹)</li><li>å¦‚æœç±»å‹åŒ¹é…çš„ç»“æœä¸ºå¤šä¸ªï¼Œéœ€è¦è¿›è¡Œç­›é€‰(@Primaryã€ä¼˜å…ˆçº§ã€å­—æ®µå)</li><li>å¦‚æœç­›é€‰ç»“æœä¸ä¸ºç©ºï¼Œæˆ–è€…åªæœ‰ä¸€ä¸ªbeanç±»å‹åŒ¹é…ï¼Œå°±ç›´æ¥ä½¿ç”¨è¯¥bean</li></ol></li></ol><p><code>DefaultListableBeanFactory#findAutowireCandidates</code>ï¼šæœç´¢ç±»å‹åŒ¹é…çš„beandçš„Map</p><p>æ ¹æ®æ³¨è§£è¿›è¡Œä¾èµ–æ³¨å…¥çš„ä¸»è¦å·¥ä½œï¼Œå°±æ˜¯æ ¹æ®æ ‡æ³¨çš„å­—æ®µçš„ç±»å‹æ¥æœç´¢ç¬¦åˆçš„beanï¼Œå¹¶å°†ç±»å‹åŒ¹é…çš„beanæ³¨å…¥åˆ°å­—æ®µä¸­ã€‚è€Œæœç´¢beançš„å·¥ä½œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®ç°ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAutowireCandidates</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// è·å–ç±»å‹åŒ¹é…çš„beançš„beanNameåˆ—è¡¨ï¼ˆåŒ…æ‹¬çˆ¶å®¹å™¨ï¼Œä½†æ˜¯æ­¤æ—¶è¿˜æ²¡æœ‰è¿›è¡Œæ³›å‹çš„ç²¾ç¡®åŒ¹é…ï¼‰</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidateNames <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">isEager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å­˜æ”¾ç»“æœçš„Map(beanName -&gt; benaå®ä¾‹)  æœ€ç»ˆä¼šreturnçš„</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>candidateNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//å¦‚æœæ³¨å…¥ç±»å‹æ˜¯ç‰¹æ®Šç±»å‹æˆ–å…¶å­ç±»ï¼Œä¼šå°†ç‰¹æ®Šç±»å‹çš„å®ä¾‹æ·»åŠ åˆ°ç»“æœ</span>
        <span class="token comment">// å“ªäº›ç‰¹æ®Šç±»å‹å‘¢ï¼Ÿä¸Šé¢æˆªå›¾æœ‰ï¼Œæ¯”å¦‚ä½ è¦æ³¨å…¥ApplicationContextã€BeanFactoryç­‰ç­‰</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> autowiringType <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolvableDependencies<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>autowiringType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Object</span> autowiringValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolvableDependencies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>autowiringType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                autowiringValue <span class="token operator">=</span> <span class="token class-name">AutowireUtils</span><span class="token punctuation">.</span><span class="token function">resolveAutowiringValue</span><span class="token punctuation">(</span>autowiringValue<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>autowiringValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">identityToString</span><span class="token punctuation">(</span>autowiringValue<span class="token punctuation">)</span><span class="token punctuation">,</span> autowiringValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// candidateNameså¯èƒ½ä¼šæœ‰å¤šä¸ªï¼Œè¿™é‡Œå°±è¦å¼€å§‹è¿‡æ»¤äº†ï¼Œæ¯”å¦‚@Qualifierã€æ³›å‹ç­‰ç­‰</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> candidate <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ä¸æ˜¯è‡ªå¼•ç”¨ &amp;&amp; ç¬¦åˆæ³¨å…¥æ¡ä»¶</span>
            <span class="token comment">// è‡ªå¼•ç”¨çš„åˆ¤æ–­ï¼šæ‰¾åˆ°çš„å€™é€‰çš„Beançš„åç§°å’Œå½“å‰Beanåç§°ç›¸ç­‰ æˆ–è€… å½“å‰beanåç§°ç­‰äºå·¥å‚beançš„åç§°~~~~~~~</span>
            <span class="token comment">// isAutowireCandidateï¼šè¿™ä¸ªæ–¹æ³•éå¸¸çš„å…³é”®ï¼Œåˆ¤æ–­è¯¥beanæ˜¯å¦å…è®¸æ³¨å…¥è¿›æ¥ã€‚æ³›å‹çš„åŒ¹é…å°±å‘ç”Ÿåœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œä¸‹é¢ä¼šè¯¦è§£</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSelfReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">addCandidateEntry</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> candidate<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">////ç»“æœé›†ä¸ºç©º &amp;&amp; æ³¨å…¥å±æ€§æ˜¯éæ•°ç»„ã€å®¹å™¨ç±»å‹  é‚£ä¹ˆSpringå°±ä¼šæ”¾å®½æ³¨å…¥æ¡ä»¶ï¼Œç„¶åç»§ç»­å¯»æ‰¾</span>
        <span class="token comment">// ä»€ä¹ˆå«æ”¾å®½ï¼šæ¯”å¦‚æ³›å‹ä¸è¦æ±‚ç²¾ç¡®åŒ¹é…äº†ã€æ¯”å¦‚è‡ªå¼•ç”¨çš„æ³¨å…¥ç­‰ç­‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">indicatesMultipleBeans</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Consider fallback matches if the first pass failed to find anything...</span>
            <span class="token comment">//// FallbackMatchï¼šæ”¾å®½å¯¹æ³›å‹ç±»å‹çš„éªŒè¯  æ‰€ä»¥ä»è¿™é‡Œç”¨äº†ä¸€ä¸ªæ–°çš„fallbackDescriptor å¯¹è±¡   ç›¸å½“äºæ”¾å®½äº†æ³›å‹çš„åŒ¹é…</span>
            <span class="token class-name">DependencyDescriptor</span> fallbackDescriptor <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">forFallbackMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> candidate <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSelfReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> fallbackDescriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">addCandidateEntry</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> candidate<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Consider self references as a final pass...</span>
                <span class="token comment">// but in the case of a dependency collection, not the very same bean itself.</span>
                <span class="token comment">//// å¦‚æœç»“æœè¿˜æ˜¯ä¸ºç©ºï¼ŒSpringä¼šå°†è‡ªå¼•ç”¨æ·»åŠ åˆ°ç»“æœä¸­  è‡ªå¼•ç”¨æ˜¯æ”¾åœ¨æœ€åä¸€æ­¥æ·»åŠ è¿›å»çš„</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> candidate <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSelfReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>descriptor <span class="token keyword">instanceof</span> <span class="token class-name">MultiElementDescriptor</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> fallbackDescriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">addCandidateEntry</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> candidate<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¥éª¤æ€»ç»“ï¼š</p><ol><li>å°†è·å–ç±»å‹åŒ¹é…çš„Beanå·¥ä½œäº¤ç»™<code>BeanFactoryUtils.beanNamesForTypeIncludingAncestors</code>ã€‚è¯¥æ–¹æ³•é™¤äº†å½“å‰beanFactoryè¿˜ä¼šé€’å½’å¯¹çˆ¶parentFactoryè¿›è¡ŒæŸ¥æ‰¾</li><li>å¦‚æœæ³¨å…¥ç±»å‹æ˜¯ç‰¹æ®Šç±»å‹æˆ–å…¶å­ç±»ï¼Œä¼šå°†ç‰¹æ®Šç±»å‹çš„å®ä¾‹æ·»åŠ åˆ°ç»“æœ</li><li>å¯¹ç»“æœè¿›è¡Œç­›é€‰ <ol><li><code>BeanDefinitionçš„autowireCandidate</code>å±æ€§ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸è¯¥benaæ³¨å…¥åˆ°å…¶ä»–beanä¸­ï¼Œé»˜è®¤ä¸ºtrue</li><li>æ³›å‹ç±»å‹çš„åŒ¹é…ï¼Œå¦‚æœå­˜åœ¨çš„è¯</li><li>Qualifieræ³¨è§£ã€‚å¦‚æœå­˜åœ¨Qualifieræ³¨è§£çš„è¯ï¼Œä¼šç›´æ¥æ¯”å¯¹Qualifieræ³¨è§£ä¸­æŒ‡å®šçš„beanNameã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSpringå¤„ç†è‡ªå·±å®šä¹‰çš„Qualifieræ³¨è§£ï¼Œè¿˜æ”¯æŒ<code>javax.inject.Qualifier</code>æ³¨è§£</li></ol></li><li>å¦‚æœç­›é€‰åï¼Œç»“æœä¸ºç©ºï¼ŒSpringä¼šæ”¾å®½ç­›é€‰æ¡ä»¶ï¼Œå†ç­›é€‰ä¸€æ¬¡</li></ol><p><code>DefaultListableBeanFactory#isAutowireCandidate</code> åˆ¤æ–­æŒ‡å®šçš„descriptoræ˜¯å¦èƒ½å¤Ÿè¢«æ³¨å…¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">{</span>
        <span class="token comment">//getAutowireCandidateResolver()ä¸ºContextAnnotationAutowireCandidateResolver</span>
        <span class="token keyword">return</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> <span class="token function">getAutowireCandidateResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">,</span> <span class="token class-name">AutowireCandidateResolver</span> resolver<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> beanDefinitionName <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">transformedBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‹¥å­˜åœ¨Beanå®šä¹‰ï¼Œå°±èµ°è¿™é‡Œï¼ˆå› ä¸ºæœ‰çš„Beanå¯èƒ½æ˜¯ç›´æ¥registerSingletonè¿›æ¥çš„ï¼Œæ˜¯ä¸å­˜åœ¨Beanå®šä¹‰çš„ï¼‰  </span>
        <span class="token comment">// æˆ‘ä»¬çš„æ³¨å…¥ï¼Œç»å¤§éƒ¨åˆ†æƒ…å†µéƒ½èµ°è¿™é‡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanDefinitionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//getMergedLocalBeanDefinitionæ–¹æ³•çš„ä½œç”¨å°±æ˜¯è·å–ç¼“å­˜çš„BeanDefinitionå¯¹è±¡å¹¶åˆå¹¶å…¶çˆ¶ç±»å’Œæœ¬èº«çš„å±æ€§</span>
            <span class="token keyword">return</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanDefinitionName<span class="token punctuation">)</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è‹¥å·²ç»å­˜åœ¨å®ä¾‹äº†ï¼Œå°±èµ°è¿™é‡Œ</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span><span class="token function">getType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// çˆ¶å®¹å™¨  æœ‰å¯èƒ½ä¸ºnullï¼Œä¸ºnullå°±è‚¯å®šèµ°elseé»˜è®¤å€¼äº† true å¯ä»¥æ³¨å…¥</span>
        <span class="token class-name">BeanFactory</span> parent <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token keyword">instanceof</span> <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// No bean definition found in this factory -&gt; delegate to parent.</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">)</span> parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If no DefaultListableBeanFactory, can&#39;t pass the resolver along.</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> parent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// é»˜è®¤å€¼æ˜¯true</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span>
                                          <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">,</span> <span class="token class-name">AutowireCandidateResolver</span> resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">String</span> beanDefinitionName <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">transformedBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//resolveBeanClass è¿™ä¸ªæ–¹æ³•ä¹‹å‰æåˆ°è¿‡ï¼Œä¸»è¦æ˜¯ä¿è¯æ­¤Classå·²ç»è¢«åŠ è½½è¿›æ¥äº†</span>
        <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanDefinitionName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ˜¯å¦å·²ç»æŒ‡å®šå¼•ç”¨éé‡è½½æ–¹æ³•çš„å·¥å‚æ–¹æ³•åã€‚  é»˜è®¤å€¼æ˜¯true</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>isFactoryMethodUnique<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> resolve<span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resolve <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ­¤å¤„ä¸»è¦å¤„ç†å·¥å‚æ–¹æ³•çš„æ–¹å¼ï¼Œæ­¤å¤„å…ˆç•¥è¿‡~</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">new</span> <span class="token class-name">ConstructorResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveFactoryMethodIfPossible</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ ¸å¿ƒæ¥äº†ã€‚ContextAnnotationAutowireCandidateResolver#isAutowireCandidateæ–¹æ³•</span>
        <span class="token comment">// çœŸæ­£çš„å®ç°åœ¨çˆ¶ç±»ï¼šQualifierAnnotationAutowireCandidateResolverå®ƒèº«ä¸Š</span>
        <span class="token keyword">return</span> resolver<span class="token punctuation">.</span><span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token function">getAliases</span><span class="token punctuation">(</span>beanDefinitionName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>QualifierAnnotationAutowireCandidateResolver#isAutowireCandidate</code>ï¼šåˆ¤æ–­è¯¥Beanæ˜¯å¦èƒ½æ³¨å…¥ï¼ˆä¼šè§£æ@Qualifieræ³¨è§£ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> bdHolder<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> match <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ°äº†è¿™ï¼Œå¦‚æœæ˜¯falseï¼Œè¯´æ˜æ³›å‹æ²¡æœ‰åŒ¹é…ä¸Š(é‚£å°±ä¸ç”¨ç»§ç»­å¾€ä¸‹èµ°äº†)</span>
        <span class="token comment">// å¦‚æœæ˜¯trueï¼Œé‚£å°±ç»§ç»­ï¼Œè§£æ@Qualifieræ³¨è§£å•¦  æ‰€ä»¥è‹¥ä½ æ ‡è®°äº†@Qualifieræ³¨è§£ ä¹Ÿæ˜¯éœ€è¦å¯¹åº”ä¸Š</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿™ä¸ªé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ ‡æ³¨@Qualifieræ³¨è§£(æ²¡æœ‰æ ‡æ³¨ä¹Ÿæ˜¯è¿”å›true~~)</span>
            <span class="token comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSpringè¿™é‡Œæ”¯æŒè‡ªå·±çš„@Qualifierï¼Œä¹Ÿæ”¯æŒjavax.inject.Qualifier</span>
            <span class="token comment">// checkQualifiers() è¿™ä¸ªæ–¹æ³•æœ‰ä¸€äº›æœ‰æ„æ€çš„å¤„ç†ï¼Œå› æ­¤è¿˜æ˜¯å†³å®šè®²è§£ä¸€ä¸‹ï¼Œè¯·å‚è§ä¸‹é¢çš„è§£æ~~~~~</span>
            match <span class="token operator">=</span> <span class="token function">checkQualifiers</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> descriptor<span class="token punctuation">.</span><span class="token function">getAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å…¼å®¹åˆ°æ–¹æ³•çº§åˆ«çš„æ³¨å…¥~~~~~~~~~~~~~</span>
                <span class="token class-name">MethodParameter</span> methodParam <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>methodParam <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Method</span> method <span class="token operator">=</span> methodParam<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        match <span class="token operator">=</span> <span class="token function">checkQualifiers</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> methodParam<span class="token punctuation">.</span><span class="token function">getMethodAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//boolean match = super.isAutowireCandidate(bdHolder, descriptor);(GenericTypeAwareAutowireCandidateResolverä¸­)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> bdHolder<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// If explicitly false, do not proceed with any other checks...</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¿™é‡Œï¼Œè¿™é‡Œï¼Œè¿™é‡Œ  çœ‹æ–¹æ³•åå°±èƒ½çœ‹å‡ºæ¥ã€‚æ£€æµ‹çœ‹çœ‹æ³›å‹æ˜¯å¦åŒ¹é…ã€‚</span>
        <span class="token comment">// è‹¥æ³›å‹éƒ½ä¸åŒ¹é…ï¼Œå°±ç›´æ¥è¿”å›falseäº†,åŸºæœ¬æ­¥éª¤ä¸ºï¼š</span>
        <span class="token comment">//1ã€ä»descriptoré‡Œæ‹¿å€’æ³›å‹ç±»å‹</span>
        <span class="token comment">//2ã€First, check factory method return type, if applicable</span>
        <span class="token comment">//3ã€return dependencyType.isAssignableFrom(targetType);</span>
        <span class="token comment">// è¿™ä¸ªæ–¹æ³•å®˜æ–¹docä¸ºï¼šFull check for complex generic type match... å¸¦æ³›å‹çš„å…¨æ£€æŸ¥ï¼Œè€Œä¸æ˜¯ç®€å•Classç±»å‹çš„åˆ¤æ–­</span>
        <span class="token keyword">return</span> <span class="token function">checkGenericTypeMatch</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// if (!super.isAutowireCandidate(bdHolder, descriptor)) {  (SimpleAutowireCandidateResolverä¸­)</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> bdHolder<span class="token punctuation">,</span> <span class="token class-name">DependencyDescriptor</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Beanå®šä¹‰ä¿¡æ¯çš„é»˜è®¤å€¼ï¼Œéƒ½ä¼šè¿”å›true</span>
        <span class="token keyword">return</span> bdHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutowireCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>QualifierAnnotationAutowireCandidateResolver#checkQualifiers</code>ï¼šæ£€æŸ¥<code>@Qualifier</code>æ³¨è§£æ˜¯å¦ç¬¦åˆæ¡ä»¶ ä¸Šé¢çŸ¥é“äº†ï¼Œè‹¥ç±»å‹å•¥çš„éƒ½åŒ¹é…ä¸Šäº†ï¼Œæ¥ä¸‹æ¥è¿˜å¾—è§£æ<code>@Qualifier</code>æ˜¯å¦åŒ¹é…ï¼Œå®ƒæœ‰ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç‚¹ï¼š<code>@Qualifier</code>å¯ä»¥æ ‡æ³¨åœ¨ç±»ä¸Šé¢ï¼Œä¹Ÿå¯ä»¥è¾¾åˆ°åŒ¹é…çš„æ•ˆæœã€‚ï¼ˆä½†å®ƒä¸æ˜¯Beanåç§°ï¼Œä¹Ÿä¸æ˜¯beançš„åˆ«åï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * Match the given qualifier annotations against the candidate bean definition.
     * å°†ç»™å®šçš„@Qualifieræ³¨è§£ä¸å€™é€‰beanå®šä¹‰åŒ¹é…~~~ï¼ˆç®€å•çš„ä¹¦å°±æ˜¯çœ‹çœ‹ç±»å‹å·²åŒ¹é…ä¸Šçš„ï¼Œ@Qualifieræ˜¯å¦è¿˜èƒ½åŒ¹é…ä¸Šï¼‰
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">checkQualifiers</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> bdHolder<span class="token punctuation">,</span> <span class="token class-name">Annotation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> annotationsToSearch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿™é‡Œä¸€èˆ¬ä¼šæœ‰ä¸¤ä¸ªæ³¨è§£  ä¸€ä¸ª@Autowired ä¸€ä¸ª@Qualifier  </span>
        <span class="token comment">// æˆ–è€…è¿˜æœ‰å…¶ä½™çš„ç»„åˆæ³¨è§£~~~</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>annotationsToSearch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">SimpleTypeConverter</span> typeConverter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Annotation</span> annotation <span class="token operator">:</span> annotationsToSearch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> type <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">annotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> checkMeta <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> fallbackToMeta <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token comment">//isQualifierï¼šåˆ¤æ–­æ˜¯ä¸æ˜¯@Qualifieræ³¨è§£ä»¥åŠ JSR330çš„`javax.inject.Qualifier`æ³¨è§£ä¹Ÿæ˜¯æ”¯æŒçš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isQualifier</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// checkQualifier æœ€é‡è¦çš„æ–¹æ³•å°±æ˜¯è¿™ä¸ªäº†ï¼Œå®ƒæ˜¯ä¸ªé‡è½½æ–¹æ³•ã€‚ã€‚ã€‚å®ƒçš„å†…å®¹éå¸¸é•¿ï¼Œå¤§è‡´æˆ‘åœ¨è¿™é‡Œè§£ææ­¥éª¤å¦‚ä¸‹ï¼š</span>
                <span class="token comment">//1ã€bd.getQualifier çœ‹çœ‹Beanå®šä¹‰é‡Œæ˜¯å¦å·²ç»å®šä¹‰è¿‡tQualifierä»¬(ä½†æ˜¯ç»è¿‡æˆ‘çš„è·Ÿè¸ªï¼ŒBeanå®šä¹‰å¾—è¿™ä¸ªå­—æ®µï¼šprivate final Map&lt;String, AutowireCandidateQualifier&gt; qualifiers;æ°¸è¿œä¸ä¼šè¢«èµ‹å€¼ å¦‚æœ‰äººçŸ¥é“ï¼Œè¯·å‘ŠçŸ¥æˆ‘ äº†èƒ½äº‹Springé¢„ç•™å¾—å§)</span>
                <span class="token comment">//2ã€è¯¥Beanå®šä¹‰å¾—AnnotatedElement qualifiedElementçš„è¿™ä¸ªå±æ€§ä¸Šæ˜¯å¦æœ‰æŒ‡å®šçš„æ³¨è§£ï¼Œæœ‰å°±æ‹¿å‡ºè¿™ä¸ªAnnotationï¼Œå¦åˆ™ç»§ç»­ä¸‹ä¸€æ­¥</span>
                <span class="token comment">//3ã€resolvedFactoryMethodå·¥å‚æ–¹æ³•ä¸Šæ˜¯å¦æœ‰è¿™ä¸ªæ³¨è§£ï¼Œå¦åˆ™è¿›è¡Œä¸‹ä¸€æ­¥ï¼ˆä¸‹ä¸€æ­¥äº‹å…³é”®ã€‚ã€‚ã€‚ï¼‰</span>
                <span class="token comment">//4ã€Look for matching annotation on the target class  JavaDocå¾—æ„æ€å¤‡æ³¨ä¹Ÿå¾ˆæ¸…æ™°ï¼Œå°±æ˜¯å»å…·ä½“å¾—ç±»ä¸Šé¢ï¼Œçœ‹æœ‰æ²¡æœ‰æœ‰å¯¹åº”çš„æ³¨è§£ï¼Œæœ‰å°±æ‹¿å‡ºæ¥ã€‚</span>
                <span class="token comment">//ï¼ˆæœ‰ä¸ªç»†èŠ‚ï¼‰ï¼šå³ä½¿è¿™ä¸ªç±»è¢«ä»£ç†äº†ï¼Œä¹Ÿæ˜¯èƒ½æ‹¿åˆ°æ ‡æ³¨åœ¨å®ƒä¸Šé¢çš„æ³¨è§£çš„  å› ä¸ºï¼š AnnotationUtils.getAnnotation(ClassUtils.getUserClass(bd.getBeanClass()), type)</span>
                <span class="token comment">//5ã€åˆ°è¿™é‡Œï¼Œå¦‚å›½è·å¾—äº†å¯¹åº”çš„@Qualifieræ³¨è§£ï¼Œé‚£å°±ä¼šæ¯”è¾ƒã€‚å¦‚æœvalueå€¼ä¹Ÿç›¸åŒï¼Œé‚£å°±return trueï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹èµ°</span>
                <span class="token comment">//6ã€æ¥ä¸‹æ¥æ‹¿åˆ°è¿™ä¸ªæ³¨è§£çš„attributesï¼Œç„¶ååˆ¤æ–­è‹¥@Qualifieræ²¡æœ‰valueå€¼æˆ–è€…æ˜¯ç©ºä¸²ï¼Œå°±åªreturn falseäº†  å¦åˆ™ç»§ç»­çœ‹</span>
                <span class="token comment">//7ã€æœ€ç»ˆä¼šå’ŒBeanä¸Šé¢é‚£ä¸ªæ³¨è§£ï¼ˆä¸€èˆ¬éƒ½æ˜¯@Componentç­‰æ³¨è§£ï¼‰çš„valueå€¼å’Œ@Qualifierå¾—valueå€¼è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥ç›¸ç­‰  å°±æœ€ç»ˆè¿”å›trueå‹’ï¼ˆè¯·æ³¨æ„ï¼šæ­¤å¤„Beanå¾—aliasåˆ«åè‹¥ç›¸ç­‰ä¹Ÿæ˜¯ä¼šè¿”å›trueï¼‰</span>
                <span class="token comment">//8ã€======å°±è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†Beanå®šä¹‰å’Œ@Qualifierå¾—ä¸€ä¸ªåŒ¹é…è¿‡ç¨‹======</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkQualifier</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> typeConverter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fallbackToMeta <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    checkMeta <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// è¿™ä¸€æ­¥éå¸¸æœ‰æ•ˆï¼šç›¸å½“äºæ”¯æŒåˆ°äº†ç»„åˆæ³¨è§£çš„æƒ…å†µã€‚ å®ƒè¿æ³¨è§£çš„æ³¨è§£éƒ½ä¼šè§£æ</span>
            <span class="token comment">// æ¯”å¦‚æˆ‘ä»¬@MyAnnoä¸Šé¢è¿˜æœ‰@Qualifieræ³¨è§£ï¼Œä»ç„¶ä¼šè¢«è¿™é‡Œè§£æåˆ°çš„  å†…éƒ¨æœ‰ä¸€ä¸ªé€’å½’</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> foundMeta <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Annotation</span> metaAnn <span class="token operator">:</span> type<span class="token punctuation">.</span><span class="token function">getAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span> metaType <span class="token operator">=</span> metaAnn<span class="token punctuation">.</span><span class="token function">annotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isQualifier</span><span class="token punctuation">(</span>metaType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        foundMeta <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token comment">// Only accept fallback match if @Qualifier annotation has a value...</span>
                        <span class="token comment">// Otherwise it is just a marker for a custom qualifier annotation.</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fallbackToMeta <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>metaAnn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                                <span class="token operator">!</span><span class="token function">checkQualifier</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> metaAnn<span class="token punctuation">,</span> typeConverter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fallbackToMeta <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>foundMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><ul><li><strong>AbstractAutoProxyCreator</strong></li></ul><blockquote><p>â€‹ AOPä¸­å¯¹å¤„ç†å™¨çš„å…¸å‹åº”ç”¨ï¼Œç»§æ‰¿è‡ª<code>SmartInstantiationAwareBeanPostProcessor</code>ã€‚AspectJAwareAdvisorAutoProxyCreatorï¼ˆæä¾›å¯¹<code>&lt;aop:config&gt;</code>çš„æ”¯æŒï¼‰å’ŒAnnotationAwareAspectJAutoProxyCreatorï¼ˆæä¾›å¯¹<code>@AspectJ</code>æ³¨è§£çš„æ”¯æŒï¼‰éƒ½æ˜¯ç»§æ‰¿AbstractAutoProxyCreatorï¼Œå½“ä½¿ç”¨<code>aop:config</code>é…ç½®æ—¶è‡ªåŠ¨æ³¨å†ŒAspectJAwareAdvisorAutoProxyCreatorï¼Œè€Œä½¿ç”¨<code>aop:aspectj-autoproxy</code>æ—¶ä¼šè‡ªåŠ¨æ³¨å†ŒAnnotationAwareAspectJAutoProxyCreatorã€‚</p><ul><li>predictBeanTypeï¼šé¢„æµ‹Beançš„ç±»å‹ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡è¢«AOPä»£ç†å¯¹è±¡åŒ…è£…ï¼Œæ­¤å¤„å°†è¿”å›AOPä»£ç†å¯¹è±¡çš„ç±»å‹ï¼ˆè€Œä¸æ˜¯ç›®æ ‡å¯¹è±¡çš„ç±»å‹ï¼‰</li><li>postProcessBeforeInstantiationï¼šå½“æˆ‘ä»¬é…ç½®<code>TargetSourceCreator</code>è¿›è¡Œ<strong>è‡ªå®šä¹‰TargetSourceåˆ›å»ºæ—¶</strong>ï¼Œä¼šåˆ›å»ºä»£ç†å¯¹è±¡å¹¶<strong>ä¸­æ–­</strong>é»˜è®¤Springåˆ›å»ºæµç¨‹</li><li>getEarlyBeanReferenceï¼šè·å–early Beanå¼•ç”¨ï¼ˆåªæœ‰å•ä¾‹Beanæ‰èƒ½å›è°ƒè¯¥æ–¹æ³•ï¼‰</li><li>postProcessAfterInitializationï¼šå¦‚æœä¹‹å‰è°ƒç”¨è¿‡getEarlyBeanReferenceè·å–åŒ…è£…ç›®æ ‡å¯¹è±¡åˆ°AOPä»£ç†å¯¹è±¡ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œåˆ™ä¸å†æ‰§è¡Œã€‚å¦åˆ™åŒ…è£…ç›®æ ‡å¯¹è±¡åˆ°AOPä»£ç†å¯¹è±¡ï¼ˆå¦‚æœéœ€è¦ï¼‰</li></ul><p>getEarlyBeanReferenceå’ŒpostProcessAfterInitializationæ˜¯äºŒè€…é€‰ä¸€çš„ï¼Œè€Œä¸”å•ä¾‹Beanç›®æ ‡å¯¹è±¡åªèƒ½è¢«å¢å¼ºä¸€æ¬¡ï¼Œè€ŒåŸå‹Beanç›®æ ‡å¯¹è±¡å¯èƒ½è¢«åŒ…è£…å¤šæ¬¡</p></blockquote><ul><li><strong>MethodValidationPostProcessor</strong></li></ul><blockquote><p>åŸºäº<code>Hibernate Validator</code>çš„æ ¡éªŒã€‚<strong>æä¾›å¯¹æ–¹æ³•å‚æ•°/æ–¹æ³•è¿”å›å€¼çš„è¿›è¡ŒéªŒè¯</strong>ï¼ˆå³å‰ç½®æ¡ä»¶/åç½®æ¡ä»¶çš„æ”¯æŒï¼‰ï¼Œé€šè¿‡JSR-303æ³¨è§£éªŒè¯ï¼Œä½¿ç”¨æ–¹å¼å¦‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token annotation punctuation">@NotNull</span> <span class="token class-name">Object</span> <span class="token function">myValidMethod</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> <span class="token class-name">String</span> arg1<span class="token punctuation">,</span> <span class="token annotation punctuation">@Max</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">int</span> arg2<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>â€‹ é»˜è®¤åªå¯¹<code>@org.springframework.validation.annotation.Validated</code>(å®ƒæ˜¯jsr303æ³¨è§£<code>javax.validation.Valid</code>çš„å˜ä½“)æ³¨è§£çš„Beanè¿›è¡ŒéªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹validatedAnnotationTypeä¸ºå…¶ä»–æ³¨è§£ç±»å‹æ¥æ”¯æŒå…¶ä»–æ³¨è§£éªŒè¯ã€‚è€Œä¸”ç›®å‰åªæ”¯æŒHibernate Validatorå®ç°ï¼Œåœ¨æœªæ¥ç‰ˆæœ¬å¯èƒ½æ”¯æŒå…¶ä»–å®ç°ã€‚</p></blockquote><ul><li><strong>ScheduledAnnotationBeanPostProcessor</strong></li></ul><blockquote><p>â€‹ å½“é…ç½®æ–‡ä»¶ä¸­æœ‰<code>task:annotation-driven</code>è‡ªåŠ¨æ³¨å†Œæˆ–<code>@EnableScheduling</code>è‡ªåŠ¨æ³¨å†Œã€‚ï¼ˆæä¾›å¯¹æ³¨è§£@Scheduledä»»åŠ¡è°ƒåº¦çš„æ”¯æŒï¼‰</p><p>â€‹ <code>postProcessAfterInitialization</code>ï¼šé€šè¿‡æŸ¥æ‰¾Beanå¯¹è±¡ç±»ä¸Šçš„<code>@Scheduled</code>æ³¨è§£æ¥åˆ›å»ºScheduledMethodRunnableå¯¹è±¡å¹¶æ³¨å†Œä»»åŠ¡è°ƒåº¦æ–¹æ³•ï¼ˆ<strong>ä»…è¿”å›å€¼ä¸ºvoidä¸”æ–¹æ³•æ˜¯æ— å½¢å¼å‚æ•°çš„æ‰å¯ä»¥</strong>ï¼‰ã€‚</p></blockquote><ul><li><strong>AsyncAnnotationBeanPostProcessor</strong></li></ul><blockquote><p>â€‹ å½“é…ç½®æ–‡ä»¶ä¸­æœ‰<code>task:annotation-driven</code>è‡ªåŠ¨æ³¨å†Œæˆ–<code>@EnableAsync</code>è‡ªåŠ¨æ³¨å†Œã€‚æä¾›å¯¹<code>@Async</code>å’ŒEJB3.1çš„<code>@javax.ejb.Asynchronous</code>æ³¨è§£çš„<strong>å¼‚æ­¥è°ƒç”¨</strong>æ”¯æŒã€‚ <code>postProcessAfterInitialization</code>ï¼šé€šè¿‡<code>ProxyFactory</code>åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œé»˜è®¤ä½¿ç”¨AsyncAnnotationAdvisorï¼ˆå†…éƒ¨ä½¿ç”¨AsyncExecutionInterceptor é€šè¿‡AsyncTaskExecutorï¼ˆç»§æ‰¿TaskExecutorï¼‰é€šè¿‡submitæäº¤å¼‚æ­¥ä»»åŠ¡ï¼‰</p></blockquote><ul><li><strong>ServletContextAwareProcessor</strong></li></ul><blockquote><p>â€‹ åœ¨ä½¿ç”¨Webå®¹å™¨æ—¶è‡ªåŠ¨æ³¨å†Œã€‚ç±»ä¼¼äºApplicationContextAwareProcessorï¼Œå½“ä½ çš„Bean å®ç°äº†ServletContextAware/ ServletConfigAwareä¼šè‡ªåŠ¨è°ƒç”¨å›è°ƒæ–¹æ³•æ³¨å…¥ServletContext/ServletConfigã€‚</p></blockquote><h4 id="beanpostprocessorçš„æ‰§è¡Œé¡ºåº" tabindex="-1"><a class="header-anchor" href="#beanpostprocessorçš„æ‰§è¡Œé¡ºåº" aria-hidden="true">#</a> BeanPostProcessorçš„æ‰§è¡Œé¡ºåº</h4><ol><li>å¦‚æœä½¿ç”¨BeanFactoryå®ç°ï¼ŒéApplicationContextå®ç°ï¼ŒBeanPostProcessoræ‰§è¡Œé¡ºåºå°±æ˜¯æ·»åŠ é¡ºåºã€‚</li><li>å¦‚æœä½¿ç”¨çš„æ˜¯AbstractApplicationContextï¼ˆå®ç°äº†ApplicationContextï¼‰çš„å®ç°ï¼Œåˆ™é€šè¿‡å¦‚ä¸‹è§„åˆ™æŒ‡å®šé¡ºåºã€‚<code>PriorityOrdered &gt; Ordered &gt; æ— å®ç°æ¥å£çš„ &gt; å†…éƒ¨Beanåå¤„ç†å™¨</code>ï¼ˆå®ç°äº†MergedBeanDefinitionPostProcessoræ¥å£çš„æ˜¯å†…éƒ¨BeanPostProcessorï¼Œå°†åœ¨æœ€åä¸”æ— åºæ³¨å†Œï¼‰</li></ol><hr><h3 id="beanfactory" tabindex="-1"><a class="header-anchor" href="#beanfactory" aria-hidden="true">#</a> BeanFactory</h3><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/bw88ddpa4c.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>BeanFactoryï¼šä¸€çº§æ¥å£ï¼ŒSpring IOCå®¹å™¨é¡¶çº§æ¥å£ï¼Œå®šä¹‰äº†å¯¹å•ä¸ªbeançš„è·å–ï¼Œå¯¹beançš„ä½œç”¨åŸŸåˆ¤æ–­ï¼Œè·å–beanç±»å‹ï¼Œè·å–beanåˆ«åçš„åŠŸèƒ½ã€‚<strong>å®ƒæ²¡æœ‰AOPåŠŸèƒ½ã€Webåº”ç”¨åŠŸèƒ½ç­‰ç­‰</strong></li><li>ListableBeanFactoryï¼šäºŒçº§æ¥å£ï¼Œæ‰©å±•äº†BeanFactoryæ¥å£ï¼Œå¹¶æä¾›äº†å¯¹beançš„æšä¸¾èƒ½åŠ›</li><li>HierarchicalBeanFactoryï¼šäºŒçº§æ¥å£ï¼Œæ‰©å±•äº†BeanFactoryæ¥å£ï¼Œå¹¶æä¾›äº†è®¿é—®çˆ¶å®¹å™¨çš„èƒ½åŠ›</li><li>AutowireCapableBeanFactoryï¼šäºŒçº§æ¥å£ï¼Œæ‰©å±•äº†BeanFactoryæ¥å£ï¼Œå¹¶æä¾›äº†è‡ªåŠ¨è£…é…èƒ½åŠ›</li><li>ConfigurableBeanFactoryï¼šä¸‰çº§æ¥å£ï¼Œæ‰©å±•äº†HierarchicalBeanFactoryï¼Œå¹¶æä¾›äº†å¯¹å®¹å™¨çš„é…ç½®èƒ½åŠ›</li><li>ConfigurableListableBeanFactoryï¼šå››çº§æ¥å£ï¼Œæ‰©å±•äº†ListableBeanFactoryï¼Œ AutowireCapableBeanFactoryï¼ŒConfigurableBeanFactoryæ¥å£ï¼Œå¹¶æä¾›äº†å¿½ç•¥ä¾èµ–ï¼Œè‡ªåŠ¨è£…é…åˆ¤æ–­ï¼Œå†»ç»“beançš„å®šä¹‰ï¼Œæšä¸¾æ‰€æœ‰beanåç§°çš„åŠŸèƒ½`</li></ul><h4 id="abstractbeanfactory" tabindex="-1"><a class="header-anchor" href="#abstractbeanfactory" aria-hidden="true">#</a> AbstractBeanFactory</h4><p>â€‹ <code>AbstractBeanFactory</code>ä½œä¸ºä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°äº†ä¸‰çº§æ¥å£<code>ConfigurableBeanFactory</code>(æ–¹æ³•50+çš„æ¥å£)å¤§éƒ¨åˆ†åŠŸèƒ½ã€‚ è€Œä¸”ç»§æ‰¿è‡ª<code>FactoryBeanRegistrySupport</code>ï¼Œæ‰€ä»¥å®ƒä¹Ÿå…·å¤‡äº†<code>SingletonBeanRegistry</code>å’Œ<code>SimpleAliasRegistry</code>çš„èƒ½åŠ›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">FactoryBeanRegistrySupport</span> <span class="token keyword">implements</span> <span class="token class-name">ConfigurableBeanFactory</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> å®ç°äº†å¤§éƒ¨åˆ†çš„æ–¹æ³•ï¼Œå…¶ä¸­æœ€ç»ˆçš„å®ç°ä¸º<span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>æ–¹æ³•çš„å®ç°ï¼Œæä¾›äº†æ¨¡ç‰ˆã€‚å…¶å®createBeanæŠ½è±¡æ–¹æ³•ï¼Œè¿˜æ˜¯å­ç±»å»å®ç°çš„
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> ä¹Ÿèƒ½å®ç°ç²¾å‡†çš„åˆ¤æ–­äº†

	<span class="token comment">// ===å…¶ä¸­ï¼Œå®ƒè‡ªå·±æä¾›äº†ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å¿…è¦å»å®ç°çš„===</span>
	
	<span class="token comment">// æ•ˆæœåŒï¼šListableBeanFactory#containsBeanDefinition  å®ç°ç±»ï¼šDefaultListableBeanFactory</span>
	<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// æ•ˆæœåŒï¼šConfigurableListableBeanFactory#getBeanDefinition  å®ç°ç±»ï¼šDefaultListableBeanFactory</span>
	<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">BeanDefinition</span> <span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>
	<span class="token comment">// åˆ›å»ºBeançš„å¤æ‚é€»è¾‘ï¼Œå­ç±»å»å®ç°ã€‚(å­ç±»ï¼šAbstractAutowireCapableBeanFactory)</span>
	<span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
	<span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">;</span>
	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="abstractautowirecapablebeanfactory" tabindex="-1"><a class="header-anchor" href="#abstractautowirecapablebeanfactory" aria-hidden="true">#</a> AbstractAutowireCapableBeanFactory</h4><p>AutowireCapableBeanFactoryå¯ä»¥ä¸ºéå®¹å™¨å†…çš„beanæœåŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„åº”ç”¨ä¸Šä¸‹æ–‡<code>ApplicationContext</code>å®ƒå°±æä¾›äº†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ä¸€èˆ¬çš„å®ç°ä¸ºDefaultListableBeanFactory</span>
<span class="token class-name">AutowireCapableBeanFactory</span> <span class="token function">getAutowireCapableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>AutowireCapableBeanFactoryåœ¨BeanFactoryåŸºç¡€ä¸Šå®ç°äº†å¯¹å­˜åœ¨å®ä¾‹çš„ç®¡ç†ã€‚å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¥å£é›†æˆå…¶å®ƒæ¡†æ¶ï¼Œæ†ç»‘å¹¶å¡«å……å¹¶ä¸ç”±Springç®¡ç†ç”Ÿå‘½å‘¨æœŸå¹¶å·²å­˜åœ¨çš„å®ä¾‹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token keyword">int</span> autowireMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dependencyCheck<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token comment">// Use non-singleton bean definition, to avoid registering bean as dependent bean.</span>
        <span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span>  autowireMode<span class="token punctuation">,</span> dependencyCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™é‡Œçœ‹åˆ°äº†ï¼Œé‡‡ç”¨çš„ä¸æ˜¯å•ä¾‹ï¼Œè€Œæ˜¯prototype</span>
        bd<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">SCOPE_PROTOTYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// For the nullability warning, see the elaboration in AbstractBeanFactory.doGetBean;</span>
        <span class="token comment">// in short: This is never going to be null unless user-declared code enforces null.</span>
        <span class="token comment">// docè¯´å¾—å¾ˆæ˜ç™½ï¼Œè¿™é‡Œè¿”å›å€¼æ°¸è¿œä¸å¯èƒ½ä¸ºnullã€‚é™¤éè°ƒç”¨è€…å¼ºåˆ¶return null</span>
        <span class="token comment">// æ³¨æ„çš„æ˜¯:è¿™é‡ŒBeanNameå°±æ˜¯beanClass.getName()</span>
        <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æœ€ç»ˆéƒ½è°ƒç”¨åˆ°äº†ä¸‹é¢è¿™ä¸ªcreateBeanæ–¹æ³•ã€‚å®ƒä¹Ÿæ˜¯AbstractBeanFactoryæä¾›çš„ä¸€ä¸ªæŠ½è±¡æ–¹æ³•</span>
    <span class="token comment">// æœ€ç»ˆä¹Ÿç”±AbstractAutowireCapableBeanFactoryå»å®ç°çš„ã€‚ æˆ‘ä»¬ç†Ÿæ‚‰çš„doGetBean()æ–¹æ³•ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨å®ƒæ¥åˆ›å»ºå®ä¾‹å¯¹è±¡  åªæ˜¯doGetBean()æŠŠå•ä¾‹å¯¹è±¡éƒ½ç¼“å­˜èµ·æ¥äº†</span>
    <span class="token comment">// è¿™ä¸ªæ–¹æ³•å¾ˆå•çº¯ï¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œç„¶ååˆå§‹åŒ–ä»–ï¼ˆç»™å±æ€§ä»¬èµ‹å€¼ï¼‰ï¼Œç„¶åreturnå‡ºå»å³å¯</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating instance of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>

        <span class="token comment">// Make sure bean class is actually resolved at this point, and</span>
        <span class="token comment">// clone the bean definition in case of a dynamically resolved Class</span>
        <span class="token comment">// which cannot be stored in the shared merged bean definition.</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Prepare method overrides.</span>
        <span class="token comment">// è§£æä¸€äº›@lookupæ³¨è§£ä¹‹ç±»çš„  å¿½ç•¥</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    beanName<span class="token punctuation">,</span> <span class="token string">&quot;Validation of method overrides failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
            <span class="token comment">// è‹¥BeanPostProcessors äº§ç”Ÿäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå°±ä¸éœ€è¦æˆ‘å»åˆ›å»ºäº†ï¼Œå°±ä¸ç»§ç»­å¾€ä¸‹èµ°äº†ï¼ˆAOPéƒ½èµ°è¿™é‡Œï¼‰</span>
            <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                    <span class="token string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// é‡ç‚¹æ¥äº†ã€‚å®ƒæ˜¯æœ¬ç±»çš„ä¸€ä¸ªprotectedæ–¹æ³•ï¼Œä¸“é—¨ç”¨äºå¤„ç†åˆ›å»ºBeançš„è¿‡ç¨‹ï¼ˆåŒ…æ‹¬å±æ€§èµ‹å€¼ä¹‹ç±»çš„ï¼‰</span>
            <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Finished creating instance of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> <span class="token class-name">ImplicitlyAppearedSingletonException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// A previously detected exception with proper bean creation context already,</span>
            <span class="token comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
                    mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Unexpected exception during bean creation&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// createBeanInstance æ˜¯é‡ç‚¹ï¼ˆéƒ½æ˜¯è¿”å›ä¸€ä¸ªBeanWrapperï¼‰  å®ƒä¹Ÿæ˜¯æœ¬ç±»çš„ä¸€ä¸ªprotectedæ–¹æ³•</span>
        instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Beanå·²ç»å®ä¾‹åŒ–å¥½äº†,å‡†å¤‡åˆå§‹åŒ–å§</span>
	    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// æ‰§è¡ŒMergedBeanDefinitionPostProcessor</span>
        <span class="token comment">// å¤„ç†å¾ªç¯å¼•ç”¨ï¼Œç°åœ¨è‹¥æˆ‘ä»¬Beanä¸åœ¨å®¹å™¨é‡Œï¼Œè‚¯å®šæ˜¯ä¸å­˜åœ¨å¾ªç¯å¼•ç”¨çš„ï¼ˆä½†æ˜¯æˆ‘ä¾èµ–çš„Beanå¯èƒ½è¿˜æ²¡åˆ›å»ºæ˜¯çœŸçš„ï¼Œä¹Ÿæ˜¯è¿™é‡Œæ¥å¤„ç†çš„ï¼‰</span>
	    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// ç»™Beanå®ä¾‹çš„å„ä¸ªå±æ€§è¿›è¡Œèµ‹å€¼ æ¯”å¦‚è°ƒç”¨InstantiationAwareBeanPostProcessor#postProcessAfterInstantiationã€ç»™å±æ€§æ³¨å…¥å€¼ï¼ˆå¹¶ä¸ä¾èµ–äº@Autowiredæ³¨è§£ï¼‰</span>
        <span class="token comment">// æ‰§è¡ŒInstantiationAwareBeanPostProcessor#postProcessPropertyValuesç­‰ç­‰</span>
        <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆå§‹åŒ–Bean æ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ–¹æ³•init @PostContructæ–¹æ³•ç­‰ç­‰ </span>
        <span class="token comment">// BeanPostProcessorçš„postProcessBeforeInitializationå’ŒpostProcessAfterInitializationç­‰ç­‰</span>
        exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ å¯ä»¥çœ‹å‡ºï¼Œç›®å‰æœ€é‡è¦çš„ä¸‰ä¸ªæ­¥éª¤ä¸º<code>doCreateBean</code>é‡Œé¢çš„ï¼š<code>createBeanInstance</code>ã€<code>populateBean</code>ã€<code>initializeBean</code>ï¼Œéƒ½åœ¨<code>AbstractAutowireCapableBeanFactory</code>è¿™é‡Œã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">BeanWrapper</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Make sure bean class is actually resolved at this point.</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¦‚æœä¸ä¸ºnullï¼Œå¹¶ä¸”è¿˜ä¸æ˜¯publicçš„è®¿é—®æƒé™ å¹¶ä¸”è¿˜nonPublicAccessAllowedä¸ºfalse é‚£å°±æŠ›å¼‚å¸¸å§</span>
        <span class="token comment">// é¢˜å¤–è¯ï¼šnonPublicAccessAllowedä¸ºtrueçš„æƒ…å†µä¸‹ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œå³ä½¿ä½ ä¸æ˜¯publicçš„ä¹Ÿok</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isNonPublicAccessAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                    <span class="token string">&quot;Bean class isn&#39;t public, and non-public access not allowed: &quot;</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä½ å¯ä»¥è‡ªå·±é€šè¿‡Supplieræ¥åˆ›å»ºBeanï¼Œæœ€ç»ˆäº¤ç»™obtainFromSupplieråŒ…è£…æˆBeanWrapper</span>
        <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> instanceSupplier <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getInstanceSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceSupplier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">obtainFromSupplier</span><span class="token punctuation">(</span>instanceSupplier<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// é€šè¿‡å·¥å‚æ–¹æ³•åˆ›å»º æ”¯æŒå·¥å‚æ–¹æ³•æ–¹å¼åˆ›å»ºBean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">instantiateUsingFactoryMethod</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Shortcut when re-creating the same bean...</span>
        <span class="token comment">// ä¸€ä¸ªç±»å¯èƒ½æœ‰å¤šä¸ªæ„é€ å™¨ï¼Œæ‰€ä»¥Springå¾—æ ¹æ®å‚æ•°ä¸ªæ•°ã€ç±»å‹ç¡®å®šéœ€è¦è°ƒç”¨çš„æ„é€ å™¨</span>
        <span class="token comment">// åœ¨ä½¿ç”¨æ„é€ å™¨åˆ›å»ºå®ä¾‹åï¼ŒSpringä¼šå°†è§£æè¿‡åç¡®å®šä¸‹æ¥çš„æ„é€ å™¨æˆ–å·¥å‚æ–¹æ³•ä¿å­˜åœ¨ç¼“å­˜ä¸­ï¼Œé¿å…å†æ¬¡åˆ›å»ºç›¸åŒbeanæ—¶å†æ¬¡è§£æ</span>
        <span class="token keyword">boolean</span> resolved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> autowireNecessary <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>constructorArgumentLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>resolvedConstructorOrFactoryMethod <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    resolved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    autowireNecessary <span class="token operator">=</span> mbd<span class="token punctuation">.</span>constructorArgumentsResolved<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// é¦–æ¬¡è¿›å…¥ï¼Œresolvedä¸ºfalseã€‚</span>
        <span class="token comment">// è¯´ä¸€ä¸‹ï¼šConstructorResolverï¼Œå°±æ˜¯æ‰¾åˆ°åˆé€‚çš„æ„é€ å™¨ç»™ä½ å»å®ä¾‹åŒ–ä¸€ä¸ªBeanï¼ˆä¼šç»“åˆSpringå®¹å™¨è¿›è¡Œä¸€èµ·è§£æï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>autowireNecessary<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Need to determine the constructor...</span>
        <span class="token comment">// æ‰§è¡ŒBeanPostProcesso#determineCandidateConstructors è‡ªå·±å»å†³å®šä½¿ç”¨å“ªä¸ªæ„é€ å™¨ï¼Œå¯èƒ½ä¼šè¿”å›ä¸€æ‰¹æ„é€ å™¨å“Ÿ  </span>
        <span class="token comment">// è¿™é‡Œæˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„`AutowiredAnnotationBeanPostProcessor`å°±å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œå¯ä»¥æ™ºèƒ½å»æ‰¾å‡ºä¸€ä¸ªåˆé€‚çš„æ„é€ å™¨.</span>
        <span class="token comment">// è¿™é‡Œéœ€è¦æ³¨æ„äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„Childçš„å±æ€§HelloServiceé‡Œå¹¶æ²¡æœ‰ä¹¦å†™@Autowiredå±æ€§ï¼Œæ‰€ä»¥è¿™é‡Œæœ€ç»ˆçš„è¿”å›ç»“æœæ˜¯null================è¿™ä¸ªéœ€è¦æ³¨æ„Springçš„å¤„ç†(ç©ºæ„é€ å°±ä¸ç”¨äº¤ç»™autowireConstructorå¤„ç†äº†ï¼Œè‡ªå·±ç›´æ¥newå§)</span>
        <span class="token comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè‹¥æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªæ„é€     public Child(HelloService helloService) {  this.helloService = helloService; } é‚£ä¹ˆå®ƒå°±ä¼šæ‹¿åˆ°ï¼Œç„¶åèµ°ä¸‹é¢è®©Springæ‰§è¡Œæ„é€ å™¨çš„æ³¨å…¥çš„</span>
        <span class="token comment">// æ—ç™½ï¼šå¦‚æœä½ åªæœ‰ç©ºæ„é€ ï¼Œé‚£å°±ç›´æ¥instantiateBeanï¼Œå¦åˆ™ä¼šè‡ªåŠ¨å»èµ°Springçš„æ„é€ å™¨æ³¨å…¥çš„é€»è¾‘</span>
        <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctors <span class="token operator">=</span> <span class="token function">determineConstructorsFromBeanPostProcessors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ctors <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_CONSTRUCTOR</span> <span class="token operator">||</span>
                mbd<span class="token punctuation">.</span><span class="token function">hasConstructorArgumentValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">autowireConstructor</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> ctors<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// No special handling: simply use no-arg constructor.</span>
        <span class="token comment">// æ‰€ä»¥åªæœ‰ç©ºæ„é€ å™¨ï¼Œå°±åªèƒ½èµ°è¿™é‡Œå•¦</span>
        <span class="token comment">// è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæˆ‘å°±ä¸è´´äº†ã€‚ä¸»è¦æ˜¯ç”¨InstantiationStrategyç­–ç•¥å™¨è¿›è¡Œå®ä¾‹åŒ–</span>
        <span class="token keyword">return</span> <span class="token function">instantiateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯¥æ–¹æ³•æ‰§è¡Œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯¹è±¡å°±è¢«åˆ›å»ºäº†ï¼Œä½†ä»…ä»…è¿˜åªæ˜¯åˆ›å»ºå¥½å“¦ã€‚ä¸‹é¢ç»§ç»­çœ‹ï¼š<strong><code>populateBean</code>ï¼š</strong> populateï¼šå±…ä½äº; ç”Ÿæ´»äºã€‚å¤§è‡´æ„æ€å°±æ˜¯ç»™Beançš„å„ä¸ªå±æ€§èµ‹å€¼</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
                        mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Cannot apply property values to null instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Skip property population phase for null instance.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</span>
        <span class="token comment">// state of the bean before properties are set. This can be used, for example,</span>
        <span class="token comment">// to support styles of field injection.</span>
        <span class="token keyword">boolean</span> continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token comment">// å› ä¸ºå·²ç»å®ä¾‹åŒ–äº†ï¼Œå¯¹è±¡å·²ç»åˆ›å»ºäº†ï¼Œæ‰€ä»¥è¿™é‡Œç«‹é©¬æ‰§è¡Œäº†InstantiationAwareBeanPostProcessor#postProcessAfterInstantiationæ–¹æ³•</span>
        <span class="token comment">// å•ååªæœ‰å…¶ä¸­ä¸€ä¸ªè¿”å›äº†falseï¼Œç›¸å½“äºå‘Šè¯‰å®¹å™¨æˆ‘éƒ½å¤„ç†å¥½äº†ï¼Œé‚£ä¹ˆåé¢çš„èµ‹å€¼æ“ä½œå°±Springå®¹å™¨å°±ä¸å†å¤„ç†äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>continueWithPropertyPopulation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä»¥å¯¹è±¡çš„æ–¹å¼å­˜å‚¨å¥å€¼å¯¹,æ¯”å­˜å‚¨åœ¨mapä¼šæ›´åŠ çµæ´»</span>
        <span class="token comment">// PropertyValues  æ˜¯ç”¨æ¥ç®¡ç†PropertyValueçš„  ä¸€èˆ¬æƒ…å†µä¸‹ä¸ºnull</span>
        <span class="token class-name">PropertyValues</span> pvs <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œå°±å¼€å§‹å¹²æ­£äº‹äº†~~~~</span>
        <span class="token comment">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šæˆ‘ä»¬çŸ¥é“ä¸Šé¢æˆ‘ä»¬è‡ªå·±ä¼ è¿›æ¥çš„æ˜¯byTypeï¼Œæ‰€ä»¥è¿™ä¸ªçš„ifæ˜¯èƒ½å¤Ÿè¿›æ¥çš„,æœ€ç»ˆèƒ½å¤Ÿå®šä½autowireByTypeè®©å®ƒå»å®ç°æ³¨å…¥åŠŸèƒ½ã€‚</span>
        <span class="token comment">// æ‰€ä»¥æˆ‘ä»¬çš„helloServiceå­—æ®µè¦ä¸è¦@Autowiredè¦ä¸è¦æ— æ‰€è°“(è¦äº†ä¹Ÿåªæ˜¯é‡å¤æ“ä½œè€Œå·²ï¼Œä½†æ˜¯æˆ‘å»ºè®®æ˜¾ç¤ºçš„æŒ‡æ˜å§)</span>

        <span class="token comment">// ä½†æ˜¯è¢«Springæ‰«æScanç®¡ç†çš„Beanä»¬ï¼ˆæˆ–è€…å…¶ä½™Beanï¼‰ï¼Œå¦‚æœä½ æƒ³è¦ç»™ä»–å­—æ®µæ³¨å…¥å±æ€§å€¼ï¼Œå¿…é¡»å¿…é¡»ä½¿ç”¨@Autowiredæ³¨è§£ï¼Œä»è€Œäº¤ç»™åç½®å¤„ç†å™¨AutowiredAnnotationBeanPostProcessor#postProcessPropertyValuesè¿™ä¸ªæ–¹æ³•å»å¤„ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_NAME</span> <span class="token operator">||</span>
                mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MutablePropertyValues</span> newPvs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Add property values based on autowire by name if applicable.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">autowireByName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Add property values based on autowire by type if applicable.</span>
            <span class="token comment">// æŒ‰ç±»å‹è‡ªåŠ¨è£…é…ã€‚ä¸€èˆ¬éƒ½ä¼šèµ°è¿™é‡Œï¼Œé€šè¿‡ç±»å‹çš„åŒ¹é…ï¼Œæ¥ç»™å±æ€§èµ‹å€¼ï¼Œå®ç°æ³¨å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// å®ƒçš„æ­¥éª¤ç›¸å¯¹ç®€å•ï¼šæ˜¾ç¤ºBeanUtils.getWriteMethodParameter(pd)æ‹¿åˆ°setæ–¹æ³•ï¼ˆæ‰€ä»¥ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œè‹¥æ²¡æœ‰setæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯æ³¨å…¥ä¸è¿›å»çš„ï¼Œè¿™ä¸ªæ²¡@Autowiredå¼ºå¤§ï¼‰</span>
                <span class="token comment">// ç„¶åå»è§£æå»å®¹å™¨é‡Œé¢æ‰¾å¯¹åº”çš„ä¾èµ–ï¼Œä¹Ÿæ˜¯resolveDependencyæ–¹æ³•ï¼ˆæœ€ç»ˆç”±DefaultListableBeanFactoryå»å®ç°çš„ï¼‰</span>


                <span class="token comment">// è¿™é‡Œéœ€è¦æ³¨æ„ï¼šæ³¨å…¥çš„æ—¶å€™isSimplePropertyä¸ä¼šè¢«æ³¨å…¥çš„ï¼ˆåŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹ã€Integerã€Longã€‚ã€‚ã€‚</span>
                <span class="token comment">// ç”šè‡³è¿˜åŒ…æ‹¬Enumã€CharSequence(æ˜¾ç„¶å°±åŒ…å«äº†Spring)ã€Numberã€Dateã€URIã€URLã€Localeã€Classç­‰ç­‰ï¼‰</span>
                <span class="token comment">// ä½†æ˜¯ï¼Œä½†æ˜¯ï¼Œä½†æ˜¯æ ‡æ³¨@Autowiredæ˜¯èƒ½å¤Ÿæ³¨å…¥çš„å“¦ï¼Œå“ªæ€•æ˜¯Stringã€Integerç­‰ç­‰</span>
                <span class="token comment">// æ ‡æ³¨äº†@Autowiredï¼Œæ²¡æœ‰æ‰¾åˆ°åå€’ä¼šæŠ¥é”™ No qualifying bean of type &#39;java.lang.String&#39; ã€‚ã€‚ã€‚æ³¨æ„è¿™äº›åŒºåˆ«</span>
                <span class="token function">autowireByType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            pvs <span class="token operator">=</span> newPvs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">DEPENDENCY_CHECK_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps <span class="token operator">||</span> needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token comment">// å¼€å§‹æ‰§è¡ŒInstantiationAwareBeanPostProcessor#postProcessPropertyValues</span>
                <span class="token comment">// è¿™é‡Œä¸»è¦æ–½å·¥çš„åˆæ˜¯æˆ‘ä»¬å¤§åé¼é¼çš„AutowiredAnnotationBeanPostProcessorå®ƒäº†ï¼Œä»–ä¼šæ ¹æ®æ‰€æœ‰æ ‡æ³¨æœ‰@Autpwiredæ³¨è§£åœ°æ–¹ï¼Œæ‰§è¡Œæ³¨å…¥ï¼ˆéå¸¸é‡è¦ï¼‰</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                        pvs <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkDependencies</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// applyPropertyValueså’ŒPropertyValueså¯†åˆ‡ç›¸å…³ï¼Œåœ¨åé¢ç›¸å…³ä¸“é¢˜åœ¨è¯¦ç»†è®²è§£  ä¼šå›åˆ°è¿™é‡Œçš„ï¼ŒæŒç»­å…³æ³¨~</span>
        <span class="token comment">// ä½œç”¨ï¼šApply the given property values, resolving any runtime references</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ä½¿ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯" aria-hidden="true">#</a> ä½¿ç”¨åœºæ™¯</h4><ol><li><p>é¦–å…ˆæœ€å¤§çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯Springå†…éƒ¨</p></li><li><p>Spring Booté›†æˆ<code>Quartz</code>çš„æ—¶å€™ã€‚å¾ˆå¥½çš„ä½¿ç”¨åˆ°äº†æ­¤æ–¹æ¡ˆã€‚æˆ‘ä»¬åœ¨Jobç±»é‡Œé¢ä½¿ç”¨@Autowiredæ³¨å…¥çš„æ—¶å€™ï¼Œè‹¥å‡ºç°æ³¨å…¥ä¸è¿›å»çš„ç°è±¡ã€‚å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>AutowireCapableBeanFactory</code>è¿›è¡ŒååŠ©ã€‚</p></li><li><p>ç»§æ‰¿ç‰¹å®šçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä»–ä»¬çš„Beanå¹¶ä¸éœ€è¦äº¤ç»™Springç®¡ç†ï¼Œä½†æ˜¯åˆæƒ³ç”¨åˆ°Springå®¹å™¨é‡Œé¢çš„Beanå®Œæˆä¸€äº›åŠŸèƒ½çš„æ—¶å€™ï¼Œä½¿ç”¨å®ƒå°±ç‰¹åˆ«çš„æ–¹ä¾¿äº†ã€‚</p></li></ol><h4 id="instantiationstrategy" tabindex="-1"><a class="header-anchor" href="#instantiationstrategy" aria-hidden="true">#</a> InstantiationStrategy</h4><p>Beanå¤§éƒ½æœ€ç»ˆçš„å®ä¾‹åŒ–æ“ä½œæ˜¯äº¤ç”±è¿™ä¸ªç­–ç•¥å™¨æ¥æå®šçš„ï¼Œé‚£å®ƒæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// Interface responsible for creating instances corresponding to a root bean definition.</span>
<span class="token comment">// ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯æ ¹æ®RootBeanDefinitionï¼Œå»å®ä¾‹åŒ–ä¸€ä¸ªå®ä¾‹ï¼ˆç›¸å½“äºnewäº†ä¸€ä¸ªå¯¹è±¡è€Œå·²ï¼Œbeançš„å…·ä½“çš„å±æ€§åœ¨æ­¤æ—¶å¹¶æœªèµ‹å€¼ï¼‰</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InstantiationStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">// ä¸‹é¢æ˜¯ä»–çš„ä¸‰ä¸ªé‡è½½æ–¹æ³•</span>
    <span class="token comment">// ownerï¼šè¿™ä¸ªBeanå®šä¹‰æ‰€å±çš„BeanFactoryå·¥å‚</span>
    <span class="token comment">// argsï¼šæ„é€ å‡½æ•°çš„å‚æ•°ï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½ç”¨æ— å‚æ„é€ ï¼‰</span>
    <span class="token comment">// factoryBean:factoryMethod  ä¹Ÿæ”¯æŒå·¥å‚æ–¹æ³•æ–¹å¼åˆ›å»ºå®ä¾‹ï¼ˆæ³¨æ„æ­¤factoryBeanéæˆ‘ä»¬æ‰€å¸¸æŒ‡çš„æ¥å£ï¼šFactoryBeanå“¦~ï¼‰</span>
    <span class="token class-name">Object</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> bd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> owner<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> bd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> owner<span class="token punctuation">,</span>
                       <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ctor<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> <span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span> bd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> owner<span class="token punctuation">,</span>
                       <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> factoryBean<span class="token punctuation">,</span> <span class="token class-name">Method</span> factoryMethod<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="defaultlistablebeanfactory-1" tabindex="-1"><a class="header-anchor" href="#defaultlistablebeanfactory-1" aria-hidden="true">#</a> DefaultListableBeanFactory</h4><p>Springå†…éƒ¨çš„<code>å”¯ä¸€</code>ä½¿ç”¨çš„å·¥å‚å®ç°ï¼ŒåŸºäºbean definitionå¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªæˆç†Ÿçš„bean factroyã€‚å®ƒæ˜¯æ•´ä¸ªbeanåŠ è½½çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¹Ÿæ˜¯springæ³¨å†ŒåŠ è½½beançš„é»˜è®¤å®ç°ã€‚</p><p>â€‹ <code>DefaultListableBeanFactory</code>æ—¢å¯ä»¥ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„beanFactoryï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè‡ªå®šä¹‰beanFactoryçš„çˆ¶ç±»ã€‚ è‡³äºç‰¹å®šæ ¼å¼çš„Beanå®šä¹‰ä¿¡æ¯ï¼ˆæ¯”å¦‚å¸¸è§çš„æœ‰xmlã€æ³¨è§£ç­‰ï¼‰çš„è§£æå™¨å¯ä»¥è‡ªå·±å®ç°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŸæœ‰çš„è§£æå™¨ï¼Œå¦‚ï¼š <code>PropertiesBeanDefinitionReader</code>å’Œ<code>XmLBeanDefinitionReader</code>ã€<code>AnnotatedBeanDefinitionReader</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// extendsï¼šç›¸å½“äºç»§æ‰¿äº†æŠ½è±¡ç±»æ‰€æœ‰çš„å®ç°ï¼Œå¹¶ä¸”æ˜¯å·²ç»å…·æœ‰æ³¨å…¥åŠŸèƒ½äº†ï¼ˆå«æœ‰ListableBeanFactoryã€ConfigurableListableBeanFactoryçš„æ‰€æœ‰æ¥å£ï¼‰</span>
<span class="token comment">// implementsï¼šç›´æ¥å®ç°ConfigurableListableBeanFactoryï¼Œè¡¨ç¤ºå®ƒå…·æœ‰äº†æ‰¹é‡å¤„ç†Beanã€é…ç½®Beanç­‰ç­‰åŠŸèƒ½</span>
<span class="token comment">// BeanDefinitionRegistryï¼šè¯¥æ¥å£ç›®å‰è¿˜ä»…æœ‰è¿™ä¸ªç±»å®ç°ï¼ˆå®ƒçˆ¶æ¥å£ä¸ºï¼šAliasRegistry	ï¼‰</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultListableBeanFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAutowireCapableBeanFactory</span>
	<span class="token keyword">implements</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BeanDefinitionRegistry</span> <span class="token keyword">extends</span> <span class="token class-name">AliasRegistry</span> <span class="token punctuation">{</span>
	<span class="token comment">// æ³¨å†Œä¸€ä¸ªBeanå®šä¹‰ä¿¡æ¯ï¼ˆä¸‹é¢çš„æ–¹æ³•éƒ½éå¸¸çš„ç®€å•ï¼Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼‰</span>
	<span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinition</span> beanDefinition<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">removeBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">;</span>
	<span class="token class-name">BeanDefinition</span> <span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchBeanDefinitionException</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">boolean</span> <span class="token function">isBeanNameInUse</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™é‡Œé¢æœ‰å†™æ–¹æ³•å’ŒListableBeanFactoryæ¥å£é‡Œå®šä¹‰çš„ä¸‰ä¸ªå…³äºBeanå®šä¹‰çš„æ–¹æ³•ä¸€æ ·çš„ï¼š</span>
<span class="token comment">//getBeanDefinitionNames/getBeanDefinitionCountç­‰ç­‰</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="applicationcontext" tabindex="-1"><a class="header-anchor" href="#applicationcontext" aria-hidden="true">#</a> ApplicationContext</h3><p>â€‹ å¦‚æœè¯´BeanFactoryæ˜¯Springçš„å¿ƒè„ï¼Œ<strong>é‚£ä¹ˆApplicationContextå°±æ˜¯å®Œæ•´çš„èº¯ä½“äº†</strong>ï¼ŒApplicationContextç”±BeanFactoryæ´¾ç”Ÿè€Œæ¥ï¼Œæä¾›äº†æ›´å¤šé¢å‘å®é™…åº”ç”¨çš„åŠŸèƒ½ã€‚åœ¨BeanFactoryä¸­ï¼Œå¾ˆå¤šåŠŸèƒ½éœ€è¦ä»¥ç¼–ç¨‹çš„æ–¹å¼å®ç°ï¼Œè€Œåœ¨ApplicationContextä¸­åˆ™å¯ä»¥é€šè¿‡é…ç½®å®ç°</p><p>â€‹ ApplicationContextæ¥å£ç»§æ‰¿ä¼—å¤šæ¥å£ï¼Œé›†ä¼—å¤šæ¥å£åŠŸèƒ½ä¸ä¸€èº«ï¼Œä¸ºSpringçš„è¿è¡Œæä¾›åŸºæœ¬çš„åŠŸèƒ½æ”¯æ’‘ã€‚ <strong>æ ¹æ®ç¨‹åºè®¾è®¡çš„â€œå•ä¸€èŒè´£åŸåˆ™â€ï¼Œå…¶å®æ¯ä¸ªè¾ƒé¡¶å±‚æ¥å£éƒ½æ˜¯â€œå•ä¸€èŒè´£çš„â€ï¼Œåªæä¾›æŸä¸€æ–¹é¢çš„åŠŸèƒ½ï¼Œè€ŒApplicationContextæ¥å£ç»§æ‰¿äº†ä¼—å¤šæ¥å£ï¼Œç›¸å½“äºæ‹¥æœ‰äº†ä¼—å¤šæ¥å£çš„åŠŸèƒ½</strong></p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/v7jk0k1u16.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/xsmrj563fk.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/u16tym2a36.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="applicationcontext-1" tabindex="-1"><a class="header-anchor" href="#applicationcontext-1" aria-hidden="true">#</a> ApplicationContext</h4><p>ä¸€çº§æ¥å£</p><p><code>EnvironmentCapable</code>ï¼šå¯é…ç½®Environment</p><p><code>ListableBeanFactory</code>ï¼šå‰é¢æœ‰ä»‹ç»ï¼šå¯å°†Beané€ä¸€åˆ—å‡ºçš„å·¥å‚</p><p><code>HierarchicalBeanFactory</code>ï¼šå‰é¢æœ‰ä»‹ç»ï¼šåˆ†å±‚çš„å·¥å‚</p><p><code>MessageSource</code>ï¼šå¯ç®¡ç†messageå®ç°å›½é™…åŒ–ç­‰åŠŸèƒ½</p><p><code>ApplicationEventPublisher</code>ï¼šå¯publishäº‹ä»¶ï¼Œè°ƒç”¨Listener</p><p><code>ResourcePatternResolver</code>ï¼šåŠ è½½patternæŒ‡å®šçš„èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ApplicationContext</span> <span class="token keyword">extends</span> <span class="token class-name">EnvironmentCapable</span><span class="token punctuation">,</span> <span class="token class-name">ListableBeanFactory</span><span class="token punctuation">,</span> <span class="token class-name">HierarchicalBeanFactory</span><span class="token punctuation">,</span>
	<span class="token class-name">MessageSource</span><span class="token punctuation">,</span> <span class="token class-name">ApplicationEventPublisher</span><span class="token punctuation">,</span> <span class="token class-name">ResourcePatternResolver</span> <span class="token punctuation">{</span>

	<span class="token comment">//å®¹å™¨çš„unique id</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// éƒ¨ç½²çš„åº”ç”¨çš„åç§° webåº”ç”¨ä¸€èˆ¬ä¼šæŠŠservletContext.getContextPath()èµ‹å€¼ç»™ä»–</span>
	<span class="token comment">// éwebåº”ç”¨å°±æ˜¯&quot;&quot;</span>
	<span class="token class-name">String</span> <span class="token function">getApplicationName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// è¯¥åº”ç”¨contextå±•ç¤ºçš„åç§°</span>
	<span class="token class-name">String</span> <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å®¹å™¨é¦–æ¬¡è¢«åŠ è½½ã€å¯åŠ¨çš„æ—¶é—´</span>
	<span class="token keyword">long</span> <span class="token function">getStartupDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// è·å–çˆ¶å®¹å™¨ æœ‰å¯èƒ½ä¸ºnull</span>
	<span class="token annotation punctuation">@Nullable</span>
	<span class="token class-name">ApplicationContext</span> <span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// ä¸Šé¢éƒ½æ²¡ä»€ä¹ˆå¤§ä½œç”¨ï¼Œè¿™ä¸ªæ–¹æ³•ï¼šè™½ç„¶ä¸ç»§æ‰¿AutowireCapableBeanFactory,ä½†æ˜¯æˆ‘ä»¬å¯é€šè¿‡æ­¤æ–¹æ³•å¾—åˆ°å®ƒï¼Œä»è€Œç”¨å®ƒçš„ç›¸å…³åŠŸèƒ½</span>
	<span class="token class-name">AutowireCapableBeanFactory</span> <span class="token function">getAutowireCapableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>WebApplicationContextï¼šäºŒçº§æ¥å£ï¼Œwebç¯å¢ƒçš„Context</li><li>ConfigurableApplicationContextï¼šäºŒçº§æ¥å£ï¼Œå¯é…ç½®çš„åº”ç”¨ä¸Šä¸‹æ–‡</li><li>AbstractApplicationContextï¼šå®ç°äº†ConfigurableApplicationContextå¤§éƒ¨åˆ†åŠŸèƒ½</li><li>AbstractRefreshableApplicationContextï¼šAbstractRefreshableApplicationContextå®ç°äº†çˆ¶ç±»çš„æ–¹æ³•refreshBeanFactory()ï¼Œæ‰§è¡ŒBeanFactoryçš„â€œåˆ·æ–°â€ã€‚</li><li>GenericApplicationContextï¼šé€šç”¨çš„åº”ç”¨ä¸Šçº¿æ–‡</li></ul><hr><h4 id="abstractapplicationcontext-refresh" tabindex="-1"><a class="header-anchor" href="#abstractapplicationcontext-refresh" aria-hidden="true">#</a> AbstractApplicationContext#refresh</h4><p><code>refresh()</code>æ–¹æ³•æ‰€æœ‰çš„<code>ApplicationContext</code>å­ç±»éƒ½æ²¡é‡å†™ï¼Œåªæœ‰<code>AbstractApplicationContext</code>é‡Œæœ‰å®ç°è¿‡ï¼ˆæ¥å£å®šä¹‰åœ¨<code>ConfigurableApplicationContext</code>ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalStateException</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å®¹å™¨åˆ·æ–°å‰çš„å‡†å¤‡ï¼Œè®¾ç½®ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œè·å–å±æ€§ï¼ŒéªŒè¯å¿…è¦çš„å±æ€§ç­‰</span>
            <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// è·å–æ–°çš„beanFactoryï¼Œé”€æ¯åŸæœ‰beanFactoryã€ä¸ºæ¯ä¸ªbeanç”ŸæˆBeanDefinitionç­‰  æ³¨æ„ï¼Œæ­¤å¤„æ˜¯è·å–æ–°çš„ï¼Œé”€æ¯æ—§çš„ï¼Œè¿™å°±æ˜¯åˆ·æ–°çš„æ„ä¹‰</span>
            <span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// é…ç½®æ ‡å‡†çš„beanFactoryï¼Œè®¾ç½®ClassLoaderï¼Œè®¾ç½®SpELè¡¨è¾¾å¼è§£æå™¨ï¼Œè®¾ç½®äº†ä¸€äº›å¤„ç†å™¨ï¼Œéœ€è¦å¿½ç•¥çš„æ¥å£ç­‰</span>
            <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ¨¡æ¿æ–¹æ³•ï¼Œå…è®¸åœ¨å­ç±»ä¸­å¯¹beanFactoryè¿›è¡Œåç½®å¤„ç†ã€‚ä¾‹å¦‚AnnotationConfigServletWebServerApplicationContextåœ¨è¿™é‡Œå®ç°äº†åŒ…æ‰«æé€»è¾‘</span>
                <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// å®ä¾‹åŒ–å¹¶è°ƒç”¨æ‰€æœ‰æ³¨å†Œçš„beanFactoryåç½®å¤„ç†å™¨ï¼ˆå®ç°æ¥å£BeanFactoryPostProcessorçš„beanï¼‰ã€‚</span>
                <span class="token comment">// åœ¨beanFactoryæ ‡å‡†åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ  ä¾‹å¦‚ï¼šPropertyPlaceholderConfigurer(å¤„ç†å ä½ç¬¦)</span>
                <span class="token comment">// è¿™é‡Œæˆ‘ä»¬æ—¢å¯ä»¥é€šè¿‡beanFacotoryRegisteræ³¨å†ŒbeanDefinitionï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹å·²ç»åŠ è½½çš„beanDefinitionçš„æºä¿¡æ¯</span>
                <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// å®ä¾‹åŒ–å’Œæ³¨å†ŒbeanFactoryä¸­æ‰©å±•äº†BeanPostProcessorçš„beanã€‚åŒ…æ‹¬æˆ‘ä»¬è‡ªå®šä¹‰çš„ï¼Œå› ä¸ºå®ƒä¼šä»beanFacotoryä¸­æ‰¾beanPostProcessorï¼Œ</span>
                <span class="token comment">// æ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¹Ÿå¯ä»¥åŠ è½½è¿›æ¥ï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰å®ä¾‹åŒ–beanï¼Œ æ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„beanPostProcessorå¯ä»¥åœ¨beanå®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œå¤„ç†</span>
                <span class="token comment">// ä¾‹å¦‚ï¼š</span>
                <span class="token comment">// AutowiredAnnotationBeanPostProcessor(å¤„ç†è¢«@Autowiredæ³¨è§£ä¿®é¥°çš„beanå¹¶æ³¨å…¥)</span>
                <span class="token comment">// RequiredAnnotationBeanPostProcessor(å¤„ç†è¢«@Requiredæ³¨è§£ä¿®é¥°çš„æ–¹æ³•)</span>
                <span class="token comment">// CommonAnnotationBeanPostProcessor(å¤„ç†@PreDestroyã€@PostConstructã€@Resourceç­‰å¤šä¸ªæ³¨è§£çš„ä½œç”¨)ç­‰ã€‚</span>
                <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// åˆå§‹åŒ–å›½é™…åŒ–å·¥å…·ç±»MessageSource</span>
                <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨</span>
                <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// æ¨¡æ¿æ–¹æ³•ï¼Œåœ¨å®¹å™¨åˆ·æ–°çš„æ—¶å€™å¯ä»¥è‡ªå®šä¹‰é€»è¾‘ï¼ˆå­ç±»è‡ªå·±å»å®ç°é€»è¾‘ï¼‰ï¼Œä¸åŒçš„Springå®¹å™¨åšä¸åŒçš„äº‹æƒ…</span>
                <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// æ³¨å†Œç›‘å¬å™¨ï¼Œå¹¶ä¸”å¹¿æ’­early application events,ä¹Ÿå°±æ˜¯æ—©æœŸçš„äº‹ä»¶ã€‚è¿™é‡Œä¸ä»…ä¼šæ³¨å†Œé¢„å…ˆè®¾ç½®çš„ç›‘å¬å™¨ï¼Œè¿˜ä¼šæŸ¥æ‰¾beanFacotoryä¸­çš„ç›‘å¬å™¨å¹¶æ³¨å†Œï¼Œ</span>
                <span class="token comment">// æ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ç›‘å¬å™¨åœ¨æ­¤æ—¶ä¹Ÿè¢«æ³¨å†Œè¿›å»äº†</span>
                <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Instantiate all remaining (non-lazy-init) singletons.</span>
                <span class="token comment">// éå¸¸é‡è¦ã€‚ã€‚ã€‚å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™çš„ï¼ˆéæ‡’åŠ è½½ï¼‰å•ä¾‹Beanã€‚ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„é‚£äº›Beanä»¬ï¼‰</span>
                <span class="token comment">// æ¯”å¦‚invokeBeanFactoryPostProcessorsæ–¹æ³•ä¸­æ ¹æ®å„ç§æ³¨è§£è§£æå‡ºæ¥çš„ç±»ï¼Œåœ¨è¿™ä¸ªæ—¶å€™éƒ½ä¼šè¢«åˆå§‹åŒ–  æ‰«æçš„ @Beanä¹‹ç±»çš„</span>
                <span class="token comment">// å®ä¾‹åŒ–çš„è¿‡ç¨‹å„ç§BeanPostProcessorå¼€å§‹èµ·ä½œç”¨~~~~~~~~~~~~~~</span>
                <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// refreshåšå®Œä¹‹åéœ€è¦åšçš„å…¶ä»–äº‹æƒ…</span>
                <span class="token comment">// æ¸…é™¤ä¸Šä¸‹æ–‡èµ„æºç¼“å­˜ï¼ˆå¦‚æ‰«æä¸­çš„ASMå…ƒæ•°æ®ï¼‰</span>
                <span class="token comment">// åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨ï¼Œå¹¶åˆ·æ–°ï¼ˆæ‰¾å‡ºSpringå®¹å™¨ä¸­å®ç°äº†Lifecycleæ¥å£çš„beanå¹¶æ‰§è¡Œstart()æ–¹æ³•ï¼‰ã€‚</span>
                <span class="token comment">// å‘å¸ƒContextRefreshedEventäº‹ä»¶å‘ŠçŸ¥å¯¹åº”çš„ApplicationListenerè¿›è¡Œå“åº”çš„æ“ä½œ</span>
                <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Exception encountered during context initialization - &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;cancelling refresh attempt: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// å¦‚æœåˆ·æ–°å¤±è´¥é‚£ä¹ˆå°±ä¼šå°†å·²ç»åˆ›å»ºå¥½çš„å•ä¾‹Beané”€æ¯æ‰</span>
                <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// é‡ç½®contextçš„æ´»åŠ¨çŠ¶æ€ å‘ŠçŸ¥æ˜¯å¤±è´¥çš„</span>
                <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// æŠ›å‡ºå¼‚å¸¸</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¤±è´¥ä¸å¦ï¼Œéƒ½ä¼šé‡ç½®Springå†…æ ¸çš„ç¼“å­˜ã€‚å› ä¸ºå¯èƒ½ä¸å†éœ€è¦metadataç»™å•ä¾‹Beanäº†ã€‚</span>
                <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="finishbeanfactoryinitialization" tabindex="-1"><a class="header-anchor" href="#finishbeanfactoryinitialization" aria-hidden="true">#</a> finishBeanFactoryInitialization</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token string">&quot;conversionService&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span><span class="token string">&quot;conversionService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®conversionServiceï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ï¼Œä¹‹åä¼šå†™æ–‡ç« ä¸“é—¨è®²è§£</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">setConversionService</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConversionService</span><span class="token punctuation">)</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;conversionService&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ConversionService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">// å¿½ç•¥æ— å…³ä»£ç </span>
  <span class="token comment">// è¿™é‡Œä¼šç«‹å³å®ä¾‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹bean  </span>
  beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="defaultlistablebeanfactory-preinstantiatesingletons" tabindex="-1"><a class="header-anchor" href="#defaultlistablebeanfactory-preinstantiatesingletons" aria-hidden="true">#</a> DefaultListableBeanFactory#preInstantiateSingletons()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–æˆ‘ä»¬å®¹å™¨ä¸­æ‰€æœ‰beanå®šä¹‰çš„åç§°</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// åˆå¹¶beanå®šä¹‰ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</span>
            <span class="token comment">// 1. å°†å…¶å®ƒç±»å‹çš„beanDefinitionè½¬å˜ä¸ºRootBeanDefinitionï¼Œå°†æœ‰çˆ¶å­å…³ç³»çš„beanDefinitionåˆå¹¶</span>
            <span class="token class-name">RootBeanDefinition</span> bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å½“è¯¥beanDefinitionä¸æ˜¯æŠ½è±¡çš„&amp;&amp;å•ä¾‹çš„&amp;&amp;ä¸æ˜¯æ‡’åŠ è½½çš„æ—¶å€™ï¼Œä¼šç›´æ¥å»å®ä¾‹åŒ–è¯¥bean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯FactoryBeanï¼Œå·¥å‚Beanä¹Ÿæ˜¯ä¸€ä¸ªBeanï¼Œæ³¨æ„ä¸è¦å’ŒBeanFactoryæ··äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¦‚æœæ˜¯å·¥å‚beanï¼Œç»™beanNameå‰ç¼€åŠ ä¸Š&amp;ç¬¦å·ï¼Œä»£è¡¨æˆ‘ä»¬è·å–æ˜¯FactoryBeanï¼Œè€Œä¸æ˜¯é€šè¿‡FactoryBean.getObject()</span>
                    <span class="token comment">// è·å–çš„å®ä¾‹å¯¹è±¡</span>
                    <span class="token comment">// FactoryBeançš„ä½œç”¨å°±æ˜¯å¯ä»¥è®©æˆ‘ä»¬åœ¨å®ä¾‹åŒ–æˆ‘ä»¬éœ€è¦çš„çœŸæ­£çš„beançš„å®ä¾‹å¯ä»¥å®šä¹‰ä¸€äº›ä¸ªæ€§åŒ–é€»è¾‘</span>
                    <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
                        <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            isEagerInit <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
                                            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token operator">::</span><span class="token function">isEagerInit</span><span class="token punctuation">,</span>
                                    <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span>
                                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartFactoryBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦ç«‹å³é€šè¿‡FactoryBeanåˆ›å»ºçœŸæ­£çš„Beanå®ä¾‹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// éå·¥å‚Beanï¼Œå°±æ˜¯ç›´æ¥åˆ›å»ºæ™®é€šçš„bean</span>
                    <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// åˆ°è¿™é‡Œæ‰€æœ‰çš„å•å®ä¾‹çš„beanå·²ç»è®°è½½åˆ°å•å®ä¾‹beanåˆ°ç¼“å­˜ä¸­äº†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ¤æ–­å½“å‰çš„beanæ˜¯å¦å®ç°äº†SmartInitializingSingletonæ¥å£ï¼Œå¦‚æœå®ç°äº†çš„è¯ï¼Œè°ƒç”¨è¯¥beançš„</span>
            <span class="token comment">// afterSingletonsInstantiated()æ–¹æ³•ï¼Œæ³¨æ„æ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œè¯¥beanå·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´çš„beanï¼Œ</span>
            <span class="token comment">// æ‰€æœ‰çš„åˆ›å»ºæµç¨‹éƒ½å·²ç»èµ°å®Œäº†ï¼Œè¯¥æ³¨å…¥çš„ä¿¡æ¯ä¹Ÿéƒ½å·²ç»æ³¨å…¥äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">SmartInitializingSingleton</span> smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="abstractbeanfactory-getbean-dogetbean" tabindex="-1"><a class="header-anchor" href="#abstractbeanfactory-getbean-dogetbean" aria-hidden="true">#</a> AbstractBeanFactory#getBean() -&gt; doGetBean()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span>
                              <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

        <span class="token comment">// åœ¨è¿™é‡Œä¼ å…¥è¿›æ¥çš„nameå¯èƒ½æ˜¯åˆ«å, ä¹Ÿæœ‰å¯èƒ½æ˜¯Factorybeançš„name,æ‰€ä»¥åœ¨è¿™é‡Œéœ€è¦è½¬æ¢ä¸€ä¸‹åå­—</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> bean<span class="token punctuation">;</span>
        <span class="token comment">// å…ˆå°è¯•ä»ç¼“å­˜ä¸­æ‹¿å•ä¾‹beanï¼Œå¦‚æœä¹‹å‰åˆ›å»ºè¿‡ï¼Œè¿™é‡Œå°±èƒ½ç›´æ¥è·å–åˆ°ï¼Œç„¶åè¿”å›äº†ã€‚è¿™é‡Œé¢èµ°åˆ›å»ºï¼ˆå‘ç°æ˜¯ä¸ªnewçš„ï¼‰ï¼Œå°±åŠ å…¥è¿›ç¼“å­˜é‡Œé¢äº†</span>
        <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Returning eagerly cached instance of singleton bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                            <span class="token string">&quot;&#39; that is not fully initialized yet - a consequence of a circular reference&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Returning cached instance of singleton bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * å¦‚æœ sharedInstance æ˜¯æ™®é€šçš„å•ä¾‹ beanï¼Œä¸‹é¢çš„æ–¹æ³•ä¼šç›´æ¥è¿”å›ã€‚ä½†å¦‚æœ
             * sharedInstance æ˜¯ FactoryBean ç±»å‹çš„ï¼Œåˆ™éœ€è°ƒç”¨ getObject å·¥å‚æ–¹æ³•è·å–çœŸæ­£çš„
             * bean å®ä¾‹ã€‚å¦‚æœç”¨æˆ·æƒ³è·å– FactoryBean æœ¬èº«ï¼Œè¿™é‡Œä¹Ÿä¸ä¼šåšç‰¹åˆ«çš„å¤„ç†ï¼Œç›´æ¥è¿”å›
             * å³å¯ã€‚æ¯•ç«Ÿ FactoryBean çš„å®ç°ç±»æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ beanï¼Œåªä¸è¿‡å…·æœ‰ä¸€ç‚¹ç‰¹æ®Šçš„åŠŸèƒ½è€Œå·²ã€‚
             */</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Springåªå¤„ç†å•ä¾‹beançš„å¾ªç¯ä¾èµ–ï¼ŒprototypeåŸå‹beanå¾ªç¯ä¾èµ–Springä¸ä¼šå¤„ç†ï¼Œç›´æ¥æŠ¥é”™</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// åˆ¤æ–­AbstractBeanFacotryå·¥å‚æ˜¯å¦æœ‰çˆ¶å·¥å‚ï¼Œä¸€èˆ¬æƒ…å†µä¸‹,åªæœ‰Springå’ŒSpringMvcæ•´åˆçš„æ—¶æ‰ä¼šæœ‰çˆ¶å­å®¹å™¨çš„æ¦‚å¿µ,</span>
            <span class="token class-name">BeanFactory</span> parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è‹¥å­˜åœ¨çˆ¶å·¥å‚ï¼Œå¹¶ä¸”å½“å‰çš„beanå·¥å‚ä¸å­˜åœ¨å½“å‰çš„beanå®šä¹‰ï¼Œé‚£ä¹ˆå»çˆ¶beanFacotryä¸­è·å–è¯¥bean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>
                            nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token doc-comment comment">/**
             * æ–¹æ³•å‚æ•° typeCheckOnly ï¼Œæ˜¯ç”¨æ¥åˆ¤æ–­è°ƒç”¨ getBean() æ–¹æ³•æ—¶ï¼Œè¡¨ç¤ºæ˜¯å¦ä¸ºä»…ä»…è¿›è¡Œç±»å‹æ£€æŸ¥è·å–Beanå¯¹è±¡
             * å¦‚æœä¸æ˜¯ä»…ä»…åšç±»å‹æ£€æŸ¥ï¼Œè€Œæ˜¯åˆ›å»º Bean å¯¹è±¡ï¼Œåˆ™éœ€è¦è°ƒç”¨ markBeanAsCreated()æ–¹æ³•æ ‡è®°ä¸ºå·²åˆ›å»ºï¼Œå› ä¸ºä¸‹é¢
             * å°±è¦å¼€å§‹çœŸæ­£åˆ›å»ºäº†ï¼Œé¿å…å‡ºç°é‡å¤åˆ›å»º
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// å¤„ç†dependsOnçš„ä¾èµ–(è¿™ä¸ªä¸æ˜¯æˆ‘ä»¬æ‰€è°“çš„å¾ªç¯ä¾èµ– è€Œæ˜¯beanåˆ›å»ºå‰åçš„ä¾èµ–),ä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨@DependsOnæ ‡æ³¨çš„ç±»</span>
                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// åˆ¤æ–­ä¾èµ–beanå’Œè¢«ä¾èµ–beanæœ‰æ²¡æœ‰å¾ªç¯ä¾èµ–çš„å…³ç³»ï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
                        <span class="token comment">// å› ä¸ºbeanåˆ›å»ºçš„å…ˆåé¡ºåºä¾èµ–ä¸èƒ½æ˜¯å¾ªç¯ä¾èµ–ï¼Œå¦åˆ™æˆ‘éœ€è¦ä½ å…ˆåˆ›å»ºï¼Œä½ éœ€è¦æˆ‘å…ˆåˆ›å»ºï¼Œé‚£åˆ°åº•è°å…ˆåˆ›å»ºï¼Ÿ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                    <span class="token string">&quot;Circular depends-on relationship between &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; and &#39;&quot;</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment">// æ³¨å†Œä¾èµ–beanNameä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼šä¾èµ– beanName - &gt; beanName çš„é›†åˆ</span>
                        <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">// è·å–depentceOnçš„bean</span>
                            <span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                    <span class="token string">&quot;&#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; depends on missing bean &#39;&quot;</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// å¦‚æœbeanæ˜¯å•ä¾‹çš„ï¼Œé‚£ä¹ˆå®ä¾‹åŒ–å•ä¾‹bean</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">// å®é™…åˆ›å»ºbeanå¯¹è±¡çš„æ–¹æ³•</span>
                            <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// åˆ›å»ºbeançš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸,éœ€è¦é”€æ¯å…³äºå½“å‰beançš„æ‰€æœ‰ä¿¡æ¯</span>
                            <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// åŸå‹beançš„åˆ›å»º</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// It&#39;s a prototype -&gt; create a new instance.</span>
                    <span class="token class-name">Object</span> prototypeInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æŒ‡å®šç‰¹å®šscopeçš„beanåˆ›å»ºï¼Œè¿™é‡Œä»¥åä¼šå•ç‹¬è¯´</span>
                    <span class="token class-name">String</span> scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token class-name">Scope</span> scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;No Scope registered for scope name &#39;&quot;</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Object</span> scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                            <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                                <span class="token string">&quot;Scope &#39;&quot;</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">&quot;&#39; is not active for the current thread; consider &quot;</span> <span class="token operator">+</span>
                                        <span class="token string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span><span class="token punctuation">,</span>
                                ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœgetBeançš„æ—¶å€™æŒ‡å®šäº†æƒ³è¦è·å–çš„beançš„ç±»å‹ï¼Œå¹¶ä¸”è·å–å‡ºæ¥çš„beanä¸æ˜¯æŒ‡å®šçš„ç±»å‹ï¼Œé‚£ä¹ˆè¿™é‡Œä¼šè¿›è¡Œbeanç±»å‹è½¬æ¢ï¼Œè½¬æ¢æ˜¯</span>
        <span class="token comment">// ä¾é ç±»å‹è½¬æ¢å™¨ï¼Œå³ä¸Šé¢è¯´çš„conversionService</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">T</span> convertedBean <span class="token operator">=</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>convertedBean <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> convertedBean<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to convert bean &#39;&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;&#39; to required type &#39;&quot;</span> <span class="token operator">+</span>
                            <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="defaultsingletonbeanregistry-getsingleton" tabindex="-1"><a class="header-anchor" href="#defaultsingletonbeanregistry-getsingleton" aria-hidden="true">#</a> DefaultSingletonBeanRegistry#getSingleton()</h4><p>è¿™é‡Œæœ‰ä¸¤ä¸ªgetSingletion()æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ä»ç¼“å­˜ä¸­è·å–beançš„getSingleton()æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯å¸¦æœ‰å›è°ƒå‡½æ•°çš„getSingleton()æ–¹æ³•ã€‚</p><h4 id="ä»ç¼“å­˜ä¸­è·å–beançš„getsingleton" tabindex="-1"><a class="header-anchor" href="#ä»ç¼“å­˜ä¸­è·å–beançš„getsingleton" aria-hidden="true">#</a> ä»ç¼“å­˜ä¸­è·å–beançš„getSingleton()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»å•ä¾‹beanä¸€çº§ç¼“å­˜ä¸­è·å–</span>
        <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œå¹¶ä¸”è¦è·å–çš„è¯¥beanæ­£åœ¨åˆ›å»ºä¸­ï¼Œåˆ™ä»æå‰æš´éœ²beançš„äºŒçº§ç¼“å­˜ä¸­è·å–ï¼Œæ³¨æ„æ­¤æ—¶è·å–çš„å¯èƒ½ä¸æ˜¯æœ€ç»ˆbeanï¼Œ</span>
        <span class="token comment">// å¦‚æœæœ€ç»ˆbeanå¯¹è±¡ä¸earlySingletonObjectsä¸­çš„å¯¹è±¡ä¸ä¸€è‡´ï¼Œä¼šæŠ¥é”™</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æœ€åè¿˜æ²¡è·å–åˆ°ï¼Œå¹¶ä¸”å…è®¸å¾ªç¯ä¾èµ–çš„è¯ï¼Œä¼šåœ¨è¿™é‡Œé€šè¿‡è°ƒç”¨singletonFactoriesçš„æ–¹æ³•æå‰æš´éœ²beanå¯¹è±¡ã€‚</span>
                <span class="token comment">// è¿™é‡Œæ˜¯å•çº§ç¼“å­˜ï¼Œè°ƒç”¨çš„å…¶å®å°±æ˜¯BeanPostProcessorä¸­çš„getEarlyBeanReference()</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ObjectFactory</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å›è°ƒå‡½æ•°çš„getsingleton" tabindex="-1"><a class="header-anchor" href="#å›è°ƒå‡½æ•°çš„getsingleton" aria-hidden="true">#</a> å›è°ƒå‡½æ•°çš„getSingleton()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">// DefaultSingletonBeanRegistry.java</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">&quot;Bean name must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°è¯•ä»å•ä¾‹ç¼“å­˜æ± ä¸­è·å–å¯¹è±¡</span>
            <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInDestruction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationNotAllowedException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                            <span class="token string">&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot;</span> <span class="token operator">+</span>
                                    <span class="token string">&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating shared instance of singleton bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// æ ‡è®°å½“å‰çš„beanæ­£åœ¨åˆ›å»ºä¸­</span>
                <span class="token comment">// singletonsCurrentlyInCreationåœ¨è¿™é‡Œä¼šæŠŠbeanNameåŠ å…¥è¿›æ¥ï¼Œè‹¥ç¬¬äºŒæ¬¡å¾ªç¯ä¾èµ–ï¼Œæ„é€ å™¨æ³¨å…¥ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ</span>
                <span class="token comment">// å› ä¸ºæ„é€ å™¨æ³¨å…¥ä¸å…è®¸å¾ªç¯ä¾èµ–</span>
                <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> newSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> recordSuppressedExceptions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è¿™é‡Œå…¶å®æ˜¯è°ƒç”¨createBean()æ–¹æ³•</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newSingleton <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> suppressedException <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ex<span class="token punctuation">.</span><span class="token function">addRelatedCause</span><span class="token punctuation">(</span>suppressedException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// å°†è¯¥beanä»æ ‡è®°ä¸ºæ­£åœ¨åˆ›å»ºä¸­é›†åˆé‡Œåˆ é™¤ï¼Œå› ä¸ºå·²ç»åˆ›å»ºå®Œæˆäº†</span>
                    <span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newSingleton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°†åˆ›å»ºå¥½çš„beanåŠ å…¥å•ä¾‹beanä¸€çº§ç¼“å­˜ä¸­</span>
                    <span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="abstractautowirecapablebeanfactory-createbean" tabindex="-1"><a class="header-anchor" href="#abstractautowirecapablebeanfactory-createbean" aria-hidden="true">#</a> AbstractAutowireCapableBeanFactory#createBean()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating instance of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">RootBeanDefinition</span> mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>
        <span class="token comment">// ç¡®ä¿æ­¤æ—¶çš„beanå·²ç»è¢«è§£æäº†</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * éªŒè¯å’Œå‡†å¤‡è¦†ç›–æ–¹æ³•
             * lookup-method å’Œ replace-method
             * è¿™ä¸¤ä¸ªé…ç½®å­˜æ”¾åœ¨BeanDefinitionä¸­çš„methodOverrides
             * æˆ‘ä»¬çŸ¥é“åœ¨beanå®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­å¦‚æœæ£€æµ‹åˆ°å­˜åœ¨ methodOverrides ï¼Œ
             * åˆ™ä¼šåŠ¨æ€åœ°ä¸ºå½“å‰beanç”Ÿæˆä»£ç†å¹¶ä½¿ç”¨å¯¹åº”çš„æ‹¦æˆªå™¨ä¸ºbeanåšå¢å¼ºå¤„ç†ã€‚
             */</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    beanName<span class="token punctuation">,</span> <span class="token string">&quot;Validation of method overrides failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * åœ¨å®ä¾‹åŒ–beanä¹‹å‰å…ˆé€šè¿‡InstantiationAwareBeanPostProcessorsçš„postProcessBeforeInstantiation()è¿›è¡Œå¤„ç†ï¼Œ
             * å¦‚æœè¿”å›äº†å¯¹è±¡ï¼Œåˆ™ç›´æ¥è°ƒç”¨åç½®å¤„ç†å™¨çš„postProcessAfterInitialization()è¿›è¡Œå¤„ç†ï¼Œç„¶åå°†è¯¥å¯¹è±¡å½“beanå®ä¾‹è¿”å›ï¼Œ
             * ä¸å†æ‰§è¡Œä¹‹åçš„é€»è¾‘äº†ã€‚
             * ä¸€èˆ¬æƒ…å†µä¸‹åœ¨æ­¤å¤„ä¸ä¼šç”Ÿæˆä»£ç†å¯¹è±¡ã€‚ä¸ç®¡æ˜¯jdkä»£ç†è¿˜æ˜¯cglibä»£ç†éƒ½ä¸ä¼šåœ¨æ­¤å¤„è¿›è¡Œä»£ç†ï¼Œå› ä¸ºæˆ‘ä»¬çš„çœŸå®çš„å¯¹è±¡æ²¡æœ‰ç”Ÿæˆ,
             * æ‰€ä»¥åœ¨è¿™é‡Œä¸ä¼šç”Ÿæˆä»£ç†å¯¹è±¡ã€‚ä¸è¿‡è¿™ä¸€æ­¥æ˜¯AOPå’Œäº‹åŠ¡çš„å…³é”®ï¼Œå› ä¸ºåœ¨è¿™é‡Œè§£ææˆ‘ä»¬çš„aopåˆ‡é¢ä¿¡æ¯è¿›è¡Œç¼“å­˜ã€‚
             */</span>
            <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                    <span class="token string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¯¥æ­¥éª¤æ˜¯æˆ‘ä»¬çœŸæ­£çš„åˆ›å»ºæˆ‘ä»¬çš„beançš„å®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹</span>
            <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Finished creating instance of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> <span class="token class-name">ImplicitlyAppearedSingletonException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
                    mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Unexpected exception during bean creation&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="abstractautowirecapablebeanfactory-resolvebeforeinstantiation" tabindex="-1"><a class="header-anchor" href="#abstractautowirecapablebeanfactory-resolvebeforeinstantiation" aria-hidden="true">#</a> AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>beforeInstantiationResolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦æœ‰InstantiationAwareBeanPostProcessorsç±»å‹çš„åç½®å¤„ç†å™¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ¨æ–­å½“å‰beançš„classå¯¹è±¡</span>
      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetType <span class="token operator">=</span> <span class="token function">determineTargetType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetType <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// åç½®å¤„ç†å™¨çš„ã€ç¬¬ä¸€æ¬¡ã€‘è°ƒç”¨ï¼Œæ­¤å¤„ä¼šè§£æå‡ºåˆ‡é¢ä¿¡æ¯ä¿å­˜åˆ°ç¼“å­˜ä¸­</span>
        bean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInstantiation</span><span class="token punctuation">(</span>targetType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœInstantiationAwareBeanPostProcessorsåç½®å¤„ç†å™¨çš„postProcessBeforeInstantiationè¿”å›ä¸ä¸ºnullï¼Œ</span>
        <span class="token comment">// ç›´æ¥è°ƒç”¨æ‰€æœ‰åç½®å¤„ç†å™¨çš„postProcessAfterInitialization()æ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// åç½®å¤„ç†å™¨çš„ã€ç¬¬äºŒæ¬¡ã€‘è°ƒç”¨ï¼Œè¯¥åç½®å¤„ç†å™¨è‹¥è¢«è°ƒç”¨çš„è¯ï¼Œé‚£ä¹ˆç¬¬ä¸€å¤„çš„å¤„ç†å™¨è‚¯å®šè¿”å›çš„ä¸æ˜¯null</span>
          bean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mbd<span class="token punctuation">.</span>beforeInstantiationResolved <span class="token operator">=</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="abstractautowirecapablebeanfactory-docreatebean" tabindex="-1"><a class="header-anchor" href="#abstractautowirecapablebeanfactory-docreatebean" aria-hidden="true">#</a> AbstractAutowireCapableBeanFactory#doCreateBean()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>
  <span class="token comment">// BeanWrapperæ˜¯å¯¹Beançš„åŒ…è£…ï¼Œå…¶æ¥å£ä¸­æ‰€å®šä¹‰çš„åŠŸèƒ½å¾ˆç®€å•åŒ…æ‹¬è®¾ç½®è·å–è¢«åŒ…è£…çš„å¯¹è±¡ï¼Œè·å–è¢«åŒ…è£…beançš„å±æ€§æè¿°å™¨</span>
  <span class="token class-name">BeanWrapper</span> instanceWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// çœŸæ­£åˆ›å»ºbeanå®ä¾‹çš„åœ°æ–¹ï¼Œä½¿ç”¨åˆé€‚çš„å®ä¾‹åŒ–ç­–ç•¥æ¥åˆ›å»ºæ–°çš„å®ä¾‹ï¼šå·¥å‚æ–¹æ³•ã€æ„é€ å‡½æ•°è‡ªåŠ¨æ³¨å…¥ã€ç®€å•åˆå§‹åŒ–</span>
    instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">final</span> <span class="token class-name">Object</span> bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> <span class="token class-name">NullBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// åç½®å¤„ç†å™¨çš„ã€ç¬¬ä¸‰æ¬¡ã€‘è°ƒç”¨ï¼Œè¿™ä¸€æ­¥ï¼Œä¼šå°†@autowiredå’Œ@valueè¿™ç±»æ³¨è§£çš„å…ƒæ•°æ®æå–å‡ºæ¥ï¼Œä¸ºä¸‹é¢çš„æ³¨å…¥åšå‡†å¤‡</span>
        <span class="token comment">// æ­¤å¤„å¤„ç†è¿™ä¸ªæ¥å£çš„å¤„ç†å™¨ï¼šMergedBeanDefinitionPostProcessorï¼Œä»–åœ¨BeanPostProcessorçš„åŸºç¡€ä¸Šå¢åŠ äº†postProcessMergedBeanDefinitionæ–¹æ³•ï¼Œåœ¨æ­¤å¤„å°±è¢«è°ƒç”¨äº†</span>
	<span class="token comment">// ä¸»è¦æ˜¯å¤„ç†@PostConstruct,@Autowire,@Value,@Resourceï¼Œ@PreDestoryç­‰è¿™äº›æ³¨è§£ã€‚ï¼ˆæ˜¾ç„¶å¯¹åº”å“ªå»å¤„ç†å™¨ï¼Œä¸€ç›®äº†ç„¶ï¼‰</span>
        <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span>
                                        <span class="token string">&quot;Post-processing of merged bean definition failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ˜¯å¦å…è®¸æå‰æš´éœ²å•ä¾‹ï¼ˆæ˜¯å•ä¾‹ &amp;&amp; å…è®¸å¾ªç¯ä¾èµ– &amp;&amp; è¯¥beanåœ¨åˆ›å»ºä¸­ï¼‰</span>
  <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>
                                    <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç¬¬ä¸€æ¬¡åˆ¤æ–­ï¼šå¦‚æœå…è®¸æå‰æš´éœ²ï¼Œåˆ™å°†beanæ”¾å…¥singletonFacotriesä¸­, åœ¨å¾ªç¯ä¾èµ–çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡</span>
  <span class="token comment">// getEarlyBeanReference()æå‰è‡ªåŠ¨ä»£ç†ï¼Œç„¶ååœ¨å…¶ä»–beanä¸­æ³¨å…¥æå‰ä»£ç†çš„å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly caching bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                   <span class="token string">&quot;&#39; to allow for resolving potential circular references&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åç½®å¤„ç†å™¨ã€ç¬¬å››æ¬¡ã€‘è°ƒç”¨</span>
    <span class="token comment">// è¿™é‡Œä¸»è¦æ˜¯è°ƒç”¨å¤„ç†å™¨ï¼šSmartInstantiationAwareBeanPostProcessor#getEarlyBeanReferenceæ–¹æ³•å»å¯»æ‰¾åˆ°å‰æœŸçš„Beanä»¬ï¼ˆè‹¥å­˜åœ¨è¿™ç§å¤„ç†å™¨çš„è¯ï¼‰</span>
    <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œå±æ€§æ³¨å…¥</span>
    <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ‰§è¡Œå„ç§åˆå§‹åŒ–æ–¹æ³•</span>
    <span class="token comment">// å®Œæˆå±æ€§ä¾èµ–æ³¨å…¥åï¼Œè¿›ä¸€æ­¥åˆå§‹åŒ–Bean  å…·ä½“è¿›è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š</span>
	<span class="token comment">// è‹¥å®ç°äº†BeanNameAwareï¼Œ BeanClassLoaderAwareï¼ŒBeanFactoryAwareAwareç­‰æ¥å£ï¼Œåˆ™æ³¨å…¥ç›¸å…³å¯¹è±¡</span>
	<span class="token comment">// éå†åç½®å¤„ç†å™¨ï¼Œè°ƒç”¨å®ç°çš„postProcessBeforeInitializationæ–¹æ³•ï¼Œ</span>
	<span class="token comment">// å¦‚æœå®ç°äº†initialzingBeanï¼Œè°ƒç”¨å®ç°çš„ afterPropertiesSet()</span>
	<span class="token comment">// å¦‚æœé…ç½®äº†init-mothodï¼Œè°ƒç”¨ç›¸åº”çš„initæ–¹æ³•</span>
	<span class="token comment">// éå†åç½®å¤„ç†å™¨ï¼Œè°ƒç”¨å®ç°çš„postProcessAfterInitialization</span>
    exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
        mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Initialization of bean failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
    * ç¬¬äºŒæ¬¡åˆ¤æ–­ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢æå‰æš´éœ²çš„beanå’Œæœ€ç»ˆå®é™…çš„beanä¸ä¸€è‡´ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰æˆ–è€…å¼•å…¥ä¼šåˆ›å»ºä»£ç†å¯¹è±¡çš„
    * BeanPostProcessorçš„è¯ï¼Œæ˜¯ä¸ä¼šæœ‰é—®é¢˜çš„ï¼Œå› ä¸ºåœ¨springçš„AbstractAutoProxyCreatorä¸­ï¼Œå¦‚æœå·²ç»é€šè¿‡
    * getEarlyBeanReferenceæå‰åˆ›å»ºè¿‡ä»£ç†å¯¹è±¡äº†ï¼Œé‚£ä¹ˆåœ¨postProcessAfterInitializationä¸­ä¼šç›´æ¥è·³è¿‡ä»£ç†å¯¹è±¡çš„åˆ›å»º, 
    * ç„¶åå°†åŸbeanå¯¹è±¡è¿”å›ï¼Œæ‰€ä»¥ä¸‹é¢çš„exposedObject == beanæ˜¯true, åˆå› ä¸ºåœ¨postProcessAfterInitializationè·³è¿‡äº†
    * è‡ªåŠ¨ä»£ç†ç±»çš„åˆ›å»ºï¼Œä½†æ˜¯åœ¨getEarlyBeanReferenceä¸­ä»£ç†äº†ï¼Œæ‰€ä»¥è¦å°†earlySingletonReferenceèµ‹ç»™exposedObjectï¼Œ
    * ä¿è¯è¿”å›çš„beanå’Œæå‰ä»£ç†å¹¶æ³¨å…¥çš„beanæ˜¯ä¸€è‡´çš„ã€‚
    * æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¦‚æœæƒ³è‡ªå®šä¹‰BeanPostProcessorå¹¶è¦ä»£ç†beanå¯¹è±¡çš„è¯ï¼Œéœ€è¦æŒ‰ç…§AbstractAutoProxyCreatorå¤„ç†å¾ªç¯ä¾èµ–
    * çš„æ¨¡å¼å»å®ç°ï¼Œæ—¢è¦å®ç°getEarlyBeanReferenceï¼Œè¿˜è¦å®ç°postProcessAfterInitializationï¼Œå¦‚æœè°ƒç”¨è¿‡äº†
    * getEarlyBeanReferenceï¼Œæå‰æš´éœ²äº†beanå¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨postProcessAfterInitializationä¸­è¦è·³è¿‡
    * getEarlyBeanReferenceä¸­çš„å®ç°é€»è¾‘ï¼Œè€Œä¸”ä¸è¦æ”¹å˜beanå¯¹è±¡
    */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
            <span class="token string">&quot;Bean with name &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; has been injected into other beans [&quot;</span> <span class="token operator">+</span>
            <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Register bean as disposable.</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// åç½®å¤„ç†å™¨ã€ç¬¬ä¹æ¬¡ã€‘è°ƒç”¨ï¼Œåœ¨é”€æ¯beanæ—¶ï¼Œä¼šè°ƒç”¨DestructionAwareBeanPostProcessorç±»å‹åç½®å¤„ç†å™¨çš„</span>
    <span class="token comment">// postProcessBeforeDestruction()æ–¹æ³•</span>
    <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
      mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Invalid destruction signature&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰©å±•çŸ¥è¯†ï¼š</p><p><strong>springè§£å†³å¾ªç¯ä¾èµ–ä¸ºä»€ä¹ˆéœ€è¦ä¸‰å±‚ç¼“å­˜ï¼Ÿ</strong></p><blockquote><p>singletonObjectsæ˜¯å­˜æ”¾å·²ç»å¤„ç†å®Œæˆçš„æœ€ç»ˆå•ä¾‹beançš„ã€‚</p><p>singletonFactoriesæ˜¯å­˜æ”¾ç”¨äºæå‰æš´éœ²å•ä¾‹beanå¯¹è±¡çš„å¯¹è±¡å·¥å‚ï¼Œå¦‚æœå­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œæ‰ä¼šè°ƒç”¨å¯¹è±¡å·¥å‚çš„æ–¹æ³•æå‰æš´éœ²å•ä¾‹beanå¯¹è±¡ï¼Œå¦åˆ™ä¸ä¼šè°ƒç”¨ã€‚</p><p>earlySingletonObjectsæ˜¯å­˜æ”¾æå‰æš´éœ²è¿˜æ²¡æœ‰æœ€ç»ˆå®Œæˆçš„å•ä¾‹å¯¹è±¡çš„ï¼Œæ­¤æ—¶å®ƒè¿˜ä¸èƒ½ç®—æ˜¯å•ä¾‹beanå¯¹è±¡ã€‚è€Œä¸”ä¸Šé¢é€šè¿‡åˆ¤æ–­earlySingletonObjectsä¸­æ˜¯å¦å­˜åœ¨æå‰æš´éœ²çš„å¯¹è±¡ï¼Œä»¥åŠåˆ¤æ–­æå‰æš´éœ²çš„å¯¹è±¡å’Œæœ€ç»ˆçš„beanå¯¹è±¡æ˜¯å¦æ˜¯ä¸€è‡´çš„æ¥é˜²æ­¢ç¨‹åºå‡ºé”™ã€‚</p></blockquote><h4 id="abstractautowirecapablebeanfactory-populatebean" tabindex="-1"><a class="header-anchor" href="#abstractautowirecapablebeanfactory-populatebean" aria-hidden="true">#</a> AbstractAutowireCapableBeanFactory#populateBean()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">populateBean</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœbwä¸ºnullçš„è¯,åˆ™è¯´æ˜å¯¹è±¡æ²¡æœ‰å®ä¾‹åŒ–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bw <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿›å…¥ifè¯´æ˜å¯¹è±¡æœ‰å±æ€§ï¼Œbwä¸ºç©ºï¼Œä¸èƒ½ä¸ºä»–è®¾ç½®å±æ€§ï¼Œé‚£å°±åœ¨ä¸‹é¢å°±æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
                        mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">&quot;Cannot apply property values to null instance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Skip property population phase for null instance.</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * åœ¨å±æ€§è¢«å¡«å……å‰ï¼Œç»™InstantiationAwareBeanPostProcessorç±»å‹çš„åç½®å¤„ç†å™¨ä¸€ä¸ªä¿®æ”¹beançŠ¶æ€çš„æœºä¼šã€‚
         * å®˜æ–¹çš„è§£é‡Šæ˜¯ï¼šè®©ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å±æ€§æ³¨å…¥ã€‚æ¯”å¦‚ç”¨æˆ·å®ç°ä¸€ä¸ªInstantiationAwareBeanPostProcessorç±»å‹çš„åç½®å¤„ç†å™¨ï¼Œ
         * å¹¶é€šè¿‡postProcessAfterInstantiationæ–¹æ³•å‘beançš„æˆå‘˜å˜é‡æ³¨å…¥è‡ªå®šä¹‰çš„ä¿¡æ¯ã€‚
         */</span>
        <span class="token keyword">boolean</span> continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­æ˜¯å¦æŒæœ‰InstantiationAwareBeanPostProcessor</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                    <span class="token comment">// åç½®å¤„ç†å™¨ã€ç¬¬äº”æ¬¡ã€‘è°ƒç”¨ï¼ŒpostProcessAfterInstantiationï¼šå¦‚æœåº”è¯¥ç»§ç»­åœ¨beanä¸Šé¢è®¾ç½®å±æ€§åˆ™è¿”å›trueï¼Œ</span>
                    <span class="token comment">// å¦åˆ™è¿”å›falseã€‚å¦‚æœè¿”å›äº†falseï¼Œåˆ™ä¸ä¼šç»§ç»­æ‰§è¡Œä¸‹é¢çš„é€»è¾‘äº†</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ibp<span class="token punctuation">.</span><span class="token function">postProcessAfterInstantiation</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        continueWithPropertyPopulation <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœåç»­å¤„ç†å™¨å‘å‡ºåœæ­¢å¡«å……å‘½ä»¤ï¼Œåˆ™ç»ˆæ­¢åç»­æ“ä½œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>continueWithPropertyPopulation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è·å–beanå®šä¹‰çš„å±æ€§</span>
        <span class="token class-name">PropertyValues</span> pvs <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">hasPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * åˆ¤æ–­æˆ‘ä»¬çš„beançš„å±æ€§æ³¨å…¥æ¨¡å‹ï¼Œè¿™é‡Œå¤„ç†çš„xmlé…ç½®çš„å†…å®¹ï¼Œæ³¨è§£é…ç½®çš„ä¸æ˜¯åœ¨è¿™é‡Œå¤„ç†
         * AUTOWIRE_BY_NAME æ ¹æ®åç§°æ³¨å…¥
         * AUTOWIRE_BY_TYPE æ ¹æ®ç±»å‹æ³¨å…¥
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_BY_NAME</span> <span class="token operator">||</span> mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æŠŠPropertyValueså°è£…æˆä¸ºMutablePropertyValues</span>
            <span class="token class-name">MutablePropertyValues</span> newPvs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutablePropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ ¹æ®beançš„å±æ€§åç§°æ³¨å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_BY_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">autowireByName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ ¹æ®beançš„ç±»å‹è¿›è¡Œæ³¨å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResolvedAutowireMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">AUTOWIRE_BY_TYPE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">autowireByType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> newPvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æŠŠå¤„ç†è¿‡çš„ å±æ€§è¦†ç›–åŸæ¥çš„</span>
            pvs <span class="token operator">=</span> newPvs<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * ç”¨äºåœ¨Springå¡«å……å±æ€§åˆ°beanå¯¹è±¡å‰ï¼Œå¯¹å±æ€§çš„å€¼è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œæ¯”å¦‚å¯ä»¥ä¿®æ”¹æŸäº›å±æ€§çš„å€¼ã€‚
         * è¿™æ—¶æ³¨å…¥åˆ°beanä¸­çš„å€¼å°±ä¸æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹äº†ï¼Œè€Œæ˜¯ç»è¿‡åç½®å¤„ç†å™¨ä¿®æ”¹åçš„å†…å®¹ã€‚
         */</span>
        <span class="token keyword">boolean</span> hasInstAwareBpps <span class="token operator">=</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ£€æŸ¥ä¾èµ–</span>
        <span class="token keyword">boolean</span> needsDepCheck <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getDependencyCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">.</span><span class="token constant">DEPENDENCY_CHECK_NONE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps <span class="token operator">||</span> needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pvs <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// å–å‡ºå½“å‰æ­£åœ¨åˆ›å»ºçš„beanWrapperä¾èµ–çš„å¯¹è±¡</span>
            <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filteredPds <span class="token operator">=</span> <span class="token function">filterPropertyDescriptorsForDependencyCheck</span><span class="token punctuation">(</span>bw<span class="token punctuation">,</span> mbd<span class="token punctuation">.</span>allowCaching<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasInstAwareBpps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">InstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
                        <span class="token comment">// åç½®å¤„ç†å™¨ã€ç¬¬å…­æ¬¡ã€‘è°ƒç”¨ï¼Œå¯¹ä¾èµ–å¯¹è±¡è¿›è¡Œåç½®å¤„ç†</span>
                        pvs <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>pvs<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//åˆ¤æ–­æ˜¯å¦æ£€æŸ¥ä¾èµ–</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needsDepCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkDependencies</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> filteredPds<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * å…¶å®ï¼Œä¸Šé¢åªæ˜¯å®Œæˆäº†æ‰€æœ‰æ³¨å…¥å±æ€§çš„è·å–ï¼Œå°†è·å–çš„å±æ€§å°è£…åœ¨PropertyValuesçš„å®ä¾‹å¯¹è±¡ pvs ä¸­ï¼Œ
         * å¹¶æ²¡æœ‰åº”ç”¨åˆ°å·²ç»å®ä¾‹åŒ–çš„beanä¸­ã€‚è€ŒapplyPropertyValues() æ–¹æ³•ï¼Œåˆ™æ˜¯å®ŒæˆçœŸæ­£æ³¨å…¥çš„ã€‚
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pvs <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">applyPropertyValues</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bw<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">autowireByName</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">AbstractBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">,</span> <span class="token class-name">MutablePropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//æ ¹æ®bwçš„PropertyDescriptorsï¼Œéå†å‡ºæ‰€æœ‰å¯å†™çš„ï¼ˆå³setæ–¹æ³•å­˜åœ¨)ï¼Œå­˜åœ¨äºBeanDefinitioné‡Œçš„PropertyValuesï¼Œä¸”ä¸æ˜¯ç®€å•å±æ€§çš„å±æ€§å</span>
        <span class="token comment">//ç®€å•å±æ€§çš„åˆ¤å®šå‚ç…§ä¸‹é¢æ–¹æ³•ï¼Œä¸»è¦æ¶µç›–åŸºæœ¬ç±»å‹åŠå…¶åŒ…è£…ç±»ï¼ŒNumber,Dateç­‰=============</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> propertyNames <span class="token operator">=</span> <span class="token function">unsatisfiedNonSimpleProperties</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> bw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> propertyName <span class="token operator">:</span> propertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// æ˜¾ç„¶ï¼Œåªæœ‰å®¹å™¨é‡Œå­˜åœ¨çš„ï¼Œæ‰èƒ½æ ¹æ®è¿™ä¸ªåç§°æ³¨å†Œè¿›å»ã€‚</span>
            <span class="token comment">//æ³¨æ„ï¼Œè¿™é‡Œå­˜åœ¨ï¼Œæœ‰ç‚¹æ„æ€ï¼šå«æœ‰Beanï¼Œæˆ–è€…Beanå®šä¹‰ç­‰ç­‰éƒ½ç®—</span>
            <span class="token doc-comment comment">/** @Override
            public boolean containsBean(String name) <span class="token punctuation">{</span>
            String beanName = transformedBeanName(name);
            // é¦–å…ˆå·¥å‚é‡Œå¿…é¡»æœ‰å•ä¾‹Beanï¼Œæˆ–è€…beanå®šä¹‰
            // ç„¶åè¿˜å¿…é¡»ä¸æ˜¯BeanFactoryï¼ˆä¸æ˜¯&amp;æ‰“å¤´ï¼‰,æˆ–è€…æ˜¯FactoryBean  å°±ç®—æ˜¯åŒ…å«è¿™ä¸ªBeançš„
            if (containsSingleton(beanName) || containsBeanDefinition(beanName)) <span class="token punctuation">{</span>
            return (!BeanFactoryUtils.isFactoryDereference(name) || isFactoryBean(name));
            <span class="token punctuation">}</span>

            // Not found -&gt; check parent.  çœ‹çœ‹çˆ¶å®¹å™¨é‡Œæœ‰æœ¨æœ‰
            BeanFactory parentBeanFactory = getParentBeanFactory();
            return (parentBeanFactory != null &amp;&amp; parentBeanFactory.containsBean(originalBeanName(name)));
            <span class="token punctuation">}</span> */</span>

            <span class="token comment">// å†è¯´æ˜ä¸€ä¸‹containsLocalBeanè¿™ä¸ªæ–¹æ³•ï¼Œå’ŒcontainsBeançš„åŒºåˆ«åœ¨äºå®ƒåªåœ¨è‡ªå·±çš„å®¹å™¨é‡Œæ‰¾ï¼Œä¸å»çˆ¶å®¹å™¨é‡Œæ‰¾ï¼Œå…¶ä½™çš„ä¸€æ ·</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">containsBean</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ³¨æ„ï¼šæ­¤å¤„æ‰¾åˆ°ä¾èµ–äº†ï¼Œè°ƒç”¨äº†getBean()ï¼Œæ‰€ä»¥å³ä½¿ä½ ç°åœ¨ä»…ä»…åªæ˜¯Beanå®šä¹‰ï¼Œé‚£ä¹ˆä¼šè¢«åˆ›å»ºå®ä¾‹å¯¹è±¡</span>
                <span class="token class-name">Object</span> bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pvs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ³¨å†Œä¾èµ–å…³ç³»</span>
                <span class="token comment">// æ­¤å¤„éœ€è¦çŸ¥é“çš„æ˜¯ï¼šSpringä¸­ä½¿ç”¨dependentBeanMapå’ŒdependenciesForBeanMapæ¥ç®¡ç†è¿™äº›Beançš„ä¾èµ–å…³ç³»ï¼š</span>
                <span class="token comment">//Map&lt;String, Set&lt;String&gt;&gt; dependentBeanMapï¼šå­˜æ”¾ç€å½“å‰Beanè¢«å¼•ç”¨çš„Beançš„é›†åˆ</span>
                <span class="token comment">//Map&lt;String, Set&lt;String&gt;&gt; dependenciesForBeanMapï¼šå­˜æ”¾çš„åˆ™æ˜¯å½“å‰Beanæ‰€ä¾èµ–çš„Beançš„é›†åˆ</span>
                <span class="token comment">//ä¾èµ–æ³¨å…¥çš„å…·ä½“å®ç°æ˜¯åœ¨BeanWrapperImplç±»ä¸­çš„setPropertyValueæ–¹æ³•é‡Œ=======================</span>
                <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Added autowiring by name from bean name &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                            <span class="token string">&quot;&#39; via property &#39;&quot;</span> <span class="token operator">+</span> propertyName <span class="token operator">+</span> <span class="token string">&quot;&#39; to bean named &#39;&quot;</span> <span class="token operator">+</span> propertyName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Not autowiring property &#39;&quot;</span> <span class="token operator">+</span> propertyName <span class="token operator">+</span> <span class="token string">&quot;&#39; of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                            <span class="token string">&quot;&#39; by name: no matching bean found&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">autowireByType</span><span class="token punctuation">(</span>
            <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">AbstractBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">BeanWrapper</span> bw<span class="token punctuation">,</span> <span class="token class-name">MutablePropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// ç±»å‹è½¬æ¢å™¨ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°±ç”¨BeanWrapperè¿™ä¸ªè½¬æ¢å™¨</span>
        <span class="token class-name">TypeConverter</span> converter <span class="token operator">=</span> <span class="token function">getCustomTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>converter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            converter <span class="token operator">=</span> bw<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autowiredBeanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> propertyNames <span class="token operator">=</span> <span class="token function">unsatisfiedNonSimpleProperties</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> bw<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> propertyName <span class="token operator">:</span> propertyNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">PropertyDescriptor</span> pd <span class="token operator">=</span> bw<span class="token punctuation">.</span><span class="token function">getPropertyDescriptor</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Don&#39;t try autowiring by type for type Object: never makes sense,</span>
                <span class="token comment">// even if it technically is a unsatisfied, non-simple property.</span>
                <span class="token comment">//å¦‚æœæ˜¯Objectç±»å‹ä¸è¿›è¡Œè£…é…==============</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">!=</span> pd<span class="token punctuation">.</span><span class="token function">getPropertyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è·å–ç›¸å…³çš„å†™æ–¹æ³•å‚æ•°</span>
                    <span class="token class-name">MethodParameter</span> methodParam <span class="token operator">=</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">getWriteMethodParameter</span><span class="token punctuation">(</span>pd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Do not allow eager init for type matching in case of a prioritized post-processor.</span>
                    <span class="token comment">// çœ‹çœ‹å®ä¾‹æ˜¯å¦å®ç°äº†PriorityOrderedæ¥å£ï¼Œè‹¥æ²¡æœ‰å®ç°  å°±ç¨åç‚¹åŠ è½½å§-----</span>
                    <span class="token keyword">boolean</span> eager <span class="token operator">=</span> <span class="token operator">!</span><span class="token class-name">PriorityOrdered</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bw<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">DependencyDescriptor</span> desc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutowireByTypeDependencyDescriptor</span><span class="token punctuation">(</span>methodParam<span class="token punctuation">,</span> eager<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// è¿™é‡Œä¼šæ ¹æ®ä¼ å…¥descé‡Œçš„å…¥å‚ç±»å‹ï¼Œä½œä¸ºä¾èµ–è£…é…çš„ç±»å‹</span>
                    <span class="token comment">// å†æ ¹æ®è¿™ä¸ªç±»å‹åœ¨BeanFacotyä¸­æŸ¥æ‰¾æ‰€æœ‰ç±»æˆ–å…¶çˆ¶ç±»ç›¸åŒçš„BeanName</span>
                    <span class="token comment">// æœ€åæ ¹æ®BeanNameè·å–æˆ–åˆå§‹åŒ–ç›¸åº”çš„ç±»ï¼Œç„¶åå°†æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„BeanNameå¡«å……åˆ°autowiredBeanNamesä¸­ã€‚</span>
                    <span class="token class-name">Object</span> autowiredArgument <span class="token operator">=</span> <span class="token function">resolveDependency</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">,</span> converter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>autowiredArgument <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pvs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>propertyName<span class="token punctuation">,</span> autowiredArgument<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token comment">// éœ€è¦æ³¨å…¥çš„ä¾èµ–éƒ½æ‹¿åˆ°åï¼Œå°±å¼€å§‹æ³¨å†Œè¿™äº›ä¾èµ–å§</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> autowiredBeanName <span class="token operator">:</span> autowiredBeanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ä¸€æ ·çš„ è¿™é‡Œæ³¨å†Œè¿™äº›ä¾èµ–</span>
                        <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    autowiredBeanNames<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> propertyName<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// AutowiredAnnotationBeanPostProcessor:è¿™é‡Œå°±æ˜¯è§£æè¯¥Beançš„Autowiredä¿¡æ¯,ç„¶åç»™injectè¿›å»</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PropertyValues</span> <span class="token function">postProcessPropertyValues</span><span class="token punctuation">(</span>
            <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">,</span> <span class="token class-name">PropertyDescriptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pds<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>

        <span class="token class-name">InjectionMetadata</span> metadata <span class="token operator">=</span> <span class="token function">findAutowiringMetadata</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            metadata<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">&quot;Injection of autowired dependencies failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pvs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// InjectionMetadata#injectå¤„ç†ä¾èµ–æ³¨å…¥ï¼š</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectedElement</span><span class="token punctuation">&gt;</span></span> checkedElements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>checkedElements<span class="token punctuation">;</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectedElement</span><span class="token punctuation">&gt;</span></span> elementsToIterate <span class="token operator">=</span>
                <span class="token punctuation">(</span>checkedElements <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> checkedElements <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injectedElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>elementsToIterate<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> debug <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InjectedElement</span> element <span class="token operator">:</span> elementsToIterate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>debug<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Processing injected element of bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39;: &quot;</span> <span class="token operator">+</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// ä¸»è¦çš„æ–¹æ³•ï¼Œè¿˜æ˜¯åœ¨InjectedElement#injecté‡Œ</span>
                element<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> pvs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// AutowiredFieldElementä¸ºä¾‹è¿›è¡Œè®²è§£</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PropertyValues</span> pvs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¿åˆ°è¿™ä¸ªå­—æ®µå</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>member<span class="token punctuation">;</span>
        <span class="token class-name">Object</span> value<span class="token punctuation">;</span>
        <span class="token comment">// å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™é‡Œéƒ½æ˜¯false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            value <span class="token operator">=</span> <span class="token function">resolvedCachedArgument</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">DependencyDescriptor</span> desc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DependencyDescriptor</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>required<span class="token punctuation">)</span><span class="token punctuation">;</span>
            desc<span class="token punctuation">.</span><span class="token function">setContainingClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autowiredBeanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No BeanFactory available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è½¬æ¢å™¨ï¼Œæ²¡æœ‰æ‰‹åŠ¨æ³¨å†Œï¼Œé»˜è®¤éƒ½æ˜¯SimpleTypeConverter===============</span>
            <span class="token class-name">TypeConverter</span> typeConverter <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æŠŠå½“å‰beanæ‰€ä¾èµ–çš„è¿™ä¸ªBeanè§£æå‡ºæ¥ï¼ˆä»Springå®¹å™¨é‡Œé¢æ‹¿ï¼Œæˆ–è€…åˆ«çš„åœ°æ–¹è·å–å§~~~ï¼‰</span>
                value <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">resolveDependency</span><span class="token punctuation">(</span>desc<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">,</span> typeConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsatisfiedDependencyException</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InjectionPoint</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å¦‚æœå·²ç»æ‹¿åˆ°äº†è¿™ä¸ªBeanå®ä¾‹ï¼Œ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>required<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue <span class="token operator">=</span> desc<span class="token punctuation">;</span>

                        <span class="token comment">// æŠŠè¯¥Beançš„ä¾èµ–å…³ç³»å†æ³¨å†Œä¸€æ¬¡</span>
                        <span class="token function">registerDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> autowiredBeanNames<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// å› ä¸ºæ˜¯æŒ‰ç…§ç±»å‹æ³¨å…¥ï¼Œæ‰€ä»¥è‚¯å®šåªèƒ½æŒ‡å¯¼ä¸€ä¸ªè¿™ä¸ªçš„ä¾èµ–Beanï¼Œå¦åˆ™ä¸Šé¢è§£æå°±å·²ç»æŠ¥é”™äº†</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>autowiredBeanNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">String</span> autowiredBeanName <span class="token operator">=</span> autowiredBeanNames<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// è¿™é‡Œæ˜¯æ¥å¤„ç†æ”¾ç½®ç¼“å­˜çš„å­—æ®µå€¼</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                                    beanFactory<span class="token punctuation">.</span><span class="token function">isTypeMatch</span><span class="token punctuation">(</span>autowiredBeanName<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShortcutDependencyDescriptor</span><span class="token punctuation">(</span>
                                        desc<span class="token punctuation">,</span> autowiredBeanName<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>cachedFieldValue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>cached <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ç»™è¯¥å¯¹è±¡çš„è¯¥å­—æ®µèµ‹å€¼ã€‚æ³¨æ„è¿™é‡ŒmakeAccessibleè®¾ç½®ä¸ºtrueäº†ï¼Œæ‰€ä»¥å³ä½¿ä½ çš„å­—æ®µæ˜¯privateçš„ä¹Ÿæœ¨æœ‰å…³ç³»å“¦, ä½¿ç”¨çš„åå°„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">makeAccessible</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="abstractautowirecapablebeanfactory-initializebean" tabindex="-1"><a class="header-anchor" href="#abstractautowirecapablebeanfactory-initializebean" aria-hidden="true">#</a> AbstractAutowireCapableBeanFactory#initializeBean()</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// è‹¥æˆ‘ä»¬çš„beanå®ç°äº†XXXAwareæ¥å£ï¼Œåœ¨è¿™é‡Œè¿›è¡Œæ¥å£æ–¹æ³•çš„å›è°ƒï¼Œ</span>
    <span class="token comment">// æ³¨æ„è¿™é‡Œåªæ˜¯å¤„ç†äº†BeanNameAwareã€BeanClassLoaderAwareã€BeanFactoryAwareè¿™ä¸‰ä¸ªæ¥å£çš„å›è°ƒã€‚</span>
    <span class="token comment">// ä¸applicationæœ‰å…³çš„awareæ¥å£å›è°ƒæ˜¯åœ¨ApplicationContextAwareProcessor.postProcessBeforeInitialization()</span>
    <span class="token comment">// æ–¹æ³•ä¸­å¤„ç†çš„ï¼ŒåŒ…æ‹¬ï¼šEnvironmentAwareã€EmbeddedValueResolverAwareã€ResourceLoaderAwareã€	</span>
    <span class="token comment">// ApplicationEventPublisherAwareã€MessageSourceAwareã€ApplicationContextAwareã€‚</span>
    <span class="token comment">// ImportAwareæ˜¯åœ¨ImportAwareBeanPostProcessor.postProcessBeforeInitialization()å¤„ç†çš„ã€‚</span>
    <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">Object</span> wrappedBean <span class="token operator">=</span> bean<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åç½®å¤„ç†å™¨ã€ç¬¬ä¸ƒæ¬¡ã€‘è°ƒç”¨ï¼Œè°ƒç”¨æˆ‘ä»¬çš„beançš„åç½®å¤„ç†å™¨çš„postProcessorsBeforeInitializationæ–¹æ³•  </span>
    <span class="token comment">// @PostConstructæ³¨è§£çš„æ–¹æ³•å°±æ˜¯åœ¨è¿™ä¸€æ­¥è¢«è°ƒç”¨çš„</span>
    wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsBeforeInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</span>
    <span class="token comment">// InitializingBeanæ¥å£ï¼Œinit-methodæ–¹æ³•</span>
    <span class="token function">invokeInitMethods</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> wrappedBean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      beanName<span class="token punctuation">,</span> <span class="token string">&quot;Invocation of init method failed&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åç½®å¤„ç†å™¨ã€ç¬¬å…«æ¬¡ã€‘è°ƒç”¨ï¼Œè°ƒç”¨æˆ‘ä»¬beançš„åç½®å¤„ç†å™¨çš„PostProcessorsAfterInitializationæ–¹æ³•</span>
    wrappedBean <span class="token operator">=</span> <span class="token function">applyBeanPostProcessorsAfterInitialization</span><span class="token punctuation">(</span>wrappedBean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> wrappedBean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼ŒSpringçš„beanåˆ›å»ºæµç¨‹å°±ç»“æŸäº†ã€‚</p><h4 id="refreshæ€»ç»“" tabindex="-1"><a class="header-anchor" href="#refreshæ€»ç»“" aria-hidden="true">#</a> refreshæ€»ç»“</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">1</span>ã€<span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>åˆ·æ–°å‰çš„é¢„å¤„ç†<span class="token punctuation">;</span>
	<span class="token number">0</span>ï¼‰<span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>ï¼Œ<span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>  è®¾ç½®ä¸€äº›æ ‡è®°ä½
	<span class="token number">1</span>ï¼‰<span class="token function">initPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>åˆå§‹åŒ–ä¸€äº›å±æ€§è®¾ç½®<span class="token punctuation">;</span><span class="token punctuation">(</span>äº¤ç”±å­ç±»å»å®ç°ï¼Œæ¯”å¦‚webå®¹å™¨ä¸­çš„ <span class="token class-name">AbstractRefreshableWebApplicationContext</span> å°±å»åˆå§‹åŒ–äº†servletçš„ä¸€äº›initå‚æ•°ç­‰ç­‰<span class="token punctuation">)</span>
	<span class="token number">2</span>ï¼‰<span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateRequiredProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>æ£€éªŒå±æ€§çš„åˆæ³•ç­‰
	<span class="token number">3</span>ï¼‰earlyApplicationEvents<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>åˆå§‹åŒ–å®¹å™¨ï¼Œä¿å­˜ä¸€äº›æ—©æœŸçš„äº‹ä»¶ï¼›
	
<span class="token number">2</span>ã€<span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>è·å–<span class="token class-name">BeanFactory</span>ï¼›
	<span class="token number">1</span>ï¼‰<span class="token function">refreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>æŠ½è±¡æ–¹æ³•ï¼Œå­ç±»ã€<span class="token class-name">AbstractRefreshableApplicationContext</span>ã€‘å”¯ä¸€å®ç°çš„ï¼š
		â‘  è‹¥å·²ç»å­˜åœ¨beanFactoryäº†ï¼Œé‚£å°±åšä¸€äº›æ¸…ç†å·¥ä½œï¼ˆé”€æ¯å•ä¾‹<span class="token class-name">Bean</span>ã€å…³é—­å·¥å‚ï¼‰
		â‘¡ åˆ›å»ºäº†ä¸€ä¸ª<span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultListableBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>å¹¶ä¸”è®¾ç½®id
		â‘¢ æŠŠæ—§çš„å·¥å‚çš„å±æ€§èµ‹å€¼ç»™æ–°åˆ›å»ºçš„å·¥å‚ï¼š<span class="token function">customizeBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span>
		â‘£ <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span>ï¼šåŠ è½½<span class="token class-name">Bean</span>å®šä¹‰ã€‚æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å»å†³å®šä»å“ªå„¿å»æŠŠ<span class="token class-name">Bean</span>å®šä¹‰åŠ è½½è¿›æ¥ï¼Œå®ç°æœ‰æ¯”å¦‚ï¼š
			<span class="token class-name">XmlWebApplicationContext</span>ï¼šä¸“ä¸ºwebè®¾è®¡çš„ä»xmlæ–‡ä»¶é‡ŒåŠ è½½<span class="token class-name">Bean</span>å®šä¹‰ï¼ˆå€ŸåŠ©<span class="token class-name">XmlBeanDefinitionReader</span>ï¼‰
			<span class="token class-name">ClassPathXmlApplicationContext</span><span class="token operator">/</span><span class="token class-name">FileSystemXmlApplicationContext</span>ï¼šå‡ç”±çˆ¶ç±»<span class="token class-name">AbstractXmlApplicationContext</span>å»å®ç°è¿™ä¸ªæ–¹æ³•çš„ï¼Œä¹Ÿæ˜¯å€ŸåŠ©<span class="token class-name">XmlBeanDefinitionReader</span>
			<span class="token class-name">AnnotationConfigWebApplicationContext</span>ï¼šåŸºäºæ³¨è§£é©±åŠ¨çš„å®¹å™¨ã€‚ï¼ˆä¹Ÿæ˜¯å½“ä¸‹æœ€æµè¡Œã€æœ€é‡è¦çš„ä¸€ä¸ªå®ç°ï¼Œå‰é¢ä¸€ç¯‡åšæ–‡å¯¹æ­¤æœ‰é‡ç‚¹åˆ†æï¼‰ï¼Œå€ŸåŠ©äº†<span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>æ–¹æ³•åŠ è½½<span class="token class-name">Bean</span>å®šä¹‰
		ï¼ˆè¿™é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>åªæ˜¯æŠŠå½“å‰è¿™ä¸€ä¸ª<span class="token class-name">Class</span>å¯¹è±¡registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>äº†ï¼Œè‡³äºå†…éƒ¨çš„<span class="token annotation punctuation">@Bean</span>ã€<span class="token annotation punctuation">@ComponentScan</span>æ‰«æåˆ°çš„ï¼Œéƒ½ä¸æ˜¯åœ¨æ­¤å¤„æ³¨å†Œçš„ï¼‰æœ‰å¿…è¦è¯´ä¸€å¥ï¼š<span class="token class-name">AnnotationConfigApplicationContext</span>æ˜¯åœ¨éwebç¯å¢ƒä¸‹çš„å®¹å™¨ã€‚å®ƒè™½ç„¶æ²¡æœ‰å®ç°å®ç°<span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>æŠ½è±¡æ–¹æ³•ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨<span class="token keyword">new</span>å¯¹è±¡çš„æ—¶å€™ï¼Œå·²ç»è°ƒç”¨äº†<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>å®Œæˆé…ç½®<span class="token class-name">Bean</span>å®šä¹‰ä¿¡æ¯çš„æ³¨å†Œäº†
	<span class="token number">2</span>ï¼‰<span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>è¿”å›åˆšæ‰<span class="token class-name">GenericApplicationContext</span>åˆ›å»ºçš„<span class="token class-name">BeanFactory</span>å¯¹è±¡ï¼›
	<span class="token number">3</span>ï¼‰å°†åˆ›å»ºçš„<span class="token class-name">BeanFactory</span>ã€<span class="token class-name">DefaultListableBeanFactory</span>ã€‘è¿”å›ï¼›

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>------åˆ°è¿™ä¸€æ­¥æˆªæ­¢ï¼ŒBeanFactoryå·²ç»åˆ›å»ºå¥½äº†ï¼ˆåªä¸è¿‡éƒ½è¿˜æ˜¯é»˜è®¤é…ç½®è€Œå·²ï¼‰ï¼Œé…ç½®Beançš„å®šä¹‰ä¿¡æ¯ä¹Ÿæ³¨å†Œå¥½äº†------</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">3</span>ã€<span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BeanFactory</span>çš„é¢„å‡†å¤‡å·¥ä½œï¼ˆå¯¹<span class="token class-name">BeanFactory</span>è¿›è¡Œä¸€äº›è®¾ç½®ï¼‰ï¼›
	<span class="token number">1</span>ï¼‰è®¾ç½®<span class="token class-name">BeanFactory</span>çš„ç±»åŠ è½½å™¨ã€<span class="token class-name">StandardBeanExpressionResolver</span>ã€<span class="token class-name">ResourceEditorRegistrar</span>
	<span class="token number">2</span>ï¼‰æ·»åŠ æ„ŸçŸ¥åç½®å¤„ç†å™¨<span class="token class-name">BeanPostProcessor</span>ã€<span class="token class-name">ApplicationContextAwareProcessor</span>ã€‘<span class="token punctuation">,</span>å¹¶è®¾ç½®ä¸€äº›å¿½ç•¥<span class="token class-name">EnvironmentAware</span>ã€<span class="token class-name">EmbeddedValueResolverAware</span>ã€xxxxxï¼ˆå› ä¸ºè¿™ä¸ªå¤„ç†å™¨éƒ½ä¸€æŠŠæŠ“äº†ï¼‰
	<span class="token number">3</span>ï¼‰æ³¨å†Œã€å¯ä»¥è§£æçš„<span class="token punctuation">(</span>è¡¨ç¤ºè™½ç„¶ä¸åœ¨å®¹å™¨é‡Œï¼Œä½†è¿˜æ˜¯å¯ä»¥ç›´æ¥ <span class="token annotation punctuation">@Auwowired</span><span class="token punctuation">)</span>ã€‘è‡ªåŠ¨è£…é…ï¼›æˆ‘ä»¬èƒ½ç›´æ¥åœ¨ä»»ä½•ç»„ä»¶ä¸­è‡ªåŠ¨æ³¨å…¥<span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">)</span>ï¼š
		<span class="token class-name">BeanFactory</span>ã€<span class="token class-name">ResourceLoader</span>ã€<span class="token class-name">ApplicationEventPublisher</span>ã€<span class="token class-name">ApplicationContext</span>
	<span class="token number">5</span>ï¼‰æ·»åŠ <span class="token class-name">BeanPostProcessor</span>ã€<span class="token class-name">ApplicationListenerDetector</span>ã€‘ æ£€æµ‹æ³¨å…¥è¿›æ¥çš„<span class="token class-name">Bean</span>æ˜¯å¦æ˜¯ç›‘å¬å™¨
	<span class="token number">6</span>ï¼‰<span class="token class-name">Detect</span> a <span class="token class-name">LoadTimeWeaver</span> and prepare <span class="token keyword">for</span> weaving<span class="token punctuation">,</span> <span class="token keyword">if</span> found<span class="token punctuation">.</span>æ·»åŠ ç¼–è¯‘æ—¶çš„<span class="token class-name">AspectJ</span>æ”¯æŒï¼š<span class="token class-name">LoadTimeWeaverAwareProcessor</span>
		<span class="token punctuation">(</span>æ·»åŠ çš„æ”¯æŒçš„æ¡ä»¶æ˜¯ï¼šbeanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span><span class="token string">&quot;loadTimeWeaver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token number">7</span>ï¼‰ç»™<span class="token class-name">BeanFactory</span>ä¸­æ³¨å†Œä¸€äº›èƒ½ç”¨çš„ç»„ä»¶ï¼›
		environment<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">ConfigurableEnvironment</span>ã€‘ã€
		systemProperties<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span>ã€‘ã€
		systemEnvironment<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span>ã€‘

<span class="token number">4</span>ã€<span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">BeanFactory</span>å‡†å¤‡å·¥ä½œå®Œæˆåè¿›è¡Œçš„åç½®å¤„ç†å·¥ä½œï¼›ï¼ˆç”±å­ç±»å®Œæˆï¼‰
	ä¸€èˆ¬webå®¹å™¨éƒ½ä¼šå¯¹åº”çš„å®ç°æ­¤æ–¹æ³•ï¼Œæ¯”å¦‚ <span class="token class-name">AbstractRefreshableWebApplicationContext</span>ï¼š
	<span class="token number">1</span><span class="token punctuation">)</span> æ·»åŠ æ„ŸçŸ¥<span class="token class-name">BeanPostProcessor</span>ã€<span class="token class-name">ServletContextAwareProcessor</span>ã€‘ï¼Œæ”¯æŒåˆ°äº†<span class="token class-name">ServletContextAware</span>ã€<span class="token class-name">ServletConfigAware</span>
	<span class="token number">2</span><span class="token punctuation">)</span> æ³¨å†Œscopseï¼šbeanFactory<span class="token punctuation">.</span><span class="token function">registerScope</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationContext</span><span class="token punctuation">.</span><span class="token constant">SCOPE_REQUEST</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>å½“ç„¶è¿˜æœ‰<span class="token constant">SCOPE_SESSION</span>ã€<span class="token class-name">SCOPE_APPLICATION</span>
	<span class="token number">3</span><span class="token punctuation">)</span> å‘ä¸Šé¢ä¸€æ ·ï¼Œæ³¨å†Œã€å¯ä»¥è§£æçš„ã€‘è‡ªåŠ¨æ³¨å…¥ä¾èµ–ï¼š<span class="token class-name">ServletRequest</span><span class="token operator">/</span><span class="token class-name">ServletResponse</span><span class="token operator">/</span><span class="token class-name">HttpSession</span><span class="token operator">/</span><span class="token class-name">WebRequest</span>
	<span class="token punctuation">(</span>å¤‡æ³¨ï¼šæ­¤å¤„æ”¾è¿›å®¹å™¨çš„éƒ½æ˜¯xxxObjectFactoryç±»å‹ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸ºä½•<span class="token annotation punctuation">@Autowired</span>æ²¡æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜çš„é‡è¦ä¸€æ­¥<span class="token punctuation">)</span>
	<span class="token number">4</span><span class="token punctuation">)</span> registerEnvironmentBeansï¼šæ³¨å†Œç¯å¢ƒç›¸å…³çš„<span class="token class-name">Bean</span>ï¼ˆä½¿ç”¨çš„registerSingletonï¼Œæ˜¯ç›´æ¥ä»¥å•ä¾‹<span class="token class-name">Bean</span>æ”¾åˆ°å®¹å™¨é‡Œé¢äº†ï¼‰
		servletContext<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">ServletContext</span>ã€‘
		servletConfig<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">ServletConfig</span>ã€‘
		contextParameters<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>ã€‘ ä¿å­˜æœ‰æ‰€æœ‰çš„initåˆå§‹åŒ–å‚æ•°ï¼ˆgetInitParameterï¼‰
		contextAttributes<span class="token operator">--</span><span class="token operator">&gt;</span>ã€<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span>ã€‘ servletContextçš„æ‰€æœ‰å±æ€§ï¼ˆ<span class="token class-name">ServletContext</span>#<span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>ï¼‰
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>--------ä»¥ä¸Šæ˜¯BeanFactoryçš„åˆ›å»ºåŠé¢„å‡†å¤‡å·¥ä½œï¼Œè‡³æ­¤å‡†å¤‡å·¥ä½œå®Œæˆäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¾—åˆ©ç”¨å·¥å‚å¹²ç‚¹æ­£äº‹äº†--------</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token number">5</span>ã€<span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>æ‰§è¡Œ<span class="token class-name">BeanFactoryPostProcessor</span>çš„æ–¹æ³•ï¼›
	<span class="token class-name">BeanFactoryPostProcessor</span>ï¼š<span class="token class-name">BeanFactory</span>çš„åç½®å¤„ç†å™¨ã€‚æ­¤å¤„è°ƒç”¨ï¼Œç°åœ¨å°±è¡¨ç¤ºåœ¨<span class="token class-name">BeanFactory</span>æ ‡å‡†åˆå§‹åŒ–ä¹‹åæ‰§è¡Œçš„ï¼›
	ä¸¤ä¸ªæ¥å£ï¼š<span class="token class-name">BeanFactoryPostProcessor</span>ã€<span class="token class-name">BeanDefinitionRegistryPostProcessor</span>ï¼ˆå­æ¥å£ï¼‰
	<span class="token number">1</span>ï¼‰æ‰§è¡Œ<span class="token class-name">BeanFactoryPostProcessor</span>ä»¬çš„æ–¹æ³•ï¼›
	
	<span class="token operator">--</span><span class="token operator">-</span>å…ˆæ‰§è¡Œ<span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token operator">--</span><span class="token operator">-</span>
	<span class="token number">1</span>ï¼‰è·å–æ‰€æœ‰çš„<span class="token class-name">BeanDefinitionRegistryPostProcessor</span>ï¼›ï¼ˆå½“ç„¶ä¼šæœ€å…ˆæ‰§è¡Œæˆ‘ä»¬æ‰‹åŠ¨setè¿›å»çš„<span class="token class-name">Processor</span>ï¼Œä½†æ˜¯è¿™ä¸ªä¸€èˆ¬éƒ½ä¸ä¼šæœ‰ï¼‰
	<span class="token number">2</span>ï¼‰å…ˆæ‰§è¡Œå®ç°äº†<span class="token class-name">PriorityOrdered</span>ä¼˜å…ˆçº§æ¥å£çš„<span class="token class-name">BeanDefinitionRegistryPostProcessor</span>ã€
	postProcessor<span class="token punctuation">.</span><span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span>
	<span class="token number">3</span>ï¼‰å†æ‰§è¡Œå®ç°äº†<span class="token class-name">Ordered</span>é¡ºåºæ¥å£çš„<span class="token class-name">BeanDefinitionRegistryPostProcessor</span>
	<span class="token number">4</span>ï¼‰æœ€åæ‰§è¡Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æˆ–è€…æ˜¯é¡ºåºæ¥å£çš„<span class="token class-name">BeanDefinitionRegistryPostProcessors</span>
	ï¼ˆå°ç»†èŠ‚ï¼šéƒ½ä¼šè°ƒç”¨<span class="token function">getBean</span><span class="token punctuation">(</span>â€œnameâ€<span class="token punctuation">,</span><span class="token class-name">BeanDefinitionRegistryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>æ–¹æ³•ï¼Œæ‰€ä»¥éƒ½ä¼šå…ˆå®ä¾‹åŒ–ï¼Œæ‰å»æ‰§è¡Œçš„ï¼‰
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è¿™é‡Œé¢éœ€è¦ç‰¹åˆ«çš„ä»‹ç»ä¸€ä¸ªå¤„ç†å™¨ï¼š<code>ConfigurationClassPostProcessor</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªBeanDefinitionRegistryPostProcessorï¼Œå®ƒä¼šè§£æå®Œæˆæ‰€æœ‰çš„@Configurationé…ç½®ç±»ï¼Œç„¶åæ‰€æœ‰@Beanã€@ComponentScanç­‰ç­‰Beanå®šä¹‰éƒ½ä¼šæœé›†è¿›æ¥äº†ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯éå¸¸çš„é‡è¦çš„</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token operator">--</span><span class="token operator">-</span>å†æ‰§è¡Œ<span class="token class-name">BeanFactoryPostProcessor</span>çš„æ–¹æ³•ï¼ˆé¡ºåºé€»è¾‘åŒä¸Šï¼Œç•¥ï¼‰<span class="token operator">--</span><span class="token operator">-</span>
	<span class="token number">2</span><span class="token punctuation">)</span> å†æ¬¡æ£€æµ‹ä¸€æ¬¡æ·»åŠ å¯¹<span class="token class-name">AspectJ</span>çš„æ”¯æŒã€‚ä¸ºä½•è¿˜è¦æ£€æµ‹å‘¢ï¼Ÿthrough an <span class="token annotation punctuation">@Bean</span> method registered by <span class="token class-name">ConfigurationClassPostProcessor</span>ï¼Œè¿™æ ·æˆ‘ä»¬æ³¨å…¥äº†ä¸€ä¸ªåˆ‡é¢<span class="token class-name">Bean</span>ï¼Œå°±ç¬¦åˆæ¡ä»¶äº†å˜›
	
<span class="token number">6</span>ã€<span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>æ³¨å†Œ<span class="token class-name">BeanPostProcessor</span>ï¼ˆ<span class="token class-name">Bean</span>çš„åç½®å¤„ç†å™¨ï¼‰ã€ intercept bean creationã€‘
	ä¸åŒæ¥å£ç±»å‹çš„<span class="token class-name">BeanPostProcessor</span>ï¼›åœ¨<span class="token class-name">Bean</span>åˆ›å»ºå‰åçš„æ‰§è¡Œæ—¶æœºæ˜¯ä¸ä¸€æ ·çš„
	<span class="token class-name">BeanPostProcessor</span>ï¼š<span class="token class-name">BeanPostProcessor</span>æ˜¯ä¸€ä¸ªå·¥å‚é’©å­ï¼Œå…è®¸<span class="token class-name">Spring</span>æ¡†æ¶åœ¨æ–°åˆ›å»º<span class="token class-name">Bean</span>å®ä¾‹æ—¶å¯¹å…¶è¿›è¡Œå®šåˆ¶åŒ–ä¿®æ”¹ï¼Œæ¯”å¦‚å¡«å……<span class="token class-name">Bean</span>ã€åˆ›å»ºä»£ç†ã€è§£æ<span class="token class-name">Bean</span>å†…éƒ¨çš„æ³¨è§£ç­‰ç­‰ã€‚ã€‚ã€‚
	<span class="token class-name">DestructionAwareBeanPostProcessor</span>ï¼š<span class="token class-name">Bean</span>é”€æ¯æ—¶å€™
	<span class="token class-name">InstantiationAwareBeanPostProcessor</span>ï¼š<span class="token class-name">Bean</span>åˆå§‹åŒ–çš„æ—¶å€™
	<span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span>ï¼šåˆå§‹åŒ–å¢å¼ºç‰ˆæœ¬ï¼šå¢åŠ äº†ä¸€ä¸ªå¯¹<span class="token class-name">Bean</span>ç±»å‹é¢„æµ‹çš„å›è°ƒï¼ˆä¸€èˆ¬æ˜¯<span class="token class-name">Spring</span>å†…éƒ¨ä½¿ç”¨ï¼Œè°ƒç”¨è€…è¿˜æ˜¯ä½¿ç”¨<span class="token class-name">InstantiationAwareBeanPostProcessor</span>å°±å¥½ï¼‰
	<span class="token class-name">MergedBeanDefinitionPostProcessor</span>ï¼šåˆå¹¶å¤„ç†<span class="token class-name">Bean</span>å®šä¹‰çš„æ—¶å€™çš„å›è°ƒã€è¯¥ç±»å‹çš„å¤„ç†å™¨ä¿å­˜åœ¨åä¸ºinternalPostProcessorsçš„<span class="token class-name">List</span>ä¸­ã€‘ã€
	
	<span class="token number">1</span>ï¼‰è·å–æ‰€æœ‰çš„ <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">;</span>åç½®å¤„ç†å™¨éƒ½é»˜è®¤å¯ä»¥é€šè¿‡<span class="token class-name">PriorityOrdered</span>ã€<span class="token class-name">Ordered</span>æ¥å£æ¥æ‰§è¡Œä¼˜å…ˆçº§
	<span class="token number">2</span>ï¼‰å…ˆæ³¨å†Œ<span class="token class-name">PriorityOrdered</span>ä¼˜å…ˆçº§æ¥å£çš„<span class="token class-name">BeanPostProcessor</span>ï¼›
		æŠŠæ¯ä¸€ä¸ª<span class="token class-name">BeanPostProcessor</span>ï¼›æ·»åŠ åˆ°<span class="token class-name">BeanFactory</span>ä¸­
		beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span>postProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token number">3</span>ï¼‰å†æ³¨å†Œ<span class="token class-name">Ordered</span>æ¥å£çš„ã€æœ€åæ³¨å†Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æ¥å£çš„ã€æœ€ç»ˆæ³¨å†Œ<span class="token class-name">MergedBeanDefinitionPostProcessor</span>
		<span class="token punctuation">(</span>æ­¤å¤„ç»†èŠ‚ï¼š<span class="token class-name">BeanPostProcessor</span>æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª<span class="token class-name">Bean</span>ï¼Œå…¶æ³¨å†Œä¹‹å‰ä¸€å®šå…ˆå®ä¾‹åŒ–ï¼Œè€Œä¸”æ˜¯åˆ†æ‰¹å®ä¾‹åŒ–å’Œæ³¨å†Œã€‚
			å¦å¤–è¿˜æœ‰ä¸€ä¸ªéå¸¸éå¸¸é‡è¦çš„ä¸€ç‚¹å°±æ˜¯é˜¶æ®µé¡ºåºé—®é¢˜ï¼š
		æˆ‘ä»¬å¯ä»¥æŠŠ<span class="token class-name">BeanPostProcessor</span>çš„å®ä¾‹åŒ–ä¸æ³¨å†Œåˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š
		ç¬¬ä¸€é˜¶æ®µapplicationContextå†…ç½®é˜¶æ®µã€
		ç¬¬äºŒé˜¶æ®µpriorityOrderedé˜¶æ®µã€
		ç¬¬ä¸‰é˜¶æ®µ<span class="token class-name">Ordered</span>é˜¶æ®µã€
		ç¬¬å››é˜¶æ®µnonOrderedé˜¶æ®µ
		å› ä¸ºæ˜¯åˆ†æ‰¹æ³¨å†Œï¼Œæ‰€ä»¥æˆ‘ä»¬åŒé˜¶æ®µæ˜¯ä¸èƒ½æ‹¦æˆªåˆ°åŒé˜¶æ®µçš„<span class="token class-name">BeanPostProcessor</span>çš„å®ä¾‹åŒ–çš„ã€‚ä¸¾ä¾‹å­ï¼š
		<span class="token class-name">PriorityOrdered</span>çš„åªèƒ½è¢«å†…ç½®é˜¶æ®µçš„æ¯”å¦‚ï¼š<span class="token class-name">ApplicationContextAwareProcessor</span><span class="token punctuation">(</span>å¯ä»¥æ³¨å…¥å•¦<span class="token punctuation">)</span><span class="token operator">/</span><span class="token class-name">ApplicationListenerDetector</span>ï¼ˆå¯ä»¥æ¥å—äº‹ä»¶å•¦ï¼‰è¿™ç§æ‹¦æˆª
		è€Œï¼š<span class="token class-name">Ordered</span>å°±å¯ä»¥è¢«	å†…ç½®çš„ã€<span class="token class-name">PriorityOrdered</span>éƒ½æ‹¦æˆªåˆ°äº†
		ã€‚ã€‚ã€‚ ä»¥æ­¤ç±»æ¨ã€‚ã€‚ã€‚
	
		æ‰€ä»¥æˆ‘ä»¬çš„<span class="token class-name">BeanPostProcessor</span>æ˜¯å¯ä»¥<span class="token annotation punctuation">@Autowired</span> æ¯”å¦‚<span class="token class-name">Service</span>ã€<span class="token class-name">Dao</span>æ¥åšä¸€äº›äº‹çš„ã€‚å•æ€ï¼Œä½†æ˜¯ä¸€å®šè¦ã€æ³¨æ„é¿å…<span class="token class-name">BeanPostProcessor</span>å¯åŠ¨æ—¶çš„â€œè¯¯ä¼¤â€é™·é˜±ã€‘ï¼Œä»€ä¹ˆæ„æ€ï¼Ÿå¤§æ¦‚è§£é‡Šä¸€ä¸‹å¦‚ä¸‹ï¼š
		å¯èƒ½ç”±äºä½ çš„<span class="token class-name">Processor</span>ä¾èµ–äºæŸä¸ª<span class="token annotation punctuation">@Bean</span>ï¼Œä»è€Œè®©å®ƒæå‰å®ä¾‹åŒ–äº†ï¼Œç„¶åå°±å¾ˆå¯èƒ½é”™è¿‡äº†åé¢ä¸€äº›<span class="token class-name">BeanPostProcessor</span>çš„å¤„ç†ï¼Œé€ æˆâ€œè¯¯ä¼¤â€
		ï¼ˆ<span class="token class-name">SpringBoot</span>ä¸­ä½¿ç”¨<span class="token class-name">Shiro</span>ã€<span class="token class-name">Spring</span><span class="token operator">-</span><span class="token class-name">Cache</span>çš„æ—¶å€™ï¼Œä½¿ç”¨ä¸å½“ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼‰
	
	<span class="token number">6</span>ï¼‰è¿™ä¸€æ­¥éå¸¸æœ‰æ„æ€ï¼šmoving it <span class="token keyword">to</span> <span class="token namespace">the</span> end of the processor chainã€‚å®ƒçš„åˆæ³¨å†Œäº†ä¸€æ¬¡ï¼Œä½œç”¨æ˜¯æŠŠè¿™ä¸ªæ¢æµ‹å™¨ç§»åŠ¨åˆ°å¤„ç†å™¨çš„åº•éƒ¨ï¼Œæœ€åä¸€ä¸ªï¼ˆæ˜¾ç„¶ï¼Œæœ€åä¸€ä¸ªæ˜¯ä¸ºäº†ä¸è¦æ”¾è¿‡ä»»ä½•<span class="token class-name">Bean</span>ï¼‰
	ï¼ˆå°ç»†èŠ‚ï¼šå¯èƒ½æœ‰å°ä¼™ä¼´ç–‘é—®ï¼Œè¿™é‡Œä¹Ÿæ˜¯<span class="token keyword">new</span>å‡ºæ¥ï¼Œè¿™è¿™æ ·å®¹å™¨å†…ä¸å°±æœ‰ä¸¤ä¸ªæ¢æµ‹å™¨å¯¹è±¡äº†å—ï¼Ÿæ°”å…¶å®ä¸ç„¶ï¼Œ<span class="token class-name">ApplicationListenerDetector</span>å®ƒé‡å†™äº†hashCodeæ–¹æ³•ï¼Œä¸”åªå’Œåº”ç”¨applicationContextæœ‰å…³ï¼‰
	<span class="token keyword">return</span> <span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">nullSafeHashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>æ‰€ä»¥å¯¹å®ƒæ‰§è¡Œremoveçš„æ—¶å€™ï¼Œä¼šè¢«å½“ä½œåŒä¸€ä¸ªå¯¹è±¡å¤„ç†ï¼Œèƒ½æŠŠè€çš„ç§»é™¤æˆåŠŸæ·»åŠ æ–°çš„çš„

<span class="token number">7</span>ã€<span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>åˆå§‹åŒ–<span class="token class-name">MessageSource</span>ç»„ä»¶ï¼ˆåšå›½é™…åŒ–åŠŸèƒ½ï¼›æ¶ˆæ¯ç»‘å®šï¼Œæ¶ˆæ¯è§£æï¼‰
	<span class="token number">1</span>ï¼‰çœ‹å®¹å™¨ä¸­æ˜¯å¦æœ‰idä¸ºmessageSourceçš„ï¼Œç±»å‹æ˜¯<span class="token class-name">MessageSource</span>çš„ç»„ä»¶
		å¦‚æœæœ‰èµ‹å€¼ç»™messageSourceï¼Œå¦‚æœæ²¡æœ‰è‡ªå·±åˆ›å»ºä¸€ä¸ª<span class="token class-name">DelegatingMessageSource</span>ï¼›
		<span class="token class-name">MessageSource</span>ï¼šå–å‡ºå›½é™…åŒ–é…ç½®æ–‡ä»¶ä¸­çš„æŸä¸ªkeyçš„å€¼ï¼›èƒ½æŒ‰ç…§åŒºåŸŸä¿¡æ¯è·å–ï¼›
	<span class="token number">2</span>ï¼‰æŠŠåˆ›å»ºå¥½çš„<span class="token class-name">MessageSource</span>æ³¨å†Œåœ¨å®¹å™¨ä¸­ï¼Œä»¥åè·å–å›½é™…åŒ–é…ç½®æ–‡ä»¶çš„å€¼çš„æ—¶å€™ï¼Œå¯ä»¥è‡ªåŠ¨æ³¨å…¥<span class="token class-name">MessageSource</span>
	beanFactory<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">MESSAGE_SOURCE_BEAN_NAME</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageSource<span class="token punctuation">)</span>
	
<span class="token number">8</span>ã€<span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>åˆå§‹åŒ–äº‹ä»¶æ´¾å‘å™¨ï¼›
	<span class="token number">1</span>ï¼‰ä»<span class="token class-name">BeanFactory</span>ä¸­è·å–applicationEventMulticasterçš„<span class="token class-name">ApplicationEventMulticaster</span>ï¼›
	<span class="token number">2</span>ï¼‰å¦‚æœä¸Šä¸€æ­¥æ²¡æœ‰é…ç½®ï¼›åˆ›å»ºä¸€ä¸ª<span class="token class-name">SimpleApplicationEventMulticaster</span><span class="token punctuation">,</span>å°†åˆ›å»ºçš„<span class="token class-name">ApplicationEventMulticaster</span>æ·»åŠ åˆ°<span class="token class-name">BeanFactory</span>ä¸­
	
<span class="token number">9</span>ã€<span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ç•™ç»™å­å®¹å™¨ï¼ˆå­ç±»ï¼‰ å®¹å™¨åˆ·æ–°çš„æ—¶å€™åšäº›äº‹
	<span class="token class-name">AbstractRefreshableWebApplicationContext</span>ï¼š<span class="token keyword">this</span><span class="token punctuation">.</span>themeSource <span class="token operator">=</span> <span class="token class-name">UiApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">initThemeSource</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
<span class="token number">10</span>ã€<span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>æŠŠå®¹å™¨ä¸­å°†æ‰€æœ‰é¡¹ç›®é‡Œé¢çš„<span class="token class-name">ApplicationListener</span>æ³¨å†Œè¿›æ¥ï¼›
	<span class="token number">1</span>ã€æ‹¿åˆ°å®¹å™¨é‡Œæ‰€æœ‰çš„<span class="token class-name">Bean</span>å®šä¹‰çš„åå­—ï¼Œç±»å‹ä¸º<span class="token class-name">ApplicationListener</span>ï¼Œç„¶åæ·»åŠ è¿›æ¥
		<span class="token function">getApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addApplicationListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token number">2</span>ã€æ´¾å‘ä¹‹å‰æ­¥éª¤äº§ç”Ÿçš„äº‹ä»¶ï¼ˆæ—©æœŸäº‹ä»¶ï¼‰
	ï¼ˆç»†èŠ‚ï¼šæ­¤å¤„åªæ˜¯æŠŠ<span class="token class-name">Bean</span>çš„åå­—æ”¾è¿›å»ï¼Œ<span class="token class-name">Bean</span>è¿˜æ²¡æœ‰å®ä¾‹åŒ–å“¦<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span>ï¼‰

<span class="token number">11</span>ã€<span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>åˆå§‹åŒ–æ‰€æœ‰å‰©ä¸‹çš„å•å®ä¾‹beanï¼›è¿™åº”è¯¥æ˜¯æœ€æ ¸å¿ƒçš„ä¸€æ­¥äº†
	<span class="token number">1</span><span class="token punctuation">)</span> ä¸ºå®¹å™¨åˆå§‹åŒ–<span class="token class-name">ConversionService</span><span class="token punctuation">(</span>å®¹å™¨è‹¥æ²¡æœ‰å°±ä¸ç”¨åˆå§‹åŒ–äº†<span class="token punctuation">,</span>ä¾ç„¶é‡‡ç”¨<span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span>åˆå§‹åŒ–çš„<span class="token punctuation">)</span> æä¾›è½¬æ¢æœåŠ¡
	<span class="token number">2</span><span class="token punctuation">)</span> è‹¥æ²¡æœ‰è®¾ç½®å€¼è§£æå™¨ï¼Œé‚£å°±æ³¨å†Œä¸€ä¸ªé»˜è®¤çš„å€¼è§£æå™¨ï¼ˆlambdaè¡¨ç¤ºçš„åŒ¿åå¤„ç†ï¼‰
	<span class="token number">3</span><span class="token punctuation">)</span> å®ä¾‹åŒ–<span class="token class-name">LoadTimeWeaverAware</span><span class="token punctuation">(</span>è‹¥å­˜åœ¨<span class="token punctuation">)</span>
	<span class="token number">4</span><span class="token punctuation">)</span> æ¸…ç©ºä¸´æ—¶ç±»åŠ è½½å™¨ï¼šbeanFactory<span class="token punctuation">.</span><span class="token function">setTempClassLoader</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token number">5</span><span class="token punctuation">)</span> ç¼“å­˜ï¼ˆå¿«ç…§ï¼‰ä¸‹å½“å‰æ‰€æœ‰çš„<span class="token class-name">Bean</span>å®šä¹‰ä¿¡æ¯ beanFactory<span class="token punctuation">.</span><span class="token function">freezeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">--</span><span class="token operator">--</span> æ›´ç²¾ç¡®çš„æ˜¯è¯´æ˜¯æ ¹æ®<span class="token class-name">Bean</span>çš„å®šä¹‰ä¿¡æ¯ï¼šbeanDefinitionNamesæ¥å®ä¾‹åŒ–ã€åˆå§‹åŒ–å‰©ä½™çš„<span class="token class-name">Bean</span> <span class="token operator">--</span><span class="token operator">--</span>
	<span class="token number">6</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">.</span><span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>åˆå§‹åŒ–åå‰©ä¸‹çš„å•å®ä¾‹<span class="token function">bean</span><span class="token punctuation">(</span>è¿‡ç¨‹è¿™é‡Œå°±ä¸è¯¦è¯´äº†<span class="token punctuation">)</span>
	
<span class="token number">12</span>ã€<span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>å®Œæˆ<span class="token class-name">BeanFactory</span>çš„åˆå§‹åŒ–åˆ›å»ºå·¥ä½œï¼›<span class="token constant">IOC</span>å®¹å™¨å°±åˆ›å»ºå®Œæˆ
	<span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">clearResourceCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token class-name">Spring5</span><span class="token number">.0</span>æ‰æœ‰<span class="token punctuation">)</span>
	<span class="token number">1</span>ï¼‰<span class="token function">initLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>åˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„åç½®å¤„ç†å™¨ï¼›ä»å®¹å™¨ä¸­æ‰¾æ˜¯å¦æœ‰lifecycleProcessorçš„ç»„ä»¶ã€<span class="token class-name">LifecycleProcessor</span>ã€‘ï¼›å¦‚æœæ²¡æœ‰<span class="token keyword">new</span> <span class="token class-name">DefaultLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	å…³äº<span class="token class-name">Lifecycle</span>æ¥å£çš„ä½¿ç”¨ï¼Œä¹Ÿä¸“é—¨è®²è§£è¿‡ï¼Œè¿™é‡Œä¸èŠäº†
	<span class="token number">2</span>ï¼‰<span class="token function">getLifecycleProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  ç›¸å½“äºä¸Šé¢åˆšæ³¨å†Œï¼Œä¸‹é¢å°±è°ƒç”¨äº†
	<span class="token number">3</span>ï¼‰<span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ContextRefreshedEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>å‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶ï¼›
	<span class="token number">4</span>ï¼‰liveBeansView<span class="token punctuation">.</span><span class="token function">registerApplicationContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> å’Œ<span class="token class-name">MBean</span>ç›¸å…³ï¼Œç•¥
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ ----------æ€»ç»“-----------</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token number">1</span>ï¼‰<span class="token class-name">Spring</span>å®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå…ˆä¼šä¿å­˜æ‰€æœ‰æ³¨å†Œè¿›æ¥çš„<span class="token class-name">Bean</span>çš„å®šä¹‰ä¿¡æ¯ï¼ˆå¯ä»¥æœ‰<span class="token class-name">N</span>ç§æ–¹å¼ï¼‰ï¼›
		<span class="token number">1</span>ï¼‰xmlæ³¨å†Œbeanï¼›<span class="token generics"><span class="token punctuation">&lt;</span>bean<span class="token punctuation">&gt;</span></span>
		<span class="token number">2</span>ï¼‰æ³¨è§£æ³¨å†Œ<span class="token class-name">Bean</span>ï¼›<span class="token annotation punctuation">@Service</span>ã€<span class="token annotation punctuation">@Component</span>ã€<span class="token annotation punctuation">@Bean</span>ã€xxx
	<span class="token number">2</span>ï¼‰<span class="token class-name">Spring</span>å®¹å™¨ä¼šåˆé€‚çš„æ—¶æœºåˆ›å»ºè¿™äº›<span class="token class-name">Bean</span>
		<span class="token number">1</span>ï¼‰ç”¨åˆ°è¿™ä¸ªbeançš„æ—¶å€™ï¼›åˆ©ç”¨getBeanåˆ›å»ºbeanï¼›åˆ›å»ºå¥½ä»¥åä¿å­˜åœ¨å®¹å™¨ä¸­ï¼›
		<span class="token number">2</span>ï¼‰ç»Ÿä¸€åˆ›å»ºå‰©ä¸‹æ‰€æœ‰çš„beançš„æ—¶å€™ï¼›<span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼›
	<span class="token number">3</span>ï¼‰åç½®å¤„ç†å™¨ï¼›<span class="token class-name">BeanPostProcessor</span>
		<span class="token number">1</span>ï¼‰æ¯ä¸€ä¸ªbeanåˆ›å»ºå®Œæˆï¼Œéƒ½ä¼šä½¿ç”¨å„ç§åç½®å¤„ç†å™¨è¿›è¡Œå¤„ç†ï¼›æ¥å¢å¼ºbeançš„åŠŸèƒ½ï¼›
			<span class="token class-name">AutowiredAnnotationBeanPostProcessor</span><span class="token operator">:</span>å¤„ç†è‡ªåŠ¨æ³¨å…¥
			<span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span><span class="token operator">:</span>æ¥åš<span class="token constant">AOP</span>åŠŸèƒ½ï¼›
			xxx<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
			å¢å¼ºçš„åŠŸèƒ½æ³¨è§£ï¼š
			<span class="token class-name">AsyncAnnotationBeanPostProcessor</span>
			<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token number">4</span>ï¼‰äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼›
		<span class="token class-name">ApplicationListener</span>ï¼›äº‹ä»¶ç›‘å¬ï¼›
		<span class="token class-name">ApplicationEventMulticaster</span>ï¼›äº‹ä»¶æ´¾å‘ï¼š
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="å¸¸è§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é—®é¢˜" aria-hidden="true">#</a> å¸¸è§é—®é¢˜</h3><h4 id="beançš„ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#beançš„ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> beançš„ç”Ÿå‘½å‘¨æœŸ</h4><ol><li><p>å®ä¾‹åŒ–ï¼šä¸º Bean åˆ†é…å†…å­˜ç©ºé—´ã€‚</p></li><li><p>è®¾ç½®å±æ€§ï¼šå°†å½“å‰ç±»ä¾èµ–çš„ Bean å±æ€§ï¼Œè¿›è¡Œæ³¨å…¥å’Œè£…é…ã€‚</p></li><li><p>åˆå§‹åŒ–ï¼š</p><ul><li><p>æ‰§è¡Œå„ç§é€šçŸ¥ã€æ‰§è¡ŒAwareæ¥å£çš„å®ç°æ–¹æ³•ã€‚</p></li><li><p>æ‰§è¡Œ<code>@PostConstruct</code></p></li><li><p>æ‰§è¡Œ<code>InitializingBean#afterPropertiesSet</code></p></li><li><p>æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ï¼Œè‡ªå®šä¹‰çš„initMethod</p></li><li><p>æ‰§è¡Œ<code>BeanPostProcessor#postProcessAfterInitialization</code></p></li></ul></li><li><p>ä½¿ç”¨ Beanï¼šåœ¨ç¨‹åºä¸­ä½¿ç”¨ Bean å¯¹è±¡ã€‚</p></li><li><p>é”€æ¯ Beanï¼šå°† Bean å¯¹è±¡è¿›è¡Œé”€æ¯æ“ä½œã€‚</p><ul><li>æ‰§è¡Œ<code>@PreDestory</code></li><li>æ‰§è¡Œ<code>DisposableBean#destroy</code></li><li>æ‰§è¡Œè‡ªå®šä¹‰çš„<code>destroyMethod</code></li></ul></li></ol><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230916235025199.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/image-20230805214944673.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="æ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#æ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–" aria-hidden="true">#</a> æ€ä¹ˆè§£å†³å¾ªç¯ä¾èµ–</h4><p>å¯¹äºSpringå¾ªç¯ä¾èµ–çš„æƒ…å†µæ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li>ä¸èƒ½è§£å†³çš„æƒ…å†µï¼š <ul><li>æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–</li><li><code>prototype</code> fieldå±æ€§æ³¨å…¥å¾ªç¯ä¾èµ–</li></ul></li><li>èƒ½è§£å†³çš„æƒ…å†µï¼š <ul><li>fieldå±æ€§æ³¨å…¥ï¼ˆsetteræ–¹æ³•æ³¨å…¥ï¼‰å¾ªç¯ä¾èµ–</li></ul></li></ol><h5 id="åŸç†åˆ†æ" tabindex="-1"><a class="header-anchor" href="#åŸç†åˆ†æ" aria-hidden="true">#</a> åŸç†åˆ†æ</h5><p>åˆ›å»ºbeançš„æµç¨‹ï¼š</p><figure><img src="https://raw.githubusercontent.com/nocetfy/image/main/img/oepgq3cnb0.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯¹Beançš„åˆ›å»ºæœ€ä¸ºæ ¸å¿ƒä¸‰ä¸ªæ–¹æ³•è§£é‡Šå¦‚ä¸‹ï¼š</p><ul><li><code>createBeanInstance</code>ï¼šä¾‹åŒ–ï¼Œå…¶å®ä¹Ÿå°±æ˜¯è°ƒç”¨å¯¹è±¡çš„<strong>æ„é€ æ–¹æ³•</strong>å®ä¾‹åŒ–å¯¹è±¡</li><li><code>populateBean</code>ï¼šå¡«å……å±æ€§ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯å¯¹beançš„ä¾èµ–å±æ€§è¿›è¡Œæ³¨å…¥(<code>@Autowired</code>)</li><li><code>initializeBean</code>ï¼šå›åˆ°ä¸€äº›å½¢å¦‚<code>initMethod</code>ã€<code>InitializingBean</code>ç­‰æ–¹æ³•</li></ul><p>ä»å¯¹<code>å•ä¾‹Bean</code>çš„åˆå§‹åŒ–å¯ä»¥çœ‹å‡ºï¼Œå¾ªç¯ä¾èµ–ä¸»è¦å‘ç”Ÿåœ¨<strong>ç¬¬äºŒæ­¥ï¼ˆpopulateBeanï¼‰</strong>ï¼Œä¹Ÿå°±æ˜¯fieldå±æ€§æ³¨å…¥çš„å¤„ç†ã€‚</p><h5 id="springå®¹å™¨çš„ä¸‰çº§ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#springå®¹å™¨çš„ä¸‰çº§ç¼“å­˜" aria-hidden="true">#</a> Springå®¹å™¨çš„ä¸‰çº§ç¼“å­˜</h5><p>â€‹ åœ¨Springå®¹å™¨çš„æ•´ä¸ªå£°æ˜å‘¨æœŸä¸­ï¼Œå•ä¾‹Beanæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹è±¡ã€‚è¿™å¾ˆå®¹æ˜“è®©äººæƒ³åˆ°å¯ä»¥ç”¨ç¼“å­˜æ¥åŠ é€Ÿè®¿é—®ã€‚ ä»æºç ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºSpringå¤§é‡è¿ç”¨äº†Cacheçš„æ‰‹æ®µï¼Œåœ¨å¾ªç¯ä¾èµ–é—®é¢˜çš„è§£å†³è¿‡ç¨‹ä¸­ç”šè‡³ä¸æƒœä½¿ç”¨äº†â€œä¸‰çº§ç¼“å­˜â€ï¼Œè¿™ä¹Ÿä¾¿æ˜¯å®ƒè®¾è®¡çš„ç²¾å¦™ä¹‹å¤„~</p><p><code>ä¸‰çº§ç¼“å­˜</code>å…¶å®å®ƒæ›´åƒæ˜¯Springå®¹å™¨å·¥å‚çš„å†…çš„<code>æœ¯è¯­</code>ï¼Œé‡‡ç”¨ä¸‰çº§ç¼“å­˜æ¨¡å¼æ¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œè¿™ä¸‰çº§ç¼“å­˜åˆ†åˆ«æŒ‡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSingletonBeanRegistry</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleAliasRegistry</span> <span class="token keyword">implements</span> <span class="token class-name">SingletonBeanRegistry</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">// ä»ä¸Šè‡³ä¸‹ åˆ†è¡¨ä»£è¡¨è¿™â€œä¸‰çº§ç¼“å­˜â€</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> singletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ä¸€çº§ç¼“å­˜</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> earlySingletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// äºŒçº§ç¼“å­˜</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> singletonFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸‰çº§ç¼“å­˜</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	
	<span class="token doc-comment comment">/** Names of beans that are currently in creation. */</span>
	<span class="token comment">// è¿™ä¸ªç¼“å­˜ä¹Ÿååˆ†é‡è¦ï¼šå®ƒè¡¨ç¤ºbeanåˆ›å»ºè¿‡ç¨‹ä¸­éƒ½ä¼šåœ¨é‡Œé¢å‘†ç€~</span>
	<span class="token comment">// å®ƒåœ¨Beanå¼€å§‹åˆ›å»ºæ—¶æ”¾å€¼ï¼Œåˆ›å»ºå®Œæˆæ—¶ä¼šå°†å…¶ç§»å‡º~</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> singletonsCurrentlyInCreation <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token doc-comment comment">/** Names of beans that have already been created at least once. */</span>
	<span class="token comment">// å½“è¿™ä¸ªBeanè¢«åˆ›å»ºå®Œæˆåï¼Œä¼šæ ‡è®°ä¸ºè¿™ä¸ª æ³¨æ„ï¼šè¿™é‡Œæ˜¯seté›†åˆ ä¸ä¼šé‡å¤</span>
	<span class="token comment">// è‡³å°‘è¢«åˆ›å»ºäº†ä¸€æ¬¡çš„  éƒ½ä¼šæ”¾è¿›è¿™é‡Œ~~~~</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> alreadyCreated <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">newSetFromMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨ï¼š<code>AbstractBeanFactory</code>ç»§æ‰¿è‡ª<code>DefaultSingletonBeanRegistry</code>~</p><ol><li><code>singletonObjects</code>ï¼šç”¨äºå­˜æ”¾å®Œå…¨åˆå§‹åŒ–å¥½çš„ beanï¼Œ<strong>ä»è¯¥ç¼“å­˜ä¸­å–å‡ºçš„ bean å¯ä»¥ç›´æ¥ä½¿ç”¨</strong></li><li><code>earlySingletonObjects</code>ï¼šæå‰æ›å…‰çš„å•ä¾‹å¯¹è±¡çš„cacheï¼Œå­˜æ”¾åŸå§‹çš„ bean å¯¹è±¡ï¼ˆå°šæœªå¡«å……å±æ€§ï¼‰ï¼Œç”¨äºè§£å†³å¾ªç¯ä¾èµ–</li><li><code>singletonFactories</code>ï¼šå•ä¾‹å¯¹è±¡å·¥å‚çš„cacheï¼Œå­˜æ”¾ bean å·¥å‚å¯¹è±¡ï¼Œç”¨äºè§£å†³å¾ªç¯ä¾èµ–</li></ol><p>è·å–å•ä¾‹beançš„æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSingletonBeanRegistry</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleAliasRegistry</span> <span class="token keyword">implements</span> <span class="token class-name">SingletonBeanRegistry</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isActuallyInCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>å…ˆä»<code>ä¸€çº§ç¼“å­˜singletonObjects</code>ä¸­å»è·å–ã€‚ï¼ˆå¦‚æœè·å–åˆ°å°±ç›´æ¥returnï¼‰</li><li>å¦‚æœè·å–ä¸åˆ°æˆ–è€…å¯¹è±¡æ­£åœ¨åˆ›å»ºä¸­ï¼ˆ<code>isSingletonCurrentlyInCreation()</code>ï¼‰ï¼Œé‚£å°±å†ä»<code>äºŒçº§ç¼“å­˜earlySingletonObjects</code>ä¸­è·å–ã€‚ï¼ˆå¦‚æœè·å–åˆ°å°±ç›´æ¥returnï¼‰</li><li>å¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°ï¼Œä¸”å…è®¸singletonFactoriesï¼ˆallowEarlyReference=trueï¼‰é€šè¿‡<code>getObject()</code>è·å–ã€‚å°±ä»<code>ä¸‰çº§ç¼“å­˜singletonFactory</code>.getObject()è·å–ã€‚<strong>ï¼ˆå¦‚æœè·å–åˆ°äº†å°±ä»<code>singletonFactories</code>ä¸­ç§»é™¤ï¼Œå¹¶ä¸”æ”¾è¿›<code>earlySingletonObjects</code>ã€‚å…¶å®ä¹Ÿå°±æ˜¯ä»ä¸‰çº§ç¼“å­˜<code>ç§»åŠ¨ï¼ˆæ˜¯å‰ªåˆ‡ã€ä¸æ˜¯å¤åˆ¶å“¦~ï¼‰</code>åˆ°äº†äºŒçº§ç¼“å­˜ï¼‰</strong></li></ol><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹è§£å†³å¾ªç¯ä¾èµ–çš„é‡ç‚¹ä»£ç ï¼š</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹doGetBean()ä¸­çš„getSingletion()æ–¹æ³•, å› ä¸ºåœ¨åˆ›å»ºBeanå¯¹è±¡ä¹‹å‰ï¼Œéƒ½ä¼šå°è¯•ä»ç¼“å­˜ä¸­å…ˆè·å–ä¸€ä¸‹è¯¥Beanå¯¹è±¡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractBeanFactory.java</span>
<span class="token keyword">protected</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span>
                          <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>

  <span class="token keyword">final</span> <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Object</span> bean<span class="token punctuation">;</span>
  <span class="token comment">// 1. å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œè¿™é‡Œå…è®¸ä»ç¬¬ä¸‰çº§ç¼“å†²è·å–</span>
  <span class="token class-name">Object</span> sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// åœ¨è¯¥å¸¦å›è°ƒå‡½æ•°çš„getSingleton()ä¸­çš„beforeSingletonCreation()æ–¹æ³•ä¸­ï¼Œä¼šå°†è¯¥beanNameæ·»åŠ åˆ°singletonsCurrentlyInCreationé›†åˆä¸­ï¼Œè¯¥é›†åˆä¼šåœ¨ä»ä¸‰çº§ç¼“å­˜è·å–</span>
      <span class="token comment">// Beanå¯¹è±¡æ—¶ç”¨æ¥åˆ¤æ–­å½“å‰Beanæ˜¯å¦æ­£åœ¨åˆ›å»ºä¸­</span>
      sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 2. å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰è·å–åˆ°ï¼Œåˆ™èµ°åˆ›å»ºBeançš„é€»è¾‘</span>
          <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†beanNameæ·»åŠ åˆ°æ ‡è¯†Beanæ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultSingletonBeanRegistry.java</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// addæ·»åŠ </span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>inCreationCheckExclusions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…ˆä»ä¸‰çº§ç¼“å­˜ä¸­è·å–ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// DefaultSingletonBeanRegistry.java</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. ä»ä¸€çº§ç¼“å­˜ä¸­è·å–</span>
  <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¦‚æœä¸€çº§ç¼“å­˜ä¸­æ²¡æœ‰å¹¶ä¸”è¯¥Beanæ­£åœ¨åˆ›å»ºä¸­</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 2. ä»äºŒçº§ç¼“å­˜ä¸­è·å–</span>
      singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å¦‚æœäºŒçº§ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå¹¶ä¸”å…è®¸å¾ªç¯ä¾èµ–</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3. ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–</span>
        <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¦‚æœä¸‰çº§ç¼“å­˜ä¸ä¸ºç©ºï¼Œé€šè¿‡ä¸‰çº§ç¼“å­˜è·å–ä¸å®Œæ•´çš„Beanå¯¹è±¡(è¿™é‡Œå…¶å®ä¼šè°ƒç”¨SmartInstantiationAwareBeanPostProcessorä¸­çš„getEarlyBeanReference()æ–¹æ³•)</span>
          singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// å°†é€šè¿‡ä¸‰çº§ç¼“å­˜è·å–åˆ°çš„ä¸å®Œæ•´çš„Beanå¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ä¸­</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// æ¸…é™¤è¯¥Beanåœ¨ä¸‰çº§ç¼“å­˜ä¸­çš„å·¥å‚æ–¹æ³•</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœé€šè¿‡ä¸‰çº§ç¼“å­˜æ²¡æœ‰è·å–åˆ°Beanå¯¹è±¡ï¼Œè¯´æ˜éœ€è¦åˆ›å»ºBeanï¼Œæ­¤æ—¶ä¼šèµ°creatBean()å»åˆ›å»ºBeanï¼Œå®é™…æ‰§è¡Œçš„æ˜¯doCreateBean()ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractAutowireCapableBeanFactory.java</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
  <span class="token keyword">throws</span> <span class="token class-name">BeanCreationException</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// å¦‚æœå…è®¸å¾ªç¯ä¾èµ–ï¼Œå¹¶ä¸”å½“å‰beanæ­£åœ¨åˆ›å»ºä¸­ï¼Œé‚£ä¹ˆå…ˆæ”¾å…¥singletonFactories,singletonFactorieså±äºæ˜¯ä¸€ä¸ªç¼“å­˜ï¼Œspringè·å–bean</span>
  <span class="token comment">// beanå®ä¾‹çš„æ—¶å€™ï¼Œä¼šå…ˆä»singletonObjectsè·å–ï¼Œè·å–ä¸åˆ°å†ä»earlySingletonObjectsè·å–ï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œå°±ä¼šä»singletonFactories</span>
  <span class="token comment">// è¿›è¡Œè·å–ï¼Œå› ä¸ºæå‰æš´éœ²çš„å¯¹è±¡æˆ‘ä»¬å·²ç»addåˆ°singletonFactoriesä¸­äº†ï¼Œé‚£ä¹ˆä»singletonFactoriesè·å–å¯¹è±¡æ—¶å°±ä¼šè°ƒç”¨</span>
  <span class="token comment">// () -&gt; getEarlyBeanReference(beanName, mbd, bean),ä»è€Œå°±å¯ä»¥æå‰è·å–åˆ°ä»£ç†å¯¹è±¡äº†ã€‚</span>
  <span class="token comment">// è™½ç„¶é€šè¿‡ä¸‰çº§ç¼“å­˜æå‰è·å–åˆ°Beanå¯¹è±¡äº†ï¼Œä½†æ˜¯æ­¤æ—¶è¿˜ä¸å®Œæ•´ï¼Œæ‰€ä»¥è¯¥Beanåç»­è¿˜ä¼šç»§ç»­èµ°åé¢çš„ä¾èµ–æ³¨å…¥åˆå§‹åŒ–é€»è¾‘ã€‚</span>
  <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span>
                                    <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ç¬¬ä¸€æ¬¡åˆ¤æ–­ï¼šå¦‚æœå…è®¸æå‰æš´éœ²ï¼Œåˆ™å°†beanæ”¾å…¥singletonFacotriesä¸­, åœ¨å¾ªç¯ä¾èµ–çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡getEarlyBeanReferenceæå‰è‡ªåŠ¨ä»£ç†ï¼Œç„¶ååœ¨å…¶ä»–beanä¸­æ³¨å…¥æå‰ä»£ç†çš„å¯¹è±¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Eagerly caching bean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span>
                   <span class="token string">&quot;&#39; to allow for resolving potential circular references&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œé‡Œé¢å°è£…äº†èƒ½å¤Ÿæ­£ç¡®æ³¨å…¥ä»£ç†çš„é€»è¾‘</span>
    <span class="token comment">// é‡ç‚¹å°±æ˜¯getEarlyBeanReference(beanName, mbd, bean)æ–¹æ³•</span>
    <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œä¼šæ‰§è¡ŒAutowiredAnnotationBeanPostProcessorçš„postProcessPropertiesï¼Œä»è€Œè¿›è¡Œäº†@Autowirdå±æ€§çš„æ³¨å…¥, æ³¨å…¥å°±å¯èƒ½ä¼šå‡ºç°å¾ªç¯ä¾èµ–</span>
    <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ç¬¬äºŒæ¬¡åˆ¤æ–­ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢æå‰æš´éœ²çš„beanå’Œæœ€ç»ˆå®é™…çš„beanä¸ä¸€è‡´ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰è‡ªå®šä¹‰æˆ–è€…å¼•å…¥ä¼šåˆ›å»ºä»£ç†å¯¹è±¡çš„BeanPostProcessorçš„è¯ï¼Œæ˜¯ä¸ä¼šæœ‰é—®é¢˜çš„ï¼Œå› ä¸ºåœ¨springçš„</span>
  <span class="token comment">// AbstractAutoProxyCreatorä¸­ï¼Œå¦‚æœå·²ç»é€šè¿‡getEarlyBeanReferenceæå‰åˆ›å»ºè¿‡ä»£ç†å¯¹è±¡äº†ï¼Œé‚£ä¹ˆåœ¨postProcessAfterInitializationä¸­ä¼šç›´æ¥è·³è¿‡ä»£ç†å¯¹è±¡çš„åˆ›å»º, ç„¶åå°†</span>
  <span class="token comment">// åŸbeanå¯¹è±¡è¿”å›ï¼Œæ‰€ä»¥ä¸‹é¢çš„exposedObject == beanæ˜¯true, åˆå› ä¸ºåœ¨postProcessAfterInitializationè·³è¿‡äº†è‡ªåŠ¨ä»£ç†ç±»çš„åˆ›å»ºï¼Œä½†æ˜¯åœ¨getEarlyBeanReferenceä¸­ä»£ç†äº†ï¼Œ</span>
  <span class="token comment">// æ‰€ä»¥è¦å°†earlySingletonReferenceèµ‹ç»™exposedObjectï¼Œä¿è¯è¿”å›çš„beanå’Œæå‰ä»£ç†å¹¶æ³¨å…¥çš„beanæ˜¯ä¸€è‡´çš„ã€‚</span>
  <span class="token comment">// æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¦‚æœæƒ³è‡ªå®šä¹‰BeanPostProcessorå¹¶è¦ä»£ç†beanå¯¹è±¡çš„è¯ï¼Œéœ€è¦æŒ‰ç…§AbstractAutoProxyCreatorå¤„ç†å¾ªç¯ä¾èµ–çš„æ¨¡å¼å»å®ç°ï¼Œæ—¢è¦å®ç°getEarlyBeanReferenceï¼Œè¿˜è¦</span>
  <span class="token comment">// å®ç°postProcessAfterInitializationï¼Œå¦‚æœè°ƒç”¨è¿‡äº†getEarlyBeanReferenceï¼Œæå‰æš´éœ²äº†beanå¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨postProcessAfterInitializationä¸­è¦è·³è¿‡</span>
  <span class="token comment">// getEarlyBeanReferenceä¸­çš„å®ç°é€»è¾‘ï¼Œè€Œä¸”ä¸è¦æ”¹å˜beanå¯¹è±¡ã€‚</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–è·å–æå‰æš´éœ²çš„Beanï¼Œè¿™é‡Œä¸å…è®¸ä»ç¬¬ä¸‰çº§ç¼“å­˜ä¸­è·å–</span>
    <span class="token class-name">Object</span> earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœæå‰æš´éœ²å¯¹è±¡ä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æå‰æš´éœ²Beanå¯¹è±¡ï¼Œä¹Ÿå°±æ²¡æœ‰å‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œå¦‚æœä¸ä¸ºnullï¼Œè¯´æ˜å‘ç”Ÿå¾ªç¯ä¾èµ–äº†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœexposedObjectä¸beanç›¸ç­‰ï¼Œè¯´æ˜ç»è¿‡äº†Beançš„æ•´ä¸ªåˆ›å»ºå‘¨æœŸåï¼ŒBeanå¯¹è±¡æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶å°†æå‰æš´éœ²çš„Beanèµ‹å€¼ç»™æœ€ç»ˆBeanã€‚</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜åœ¨æå‰æš´éœ²Beanä¹‹åï¼Œåœ¨åç»­é€»è¾‘ä¸­æœ€ç»ˆBeanåˆè¢«ä¿®æ”¹äº†</span>
      <span class="token comment">// å¦‚æœä¸å…è®¸åœ¨å‡ºç°å¾ªç¯ä¾èµ–ï¼Œæœ€ç»ˆæ˜¯ä»£ç†å¯¹è±¡çš„æƒ…å†µä¸‹æ³¨å…¥åŸå§‹Beanå¹¶ä¸”ä¾èµ–è¯¥Beançš„Beanå·²ç»è¢«åˆ›å»ºäº†ï¼Œåˆ™æŠ¥é”™</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¿™é‡Œå°±æ˜¯æŠ¥é”™çš„åœ°æ–¹ï¼Œå› ä¸ºæ£€æµ‹å‡ºæ¥äº†ä¾èµ–çš„beanå’Œå®é™…çš„beanä¸ä¸€è‡´</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>
                                                     <span class="token string">&quot;Bean with name &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; has been injected into other beans [&quot;</span> <span class="token operator">+</span>
                                                     <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span>
                                                     <span class="token string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> <span class="token operator">+</span>
                                                     <span class="token string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> <span class="token operator">+</span>
                                                     <span class="token string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> <span class="token operator">+</span>
                                                     <span class="token string">&quot;&#39;getBeanNamesOfType&#39; with the &#39;allowEagerInit&#39; flag turned off, for example.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸‰çº§ç¼“å­˜å®é™…ä¸Šè°ƒç”¨çš„æ˜¯è¿™é‡Œã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractAutowireCapableBeanFactory.java</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">RootBeanDefinition</span> mbd<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Object</span> exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasInstantiationAwareBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanPostProcessor</span> bp <span class="token operator">:</span> <span class="token function">getBeanPostProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä»è¿™é‡Œå°±å¯ä»¥å‘ç°ï¼Œå¯¹äºæå‰æš´éœ²çš„beanå¼•ç”¨ï¼Œè¿™é‡Œä¼šè°ƒç”¨SmartInstantiationAwareBeanPostProcessorçš„</span>
      <span class="token comment">//getEarlyBeanReferenceçš„æ–¹æ³•ï¼Œå¹¶å°†è¯¥æ–¹æ³•è¿”å›çš„å¯¹è±¡ä½œä¸ºå®é™…æš´éœ²çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ä¸éš¾ç†è§£ä¸ºä»€ä¹ˆæˆ‘ä»¬é‡å†™äº†è¿™ä¸ªæ–¹æ³•åï¼Œå°±å¯ä»¥å°†æˆ‘ä»¬ä»£</span>
      <span class="token comment">//ç†åçš„å¯¹è±¡æ­£ç¡®æ³¨å…¥äº†</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bp <span class="token keyword">instanceof</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span> ibp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">)</span> bp<span class="token punctuation">;</span>
        exposedObject <span class="token operator">=</span> ibp<span class="token punctuation">.</span><span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>exposedObject<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="prototypeç±»å‹ä¸ºä»€ä¹ˆè§£å†³ä¸äº†å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#prototypeç±»å‹ä¸ºä»€ä¹ˆè§£å†³ä¸äº†å¾ªç¯ä¾èµ–" aria-hidden="true">#</a> Prototypeç±»å‹ä¸ºä»€ä¹ˆè§£å†³ä¸äº†å¾ªç¯ä¾èµ–ï¼Ÿ</h5><p>å› ä¸ºPrototypeç±»å‹çš„Beanåœ¨æ¯æ¬¡è·å–æ—¶éƒ½è¦é‡æ–°åˆ›å»ºï¼Œè€Œä¾èµ–æ³¨å…¥çš„Beanåœ¨æ³¨å…¥åå°±ç»“æŸäº†ï¼Œä¸èƒ½å†ä¿®æ”¹äº†ï¼Œæ‰€ä»¥Prototypeä¸èƒ½è§£å†³å¾ªç¯ä¾èµ–ã€‚åœ¨springçš„AbstractBeanFactoryä¸­çš„doGetBeanæ–¹æ³•ä¸­æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœæ˜¯Prototypeç±»å‹å¹¶ä¸”è¯¥å®ä¾‹æ­£åœ¨åˆ›å»ºä¸­ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AbstractBeanFactory.java -&gt; doGetBean()</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Object</span> curVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prototypesCurrentlyInCreation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>curVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
			<span class="token punctuation">(</span>curVal<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>curVal <span class="token keyword">instanceof</span> <span class="token class-name">Set</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> curVal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ„é€ æ–¹æ³•æ³¨å…¥ä¸ºä»€ä¹ˆè§£å†³ä¸äº†å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#æ„é€ æ–¹æ³•æ³¨å…¥ä¸ºä»€ä¹ˆè§£å†³ä¸äº†å¾ªç¯ä¾èµ–" aria-hidden="true">#</a> æ„é€ æ–¹æ³•æ³¨å…¥ä¸ºä»€ä¹ˆè§£å†³ä¸äº†å¾ªç¯ä¾èµ–ï¼Ÿ</h5><p>æ€è€ƒä¸€ä¸ªé€»è¾‘ï¼ŒSpringåˆ›å»ºAçš„æ—¶å€™ï¼Œå‘ç°Açš„æ„é€ å‡½æ•°ä¸­éœ€è¦æ³¨å…¥Bï¼Œç„¶åspringå»åˆ›å»ºBï¼Œè¿™æ—¶å€™å‘ç°ï¼ŒBçš„æ„é€ å‡½æ•°ä¸­åˆéœ€è¦æ³¨å…¥Aï¼Œå¯æ˜¯è¿™æ—¶å€™Aè¿˜åœ¨ç­‰å¾…Båˆ›å»ºæˆåŠŸåè¿›è¡Œæ³¨å…¥ï¼ŒAè¿˜æ²¡åˆ›å»ºå¥½å‘¢ï¼Œè¿™æ—¶å€™å°±æ„æˆäº†æ­»ç­‰å¾…ï¼ŒAç­‰å¾…Båˆ›å»ºï¼ŒBç­‰å¾…Aåˆ›å»ºï¼Œæœ€ç»ˆçš„ç»“æœå°±æ˜¯éƒ½è¿›è¡Œä¸ä¸‹å»äº†ï¼Œspringæ£€æµ‹åˆ°åå°±åªèƒ½ç»™æˆ‘ä»¬æŠ›å¼‚å¸¸äº†ã€‚</p><h5 id="è‡ªå®šä¹‰beanpostprocessorå¹¶æ”¯æŒå¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#è‡ªå®šä¹‰beanpostprocessorå¹¶æ”¯æŒå¾ªç¯ä¾èµ–" aria-hidden="true">#</a> è‡ªå®šä¹‰BeanPostProcessorå¹¶æ”¯æŒå¾ªç¯ä¾èµ–</h5><p>å¦‚æœæˆ‘ä»¬æƒ³è¦è‡ªå®šä¹‰BeanPostProcessorï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦é€šè¿‡ä»£ç†åŸå§‹ç±»ï¼Œæ‰©å±•æˆ‘ä»¬çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬åƒä¸‹é¢è¿™æ ·å†™ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">,</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å¯¹Aåˆ›å»ºä»£ç†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»£ç†æ‹¦æˆª&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> object<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·å†™ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>BeanCurrentlyInCreationException<span class="token operator">:</span> Error creating bean <span class="token keyword">with</span> name <span class="token string">&#39;a&#39;</span><span class="token operator">:</span> Bean <span class="token keyword">with</span> name 
<span class="token string">&#39;a&#39;</span> has been injected into other beans <span class="token punctuation">[</span>b<span class="token punctuation">]</span> <span class="token keyword">in</span> its raw version <span class="token keyword">as</span> part <span class="token keyword">of</span> a circular reference<span class="token punctuation">,</span> but has eventually been 
wrapped<span class="token punctuation">.</span> This means that said other beans <span class="token keyword">do</span> not use the final version <span class="token keyword">of</span> the bean<span class="token punctuation">.</span> This is often the result <span class="token keyword">of</span> over<span class="token operator">-</span>
eager type matching <span class="token operator">-</span> consider using <span class="token string">&#39;getBeanNamesOfType&#39;</span> <span class="token keyword">with</span> the <span class="token string">&#39;allowEagerInit&#39;</span> flag turned off<span class="token punctuation">,</span> <span class="token keyword">for</span> example<span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ®µé”™è¯¯å¤§æ¦‚çš„æ„æ€å°±æ˜¯ï¼Œæˆ‘ä»¬å·²ç»æ³¨å…¥çš„beanåæ¥è¢«ä¿®æ”¹äº†ï¼Œå¯¼è‡´æ³¨å…¥çš„beanå’Œæœ€ç»ˆå®é™…çš„beanä¸æ˜¯ä¸€ä¸ªï¼Œæ‰€ä»¥æŠ¥é”™äº†ï¼Œå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‰ç…§æç¤ºï¼Œé€šè¿‡allowEagerInitè¿™ä¸ªå±æ€§è¿›è¡Œé…ç½®ï¼Œå…è®¸è¿™ç§ä¸ä¸€è‡´çš„æƒ…å†µå‘ç”Ÿï¼Œåªæ˜¯æˆ‘ä¸æ¨èè¿™ç§åšæ³•ï¼Œå¾ˆæœ‰å¯èƒ½å¸¦æ¥è«åå…¶å¦™çš„é”™è¯¯ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬æ¥æ”¹å†™ä¸€ä¸‹å®ç°æ–¹å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestBeanPostProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">SmartInstantiationAwareBeanPostProcessor</span><span class="token punctuation">,</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> alreadyWrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      alreadyWrap<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å¯¹Aåˆ›å»ºä»£ç†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœå·²ç»åœ¨æå‰æš´éœ²å¯¹è±¡çš„æ—¶å€™åˆ›å»ºä»£ç†å¯¹è±¡äº†ï¼Œè¿™é‡Œå°±ä¸å†è¿›è¡Œé‡å¤ä»£ç†äº†</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyWrap<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å¯¹Aåˆ›å»ºä»£ç†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span><span class="token class-name">A</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> methodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»£ç†æ‹¦æˆª&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> object <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> objects<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> object<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½ ä¼šå‘ç°è¿™ç§æ–¹å¼æˆåŠŸå¯åŠ¨äº†ï¼Œå¹¶ä¸”åœ¨Bä¸­æ³¨å…¥çš„Aå®ä¾‹å°±æ˜¯æˆ‘ä»¬ä»£ç†åçš„å¯¹è±¡ã€‚</p><p>æ³¨æ„ä¸€ä¸‹è¿™ä¸¤ç§å®ç°æ–¹å¼ï¼š</p><p>ç¬¬ä¸€ç§æ˜¯å®ç°äº†BeanPostProcessorï¼Œå¹¶å¯¹postProcessAfterInitialization()æ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼›</p><p>ç¬¬äºŒç§æ˜¯å®ç°äº†SmartInstantiationAwareBeanPostProcessorï¼Œå¹¶å¯¹getEarlyBeanReferenceè¿›è¡Œäº†é‡å†™ã€‚</p><p>è¦æƒ³æ˜ç™½åŸå› ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“Springåœ¨ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘BeanPostProcessorçš„è°ƒç”¨ã€‚ä¹‹æ‰€ä»¥ç¬¬äºŒç§èƒ½å¤ŸæˆåŠŸï¼Œæ˜¯å› ä¸ºSpringä¸­æå‰æš´éœ²beanæ—¶çš„ä¸€æ®µå¤„ç†é€»è¾‘ï¼Œè¿™æ®µé€»è¾‘ä½äºAbstractAutowireCapableBeanFactoryä¸­çš„doCreateBeanæ–¹æ³•ä¸­ï¼Œä¸Šé¢å·²ç»è®²è¿‡äº†ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ç¬¬ä¸€ç§æ–¹å¼ä¸ºä»€ä¹ˆä¸èƒ½æˆåŠŸ?</p><p>é€šè¿‡ä¸Šé¢ä»£ç çš„æ ‡æ³¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†ç¬¬ä¸€ç§æ–¹å¼postProcessAfterInitialization()æ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨initializeBean()ä¸­ï¼Œè€Œæˆ‘ä»¬çš„@Autowirdæ³¨è§£çš„æ³¨å…¥æ˜¯åœ¨initializeBeançš„å‰ä¸€ä¸ªæ–¹æ³•populateBeanä¸­ï¼Œä¹Ÿå°±æ˜¯Bä¸­éƒ½å·²ç»æ³¨å…¥äº†Aæå‰æš´éœ²å‡ºæ¥çš„å¯¹è±¡åï¼Œæˆ‘ä»¬çš„postProcessAfterInitialization()æ–¹æ³•åˆå°†Aå¯¹è±¡å®ä¾‹ç»™æ”¹æˆäº†æˆ‘ä»¬çš„ä»£ç†å¯¹è±¡ï¼Œä»è€Œå¯¼è‡´äº†æ³¨å…¥çš„Açš„beanå¯¹è±¡å’Œæœ€ç»ˆçš„Açš„beanå¯¹è±¡ä¸æ˜¯ä¸€ä¸ªã€‚</p><h5 id="ä¸ºä»€ä¹ˆéè¦ä¸‰çº§ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéè¦ä¸‰çº§ä¾èµ–" aria-hidden="true">#</a> ä¸ºä»€ä¹ˆéè¦ä¸‰çº§ä¾èµ–</h5><p>â€‹ ä¸¥æ ¼æ¥è®²ï¼Œç¬¬ä¸‰çº§ç¼“å­˜å¹¶éç¼ºå®ƒä¸å¯ï¼Œå› ä¸ºå¯ä»¥æå‰åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæå‰åˆ›å»ºä»£ç†å¯¹è±¡åªæ˜¯ä¼šèŠ‚çœé‚£ä¹ˆä¸€ä¸¢ä¸¢å†…å­˜ç©ºé—´ï¼Œå¹¶ä¸ä¼šå¸¦æ¥æ€§èƒ½ä¸Šçš„æå‡ï¼Œä½†æ˜¯ä¼šç ´ç¯ Spring çš„è®¾è®¡åŸåˆ™ã€‚Spring çš„è®¾è®¡åŸåˆ™æ˜¯å°½å¯èƒ½ä¿è¯æ™®é€šå¯¹è±¡åˆ›å»ºå®Œæˆä¹‹åï¼Œå†ç”Ÿæˆå…¶ AOP ä»£ç†ï¼ˆå°½å¯èƒ½å»¶è¿Ÿä»£ç†å¯¹è±¡çš„ç”Ÿæˆï¼‰ã€‚æ‰€ä»¥ Spring ç”¨äº†ç¬¬ä¸‰çº§ç¼“å­˜ï¼Œæ—¢ç»´æŒäº†è®¾è®¡åŸåˆ™ï¼Œåˆå¤„ç†äº†å¾ªç¯ä¾èµ–ï¼›ç‰ºç‰²é‚£ä¹ˆä¸€ä¸¢ä¸¢å†…å­˜ç©ºé—´æ˜¯æ„¿æ„æ¥å—çš„ã€‚</p><p>â€‹ å¯¹äºäºŒçº§ç¼“å­˜ï¼Œå¦‚æœå°†åŠæˆå“å¯¹è±¡å’Œæˆå“å¯¹è±¡éƒ½æ··åœ¨ä¸€çº§ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆä¸ºäº†åŒºåˆ†ä»–ä»¬ï¼ŒåŠ¿å¿…ä¼šå¢åŠ ä¸€äº›è€Œå¤–çš„æ ‡è®°å’Œé€»è¾‘å¤„ç†ï¼Œè¿™å°±ä¼šå¯¼è‡´å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹å˜å¾—å¤æ‚åŒ–äº†ã€‚</p><hr><h4 id="beanfactoryå’ŒfactorybeanåŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#beanfactoryå’ŒfactorybeanåŒºåˆ«" aria-hidden="true">#</a> <code>BeanFactory</code>å’Œ<code>FactoryBean</code>åŒºåˆ«</h4><p>BeanFactory æ˜¯ Factory è€Œ FactoryBean æ˜¯ä¸€ä¸ª Bean</p><ul><li>BeanFactory æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒæ¥å£ä¹‹ä¸€ï¼Œç”¨äºç®¡ç†å’Œè·å–åº”ç”¨ç¨‹åºä¸­çš„ Bean å®ä¾‹ã€‚å®ƒæ˜¯ä¸€ä¸ªå·¥å‚æ¨¡å¼çš„å®ç°ï¼Œè´Ÿè´£åˆ›å»ºã€é…ç½®å’Œç®¡ç† Bean å¯¹è±¡ã€‚BeanFactory æ˜¯ Spring IoC å®¹å™¨çš„åŸºç¡€ï¼Œå®ƒå¯ä»¥ä»é…ç½®å…ƒæ•°æ®ï¼ˆå¦‚ XML æ–‡ä»¶ï¼‰ä¸­è¯»å– Bean çš„å®šä¹‰ï¼Œå¹¶åœ¨éœ€è¦æ—¶å®ä¾‹åŒ–å’Œæä¾›è¿™äº› Beanã€‚</li><li>FactoryBean æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Beanï¼Œå®ƒæ˜¯ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†å…¶ä»– Bean çš„å®ä¾‹ã€‚FactoryBean æ¥å£å®šä¹‰äº†ä¸€ç§åˆ›å»º Bean çš„æ–¹å¼ï¼Œå®ƒå…è®¸å¼€å‘äººå‘˜åœ¨ Bean çš„åˆ›å»ºè¿‡ç¨‹ä¸­è¿›è¡Œæ›´å¤šçš„è‡ªå®šä¹‰æ“ä½œã€‚é€šè¿‡å®ç° FactoryBean æ¥å£ï¼Œå¼€å‘äººå‘˜å¯ä»¥åˆ›å»ºå¤æ‚çš„ Bean å®ä¾‹ï¼Œæˆ–è€…åœ¨ Bean å®ä¾‹åŒ–ä¹‹å‰è¿›è¡Œä¸€äº›é¢å¤–çš„é€»è¾‘å¤„ç†ã€‚å®ƒæ˜¯ä¸€ä¸ªBeanï¼Œä¸åŒäºæ™®é€šBeançš„æ˜¯ï¼šå®ƒæ˜¯å®ç°äº†<code>FactoryBean&lt;T&gt;</code>æ¥å£çš„Beanï¼Œæ ¹æ®è¯¥Beançš„IDä»BeanFactoryä¸­è·å–çš„å®é™…ä¸Šæ˜¯FactoryBeançš„getObject()è¿”å›çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯FactoryBeanæœ¬èº«ï¼Œå¦‚æœè¦è·å–FactoryBeanå¯¹è±¡ï¼Œè¯·åœ¨idå‰é¢åŠ ä¸€ä¸ª<code>&amp;</code>ç¬¦å·æ¥è·å–ã€‚</li></ul><p>â€‹ åŒºåˆ«åœ¨äºï¼ŒBeanFactory æ˜¯ Spring æ¡†æ¶çš„æ ¸å¿ƒæ¥å£ï¼Œç”¨äºç®¡ç†å’Œæä¾› Bean å®ä¾‹ï¼Œè€Œ FactoryBean æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Beanï¼Œç”¨äºåˆ›å»ºå’Œç®¡ç†å…¶ä»– Bean çš„å®ä¾‹ã€‚FactoryBean åœ¨ Bean çš„åˆ›å»ºè¿‡ç¨‹ä¸­æä¾›æ›´å¤šçš„è‡ªå®šä¹‰èƒ½åŠ›ï¼Œå…è®¸è¿›è¡Œé¢å¤–çš„é€»è¾‘å¤„ç†ã€‚</p><hr><h4 id="autowiredå’Œ-resourceçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#autowiredå’Œ-resourceçš„åŒºåˆ«" aria-hidden="true">#</a> @Autowiredå’Œ@Resourceçš„åŒºåˆ«</h4><p>ç›´è§‚çš„é”™è¯¯ç†è§£ï¼š</p><ol><li><code>@Autowired</code>æ ¹æ®ç±»å‹è¿›è¡Œæ³¨å…¥ï¼Œè‹¥æ²¡æœ‰æ‰¾åˆ°è¯¥ç±»å‹Beanä¼šæŠ¥é”™</li><li><code>@Autowired</code>æ ¹æ®ç±»å‹è¿›è¡Œæ³¨å…¥ï¼Œ è‹¥å‡ºç°å¤šä¸ªç±»å‹çš„Beanï¼Œä¼šæŠ¥é”™</li><li><code>@Resource</code>æ ¹æ®åç§°è¿›å…¥æ³¨å…¥</li></ol><p>è§£ç­”è¿™äº›è¯¯è§£ï¼ˆç»™å‡ºæ­£ç¡®ç­”æ¡ˆï¼‰ï¼š</p><ol><li><code>@Autowired</code>æ ¹æ®ç±»å‹è¿›è¡Œæ³¨å…¥è¿™è¯æ²¡æ¯›ç—…ï¼Œä½†æ˜¯è‹¥æ²¡æœ‰æ‰¾åˆ°è¯¥ç±»å‹çš„Beanï¼Œè‹¥è®¾ç½®äº†å±æ€§<code>required=false</code>ä¹Ÿæ˜¯ä¸ä¼šæŠ¥é”™çš„</li><li><code>@Autowired</code>æ³¨å…¥è‹¥æ‰¾åˆ°å¤šä¸ªç±»å‹çš„Beanï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œæ¯”å¦‚ä¸‹é¢ä¸‰ç§æƒ…å†µï¼Œéƒ½ä¸ä¼šæŠ¥é”™~</li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// å‘å®¹å™¨ä¸­æ³¨å…¥ä¸¤ä¸ªç›¸åŒç±»å‹çš„Beanï¼Œå¹¶ä¸”éƒ½ä¸ä½¿ç”¨@Primaryæ ‡æ³¨</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RootConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Parent</span> <span class="token function">parentOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Parent</span> <span class="token function">parentTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

æ³¨å…¥æ–¹å¼å¦‚ä¸‹ï¼š
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Parent</span> parent<span class="token punctuation">;</span>

<span class="token comment">// è‹¥ä»€ä¹ˆéƒ½ä¸å¤„ç†ï¼Œä¼šå¼‚å¸¸ï¼šNoUniqueBeanDefinitionException: No qualifying bean of type &#39;com.fsx.bean.Parent&#39; available: expected single matching bean but found 2: parentOne,parentTwo</span>

<span class="token comment">// æ–¹æ¡ˆä¸€ï¼šå‘å®¹å™¨æ³¨å…¥Beançš„æ—¶å€™åŠ ä¸Š@Primaryæ³¨è§£ï¼ˆç•¥ï¼‰</span>
<span class="token comment">// æ–¹æ¡ˆäºŒï¼šä½¿ç”¨@Qualifierï¼ˆç•¥ï¼‰</span>
<span class="token comment">// æ–¹æ¡ˆä¸‰ï¼šä½¿å¾—å­—æ®µåï¼Œå’Œå®¹å™¨é‡Œçš„Beanåç§°ä¸€è‡´ï¼Œæ¯”å¦‚æ”¹æˆä¸‹é¢å­—æ®µåï¼Œå°±ä¸ä¼šæŠ¥é”™äº†</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Parent</span> parentOne<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Parent</span> parentTwo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€‹ <strong>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå®ƒå’Œ<code>@Qualifier</code>çš„åŒºåˆ«ï¼šä»–ä»¬çš„ç”Ÿæ•ˆé˜¶æ®µä¸ä¸€æ ·ã€‚</strong> <strong><code>@Qualifier</code>ï¼šå®ƒåœ¨å¯»æ—©åŒç±»å‹çš„Beançš„æ—¶å€™å°±ç”Ÿæ•ˆäº†ï¼Œåœ¨æ–¹æ³•<code>findAutowireCandidates</code>è¿™é‡Œå»å¯»æ‰¾å€™é€‰çš„Beançš„æ—¶å€™å°±ç”Ÿæ•ˆäº†ï¼Œåªä¼šæ‰¾å‡ºä¸€ä¸ªï¼ˆæˆ–è€…0ä¸ªå‡ºæ¥ï¼‰</strong> <strong><code>@Autowired</code>è‡ªå¸¦çš„æ ¹æ®å­—æ®µååŒ¹é…ï¼šå‘ç”Ÿåœ¨è‹¥æ‰¾å‡ºå¤šä¸ªåŒç±»å‹Beançš„æƒ…å†µä¸‹ï¼Œä¼šæ ¹æ®æ­¤å­—æ®µåç§°determineä¸€ä¸ªåŒ¹é…ä¸Šçš„å‡ºæ¥</strong></p><p><code>@Resource</code>è£…é…é¡ºåºè§£é‡Šï¼š</p><ul><li>å¦‚æœæ—¢æ²¡æœ‰æŒ‡å®šnameï¼Œåˆæ²¡æœ‰æŒ‡å®štypeï¼Œåˆ™è‡ªåŠ¨å…ˆæŒ‰ç…§byNameæ–¹å¼è¿›è¡Œè£…é…ï¼›å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™å›é€€ä¸ºä¸€ä¸ªåŸå§‹ç±»å‹è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™è‡ªåŠ¨è£…é…</li><li>å¦‚æœåŒæ—¶æŒ‡å®šäº†nameå’Œtypeï¼Œåˆ™ä»Springä¸Šä¸‹æ–‡ä¸­æ‰¾åˆ°å”¯ä¸€åŒ¹é…çš„beanè¿›è¡Œè£…é…ï¼Œæ‰¾ä¸åˆ°åˆ™æŠ›å‡ºå¼‚å¸¸</li><li>å¦‚æœæŒ‡å®šäº†nameï¼Œåˆ™ä»ä¸Šä¸‹æ–‡ä¸­æŸ¥æ‰¾åç§°ï¼ˆidï¼‰åŒ¹é…çš„beanè¿›è¡Œè£…é…ï¼Œæ‰¾ä¸åˆ°åˆ™æŠ›å‡ºå¼‚å¸¸</li><li>å¦‚æœæŒ‡å®šäº†typeï¼Œåˆ™ä»ä¸Šä¸‹æ–‡ä¸­æ‰¾åˆ°ç±»ä¼¼åŒ¹é…çš„å”¯ä¸€beanè¿›è¡Œè£…é…ï¼Œæ‰¾ä¸åˆ°æˆ–æ˜¯æ‰¾åˆ°å¤šä¸ªï¼Œéƒ½ä¼šæŠ›å‡ºå¼‚å¸¸</li><li><code>éœ€è¦æ³¨æ„çš„æ˜¯</code>ï¼š<code>@Resource</code>å¹¶ä¸æ”¯æŒ<code>@Primary</code>(Spring 4.2ä¹‹åæ”¯æŒäº†)</li></ul><hr><h4 id="æ€ä¹ˆæ§åˆ¶beançš„åˆå§‹åŒ–é¡ºåº" tabindex="-1"><a class="header-anchor" href="#æ€ä¹ˆæ§åˆ¶beançš„åˆå§‹åŒ–é¡ºåº" aria-hidden="true">#</a> æ€ä¹ˆæ§åˆ¶beançš„åˆå§‹åŒ–é¡ºåº</h4><ol><li>è®¾ç½®ä¾èµ–å…³ç³»ï¼Œ<code>@Autowired</code></li><li>ä½¿ç”¨<code>@DependsOn</code></li><li>ä½¿ç”¨<code>BeanPostProcessor</code>ï¼Œ<code>BeanFactoryPostProcessor</code>ï¼Œ<code>InstantiationAwareBeanPostProcessor</code></li><li>ä½¿ç”¨staticé™æ€å†…éƒ¨ç±»ï¼Œé™æ€å†…éƒ¨ç±»ä¸­å®šä¹‰çš„<code>Bean</code>ä¼šå…ˆåˆå§‹åŒ–</li></ol></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/nocetfy/edit/main/docs/interview/æ¡†æ¶/Spring IOC.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><!----><!----></div></footer><nav class="page-nav"><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/Mybatis.html" class="nav-link prev" aria-label="Mybatis"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Mybatis</div></a><a href="/MyNotes/interview/%E6%A1%86%E6%9E%B6/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E7%B1%BB.html" class="nav-link next" aria-label="å¸¸ç”¨å·¥å…·ç±»"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">å¸¸ç”¨å·¥å…·ç±»<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/MyNotes/assets/app-59c87434.js" defer></script>
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-y/instant.page/5.1.0/instantpage.min.js" type="application/javascript"></script>
  </body>
</html>
